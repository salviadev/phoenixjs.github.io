var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
/// <reference path="../../../../typings/index.d.ts" />
var Phoenix;
(function (Phoenix) {
    var utils;
    (function (utils) {
        var _getPromise = function () {
            return window['Promise'] || (window['ES6Promise'] ? window['ES6Promise'].Promise : null);
        }, _p8 = function (s) {
            var p = (Math.random().toString(16) + "000000000").substr(2, 8);
            return s ? "-" + p.substr(0, 4) + "-" + p.substr(4, 4) : p;
        }, _uuid = function () {
            return _p8(false) + _p8(true) + _p8(true) + _p8(false);
        }, _allocID = function () {
            return "I" + _p8(false) + _p8(false) + _p8(false) + _p8(false);
        }, _format = function () {
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i - 0] = arguments[_i];
            }
            return args[0].replace(/{(\d+)}/g, function (match, num) {
                num = parseInt(num, 10);
                return args[num + 1];
            });
        }, _formatByName = function (value, params) {
            return value.replace(/{([^{]*)}/g, function (match, val) {
                return params[val] || '';
            });
        }, _isNull = function (value) {
            return value === null;
        }, _isUndefined = function (value) {
            return value === undefined;
        }, _isNullOrUndefined = function (value) {
            return value === null || value === undefined;
        }, _merge = function (src, dst) {
            if (!src)
                return;
            for (var p in src) {
                var pv = src[p];
                var ov = dst[p];
                if (pv === null)
                    continue;
                if (typeof pv === 'object' && !Array.isArray(pv)) {
                    dst[p] = dst[p] || {};
                    _merge(pv, dst[p]);
                }
                else
                    dst[p] = pv;
            }
        }, _cleanUpObject = function (src) {
            Object.keys(src).forEach(function (p) {
                src[p] = null;
            });
        }, _logModules = {
            scope: false,
            destroy: false,
            menu: false,
            proxydata: false
        }, _copy = function (src) {
            var res = {};
            for (var p in src)
                res[p] = src[p];
            return res;
        }, _equals = function (src, dst) {
            if (!src && dst || !dst && src)
                return false;
            if (src === dst)
                return true;
            if (!src && !dst)
                return false;
            if (Array.isArray(src)) {
                if (src.length !== dst.length) {
                    return false;
                }
                for (var j = 0, ll = src.length; j < ll; j++) {
                    if (!_equals(src[j], dst[j]))
                        return false;
                }
                return true;
            }
            else if (typeof src === 'object') {
                if (typeof src !== typeof dst)
                    return false;
                var srcp = Object.keys(src);
                var dstp = Object.keys(dst);
                if (srcp.length !== dstp.length)
                    return false;
                for (var i = 0, len = srcp.length; i < len; i++) {
                    if (!_equals(src[srcp[i]], dst[srcp[i]]))
                        return false;
                }
                return true;
            }
            return false;
        }, _deltaPatch = function (oldValue, newValue, dst) {
            var oldProps = Object.keys(oldValue);
            var newProps = Object.keys(newValue);
            oldProps.forEach(function (pn) {
                var ov = oldValue[pn];
                var i = newProps.indexOf(pn);
                if (i >= 0) {
                    newProps.splice(i, 1);
                    var nv = newValue[pn];
                    if (nv === ov)
                        return;
                    if (nv === null) {
                        dst[pn] = null;
                    }
                    else if (ov === null) {
                        dst[pn] = nv;
                    }
                    else if (Array.isArray(ov)) {
                        if (!_equals(ov, nv))
                            dst[pn] = nv;
                    }
                    else if (typeof ov === 'object') {
                        if (!_equals(ov, nv)) {
                            dst[pn] = {};
                            _deltaPatch(ov, nv, dst[pn]);
                        }
                    }
                    else
                        dst[pn] = nv;
                }
                else {
                    // removed
                    dst[pn] = null;
                }
            });
            newProps.forEach(function (pn) {
                dst[pn] = newValue[pn];
            });
        }, _logModule = function (moduleName, value) {
            if (value !== undefined)
                _logModules[moduleName] = value;
            return _logModules[moduleName];
        }, _log = function (value, moduleName) {
            if (!_logModules)
                return;
            if (_logModules[moduleName])
                console.log(value);
        }, entityMap = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': '&quot;',
            "'": '&#39;',
            "/": '&#x2F;'
        }, _escapeHtml = function (value) {
            return (value || '').replace(/[&<>"'\/]/g, function (s) {
                return entityMap[s];
            });
        }, _getPath = function () {
            var scripts = document.getElementsByTagName('script');
            for (var i = scripts.length - 1; i >= 0; --i) {
                var s = scripts[i].src.split('?')[0];
                var a = s.split('/'), l = a.length, li = a[l - 1].toLowerCase();
                if (li == "phoenix.js" || li == "phoenix.min.js" || (li == 'core.js' && a[l - 2] == 'core')) {
                    var j = l - 1;
                    if (li == 'core.js')
                        j--;
                    return a.slice(0, j).join('/');
                }
            }
            throw "Invalid script Name";
        }, _extractData = function (path, value) {
            if (path.indexOf(".") >= 0) {
                var c = value;
                path.split(".").forEach(function (pn) {
                    if (c)
                        c = c[pn];
                });
                return (c || '') + '';
            }
            else
                return value[path] === undefined ? path : value[path];
            ;
        }, _hasexp = function (expression) {
            return (expression || '').indexOf('{{') >= 0;
        }, _parseexp = function (expression, context) {
            return expression.replace(/{{([^{]*)}}/g, function (match, p) {
                return _extractData(p, context);
            });
        }, _extractAngularValues = function (expression, map) {
            return expression.replace(/\{\{([^{]*)\}\}/g, function (match, p) {
                map.push({ name: (p.split('|'))[0].trim() });
                return '';
            });
        }, _execFilter = function (filter, value) {
            switch (filter) {
                case 'uppercase':
                    return value.toUpperCase();
                case 'lowercase':
                    return value.toLowerCase();
                case 'firstChar':
                    return value && value.length ? value[0] : '';
            }
            return value;
        }, _execAngularExpression = function (expression, context, noExpand) {
            return expression.replace(/\{\{([^{]*)\}\}/g, function (match, p) {
                var ss = p.split('|');
                var prop = (ss[0] || '').trim();
                var val = noExpand ? context[prop] : _extractData(prop, context);
                for (var i = 1, ll = ss.length; i < ll; i++) {
                    val = _execFilter((ss[i] || '').trim(), val);
                }
                return val;
            });
        }, _dp = function (propertyName, target) {
            var obj = target || this;
            Object.defineProperty(obj.props, propertyName, {
                get: function () {
                    return obj.data[propertyName];
                },
                set: function (value) {
                    if (value != obj.data[propertyName]) {
                        obj.data[propertyName] = value;
                        obj._notifyChange(propertyName);
                    }
                },
                enumerable: true
            });
        }, _applyMixins = function (derivedCtor, baseCtors) {
            baseCtors.forEach(function (baseCtor) {
                Object.getOwnPropertyNames(baseCtor.prototype).forEach(function (name) {
                    derivedCtor.prototype[name] = baseCtor.prototype[name];
                });
            });
        }, _focusDelay = function () {
            return function (fn) {
                setTimeout(function () {
                    fn();
                }, 200);
            };
        }, _getNextTick = function () {
            var nextTickFn;
            if (window.setImmediate) {
                nextTickFn = function nextTickSetImmediate(fn) {
                    setImmediate(function () {
                        fn();
                    });
                };
            }
            else {
                nextTickFn = function nextTickSetTimeout(fn) {
                    setTimeout(function () {
                        fn();
                    }, 0);
                };
            }
            return nextTickFn;
        }, _extend = function (dst, opts) {
            dst = dst || {};
            if (Object && Object["assign"]) {
                return Object["assign"](dst, opts);
            }
            else {
                Object.keys(opts).forEach(function (pn) {
                    dst[pn] = opts[pn];
                });
            }
            return dst;
        }, _getDataAsPromise = function (ldata) {
            var _promise = _getPromise();
            return _promise.resolve(ldata);
            //let nt = _getNextTick();
            //return new _promise(function (resolve, reject) {
            //    nt(function () {
            //        resolve(ldata);
            //    })
            //});
        };
        utils.Promise = _getPromise();
        utils.allocUuid = _uuid;
        utils.allocID = _allocID;
        utils.format = _format;
        utils.merge = _merge;
        utils.formatNames = _formatByName;
        utils.extend = _extend;
        utils.logModule = _logModule;
        utils.log = _log;
        utils.equals = _equals;
        utils.copy = _copy;
        utils.deltaPatch = function (oldValue, newValue) {
            var dst = {};
            _deltaPatch(oldValue, newValue, dst);
            if (!Object.keys(dst).length)
                return null;
            return dst;
        };
        utils.isNull = _isNull;
        utils.isUndefined = _isUndefined;
        utils.isNullOrUndefined = _isNullOrUndefined;
        utils.escapeHtml = _escapeHtml;
        utils.phoenixPath = _getPath;
        utils.parseExpression = _parseexp;
        utils.hasExpression = _hasexp;
        utils.parseVariable = _extractData;
        utils.defineProperty = _dp;
        utils.applyMixins = _applyMixins;
        utils.nextTick = _getNextTick();
        utils.focusDelay = _focusDelay();
        utils.dataAsPromise = _getDataAsPromise;
        utils.extractAngularVars = _extractAngularValues;
        utils.execAngularExpression = _execAngularExpression;
        utils.confirm = function (title, message, success) {
            if (window.confirm(message))
                success();
        };
        utils.alert = function (title, message, success) {
            window.alert(message);
        };
        utils.prompt = function (title, defaultValue, success) {
            var value = window.prompt(title, defaultValue);
            success(value);
        };
        utils.cleanUpObject = _cleanUpObject;
    })(utils = Phoenix.utils || (Phoenix.utils = {}));
    (function _polyfill() {
        var arrayProto = Array.prototype;
        if (!arrayProto.find) {
            arrayProto.find = function (predicate, thisArg) {
                if (this === null) {
                    throw new TypeError('Array.prototype.find called on null or undefined');
                }
                if (typeof predicate !== 'function') {
                    throw new TypeError('predicate must be a function');
                }
                var list = Object(this);
                var length = list.length >>> 0;
                var thisArg = arguments[1];
                var value;
                for (var i = 0; i < length; i++) {
                    value = list[i];
                    if (predicate.call(thisArg, value, i, list)) {
                        return value;
                    }
                }
                return undefined;
            };
        }
        if (!arrayProto.findIndex) {
            arrayProto.findIndex = function (predicate, thisArg) {
                if (this === null) {
                    throw new TypeError('Array.prototype.find called on null or undefined');
                }
                if (typeof predicate !== 'function') {
                    throw new TypeError('predicate must be a function');
                }
                var list = Object(this);
                var length = list.length >>> 0;
                var thisArg = arguments[1];
                var value;
                for (var i = 0; i < length; i++) {
                    value = list[i];
                    if (predicate.call(thisArg, value, i, list)) {
                        return i;
                    }
                }
                return -1;
            };
        }
    })();
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="./modules/utils.ts" />
var Phoenix;
(function (Phoenix) {
    var _utils = Phoenix.utils;
    var external;
    (function (external) {
        var _defPrefsLoader = function (name) {
            var promiseClass = _utils.Promise;
            if (window.localStorage)
                return new promiseClass(function (resolve, reject) {
                    var d = window.localStorage.getItem('preferences.' + name);
                    if (d)
                        resolve(JSON.parse(d));
                    else
                        resolve(null);
                });
            else
                return new promiseClass(function (resolve, reject) {
                    resolve(null);
                });
        }, _defPrefsSaver = function (name, data) {
            var promiseClass = _utils.Promise;
            if (window.localStorage)
                return new promiseClass(function (resolve, reject) {
                    if (data)
                        window.localStorage.setItem('preferences.' + name, JSON.stringify(data));
                    else
                        window.localStorage.setItem('preferences.' + name, '');
                    resolve();
                });
            else
                return new promiseClass(function (resolve, reject) {
                    resolve();
                });
        };
        external.hashHandler = null;
        external.logoutHandler = null;
        external.forbiddenHandler = null;
        external.changePasswordHandler = null;
        external.checkLoggedInHandler = null;
        external.historyChangedHandler = null;
        external.preferenceLoadHandler = _defPrefsLoader;
        external.preferenceSaveHandler = _defPrefsSaver;
    })(external = Phoenix.external || (Phoenix.external = {}));
    var history;
    (function (history) {
        var _value = [], _removeLast = function () {
            _value.pop();
            if (external.historyChangedHandler)
                external.historyChangedHandler();
        }, _add = function (hash, reset) {
            if (reset) {
                _value = [hash];
                if (external.historyChangedHandler)
                    external.historyChangedHandler();
                return;
            }
            var len = _value.length;
            var last = len ? _value[len - 1] : '';
            if (last != hash) {
                var prev = (len >= 2) ? _value[len - 2] : '';
                if (hash == prev)
                    _value.pop();
                else
                    _value.push(hash);
                if (external.historyChangedHandler)
                    external.historyChangedHandler();
            }
        }, _hasBack = function () {
            return _value.length > 1;
        }, _replaceHash;
        /* replaceHash */
        if ('replaceState' in window.history) {
            _replaceHash = function (newhash) {
                if (('' + newhash).charAt(0) !== '#')
                    newhash = '#' + newhash;
                if (window.location.hash != newhash) {
                    _removeLast();
                    window.history.replaceState('', '', newhash);
                }
            };
        }
        else {
            var hash = window.location.hash;
            _replaceHash = function (newhash) {
                if (('' + newhash).charAt(0) !== '#')
                    newhash = '#' + newhash;
                if (location.hash !== newhash) {
                    _removeLast();
                    if (location.hash !== hash)
                        window.history.back();
                    window.location.hash = newhash;
                }
            };
        }
        history.removeLast = _removeLast;
        history.add = _add;
        history.hasBack = _hasBack;
        history.value = _value;
        history.replaceHash = _replaceHash;
    })(history = Phoenix.history || (Phoenix.history = {}));
    var render;
    (function (render) {
        var _renders = {}, _registerRender = function (context, name, handler) {
            _renders[context] = _renders[context] || {};
            _renders[context][name] = handler;
        }, _getRender = function (context, name) {
            if (!_renders[context])
                return null;
            return _renders[context][name];
        };
        render.register = _registerRender;
        render.get = _getRender;
    })(render = Phoenix.render || (Phoenix.render = {}));
    var ipc;
    (function (ipc) {
        var _eventListeners = {}, _emitEvent = function (eventName, data) {
            var evname = 'on' + eventName;
            var l = _eventListeners[evname];
            if (l)
                l.forEach(function (item) {
                    var hnd = item.listener ? item.handler.bind(item.listener) : item.handler;
                    hnd(data);
                });
        }, _regListener = function (eventName, handler, listener) {
            _eventListeners[eventName] = _eventListeners[eventName] || [];
            var l = _eventListeners[eventName];
            l.push({
                listener: listener,
                handler: handler
            });
        }, _unregListener = function (listener, eventName) {
            function _rmvlistener(res) {
                if (res) {
                    var i = res.length;
                    while (i--) {
                        var o = res[i];
                        if (o.listener == listener)
                            res.splice(i, 1);
                    }
                }
            }
            if (eventName) {
                _rmvlistener(_eventListeners[eventName]);
            }
            else {
                Object.keys(_eventListeners).forEach(function (evn) {
                    _rmvlistener(_eventListeners[evn]);
                });
            }
        };
        ipc.emit = _emitEvent;
        ipc.listen = _regListener;
        ipc.unlisten = _unregListener;
    })(ipc = Phoenix.ipc || (Phoenix.ipc = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
var Phoenix;
(function (Phoenix) {
    var utils;
    (function (utils) {
        var Serial = (function () {
            function Serial() {
                this._eventList = [];
            }
            Serial.prototype.execute = function (proc) {
                this._eventList.push(proc);
                this._execute();
            };
            Serial.prototype._execute = function () {
                var that = this;
                if (that._inExec)
                    return;
                that._inExec = true;
                try {
                    while (true) {
                        if (!that._eventList.length)
                            break;
                        var p = that._eventList.shift();
                        try {
                            p();
                        }
                        catch (e) {
                        }
                    }
                }
                finally {
                    that._inExec = false;
                }
            };
            return Serial;
        }());
        utils.Serial = Serial;
        var BusEvent = (function () {
            function BusEvent(delay, promise, resolve, errorhandler, ondispose) {
                var that = this;
                that.ondispose = ondispose;
                that.promise = promise;
                that.resolve = resolve;
                that.errorhandler = errorhandler;
                that.dataHandler = that.ondata.bind(that);
                if (delay)
                    that.timer = window.setTimeout(that._execute.bind(that), delay);
                else
                    that._execute();
            }
            BusEvent.prototype.ondata = function (data) {
                var that = this;
                var resolver = that.resolve;
                that.destroy();
                if (resolver)
                    resolver(data);
            };
            BusEvent.prototype.onerror = function (error) {
                var that = this;
                var errorhandler = that.errorhandler;
                that.destroy();
                if (errorhandler)
                    errorhandler(error);
            };
            BusEvent.prototype._execute = function () {
                var that = this;
                if (that.promise && that.promise.then)
                    that.promise.then(that.dataHandler, that.onerror.bind(that));
                else if (that.promise && typeof that.promise === 'function')
                    that.dataHandler(that.promise());
                else
                    that.dataHandler(that.promise);
            };
            BusEvent.prototype._cleaTimeout = function () {
                var that = this;
                if (that.timer) {
                    window.clearTimeout(that.timer);
                    that.timer = 0;
                }
            };
            BusEvent.prototype.destroy = function () {
                var that = this;
                that.resolve = null;
                that.errorhandler = null;
                that._cleaTimeout();
                that.promise = null;
                var od = that.ondispose;
                that.ondispose = null;
                if (od)
                    od(that);
            };
            return BusEvent;
        }());
        var SingleEventBus = (function () {
            function SingleEventBus(delay) {
                this.defaultDelay = 0;
                var that = this;
                that.defaultDelay = delay;
                that._error = that._errorHandler.bind(that);
                that._dispose = that._onEventDisposed.bind(that);
            }
            SingleEventBus.prototype._errorHandler = function (error) {
                var that = this;
                if (that.onError)
                    that.onError(error);
            };
            SingleEventBus.prototype.clear = function () {
                var that = this;
                if (that.currentEvent) {
                    that.currentEvent.destroy();
                    that.currentEvent = null;
                }
            };
            SingleEventBus.prototype._onEventDisposed = function (event) {
                var that = this;
                that.currentEvent = null;
            };
            SingleEventBus.prototype.push = function (promise, onsuccess, nodelay) {
                var that = this;
                that.clear();
                var delay = nodelay ? 0 : that.defaultDelay;
                that.currentEvent = new BusEvent(delay, promise, onsuccess, that._error, that._dispose);
            };
            SingleEventBus.prototype.destroy = function () {
                var that = this;
                that.clear();
            };
            return SingleEventBus;
        }());
        utils.SingleEventBus = SingleEventBus;
        utils.GlbSerial = new Serial();
    })(utils = Phoenix.utils || (Phoenix.utils = {}));
})(Phoenix || (Phoenix = {}));
var Phoenix;
(function (Phoenix) {
    Phoenix.locale = {};
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../typings/index.d.ts" />
var Phoenix;
(function (Phoenix) {
    var customData;
    (function (customData) {
        var _userData = {}, _registerData = function (namespace, value) {
            var a = namespace.split('.');
            var cp = _userData;
            for (var i = 0, len = a.length - 1; i < len; i++) {
                var p = a[i];
                cp[p] = cp[p] || {};
                cp = cp[p];
            }
            cp[a[a.length - 1]] = value;
        }, _getRegisteredData = function (namespace) {
            var a = namespace.split('.');
            var cp = _userData, cd = null;
            for (var i = 0, len = a.length; i < len; i++) {
                cd = cp[a[i]];
                if (!cd)
                    return cd;
                cp = cd;
            }
            return cd;
        };
        customData.register = _registerData;
        customData.get = _getRegisteredData;
    })(customData = Phoenix.customData || (Phoenix.customData = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../typings/index.d.ts" />
var Phoenix;
(function (Phoenix) {
    Phoenix.device = {
        phone: false,
        tablet: false,
        deviceType: ''
    };
    var _load$Mem = function () {
        try {
            if (window.sessionStorage) {
                return JSON.parse(window.sessionStorage.getItem('$mem')) || {};
            }
        }
        catch (ex) {
            return {};
        }
    };
    var _save$Mem = function (value) {
        value = value || {};
        try {
            if (window.sessionStorage) {
                window.sessionStorage.setItem('$mem', JSON.stringify(value));
            }
        }
        catch (ex) {
        }
    };
    Phoenix.$mem = _load$Mem();
    function save$mem() {
        _save$Mem(Phoenix.$mem);
    }
    Phoenix.save$mem = save$mem;
    function sessionPreferences(name, value) {
        var p = null;
        try {
            p = JSON.parse(window.sessionStorage.getItem('preferences'));
        }
        catch (ex) { }
        if (value === undefined) {
            return p ? p[name] : undefined;
        }
        else {
            p = p || {};
            p[name] = value;
            try {
                window.sessionStorage.setItem('preferences', JSON.stringify(p));
            }
            catch (ex) { }
        }
    }
    Phoenix.sessionPreferences = sessionPreferences;
    ;
    function preferences(name, value) {
        var p = null;
        try {
            p = JSON.parse(window.localStorage.getItem('preferences'));
        }
        catch (ex) { }
        if (value === undefined) {
            return p ? p[name] : undefined;
        }
        else {
            p = p || {};
            p[name] = value;
            try {
                window.localStorage.setItem('preferences', JSON.stringify(p));
            }
            catch (ex) { }
        }
    }
    Phoenix.preferences = preferences;
    Phoenix.build = { version: '0.1.0.0', release: false };
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../typings/index.d.ts" />
/// <reference path="./globals.ts" />
var Phoenix;
(function (Phoenix) {
    var authentication;
    (function (authentication) {
        var _build = Phoenix.build;
        var _memdbStorage = {}, _memorydb = {
            setItem: function (name, value) {
                _memdbStorage[name] = value;
            },
            getItem: function (name) {
                return _memdbStorage[name];
            }
        }, _afterLogout = [], _db = function () {
            var db = null;
            try {
                //db = (_build.release ? window.sessionStorage : window.localStorage);
                db = window.localStorage;
            }
            catch (ex) {
                db = null;
            }
            if (!db)
                db = _memorydb;
            return db;
        }, _save = function (credentials, onlyCredentials) {
            if (!onlyCredentials)
                credentials.basic = "Basic " + window.btoa((credentials.login || '') + ':' + (credentials.password || ''));
            _db().setItem("authentication", JSON.stringify(credentials));
        }, _load = function () {
            try {
                return JSON.parse(_db().getItem("authentication"));
            }
            catch (ex) {
                return null;
            }
        }, _registerAfterLogout = function (hnd) {
            _afterLogout.push(hnd);
        }, _clear = function () {
            _db().setItem("authentication", 'null');
            _afterLogout.forEach(function (hnd) {
                hnd();
            });
        };
        authentication.db = _db;
        authentication.save = _save;
        authentication.load = _load;
        authentication.clear = _clear;
        authentication.registerAfterLogout = _registerAfterLogout;
    })(authentication = Phoenix.authentication || (Phoenix.authentication = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../typings/index.d.ts" />
var Phoenix;
(function (Phoenix) {
    var application;
    (function (application) {
        var _cfgdata = {}, _setconfig = function (config, value) {
            _cfgdata[config] = value;
            return value;
        }, _getconfig = function (config) {
            return _cfgdata[config];
        };
        application.core = "phoenix";
        application.name = "";
        application.support = "";
        application.homeName = "home";
        application.title = "";
        application.licences = {};
        application.configuration = null;
        function config(appName, cfg) {
            appName = appName || application.name;
            if (cfg == undefined)
                return _getconfig("application_" + appName);
            else
                return _setconfig("application_" + appName, cfg);
        }
        application.config = config;
        ;
        function init(appName, appTitle, config) {
            application.name = appName;
            application.title = appTitle;
            if (config && config.homes && config.homes[appName])
                application.homeName = config.homes[appName];
            application.configuration = config;
            if (angular) {
                var am = config ? config.angularModules || [] : [];
                if (!Array.isArray(am) && (typeof am === 'object'))
                    am = am[appName] || [];
                application.angularApplication = angular.module(appName, am);
            }
        }
        application.init = init;
        ;
        function portailName() {
            return application.configuration && application.configuration.portailName ? application.configuration.portailName : 'portail';
        }
        application.portailName = portailName;
        function isPortail() {
            return application.name === portailName();
        }
        application.isPortail = isPortail;
    })(application = Phoenix.application || (Phoenix.application = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../typings/index.d.ts" />
/// <reference path="./utils.ts" />
/// <reference path="./locale.ts" />
/// <reference path="./customdata.ts" />
/// <reference path="./authentication.ts" />
/// <reference path="./application.ts" />
var Phoenix;
(function (Phoenix) {
    var ajax;
    (function (ajax) {
        var _utils = Phoenix.utils, _application = Phoenix.application, _customData = Phoenix.customData, _authentication = Phoenix.authentication, _locale = Phoenix.locale;
        var _ajaxInterceptors = {}, _intercept = function (status) {
            var ii = _ajaxInterceptors['s' + status];
            if (ii && !ii.disabled) {
                ii.handlers.forEach(function (v) {
                    v();
                });
                return true;
            }
            return false;
        }, _addAjaxInterceptor = function (status, handler) {
            var p = 's' + status;
            var a = _ajaxInterceptors[p] || {
                disabled: false,
                handlers: []
            };
            a.handlers.push(handler);
            _ajaxInterceptors[p] = a;
        }, _activateInterceptor = function (status, value) {
            var a = _ajaxInterceptors['s' + status];
            if (a)
                a.disabled = !value;
        }, _isFunction = function (obj) {
            return obj && typeof obj === 'function';
        }, _parseError = function (jqXHR) {
            var res = null;
            if (jqXHR.responseText) {
                res = { responseText: jqXHR.responseText };
            }
            if (jqXHR.responseJSON) {
                res = res || {};
                if (typeof jqXHR.responseJSON === 'object') {
                    res.json = jqXHR.responseJSON;
                }
                else {
                    try {
                        res.json = JSON.parse(jqXHR.responseJSON);
                    }
                    catch (e) {
                    }
                }
            }
            return res;
        }, _parseAjaxException = function (ex) {
            var res = { message: '', list: [] };
            if (ex && typeof ex !== 'object')
                ex = { message: ex };
            ex = ex || {};
            res.status = ex.status;
            ex.message = ex.message || _locale.errors.unknownError;
            var cmessage;
            if (ex.detail) {
                if (ex.detail.json && ex.detail.json.error) {
                    var ce = ex.detail.json.error, me = void 0;
                    if (ce.details !== undefined)
                        me = ce;
                    cmessage = ce.message;
                    if (ce.innererror && ce.innererror.message) {
                        if (ce.innererror.type === 'Json') {
                            me = JSON.parse(ce.innererror.message);
                        }
                    }
                    if (me) {
                        res.message = me.message;
                        if (me.details) {
                            me.details.forEach(function (det) {
                                res.list.push({ message: det.message, target: det.target });
                            });
                        }
                        return res;
                    }
                }
                else if (ex.detail.json && ex.detail.json.exceptionMessage) {
                    cmessage = ex.detail.json.exceptionMessage;
                }
                else
                    cmessage = ex.detail.responseText;
            }
            res.message = cmessage || ex.message;
            return res;
        }, _get = function (lurl, options, ondata) {
            if (!ondata && _isFunction(options)) {
                ondata = options;
                options = null;
            }
            var opts = {
                type: 'GET',
                url: lurl,
                dataType: 'json',
                accept: 'application/json'
            };
            var errors = null;
            if (options) {
                errors = options.$errors;
                delete options.$errors;
                Object.keys(opts).forEach(function (pn) {
                    options[pn] = opts[pn];
                });
                opts = options;
            }
            var _promise = Phoenix.utils.Promise;
            return new _promise(function (resolve, reject) {
                $.ajax(opts).done(function (data, textStatus, jqXHR) {
                    if (ondata)
                        data = ondata(data);
                    resolve(data);
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    if (options && options.ignore && options.ignore['' + jqXHR.status])
                        return resolve({});
                    if (errors && errors[jqXHR.status + '']) {
                        var errCode = jqXHR.status + '';
                        if (typeof errors[errCode] === 'string') {
                            var hnd = _customData.get(errors[errCode]);
                            if (hnd)
                                resolve(hnd());
                        }
                        else
                            return resolve(errors[errCode]);
                    }
                    if (_intercept(jqXHR.status)) {
                        return resolve({});
                    }
                    if (jqXHR.status >= 500 && _locale && _locale.errors) {
                        textStatus = _locale.errors.error500;
                        errorThrown = null;
                    }
                    var detail = _parseError(jqXHR);
                    if (detail)
                        errorThrown = null;
                    if (errorThrown) {
                        if (typeof errorThrown === 'string') {
                            errorThrown = { message: errorThrown };
                        }
                    }
                    errorThrown = errorThrown || {
                        message: textStatus,
                        detail: detail
                    };
                    errorThrown.status = jqXHR.status;
                    reject(errorThrown);
                });
            });
        }, _sendVerb = function (method, lurl, data, options) {
            var _promise = Phoenix.utils.Promise;
            var opts = {
                type: method,
                contentType: 'application/json',
                accept: 'application/json',
                url: lurl,
                data: null
            };
            if (options && options.headers) {
                opts.headers = options.headers;
            }
            if (data)
                opts.data = JSON.stringify(data);
            return new _promise(function (resolve, reject) {
                $.ajax(opts).done(function (data, textStatus, jqXHR) {
                    resolve(data);
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    if (options && options.ignore && options.ignore['' + jqXHR.status])
                        return resolve({});
                    if (_intercept(jqXHR.status)) {
                        return resolve({});
                    }
                    if (jqXHR.status >= 500 && _locale && _locale.errors) {
                        textStatus = _locale.errors.error500;
                        errorThrown = null;
                    }
                    var detail = _parseError(jqXHR);
                    if (detail)
                        errorThrown = null;
                    if (errorThrown) {
                        if (typeof errorThrown === 'string') {
                            errorThrown = { message: errorThrown };
                        }
                    }
                    errorThrown = errorThrown || {
                        message: textStatus,
                        detail: detail
                    };
                    errorThrown.status = jqXHR.status;
                    reject(errorThrown);
                });
            });
        }, _put = function (lurl, data, options) {
            return _sendVerb('PUT', lurl, data, options);
        }, _patch = function (lurl, data, options) {
            return _sendVerb('PATCH', lurl, data, options);
        }, _post = function (lurl, data, options) {
            return _sendVerb('POST', lurl, data, options);
        }, _delete = function (lurl, options) {
            return _sendVerb('DELETE', lurl, null, options);
        }, _dynscripts = {}, _getOptions = function () {
            var cfg = Phoenix.application.config(_application.name);
            var opts = { headers: null };
            if (cfg && cfg.odata && cfg.odata.headers)
                opts.headers = cfg.odata.headers;
            opts.headers = opts.headers || {};
            opts.headers.Accept = 'application/json';
            if (cfg && cfg.odata && cfg.odata.authentication) {
                var ui = _authentication.load();
                if (ui) {
                    switch (cfg.odata.authentication) {
                        case 'basic':
                            opts.headers.Authorization = ui.basic;
                            break;
                        case 'header-session':
                            opts.headers.Authorization = 'Bearer ' + ui.token;
                            break;
                    }
                }
                else {
                    delete opts.headers.Authorization;
                }
            }
            return opts;
        }, _loadScript = function (name, lurl, after, loader) {
            var status = _dynscripts[name];
            if (!status) {
                _dynscripts[name] = { loading: true };
                if (loader) {
                    loader.execute(function (err) {
                        if (err)
                            _dynscripts[name] = { error: err };
                        else
                            _dynscripts[name] = { loaded: true };
                        after(err);
                    });
                }
                else {
                    $.ajax({
                        url: lurl,
                        dataType: 'script',
                        cache: true
                    }).done(function (data, textStatus, jqXHR) {
                        _dynscripts[name] = { loaded: true };
                        after(null);
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        var err = errorThrown || { message: textStatus };
                        _dynscripts[name] = { error: err };
                        after(err);
                    });
                }
            }
            else {
                if (status.loaded) {
                    return after(null);
                }
                else if (status.error) {
                    return after(status.error, null);
                }
                else {
                    //status.loading == true
                    window.setTimeout(function () {
                        _loadScript(name, lurl, after, loader);
                    }, 20);
                }
            }
        }, _getScript = function (lurl) {
            var _promise = Phoenix.utils.Promise;
            return new _promise(function (resolve, reject) {
                $.ajax({
                    url: lurl,
                    dataType: 'script',
                    cache: true
                }).done(function (data, textStatus, jqXHR) {
                    resolve(true);
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    reject(errorThrown || {
                        message: textStatus
                    });
                });
            });
        }, _postAndDownload = function (lurl, postData) {
            var _promise = Phoenix.utils.Promise;
            var opts = _getOptions();
            var config = _application.config(_application.name) || {};
            var base = config.rest ? config.rest.base || '' : '';
            if (lurl && lurl.charAt(0) === '/')
                base = '';
            if (base)
                lurl = base + '/' + lurl;
            return new _promise(function (resolve, reject) {
                var _onerror = function (xhr) {
                    var textStatus = xhr.statusText;
                    if (_intercept(xhr.status))
                        return resolve({});
                    if (xhr.status >= 500 && _locale && _locale.errors)
                        textStatus = _locale.errors.error500;
                    var detail = null; // _parseError(xhr);
                    reject({
                        message: textStatus,
                        detail: detail
                    });
                };
                var xhr = new XMLHttpRequest();
                xhr.open('POST', lurl, true);
                xhr.responseType = 'arraybuffer';
                xhr.onload = function () {
                    if (this.status === 200 || this.status === 201) {
                        var filename = '';
                        var disposition = xhr.getResponseHeader('Content-Disposition');
                        if (disposition && disposition.indexOf('attachment') !== -1) {
                            var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                            var matches = filenameRegex.exec(disposition);
                            if (matches != null && matches[1])
                                filename = matches[1].replace(/['"]/g, '');
                        }
                        var type = xhr.getResponseHeader('Content-Type');
                        try {
                            var blob = new Blob([this.response], { type: type });
                        }
                        catch (ex) {
                            return reject(ex);
                        }
                        if (typeof window.navigator.msSaveBlob !== 'undefined') {
                            window.navigator.msSaveBlob(blob, filename);
                            resolve({});
                        }
                        else {
                            var URL = window['URL'] || window['webkitURL'];
                            var downloadUrl = URL.createObjectURL(blob);
                            if (filename) {
                                // use HTML5 a[download] attribute to specify filename
                                var a = document.createElement('a');
                                // safari doesn't support this yet
                                if (typeof a['download'] === 'undefined') {
                                    window.location.href = downloadUrl;
                                }
                                else {
                                    a.href = downloadUrl;
                                    a['download'] = filename;
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                }
                            }
                            else {
                                window.location.href = downloadUrl;
                            }
                            setTimeout(function () {
                                URL.revokeObjectURL(downloadUrl);
                                resolve({});
                            }, 100);
                        }
                    }
                    else {
                        _onerror(this);
                    }
                };
                xhr.onerror = function () {
                    _onerror(xhr);
                };
                xhr.setRequestHeader('Content-type', 'application/json');
                if (opts && opts.headers) {
                    Object.keys(opts.headers).forEach(function (hn) {
                        xhr.setRequestHeader(hn, opts.headers[hn]);
                    });
                }
                xhr.send(JSON.stringify(postData));
            });
        };
        ajax.extractAjaxErrors = _parseAjaxException;
        ajax.get = _get;
        ajax.getScript = _getScript;
        ajax.getDefaultAjaxOptions = _getOptions;
        ajax.put = _put;
        ajax.patch = _patch;
        ajax.post = _post;
        ajax.remove = _delete;
        ajax.postAndDownload = _postAndDownload;
        ajax.loadScript = _loadScript;
        ajax.interceptError = _addAjaxInterceptor;
        ajax.activateInterceptError = _activateInterceptor;
    })(ajax = Phoenix.ajax || (Phoenix.ajax = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="./ajax.ts" />
/// <reference path="./locale.ts" />
var Phoenix;
(function (Phoenix) {
    var ulocale;
    (function (ulocale) {
        var _locale = Phoenix.locale, _ajax = Phoenix.ajax, _afterTranslate = [], _register = function (hnd) { _afterTranslate.push(hnd); }, _translate = function (ll, lang) {
            $.extend(true, _locale, ll);
            _afterTranslate.forEach(function (hnd) { hnd(lang); });
        }, _tt = function (v, context) {
            context = context || {};
            if (v && v.substring(0, 2) == '{{') {
                return v.replace(/{{(.*)}}/g, function (match, path) {
                    var segments = path.split('.');
                    var c = context;
                    for (var i = 0, len = segments.length; i < len; i++) {
                        if (!c)
                            break;
                        c = c[segments[i]];
                    }
                    if (c === undefined)
                        return '[' + path + ']';
                    else
                        return c;
                });
            }
            return v;
        };
        var _supportedLanguages = ['en', 'fr'], _checkPrecision = function (val, base) {
            val = Math.round(Math.abs(val));
            return isNaN(val) ? base : val;
        }, _toFixed = function (value, precision) {
            precision = _checkPrecision(precision, 2);
            var power = Math.pow(10, precision);
            return (Math.round(value * power) / power).toFixed(precision);
        }, _formatNumber = function (number, precision, thousand, decimal) {
            if (number === null)
                return '';
            var usePrecision = _checkPrecision(precision, 0), negative = number < 0 ? '-' : '', base = parseInt(_toFixed(Math.abs(number || 0), usePrecision), 10) + '', mod = base.length > 3 ? base.length % 3 : 0;
            return negative + (mod ? base.substr(0, mod) + thousand : '') + base.substr(mod).replace(/(\d{3})(?=\d)/g, '$1' + thousand) +
                (usePrecision ? decimal + _toFixed(Math.abs(number), usePrecision).split('.')[1] : '');
        }, _formatMoney = function (number, precision, thousand, decimal, symbol, format) {
            if (number === null)
                return '';
            format = format || '%v %s';
            return format.replace('%s', symbol).replace('%v', _formatNumber(number, precision, thousand, decimal));
        }, _parseDateISO8601 = function (value) {
            if (value instanceof Date)
                return value;
            if (!value)
                return null;
            var d = Date.parse(value);
            if (isNaN(d))
                return null;
            return new Date(d);
        }, _parseISODateAsUTC = function (value) {
            if (!value)
                return 0;
            return Date.UTC(parseInt(value.substr(0, 4), 10), parseInt(value.substr(5, 2), 10) - 1, parseInt(value.substr(8, 2), 10), 0, 0, 0);
        }, 
        /**
        * @param {string} val
        * @param {number || null} len
        */
        _pad = function (val, len) {
            var sval = val + '';
            while (sval.length < len)
                sval = '0' + val;
            return sval;
        }, _formatDate = function (value, format) {
            var token = /d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g, md = value.getDate(), day = value.getDay(), month = value.getMonth(), year = value.getFullYear(), flags = {
                d: md,
                dd: _pad(md, 2),
                ddd: _locale.date.weekdaysShort[day],
                dddd: _locale.date.weekdays[day],
                m: month + 1,
                mm: _pad(month + 1, 2),
                mmm: _locale.date.monthsShort[month],
                mmmm: _locale.date.months[month],
                yy: (year + '').slice(2),
                yyyy: year
            };
            return format.replace(token, function ($0) {
                return $0 in flags ? flags[$0] : $0.slice(1, $0.length - 1);
            });
        }, 
        /**
        * Date to ISO8601
        * @param {Date} value
        */
        _date2ISO = function (value) {
            var yy = value.getFullYear(), mm = value.getMonth() + 1, dd = value.getDate();
            return _pad(yy, 4) + '-' + _pad(mm, 2) + '-' + _pad(dd, 2);
        }, _shortDate2ISO = function (value) {
            var f = _locale.date.dateShort.split('/');
            if (f.length != 3)
                return '';
            var v = value.split(_locale.date.daySep);
            var d = [0, 0, 0];
            f.forEach(function (ff, index) {
                var ii = 0;
                if (ff.charAt(0) === 'm')
                    ii = 1;
                else if (ff.charAt(0) === 'y')
                    ii = 2;
                d[ii] = parseInt(v[index], 10);
                if (ii == 2 && d[ii] < 100 && v[index].length < 3) {
                    d[ii] += Math.round(new Date().getFullYear() / 100) * 100;
                }
            });
            var sv = _pad(d[2], 4) + '-' + _pad(d[1], 2) + '-' + _pad(d[0], 2);
            var res = Date.parse(sv);
            if (isNaN(res))
                return '';
            return sv;
        }, _shortDate = function (date) {
            if (!date)
                return '';
            var d = _parseDateISO8601(date);
            if (!d)
                return '';
            var format = _locale.date.dateShort;
            if (_locale.date.daySep != '/')
                format = format.replace(/\//g, _locale.date.daySep);
            return _formatDate(d, format);
        }, _longDate = function (date) {
            if (!date)
                return '';
            var d = _parseDateISO8601(date);
            if (!d)
                return '';
            var format = _locale.date.dateLong;
            if (_locale.date.daySep != '/')
                format = format.replace(/\//g, _locale.date.daySep);
            return _formatDate(d, format);
        }, _monthYear = function (date) {
            if (!date)
                return '';
            var d = _parseDateISO8601(date);
            if (!d)
                return '';
            var format = _locale.date.monthYear;
            if (_locale.date.daySep != '/')
                format = format.replace(/\//g, _locale.date.daySep);
            return _formatDate(d, format);
        }, _truncMoney = function (value) {
            return parseFloat(value.toFixed(_locale.number.decimal));
        }, _money = function (value, useSymbol) {
            value = value || 0;
            if (useSymbol)
                return _formatMoney(value, _locale.number.places, _locale.number.thousand, _locale.number.decimal, _locale.number.symbol, _locale.number.format);
            else
                return _formatNumber(value, _locale.number.places, _locale.number.thousand, _locale.number.decimal);
        }, _decimal = function (value, decimals, symbol) {
            if (value === null)
                return '';
            value = value || 0;
            var format = symbol ? '%v %s' : '%v';
            return _formatMoney(value, decimals, _locale.number.thousand, _locale.number.decimal, symbol, format);
        }, _formatObject = function (desc, value) {
            if (!desc || !value)
                return value;
            var props = [];
            Object.keys(desc).forEach(function (pn) {
                var d = desc[pn];
                if (d.type === 'date' || d.type === 'money' || d.type === 'decimal' || d.type === 'number') {
                    props.push({
                        name: pn,
                        type: d.type,
                        symbol: d.symbol,
                        longdate: d.longdate,
                        decimals: d.decimals,
                        useSymbol: d.useSymbol === undefined ? true : d.useSymbol
                    });
                }
            });
            if (!props.length)
                return value;
            var o = Array.isArray(value) ? value : [value];
            o.forEach(function (co) {
                props.forEach(function (f) {
                    switch (f.type) {
                        case 'date':
                            co[f.name] = _shortDate(co[f.name]);
                            break;
                        case 'money':
                            co[f.name] = _money(co[f.name], f.useSymbol);
                            break;
                        case 'integer':
                            co[f.name] = _decimal(co[f.name], 0, f.symbol);
                            break;
                        case 'decimal':
                        case 'number':
                            co[f.name] = _decimal(co[f.name], f.decimals, f.symbol);
                            break;
                    }
                });
            });
            return value;
        }, _ISODatePart = function (isoDate) {
            var s = isoDate || '';
            var ii = s.indexOf('T');
            if (ii > 0)
                s = s.substr(0, ii);
            return s;
        }, _string2Float = function (value) {
            var val = value.replace(new RegExp(Phoenix.locale.number.thousand, 'g'), '');
            if (Phoenix.locale.number.decimal != '.')
                val = val.replace(new RegExp(Phoenix.locale.number.decimal, 'g'), '.');
            var res = parseFloat(val);
            if (isNaN(res))
                res = 0.0;
            return res;
        };
        ulocale.register = _register;
        ulocale.translate = _translate;
        ulocale.tt = _tt;
        ulocale.currentLang = 'en';
        ulocale.defCountry = 'US';
        ulocale.lang = 'fr'; //(navigator.language || navigator.userLanguage || currentLang).split('-')[0];
        ulocale.country = 'FR';
        ulocale.money = _money;
        ulocale.truncMoney = _truncMoney;
        ulocale.decimal = _decimal;
        ulocale.format = _formatObject;
        ulocale.parseISODate = _parseDateISO8601;
        ulocale.parseISODateAsUTC = _parseISODateAsUTC;
        ulocale.isoDatePart = _ISODatePart;
        ulocale.shortDate = _shortDate;
        ulocale.longDate = _longDate;
        ulocale.monthYear = _monthYear;
        ulocale.localeDate2ISO = _shortDate2ISO;
        ulocale.date2ISO = _date2ISO;
        ulocale.string2Float = _string2Float;
        ulocale.localeTitle = function (title) {
            if (typeof title === 'object')
                return title[ulocale.currentLang];
            return title;
        };
        function loadLocale(newLang) {
            var pp = Phoenix.utils.phoenixPath();
            if (newLang != ulocale.currentLang) {
                _ajax.getScript(pp + '/locale/phoenix_' + ulocale.lang + '.min.js').then(function () {
                    ulocale.currentLang = newLang;
                }).catch(function (ex) {
                });
            }
        }
        ulocale.loadLocale = loadLocale;
        ;
        if (_supportedLanguages.indexOf(ulocale.lang) < 0)
            ulocale.lang = ulocale.currentLang;
        loadLocale(ulocale.lang);
    })(ulocale = Phoenix.ulocale || (Phoenix.ulocale = {}));
    var angularjs;
    (function (angularjs) {
        var _registerLocaleFilters = function (app) {
            if (app && app.filter) {
                app.filter('money', [function () {
                        return function (input, useSymbol) {
                            var value = input === null ? null : (input ? parseFloat(input) : 0.0);
                            return ulocale.money(value, useSymbol);
                        };
                    }]);
                app.filter('decimal', [function () {
                        return function (input, decimals, symbol) {
                            var value = input === null ? null : (input ? parseFloat(input) : 0.0);
                            return ulocale.decimal(value, decimals || 0, symbol);
                        };
                    }]);
                app.filter('shortdate', [function () {
                        return function (input) {
                            return ulocale.shortDate(input);
                        };
                    }]);
                app.filter('longdate', [function () {
                        return function (input) {
                            return ulocale.longDate(input);
                        };
                    }]);
                app.filter('monthyear', [function () {
                        return function (input) {
                            return ulocale.monthYear(input);
                        };
                    }]);
            }
        };
        angularjs.registerFilters = _registerLocaleFilters;
    })(angularjs = Phoenix.angularjs || (Phoenix.angularjs = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../modules/ulocale.ts" />
var Phoenix;
(function (Phoenix) {
    var en = {
        "layouts": {
            "design": {
                "Save": "Save",
                "New": "New page",
                "Open": { "title": "Open page", "open": "Open", "close": "Close" },
                "PageName": "Page Name",
                "InvalidPageName": "Invalid page name",
                "ConflictedPageName": "A page of that name exists, do you want to give another name ?",
                "Delete": "Delete page",
                "ConfirmDelete": "Are you sure you want to delete this page ?",
                "Preview": "Preview",
                "AuthoringMode": "Authoring",
                "layouts": "Blocks",
                "widgets": "Widgets",
                "fields": "Fields",
                "actions": "Actions"
            },
            "NoData": 'No data'
        },
        "schema": {
            "required": "{0} is required.",
            "minNumber": "{0} must be at least {1}",
            "maxNumber": "{0} cannot exceed {1}",
            "minNumberExclusive": "{0} must be greater than {1}",
            "maxNumberExclusive": "{0} must be less than {1}",
            "uniqueColumn": "The column '{0}' must be unique.",
            "uniqueColumns": "Duplicate value for columns '{0}' found.",
            "passwordMismatch": "Password mismatch.",
            "invalidEmail": "Invalid Email Address",
            "minLength": "{0} must be at least {1} characters"
        },
        "ui": {
            "Close": "Close",
            "Ok": "Ok",
            "Yes": "Yes",
            "No": "No",
            "Warning": "Warning",
            "Info": "Information",
            "Disconnect": "Disconnect",
            "Confirm": "Confirm",
            "Validate": "Validate",
            "password": {
                "oldPassword": "Old Password",
                "newPassword": "New Password",
                "change": "Change password"
            },
            "ApplyDetailChanges": "Apply",
            "Selected": "Sel."
        },
        "errors": {
            "Title": "Oops! An unknown error has occurred.",
            "SendMail": "Send",
            "MailSubject": "Error in JS client",
            "ErrorTitle": "Error:",
            "ErrorUser": "User:",
            "ErrorDate": "Date and time:",
            "Browser": "Browser:",
            "ErrorURI": "Address:",
            "Stack": "Call stack:",
            "Context": "Context:",
            "error500": "Internal server error",
            "unknownError": "An unknown error has occurred.",
            "notAuthorized": "Forbidden"
        },
        "listView": {
            "search": {
                "Search": "Search",
                "Nodata": "Aucun résultat trouvé ..."
            }
        },
        "pagination": {
            "Next": "»",
            "Previous": "«",
            "First": "First",
            "Last": "Last"
        },
        "number": {
            "decimal": ".",
            "thousand": " ",
            "places": 2,
            "symbol": "$",
            "format": "%s %v"
        },
        "charts": {
            "numericSymbols": ["k", "M", "G", "T", "P", "E"],
            "resetZoom": "Reset zoom",
            "resetZoomTitle": "Reset zoom level 1:1",
            "rangeSelectorZoom": "Zoom",
            "rangeSelectorFrom": "From",
            "rangeSelectorTo": "To"
        },
        "date": {
            "weekdaysShort": ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
            "weekdaysMin": ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"],
            "weekdays": ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
            "monthsShort": ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
            "months": ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
            "dateShort": "mm/dd/yyyy",
            "dateLong": "d mmmm, yyyy",
            "monthYear": "mmmm yyyy",
            "daySep": "-",
            "weekStart": 0,
            "today": "Today",
            "clear": "Clear"
        }
    };
    Phoenix.ulocale.translate(en, "en");
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../typings/index.d.ts" />
var Phoenix;
(function (Phoenix) {
    Phoenix.bootstrap4 = false;
    var dom;
    (function (dom) {
        var _mapIcon = {
            'times-circle': 'remove-sign',
            'times-circle-o': 'remove-circle',
            'times': 'remove',
            'chevron-left': 'chevron-left',
            'chevron-right': 'chevron-right',
            'arrow-left': 'arrow-left',
            "arrow-right": 'arrow-right',
            'backward': 'backward',
            'forward': 'forward',
            'file-o': 'file',
            'floppy': 'floppy-save',
            'power-off': 'off',
            'user': 'user',
            'pencil': 'pencil',
            'trash': 'trash',
            'check-square-o': 'check',
            'square-o': 'unchecked',
            'plus-circle': 'plus-sign',
            'minus-circle': 'minus-sign',
            'plus': 'plus',
            'minus': 'minus',
            'search': 'search',
            'chevron-down': 'menu-down',
            'ellipsis-v': 'option-vertical',
            'bars': 'menu-hamburger',
            'thumb-tack': 'pushpin',
            'calendar': 'calendar',
            'exclamation-circle': 'exclamation-sign',
            'cloud': 'cloud',
            'caret-up': 'triangle-top',
            'caret-down': 'triangle-bottom',
            'cog': 'cog',
            'lock': 'lock',
            'question-circle': 'question-sign',
            'info-circle': 'info-sign'
        };
        var _bootstrapBtns = {
            primary: 'primary',
            secondary: Phoenix.bootstrap4 ? 'secondary' : 'default',
            default: Phoenix.bootstrap4 ? 'secondary' : 'default',
            important: 'important',
            success: 'success',
            info: 'info',
            danger: 'danger',
            warning: 'warning',
            link: 'link'
        };
        var _parseStyle = function (style, css) {
            if (style) {
                var a = style.split(' ');
                a.forEach(function (e, index) {
                    e = e.trim();
                    if (e && (e.charAt(0) === '$'))
                        e = 'bs-style-' + e.substring(1);
                    css.push(e);
                });
            }
        }, _select = function (input) {
            if (!input)
                return;
            input.select();
        }, _addRmvClasses = function (v, add, cn) {
            var c = (v || '').split(' ');
            var i = c.indexOf(cn);
            if (add) {
                if (i < 0)
                    c.push(cn);
            }
            else {
                if (i >= 0)
                    c.splice(i, 1);
            }
            return c.join(' ');
        }, _iconClass = function (iconName, noPrefix) {
            if (noPrefix === void 0) { noPrefix = false; }
            var icon = Phoenix.bootstrap4 ? iconName : (_mapIcon[iconName] ? _mapIcon[iconName] : iconName);
            if (noPrefix)
                return (Phoenix.bootstrap4 ? 'fa-' : 'glyphicon-') + icon;
            else
                return (Phoenix.bootstrap4 ? 'fa fa-' : 'glyphicon glyphicon-') + icon;
        }, _customIconClass = function (iconName, iconClass) {
            if (iconClass)
                return iconClass + ' ' + iconClass + '-' + iconName;
            else
                return _iconClass(iconName);
        }, _iconPrefix = function () { return (Phoenix.bootstrap4 ? 'fa' : 'glyphicon'); }, _createIcon = function (iconName) {
            var icon = document.createElement('span');
            icon.className = _iconClass(iconName, false);
            return icon;
        }, _queryAll = function (parent, selector) {
            if (parent)
                return parent.querySelectorAll(selector);
            return document.querySelectorAll(selector);
        }, _find = function (parent, id) {
            if (parent) {
                if (parent.id == id)
                    return parent;
                return parent.querySelector('#' + id);
            }
            return document.getElementById(id);
        }, _query = function (parent, selector) {
            if (parent) {
                return parent.querySelector(selector);
            }
            return null;
        }, _addClass = function (element, className) {
            if (element.classList)
                element.classList.add(className);
            else
                element.className = _addRmvClasses(element.className, true, className);
        }, _removeClass = function removeClass(element, className) {
            if (element.classList)
                element.classList.remove(className);
            else
                element.className = _addRmvClasses(element.className, false, className);
        }, _hasClass = function (element, className) {
            if (element.classList)
                return element.classList.contains(className);
            else
                return (element.className || '').split(' ').indexOf(className) >= 0;
        }, _remove = function (element) {
            element.parentNode.removeChild(element);
        }, _detach = function (element) {
            element.parentNode.removeChild(element);
            return element;
        }, _empty = function (element) {
            for (var i = element.childNodes.length - 1; i >= 0; i--)
                element.removeChild(element.childNodes[i]);
        }, _append = function (parent, element) {
            parent.appendChild(element);
        }, _before = function (child, element) {
            child.parentNode.insertBefore(element, child);
        }, _documentScroll = function () {
            return {
                left: (document.documentElement.scrollLeft || document.body.scrollLeft),
                top: (document.documentElement.scrollTop || document.body.scrollTop)
            };
        }, _documentClientDim = function () {
            return {
                width: (document.documentElement.clientWidth || document.body.clientWidth),
                height: (document.documentElement.clientHeight || document.body.clientHeight)
            };
        }, _addScrolls = function (d) {
            var clientTop = document.documentElement.clientTop || document.body.clientTop || 0, clientLeft = document.documentElement.clientLeft || document.body.clientLeft || 0, scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop, scrollLeft = window.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft;
            d.top = Math.round(d.top + scrollTop - clientTop);
            d.left = Math.round(d.left + scrollLeft - clientLeft);
            return d;
        }, _position = function (element, parent) {
            if (parent) {
                var parentRect = parent.getBoundingClientRect();
                var elementRect = element.getBoundingClientRect();
                return {
                    left: Math.round(elementRect.left - parentRect.left),
                    top: Math.round(elementRect.top - parentRect.top)
                };
            }
            else {
                var elementRect = element.getBoundingClientRect();
                return _addScrolls({ left: elementRect.left, top: elementRect.top });
            }
        }, _childsPos = function (parent, list, vertical, zone, options) {
            var let = 0, element = parent;
            var res = new Array(list.length + 1);
            var firstDelta = options.firstDelta || 0;
            var lastDelta = options.lastDelta || 0;
            var delta = options.delta || 0;
            var height = options.height || 0;
            var top = options.top || 0;
            list.forEach(function (child, index) {
                var chtml = _find(parent, child.htmlId);
                var p = _position(chtml, null);
                res[index] = {
                    info: child.info,
                    zone: zone,
                    position: 'before',
                    vertical: vertical,
                    point: { x: 0, y: 0 },
                    left: p.left + (vertical ? 0 : (index === 0 ? firstDelta : delta)), top: top || p.top,
                    width: Math.round(chtml.offsetWidth),
                    height: Math.round(chtml.offsetHeight),
                    htmlId: child.htmlId
                };
            });
            var last = null;
            res.forEach(function (c) {
                var p = c.point;
                p.y = c.top + (c.height >> 1);
                p.x = c.left + (c.width >> 1);
                last = c;
            });
            if (last) {
                var cd = lastDelta - (res.length === 0 ? firstDelta : delta);
                last = {
                    position: 'after',
                    zone: zone,
                    info: last.info,
                    vertical: last.vertical,
                    point: { x: 0, y: 0 },
                    left: last.left + (vertical ? 0 : cd) + (vertical ? 0 : last.width),
                    top: last.top + (vertical ? last.height : 0),
                    width: (last.vertical ? last.width : 0),
                    height: height || (last.vertical ? 0 : last.height),
                    htmlId: last.htmlId
                };
            }
            else {
                var pp = _position(parent, null);
                last = {
                    info: {},
                    position: 'empty',
                    zone: zone,
                    vertical: vertical,
                    point: { x: 0, y: 0 },
                    left: pp.left + (vertical ? 0 : lastDelta),
                    top: top || pp.top,
                    width: Math.round(parent.offsetWidth),
                    height: height || Math.round(parent.offsetHeight),
                    html: parent.id
                };
            }
            last.point.y = last.top + (last.height >> 1);
            last.point.x = last.left + (last.width >> 1);
            res[list.length] = last;
            return res;
        }, _findNearest = function (x, y, elements) {
            var best, deltax, delta = 1000000;
            elements.forEach(function (c) {
                var ctl, ctd = Math.abs(c.point.y - y);
                if (ctd < delta) {
                    delta = ctd;
                    deltax = Math.abs(c.point.x - x);
                    best = c;
                }
                else if (ctd == delta) {
                    ctl = Math.abs(c.point.x - x);
                    if (ctl < deltax) {
                        deltax = ctl;
                        best = c;
                    }
                }
            });
            return best;
        }, _text = function (node, text) {
            if (text === undefined)
                return node.textContent;
            if (node.childNodes.length) {
                var found = false;
                for (var i = 0, len = node.childNodes.length; i < len; i++) {
                    var n = node.childNodes[i];
                    if (n.nodeType == 3) {
                        n.nodeValue = text;
                        found = true;
                        break;
                    }
                }
                if (!found)
                    _append(node, document.createTextNode(text));
            }
            else {
                node.textContent = text;
            }
        }, _showMove = function (res, vertical, pos, cssClass) {
            cssClass = cssClass || 'bs-drag-color-info';
            if (res) {
                if (res['vertical'] !== vertical) {
                    _remove(res);
                    res = null;
                }
                else {
                    var fe = res.firstChild.firstChild;
                    if (!_hasClass(fe, cssClass)) {
                        _remove(res);
                        res = null;
                    }
                }
            }
            if (!res) {
                var html = ['<div class="bs-absolute">'];
                html.push('<div class="bs-absolute" style="left: 0px; top: 0px"><span class="');
                if (vertical) {
                    html.push(_iconClass('arrow-left'));
                }
                else {
                    html.push(_iconClass('arrow-down'));
                }
                if (cssClass)
                    html.push(' ' + cssClass);
                html.push('"></span></div>');
                var css = [];
                html.push('<div class="bs-absolute" style="');
                if (vertical) {
                    css.push('right: 0px;');
                    css.push('bottom: 0px;');
                    html.push(css.join(''));
                    html.push('"><span class="');
                    html.push(_iconClass('arrow-right'));
                }
                else {
                    css.push('left: 0px;');
                    css.push('bottom: 0px;');
                    html.push(css.join(''));
                    html.push('"><span class="');
                    html.push(_iconClass('arrow-up'));
                }
                if (cssClass)
                    html.push(' ' + cssClass);
                html.push('"></span></div>');
                html.push('</div>');
                res = $(html.join('')).get(0);
                res['vertical'] = vertical;
                _append(document.body, res);
            }
            var style = res.style;
            var fc = res.firstElementChild;
            var lc = res.lastElementChild;
            var ww = Math.round(fc.offsetWidth), hh = Math.round(lc.offsetHeight);
            if (vertical) {
                style.height = hh + 'px';
                style.width = pos.width + 2 * ww + 'px';
                style.left = pos.left - ww + 'px';
                style.top = pos.top - (hh >> 2) - 4 + 'px';
            }
            else {
                style.height = pos.height + 2 * hh + 'px';
                style.top = pos.top - hh + 'px';
                style.left = pos.left - (ww >> 2) + 'px';
            }
            style.zIndex = '5002';
            return res;
        }, _elemByAttribute = function (el, root, attr) {
            var t = el;
            while (t) {
                if (!t.getAttribute)
                    return null;
                var val = t.getAttribute(attr);
                if (val)
                    return t;
                t = (t == root) ? null : t.parentNode;
            }
            return null;
        }, _setBodyTheme = function (value) {
            var fc = document.body.firstElementChild;
            if (!fc || !_hasClass(fc, 'bs-content'))
                fc = document.body;
            var old = fc.className || '';
            var nc = value ? ('bs-body-theme-' + value) : '';
            var classes = old.split(' ');
            var changed = false;
            var i = classes.length;
            while (i--) {
                var c = classes[i];
                if (c.indexOf('bs-body-theme-') == 0) {
                    if (c == nc)
                        return false;
                    changed = true;
                    classes.splice(i, 1);
                }
            }
            if (nc) {
                changed = true;
                classes.push(nc);
            }
            if (changed)
                fc.className = classes.join(' ');
        }, _after = function (child, element) {
            var p = child.parentNode;
            child = child.nextSibling;
            if (child)
                p.insertBefore(element, child);
            else
                p.appendChild(element);
        }, _getWindow = function (elem) {
            return (elem != null && elem === elem.window) ? elem : elem.nodeType === 9 && elem.defaultView;
        }, _offset = function (element) {
            var rect;
            if (element.nodeType != 3) {
                rect = element.getBoundingClientRect();
                // Make sure element is not hidden (display: none)
                if (rect.width || rect.height) {
                    var doc = element.ownerDocument;
                    var win = _getWindow(doc);
                    var docElem = doc.documentElement;
                    return {
                        top: rect.top + win.pageYOffset - docElem.clientTop,
                        left: rect.left + win.pageXOffset - docElem.clientLeft,
                        width: rect.width,
                        height: rect.height,
                        bottom: 0,
                        right: 0
                    };
                }
            }
            return rect || { top: 0, left: 0, width: 0, height: 0, bottom: 0, right: 0 };
        }, _parentByTag = function (root, element, tag) {
            tag = tag.toUpperCase();
            while (element) {
                if (element.tagName === tag)
                    return element;
                element = element.parentNode;
                if (element == root)
                    break;
            }
            return null;
        }, _parentByCssClass = function (root, element, className) {
            while (element) {
                if (_hasClass(element, className))
                    return element;
                element = element.parentNode;
                if (element == root)
                    break;
            }
            return null;
        }, _indexOf = function (parent, child) {
            for (var i = 0, len = parent.childNodes.length; i < len; i++) {
                if (parent.childNodes[i] == child)
                    return i;
            }
            return -1;
        }, _isChildOf = function (parent, child) {
            while (child) {
                if (child === parent)
                    return true;
                child = child.parentNode;
            }
            return false;
        }, _attr = function (element, attr, value) {
            if (value === void 0) { value = undefined; }
            if (value === undefined) {
                return element.getAttribute(attr);
            }
            else {
                element.setAttribute(attr, value);
            }
        }, _scrollbarWidth = function () {
            var calculated = false;
            var cw = 0;
            return function () {
                if (calculated)
                    return cw;
                var b, a = document.createElement('div');
                a.style.cssText = 'overflow:scroll; overflow-x:hidden; zoom:1; clear:both';
                a.innerHTML = '&nbsp;';
                document.body.appendChild(a);
                b = a.offsetWidth - a.scrollWidth;
                document.body.removeChild(a);
                calculated = true;
                cw = b;
                return b;
            };
        }, _cover = null, _coverRefCount = 0, _inProcessing = function () {
            return _cover != null;
        }, _processing = function (value) {
            if (value) {
                _coverRefCount++;
                if (!_cover) {
                    _coverRefCount = 1;
                    _cover = $('<div class="bs-cover"></div>').get(0);
                    _cover.style.height = ($(document).height() - 1) + 'px';
                    _append(document.body, _cover);
                }
            }
            else {
                _coverRefCount--;
                if (_coverRefCount <= 0)
                    _coverRefCount = 0;
                if (_cover) {
                    if (_coverRefCount === 0) {
                        _remove(_cover);
                        _cover = null;
                    }
                }
            }
        }, _touch = function () {
            var calculated = false, touch = false;
            return function () {
                if (calculated)
                    return touch;
                touch = 'ontouchend' in document;
                calculated = true;
                return touch;
            };
        }, _emitResize = function () {
            $(window).trigger('global-phoenix-resize');
        }, _resizeTimeOut = null, _setResizeHnd = function () {
            $(window).on('resize.phoenix', function () {
                if (_resizeTimeOut)
                    clearTimeout(_resizeTimeOut);
                _resizeTimeOut = setTimeout(_emitResize, 50);
            });
        };
        dom.readyHandlers = [_setResizeHnd];
        dom.keys = {
            VK_TAB: 9, VK_UP: 38, VK_DOWN: 40, VK_INSERT: 45, VK_DELETE: 46, VK_LEFT: 37, VK_RIGHT: 39,
            VK_ENTER: 13, VK_ESCAPE: 27, VK_F1: 112, VK_HOME: 36, VK_END: 35, VK_PGUP: 33, VK_PGDOWN: 34,
            VK_SPACE: 32, VK_F2: 113, VK_F3: 114, VK_F4: 115, VK_BACKSPACE: 8, VK_F10: 121
        };
        dom.queryAll = _queryAll;
        dom.find = _find;
        dom.query = _query;
        dom.addClass = _addClass;
        dom.removeClass = _removeClass;
        dom.hasClass = _hasClass;
        dom.icon = _createIcon;
        dom.iconClass = _iconClass;
        dom.customIconClass = _customIconClass;
        dom.iconPrefix = _iconPrefix;
        dom.bodyTheme = _setBodyTheme;
        dom.offset = _offset;
        dom.before = _before;
        dom.after = _after;
        dom.parentByTag = _parentByTag;
        dom.parentByClass = _parentByCssClass;
        dom.indexOf = _indexOf;
        dom.append = _append;
        dom.select = _select;
        dom.empty = _empty;
        dom.remove = _remove;
        dom.detach = _detach;
        dom.attr = _attr;
        dom.text = _text;
        dom.findByAttribute = _elemByAttribute;
        dom.isChildOf = _isChildOf;
        dom.parseStyle = _parseStyle;
        dom.ignoreKeys = [0, dom.keys.VK_UP, dom.keys.VK_DOWN, dom.keys.VK_HOME, dom.keys.VK_END, dom.keys.VK_PGUP, dom.keys.VK_PGDOWN, dom.keys.VK_ENTER, dom.keys.VK_ESCAPE,
            dom.keys.VK_DELETE, dom.keys.VK_BACKSPACE, dom.keys.VK_INSERT];
        dom.processing = _processing;
        dom.inProcessing = _inProcessing;
        dom.scrollbar = _scrollbarWidth();
        dom.documentScroll = _documentScroll;
        dom.documentClientDim = _documentClientDim;
        dom.touch = _touch();
        dom.position = _position;
        dom.childrenPositions = _childsPos;
        dom.findNearest = _findNearest;
        dom.showMove = _showMove;
        dom.bootstrapStyles = _bootstrapBtns;
    })(dom = Phoenix.dom || (Phoenix.dom = {}));
    $(document).ready(function () {
        if (dom.readyHandlers.length) {
            dom.readyHandlers.forEach(function (hnd) {
                hnd();
            });
        }
    });
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../typings/index.d.ts" />
/// <reference path="./utils.ts" />
/// <reference path="./dom.ts" />
/// <reference path="./globals.ts" />
/// <reference path="./authentication.ts" />
var Phoenix;
(function (Phoenix) {
    var _utils = Phoenix.utils, _dom = Phoenix.dom, _device = Phoenix.device, _authentication = Phoenix.authentication;
    var link;
    (function (link) {
        var _obj2Search = function (value) {
            if (!value)
                return '';
            var a = [];
            Object.keys(value).forEach(function (name) {
                if (value[name] === null)
                    return;
                a.push(name + '=' + encodeURIComponent(value[name] || ''));
            });
            if (a.length > 0)
                return '?' + a.join('&');
            return '';
        }, _parseUrl = function (value) {
            var search = {};
            var path = value;
            var i = value.indexOf('?');
            if (i >= 0) {
                var s = value.substring(i + 1);
                path = value.substring(0, i);
                if (s) {
                    var a = s.split('&');
                    a.forEach(function (v) {
                        if (v) {
                            var h = v.split('=');
                            search[decodeURIComponent(h[0])] = decodeURIComponent(h[1]);
                        }
                    });
                }
            }
            return {
                path: path,
                search: search
            };
        }, _urlSearch = function (value, replace) {
            if (value == null) {
                return _parseUrl(window.location.href).search;
            }
            else {
                var searchString = _obj2Search(value);
                if (!window.location.hash) {
                    if (window.location.search != searchString)
                        window.location.search = searchString;
                }
                else {
                    var ch = window.location.hash;
                    var ii = ch.indexOf('?');
                    if (ii > 0) {
                        ch = ch.substring(0, ii);
                        ch = ch + searchString;
                    }
                    if (replace) {
                        Phoenix.history.replaceHash(ch);
                    }
                    else {
                        if (window.location.hash != ch) {
                            if (window.history) {
                                try {
                                    window.history.replaceState(undefined, undefined, ch);
                                }
                                catch (ex) {
                                    window.location.hash = ch;
                                }
                            }
                        }
                    }
                }
            }
        }, _extractPage = function (cfg) {
            var page = cfg.$page;
            if (_device.phone && cfg.$pageMobile)
                page = cfg.$pageMobile;
            else if (_device.tablet && cfg.$pageTablet)
                page = cfg.$pageTablet;
            return page;
        }, _context = function (opts) {
            var usr = null;
            try {
                usr = JSON.parse(_authentication.db().getItem('authentication'));
            }
            catch (e) {
            }
            var ctx = {
                $url: _urlSearch(null, false),
                $mem: Phoenix.$mem,
                $user: {
                    name: usr ? usr.name || usr.nom || usr.login : '',
                    firstName: usr ? usr.firstName || usr.prenom || usr.login : '',
                    lastName: usr ? usr.lastName || usr.nom || '' : ''
                },
                $item: null,
                $cookie: null
            };
            if (opts && opts.cookie) {
                ctx.$cookie = {};
                var allCookies = document.cookie || '';
                allCookies.split(';').forEach(function (cookie) {
                    var name_value = cookie.split("=");
                    name_value[0] = name_value[0].replace(/^ /, '');
                    ctx.$cookie[decodeURIComponent(name_value[0])] = decodeURIComponent(name_value[1]);
                });
            }
            return ctx;
        }, _hashLink = function (cfg, data, params) {
            if (cfg.$page) {
                var page = _extractPage(cfg);
                var res = '#/' + page;
                var a = [];
                if (data && cfg.$search && cfg.$search.length) {
                    var dd = _context();
                    Object.keys(data).forEach(function (pn) {
                        dd[pn] = data[pn];
                    });
                    cfg.$search.forEach(function (v) {
                        if (v && v.left)
                            a.push(v.left + '=' + encodeURIComponent(_utils.parseVariable(v.right, dd)));
                    });
                }
                if (params) {
                    Object.keys(params).forEach(function (pn) {
                        a.push(pn + '=' + encodeURIComponent(params[pn]));
                    });
                }
                if (a.length)
                    res = res + '?' + a.join('&');
                return res;
            }
            return '#';
        }, _customProtocols = {}, _isCustomLink = function (href) {
            var i = href.indexOf('://');
            if (i > 0) {
                var p = _customProtocols[href.substring(0, i)];
                if (p)
                    return p.protocol;
            }
            return null;
        }, _execCustomLink = function (clink, context, config, params) {
            var p = _customProtocols[clink.protocol];
            if (p && p.handler)
                p.handler(clink.value, context, config, params);
        }, _registerCustomLink = function (protocol, handler) {
            _customProtocols[protocol] = {
                protocol: protocol,
                handler: handler
            };
        }, _getLink = function (e, event, dontStopPropagation) {
            var target = event.target;
            while (target && target != e) {
                var href = _dom.attr(target, 'data-phoenix-href') || _dom.attr(target, 'href');
                if (href) {
                    if (href === '#') {
                        if (!dontStopPropagation) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        break;
                    }
                    var customLink = _isCustomLink(href);
                    if (customLink) {
                        if (!dontStopPropagation) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        return {
                            protocol: customLink,
                            value: href
                        };
                    }
                }
                target = target.parentNode;
            }
            return null;
        }, _navigateToModule = function (newhash, newModule, oldModule, replace) {
            var lpath = location.pathname;
            var lhref;
            var segments = lpath.split('/');
            var addAfter = '';
            if (segments[segments.length - 1].indexOf('.html') > 0)
                addAfter = segments.pop();
            var ls = segments.pop();
            if (!addAfter && ls == '')
                segments.pop();
            segments.push(newModule);
            if (addAfter)
                segments.push(addAfter);
            lhref = segments.join('/');
            if (!newhash || ('' + newhash).charAt(0) !== '#')
                newhash = '#' + newhash;
            lhref += newhash;
            if (replace)
                location.replace(lhref);
            else
                location.href = lhref;
        }, _setHash = function (newhash, replace) {
            if (!newhash || ('' + newhash).charAt(0) !== '#')
                newhash = '#' + newhash;
            if (window.location.hash == newhash)
                return;
            if (Phoenix.external.hashHandler) {
                Phoenix.external.hashHandler(newhash, replace);
            }
            else {
                Phoenix.history.removeLast();
                if (replace && 'replaceState' in window.history) {
                    window.history.replaceState(undefined, undefined, newhash);
                }
                else {
                    location.hash = newhash;
                }
            }
        }, _doFormAuthoring = function (params) {
            if (!params.name)
                return;
            if (!params.schema)
                return;
            var ch = '/authoring/forms/' + params.name;
            var search = [];
            if (params.schema !== params.name)
                search.push('prototype=' + encodeURIComponent(params.schema));
            if (params.locale)
                search.push('locale=' + encodeURIComponent(params.locale));
            if (params.path)
                search.push('path=' + encodeURIComponent(params.path));
            var ii = window.location.href.lastIndexOf('?');
            if (ii > 0)
                search.push(window.location.href.substr(ii + 1));
            if (search.length)
                ch = ch + '?' + search.join('&');
            window.location.hash = '#' + ch;
        }, _doAuthoring = function (pageName, force) {
            var auth = '/authoring';
            var authform = '/authoring/forms/';
            var ch = window.location.hash;
            if (ch.charAt(0) == '#')
                ch = ch.substring(1);
            if (!force && ch.indexOf(auth) === 0) {
                if (ch.indexOf(authform) === 0)
                    window.history.back();
                else
                    window.location.hash = '#' + ch.substring(auth.length);
            }
            else {
                window.location.hash = '#' + auth + (pageName ? ('/' + pageName) : ch);
            }
        }, _execLink = function (clink, context, params) {
            var _application = Phoenix.application;
            var modules = _application.configuration && _application.configuration.application ?
                _application.configuration.application.modules : null;
            if (clink.$page) {
                var module = clink.$module ? clink.$module : _application.name;
                if (modules && modules[module] && _application.licences) {
                    var mlicence = _application.licences[modules[module]];
                    if (mlicence && !mlicence.hasLicence) {
                        if (Phoenix.external.forbiddenHandler)
                            return Phoenix.external.forbiddenHandler();
                    }
                }
                var hash = _hashLink(clink, context, params);
                if (clink.$module) {
                    if (clink.$module !== _application.name)
                        return _navigateToModule(hash, clink.$module, _application.name, clink.$replace);
                }
                _setHash(hash, clink.$replace);
                if (clink.$authoring)
                    _doAuthoring();
            }
            else if (clink.$logout) {
                if (Phoenix.external.logoutHandler)
                    Phoenix.external.logoutHandler();
            }
            else if (clink.$formAuthoring) {
                _doFormAuthoring(clink);
            }
            else if (clink.$authoring) {
                _doAuthoring();
            }
            else if (clink.$back) {
                window.history.back();
            }
            else if (clink.href) {
                var a = document.createElement('a');
                a.href = clink.href;
                if (clink.target)
                    a.target = clink.target;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        };
        link.search = _urlSearch;
        link.object2search = _obj2Search;
        link.parseUrl = _parseUrl;
        link.hashLink = _hashLink;
        link.pageName = _extractPage;
        link.isCustomLink = _getLink;
        link.registerCustomProtocol = _registerCustomLink;
        link.execCustomProtocol = _execCustomLink;
        link.isCustomProtocol = _isCustomLink;
        link.doAuthoring = _doAuthoring;
        link.doFormAuthoring = _doFormAuthoring;
        link.setHash = _setHash;
        link.execLink = _execLink;
        link.context = _context;
    })(link = Phoenix.link || (Phoenix.link = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="./core.ts" />
/// <reference path="./modules/utils.ts" />
/// <reference path="./modules/links.ts" />
/// <reference path="./modules/globals.ts" />
var Phoenix;
(function (Phoenix) {
    var _link = Phoenix.link;
    var _mem = Phoenix.$mem;
    var _utils = Phoenix.utils;
    _link.registerCustomProtocol("page", function (value, context, config, params) {
        if (!context.$url)
            context.$url = _link.search(null, false);
        if (!context.$mem)
            context.$mem = _mem;
        var i = value.indexOf("://");
        if (i <= 0)
            return;
        var s = value.substring(i + 3), l = _link.parseUrl(s), a = l.path.split('/'), replace;
        if (l.search.$replace) {
            replace = true;
            delete l.search.$replace;
        }
        var cfg = {
            $page: a[0],
            $search: [],
            $replace: replace,
            $menu: null
        };
        if (a.length > 1)
            cfg.$menu = a[1];
        Object.keys(l.search).forEach(function (pn) {
            cfg.$search.push({
                left: pn,
                right: l.search[pn]
            });
        });
        _link.execLink(cfg, context, null);
    });
    _link.registerCustomProtocol("link", function (value, context, config, params) {
        var ln = value.substring(('link://').length);
        var ii = ln.indexOf('/');
        if (ii <= 0)
            ii = ln.indexOf('?');
        if (ii > 0) {
            var u = _link.parseUrl(ln.substring(ii));
            ln = ln.substring(0, ii);
            if (u.search) {
                if (params)
                    _utils.extend(params, u.search);
                else
                    params = u.search;
            }
        }
        if (config.links && config.links[ln]) {
            _link.execLink(config.links[ln], context, params);
        }
    });
    _link.registerCustomProtocol("click", null);
})(Phoenix || (Phoenix = {}));
/// <reference path="../core/core.ts" />
/// <reference path="../core/modules/application.ts" />
/// <reference path="../core/modules/ajax.ts" />
/// <reference path="../core/modules/locale.ts" />
/// <reference path="../core/modules/ulocale.ts" />
var Phoenix;
(function (Phoenix) {
    var data;
    (function (data) {
        var _application = Phoenix.application;
        var _ulocale = Phoenix.ulocale;
        var _menuProvider = {
            get: function (menu, localization, appName) {
                if (localization && _ulocale.lang) {
                    menu = menu + '_' + _ulocale.lang;
                }
                var config = _application.config(appName);
                if (!config)
                    throw "Application configuration not found.";
                return Phoenix.ajax.get(config.menus + '/' + menu + '.json', { cache: true }, null);
            }
        };
        data.menu = _menuProvider;
    })(data = Phoenix.data || (Phoenix.data = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../core/core.ts" />
/// <reference path="../core/modules/application.ts" />
/// <reference path="../core/modules/ajax.ts" />
var Phoenix;
(function (Phoenix) {
    var data;
    (function (data_1) {
        var _application = Phoenix.application;
        var _ulocale = Phoenix.ulocale;
        var _widgetSchema = {
            get: function (schema, localization, appName) {
                if (localization && _ulocale.lang) {
                    schema = schema + '_' + Phoenix.ulocale.lang;
                }
                var config = _application.config(appName);
                if (!config)
                    throw "Application configuration not found.";
                return Phoenix.ajax.get(config.locales + '/' + schema + '.json', { cache: true }, function (data) {
                    if (data)
                        data.$name = schema;
                    if (data.$view)
                        data.$view.$name = schema;
                    return data;
                });
            }
        };
        data_1.schema = _widgetSchema;
    })(data = Phoenix.data || (Phoenix.data = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../core/modules/application.ts" />
/// <reference path="../core/modules/ajax.ts" />
var Phoenix;
(function (Phoenix) {
    var data;
    (function (data) {
        var _application = Phoenix.application, _ajax = Phoenix.ajax, _utils = Phoenix.utils, _execPath = function (path, ldata) {
            if (!path)
                return null;
            if (path === '.')
                return ldata;
            var a = path.split('.'), cd = ldata;
            for (var i = 0, len = a.length; i < len; i++) {
                if (!cd)
                    return null;
                cd = cd[a[i]];
            }
            return cd;
        }, _addTenantId = function (lurl) {
            return lurl;
        }, _rest = {
            getRessources: function (params, ondata) {
                var _after = function (cd) {
                    if (ondata)
                        cd = ondata(cd);
                    return cd;
                };
                var lurl = params.$url;
                var config = _application.config(_application.name) || {};
                config.rest = config.rest || {};
                var base = config.rest.base || '';
                if (lurl && lurl.charAt(0) === '/')
                    base = '';
                if (base)
                    lurl = base + '/' + lurl;
                var cfg = {};
                if (params.$module === undefined && config.rest.$module)
                    params.$module = config.rest.$module;
                if (!params.$module)
                    lurl = lurl.replace('\{\$module\}/', '');
                else
                    cfg.$module = params.$module;
                if (!config.rest.$context)
                    lurl = lurl.replace('\{\$context\}/', '');
                else
                    cfg.$context = config.rest.$context;
                lurl = _utils.formatNames(lurl, cfg);
                var opts = _ajax.getDefaultAjaxOptions();
                var query = params.$query;
                var listprop = params.$list;
                lurl = lurl + Phoenix.link.object2search(query);
                lurl = _addTenantId(lurl);
                switch (params.$method) {
                    case 'POST':
                        return _ajax.post(lurl, params.$data, opts);
                    case 'PUT':
                        return _ajax.put(lurl, params.$data, opts);
                    case 'PATCH':
                        return _ajax.patch(lurl, params.$data, opts);
                    case 'DELETE':
                        return _ajax.remove(lurl, opts);
                    default:
                        return _ajax.get(lurl, opts, function (ldata) {
                            return _after(ldata);
                        });
                }
            }
        };
        data.rest = _rest;
    })(data = Phoenix.data || (Phoenix.data = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../core/core.ts" />
/// <reference path="../core/modules/ajax.ts" />
/// <reference path="../core/modules/links.ts" />
/// <reference path="../core/modules/application.ts" />
var Phoenix;
(function (Phoenix) {
    var data;
    (function (data) {
        var _application = Phoenix.application, _link = Phoenix.link, _local = {
            getRessources: function (params, ondata) {
                var _after = function (cd) {
                    if (ondata)
                        cd = ondata(cd);
                    return cd;
                };
                var config = _application.config(_application.name);
                if (!config)
                    throw "Application configuration not found.";
                var lurl = config.localData + '/' + params.$url;
                var query = params.$query;
                lurl = lurl + _link.object2search(query);
                return Phoenix.ajax.get(lurl, {}, function (ldata) {
                    return _after(ldata);
                });
            }
        };
        data.local = _local;
    })(data = Phoenix.data || (Phoenix.data = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../core/modules/application.ts" />
/// <reference path="../core/modules/ajax.ts" />
/// <reference path="../core/modules/locale.ts" />
/// <reference path="../core/modules/authentication.ts" />
/// <reference path="../core/modules/utils.ts" />
var Phoenix;
(function (Phoenix) {
    var data;
    (function (data_2) {
        var _application = Phoenix.application, _authentication = Phoenix.authentication, _utils = Phoenix.utils, _ajax = Phoenix.ajax, _odatacache = {}, _addTenantId = function (lurl) {
            return lurl;
        }, _odata = {
            v4: true,
            transport: {
                doPost: _ajax.post,
                doPut: _ajax.put,
                doDelete: _ajax.remove,
                doGet: function (lurl, options, ondata, params) {
                    return _ajax.get(lurl, options, ondata);
                },
                doPatch: _ajax.patch
            },
            afterLogout: function () {
                //clear cache
                _odatacache = {};
            },
            addImageUrlToken: function (url) {
                var cfg = _application.config(_application.name) || {};
                cfg.odata = cfg.odata || {};
                if (cfg && cfg.odata && cfg.odata.authentication) {
                    var ui = _authentication.load();
                    if (ui) {
                        switch (cfg.odata.authentication) {
                            case 'header-session':
                                url = url + '?token=' + ui.token;
                                break;
                        }
                    }
                }
                return url;
            },
            baseUrl: function (params) {
                var config = _application.config(_application.name) || {};
                config.odata = config.odata || {};
                var base = config.odata.base || '/data';
                var cfg = {};
                params = params || {};
                if (params.$module === undefined && config.odata.$module)
                    params.$module = config.odata.$module;
                if (!params.$module)
                    base = base.replace('\{\$module\}/', '');
                else
                    cfg.$module = params.$module;
                if (!config.odata.$context)
                    base = base.replace('\{\$context\}/', '');
                else
                    cfg.$context = config.odata.$context;
                return _utils.formatNames(base, cfg);
            },
            urlResEntity: function (params, checkId) {
                var base = _odata.baseUrl(params);
                if (!params.$entity)
                    throw 'Invalid odata entity.';
                if (checkId && !params.$entityId)
                    throw 'Invalid odata entity id.';
                var lurl = base + '/' + params.$entity;
                if (params.$entityId)
                    lurl = lurl + '(' + params.$entityId + ')';
                if (params.$propertyName)
                    lurl = lurl + '/' + params.$propertyName;
                return lurl;
            },
            doDelete: function (params, etag) {
                var lurl = _odata.urlResEntity(params, true);
                var opts = _ajax.getDefaultAjaxOptions();
                if (etag) {
                    opts.headers['If-Match'] = etag;
                }
                opts.ignore = { '410': true };
                lurl = _addTenantId(lurl);
                return _odata.transport.doDelete(lurl, opts);
            },
            doPost: function (params, data) {
                var opts = _ajax.getDefaultAjaxOptions();
                var lurl = _odata.urlResEntity(params, false);
                lurl = _addTenantId(lurl);
                return _odata.transport.doPost(lurl, data, opts);
            },
            doPut: function (params, data, etag, returnRepresentation) {
                var lurl = _odata.urlResEntity(params, true);
                var opts = _ajax.getDefaultAjaxOptions();
                opts.headers = opts.headers || {};
                if (etag) {
                    opts.headers['If-Match'] = etag;
                }
                if (returnRepresentation)
                    opts.headers['Prefer'] = 'return=representation';
                lurl = _addTenantId(lurl);
                return _odata.transport.doPut(lurl, data, opts);
            },
            doPatch: function (params, data, etag, returnRepresentation) {
                var lurl = _odata.urlResEntity(params, true);
                var opts = _ajax.getDefaultAjaxOptions();
                opts.headers = opts.headers || {};
                if (etag) {
                    opts.headers['If-Match'] = etag;
                }
                if (returnRepresentation)
                    opts.headers['Prefer'] = 'return=representation';
                lurl = _addTenantId(lurl);
                return _odata.transport.doPatch(lurl, data, opts);
            },
            getRessources: function (params, ondata, errors) {
                var _after = function (cd) {
                    if (ondata)
                        cd = ondata(cd);
                    return cd;
                };
                var hasEntityId = false;
                var cache = params.$cache;
                delete params.$cache;
                var config = _application.config(_application.name) || {};
                config.odata = config.odata || {};
                if (config.odata.v4 != undefined) {
                    _odata.v4 = config.odata.v4;
                }
                var base = config.odata ? config.odata.base || '/data' : '/data';
                var cfg = {};
                if (params.$module === undefined && config.odata.$module)
                    params.$module = config.odata.$module;
                if (!params.$module)
                    base = base.replace('\{\$module\}/', '');
                else
                    cfg.$module = params.$module;
                if (!config.odata.$context)
                    base = base.replace('\{\$context\}/', '');
                else
                    cfg.$context = config.odata.$context;
                base = _utils.formatNames(base, cfg);
                delete params.$module;
                var entity = params.$entity;
                if (params.$entityId) {
                    entity = entity + '(' + params.$entityId + ')';
                    delete params.$entityId;
                    hasEntityId = true;
                }
                if (params.$propertyName) {
                    entity = entity + '/' + params.$propertyName;
                    delete params.$propertyName;
                }
                var lurl = entity;
                delete params.$entity;
                if (!hasEntityId) {
                    if (_odata.v4) {
                        if (params.$top && !params.nocount)
                            params.$count = true;
                        delete params.nocount;
                    }
                    else {
                        params.$inlinecount = 'allpages';
                    }
                }
                var opts = _ajax.getDefaultAjaxOptions();
                opts.$errors = errors;
                lurl = base + '/' + lurl + Phoenix.link.object2search(params);
                if (cache && _odatacache[entity] && _odatacache[entity].uri == lurl) {
                    return new _utils.Promise(function (resolve, reject) {
                        var cd = _after(hasEntityId ? _odatacache[entity].data : $.extend(true, {}, _odatacache[entity].data));
                        resolve(cd);
                    });
                }
                lurl = _addTenantId(lurl);
                return data_2.odata.transport.doGet(lurl, opts, function (ldata) {
                    var cd = {};
                    if (_odata.v4 && ldata)
                        delete ldata['@odata.context'];
                    if (!hasEntityId) {
                        cd.documents = _odata.v4 ? ldata.value : ldata.d.results;
                        cd.dataCount = cd.documents ? cd.documents.length : 0;
                        cd.documents.forEach(function (v) {
                            delete v.__metadata;
                        });
                        if (cd) {
                            cd.pageSize = params.$top;
                            cd.skip = params.$skip || 0;
                            cd.count = _odata.v4 ? ldata['@odata.count'] : ldata.d.__count;
                            cd.nodata = cd.dataCount == 0;
                        }
                    }
                    else {
                        cd = ldata;
                    }
                    if (cache) {
                        _odatacache[entity] = {
                            uri: lurl,
                            data: $.extend(true, {}, cd)
                        };
                    }
                    return _after(cd);
                }, { entity: entity, params: params });
            }
        };
        data_2.odata = _odata;
        _authentication.registerAfterLogout(_odata.afterLogout);
    })(data = Phoenix.data || (Phoenix.data = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../core/modules/application.ts" />
/// <reference path="../core/modules/links.ts" />
/// <reference path="../core/modules/application.ts" />
/// <reference path="../core/modules/customdata.ts" />
/// <reference path="./schema-provider.ts" />
/// <reference path="./rest-provider.ts" />
/// <reference path="./local-provider.ts" />
/// <reference path="./menu-provider.ts" />
/// <reference path="./odata-provider.ts" />
var Phoenix;
(function (Phoenix) {
    var data;
    (function (data) {
        var _link = Phoenix.link, _utils = Phoenix.utils, _customData = Phoenix.customData, _application = Phoenix.application, _execTransform = function (cfg, ldata) {
            if (cfg.$transform) {
                var func = _customData.get("datasets.transform." + cfg.$transform);
                if (func)
                    ldata = func(ldata);
            }
            return ldata;
        }, _execBeforeTransform = function (transform, params, context) {
            if (!transform)
                return params;
            var func = _customData.get("datasets.transform." + transform);
            if (func)
                return func($.extend(true, {}, params, context));
            return params;
        }, _registerDataProvider = function () {
            var _dataProvider = {};
            return {
                register: function (name, provider) {
                    _dataProvider[name] = provider;
                },
                get: function (name) {
                    return _dataProvider[name];
                    ;
                }
            };
        }, _rdp = _registerDataProvider(), _checkDataSetConfig = function (cfg) {
            cfg = cfg || {};
            cfg.$type = cfg.$type || "basic";
            cfg.$triggers = cfg.$triggers || ["$load"];
            return cfg;
        }, _checkValue = function (value, ct, addQuote, output) {
            if (value == null && ct) {
                switch (ct) {
                    case 'number':
                        value = undefined;
                        break;
                    case 'integer':
                        value = undefined;
                        break;
                    case 'boolean':
                        value = undefined;
                        break;
                    case 'string':
                        value = '';
                        break;
                    default:
                        value = null;
                        break;
                }
            }
            if (Array.isArray(value)) {
                if (output)
                    return value;
                else
                    return JSON.stringify(value);
            }
            if (addQuote && ct) {
                if (ct === 'string' || ct === 'date' || ct === 'datetime') {
                    if (value == null)
                        return null;
                    else {
                        if (ct === 'date' || ct === 'datetime') {
                        }
                        else
                            value = '\'' + value.replace(/'/g, '\'\'') + '\'';
                    }
                }
            }
            return value;
        }, _getArrayIndexValue = function (value, s) {
            var i = s.indexOf('[');
            if (i < 0)
                return null;
            value = (i === 0) ? value : value[s.substr(0, i)];
            if (!value)
                return null;
            var sindex = s.substr(i + 1, s.length - i - 2);
            if (sindex == '*' || sindex == '')
                return value;
            var index = parseInt(sindex, 10);
            if (index < value.length)
                return value[index];
            else
                return null;
        }, _getValue = function (value, context, addQuote, output) {
            var cv = value;
            var ctx = ['$url', '$context', '$data', '$item', "$mem", "$local"];
            var vt = typeof cv, ct;
            if (vt === 'object' && cv) {
                ct = value.type;
                cv = value.value;
                vt = typeof cv;
            }
            if (vt === 'string' && cv && cv.charAt(0) == '$') {
                var segments = cv.split('.');
                var i = 0, sv = null;
                while (i < segments.length) {
                    var s = segments[i];
                    if (i == 0) {
                        var s1 = s, sarray;
                        var k = s.indexOf('[');
                        if (k > 0) {
                            sarray = s.substr(k);
                            s1 = s.substr(0, k);
                        }
                        var j = ctx.indexOf(s1);
                        if (j >= 0) {
                            sv = context[ctx[j]];
                            if (sarray)
                                segments.splice(i + 1, 0, sarray);
                        }
                        else
                            return _checkValue(cv, ct, addQuote, output);
                    }
                    else {
                        if (!sv)
                            break;
                        if (s.charAt(s.length - 1) == ']')
                            sv = _getArrayIndexValue(sv, s);
                        else {
                            if (Array.isArray(sv)) {
                                sv = sv.map(function (svi) { return svi[s]; });
                            }
                            else
                                sv = sv[s];
                        }
                    }
                    i++;
                }
                return _checkValue(sv, ct, addQuote, output);
            }
            return _checkValue(cv, ct, addQuote, output);
        }, _equals = function (o1, o2, props) {
            var i = props.length;
            while (i--) {
                if (o1[props[i]] != o2[props[i]])
                    return false;
            }
            return true;
        }, _outputData = function (def, context) {
            if (!def)
                return null;
            if (typeof def == "string") {
                return _getValue(def, context, false, true);
            }
            var res = {};
            Object.keys(def).forEach(function (name) {
                res[name] = _getValue(def[name], context, false, true);
            });
            return res;
        }, _defaultData = function (def, lurl, context, localContext) {
            return _outputData(def, {
                $url: lurl,
                $context: context,
                $data: null,
                $mem: Phoenix.$mem,
                $local: localContext
            });
        }, _internalExecTree = function (tree, lurl, context, localContext, addQuote) {
            if (tree && typeof tree === 'object' && tree.$op) {
                var rtree = {
                    $op: tree.$op,
                    $nulls: tree.$nulls,
                    $left: null,
                    $right: null
                };
                if (tree.$left != null) {
                    if (typeof tree.$left === 'object' && (tree.$left.$op || tree.$left.$op === null)) {
                        rtree.$left = _internalExecTree(tree.$left, lurl, context, localContext, addQuote);
                    }
                    else {
                        rtree.$left = _getValue(tree.$left, {
                            $url: lurl,
                            $context: context,
                            $data: null,
                            $mem: Phoenix.$mem,
                            $local: localContext
                        }, false, false);
                    }
                }
                if (tree.$right != null) {
                    if (typeof tree.$right === 'object' && (tree.$right.$op || tree.$right.$op === null)) {
                        rtree.$right = _internalExecTree(tree.$right, lurl, context, localContext, addQuote);
                    }
                    else {
                        rtree.$right = _getValue(tree.$right, {
                            $url: lurl,
                            $context: context,
                            $data: null,
                            $mem: Phoenix.$mem,
                            $local: localContext
                        }, addQuote, false);
                    }
                }
                return rtree;
            }
            else if (tree && typeof tree === 'object' && tree.$op === null && tree.$right === null && tree.$left) {
                var rtree = {
                    $left: null,
                    $op: null,
                    $right: null
                };
                if (tree.$left != null) {
                    if (typeof tree.$left === 'object' && tree.$left.$op) {
                        rtree.$left = _internalExecTree(tree.$left, lurl, context, localContext, addQuote);
                    }
                    else {
                        rtree.$left = _getValue(tree.$left, {
                            $url: lurl,
                            $context: context,
                            $data: null,
                            $mem: Phoenix.$mem,
                            $local: localContext
                        }, false, false);
                    }
                }
                return rtree;
            }
            else {
                return _getValue(tree, {
                    $url: lurl,
                    $context: context,
                    $data: null,
                    $mem: Phoenix.$mem,
                    $local: localContext
                }, addQuote, false);
            }
        }, _execTree = function (tree, lurl, context, localContext) {
            if (tree && typeof tree === 'string') {
                tree = _getValue(tree, {
                    $url: lurl,
                    $context: context,
                    $data: null,
                    $mem: Phoenix.$mem,
                    $local: localContext
                }, false, false);
            }
            return _internalExecTree(tree, lurl, context, localContext, true);
        }, _memoryTree = function (tree, lurl, context, localContext) {
            return _internalExecTree(tree, lurl, context, localContext, false);
        }, _acceptFilter = function (tree, item) {
            if (tree.$op === "eq") {
                return item[tree.$left] == tree.$right;
            }
            return false;
        }, _tree2filter = function (tree) {
            if (tree && typeof tree == 'object' && tree.$op) {
                var left = _tree2filter(tree.$left);
                var right = _tree2filter(tree.$right);
                //unary operators
                if (tree.$op === "not") {
                    return { value: 'not (' + right.value + ')', op: tree.$op };
                }
                else if (tree.$op === "in") {
                    var values = right.value.split(';');
                    var res_1 = [];
                    values.forEach(function (value) {
                        res_1.push(left.value + ' eq ' + value);
                    });
                    return { value: '(' + res_1.join(' or ') + ')', op: "in" };
                }
                else if (tree.$op === "$func")
                    return { value: left.value + '(' + right.value + ')', op: tree.$op };
                else {
                    if (tree.$nulls === "ignore" && (left.value == null || right.value == null)) {
                        if (tree.$op === "and" || tree.$op === "or") {
                            if (right.value == null)
                                return { value: left.value, op: left.op };
                            else
                                return { value: right.value, op: right.op };
                        }
                        else
                            return { value: null, op: null };
                    }
                    else {
                        var lv = left.value;
                        var rv = right.value;
                        if (tree.$op === "and") {
                            if (left.op === "or")
                                lv = '(' + lv + ')';
                            if (right.op === "or")
                                rv = '(' + rv + ')';
                        }
                        return { value: lv + ' ' + tree.$op + ' ' + rv, op: tree.$op };
                    }
                }
            }
            else if (tree && typeof tree == 'object' && tree.$op === null && tree.$right === null && tree.$left) {
                var cleft = _tree2filter(tree.$left);
                return { value: cleft.value, op: null };
            }
            else
                return { value: tree, op: null };
        }, _parseTree = function (tree, lurl, context, localContext) {
            var rtree = _execTree(tree, lurl, context, localContext);
            return _tree2filter(rtree).value;
        }, _parseRestParams = function (params, lurl, context, localContext) {
            var res = { $url: null, $list: null, $query: null, $method: "GET" };
            res.$method = (params.$method || 'GET').toUpperCase();
            res.$url = _utils.execAngularExpression(params.$url, {
                $url: lurl,
                $context: context,
                $data: null,
                $mem: Phoenix.$mem,
                $local: localContext
            });
            res.$list = params.$list;
            if (params.$query) {
                res.$query = {};
                Object.keys(params.$query).forEach(function (name) {
                    if (name === '$filter' && params.$query.$filter) {
                        res.$query.$filter = _parseTree(params.$query.$filter, lurl, context, localContext);
                        if (!res.$query.$filter)
                            delete res.$query.$filter;
                    }
                    else {
                        res.$query[name] = _getValue(params.$query[name], {
                            $url: lurl,
                            $context: context,
                            $data: null,
                            $mem: Phoenix.$mem,
                            $local: localContext
                        }, false, false);
                    }
                });
            }
            if (params.$method !== "GET" && params.$method !== "DELETE") {
                if (params.$data)
                    res.$data = _getValue(params.$data, {
                        $url: lurl,
                        $context: context,
                        $data: null,
                        $mem: Phoenix.$mem,
                        $local: localContext
                    }, false, false);
                else
                    res.$data = context || {};
            }
            return res;
        }, _parseEntityId = function (entityId, ctx) {
            if (!entityId)
                return '';
            var v = typeof entityId;
            if (v === 'object') {
                if (entityId.value && entityId.type)
                    return _getValue(entityId, ctx, false, false);
                else {
                    var l = [], hasNulls = false;
                    Object.keys(entityId).forEach(function (name) {
                        if (hasNulls)
                            return;
                        var cv = entityId[name];
                        var p = _parseEntityId(cv, ctx);
                        if (!p)
                            hasNulls = true;
                        l.push(p);
                    });
                    if (hasNulls)
                        return '';
                    return l.join(', ');
                }
            }
            else
                return _getValue(entityId, ctx, false, false);
        }, _isEntityIdNull = function (v) {
            return (v === undefined || v === null || v === '');
        }, _parseODataParams = function (params, lurl, context, localContext) {
            if (!params)
                return null;
            var res = {};
            var ctx = {
                $url: lurl,
                $context: context,
                $data: null,
                $mem: Phoenix.$mem,
                $local: localContext,
            };
            Object.keys(params).forEach(function (name) {
                if (name === '$search')
                    return;
                else if (name === '$entity')
                    res.$entity = _getValue(params.$entity, ctx, false, false);
                else if (name === '$entityId') {
                    var hasKeyNull_1 = false;
                    var v = typeof params.$entityId;
                    if (v === 'object') {
                        if (params.$entityId.value && params.$entityId.type) {
                            var v_1 = _getValue(params.$entityId, ctx, false, false);
                            hasKeyNull_1 = _isEntityIdNull(v_1);
                            res[name] = v_1;
                        }
                        else {
                            var l_1 = [];
                            Object.keys(params.$entityId).forEach(function (element) {
                                var v = _getValue(params.$entityId[element], ctx, false, false);
                                if (!hasKeyNull_1)
                                    hasKeyNull_1 = _isEntityIdNull(v);
                                l_1.push(element + '=' + v);
                            });
                            res[name] = l_1.join(', ');
                        }
                    }
                    else {
                        var v_2 = _getValue(params[name], ctx, false, false);
                        hasKeyNull_1 = _isEntityIdNull(v_2);
                        res[name] = v_2;
                    }
                    if (hasKeyNull_1) {
                        res.$entityIdNull = true;
                    }
                }
                else if (name == 'aggregate' && params.aggregate)
                    res.aggregate = params.aggregate;
                else if (name == 'groupby' && params.groupby)
                    res.groupby = params.groupby;
                else if (name == 'having' && params.having)
                    res.having = params.having;
                else if (name == '$filter' && params.$filter) {
                    res.$filter = _parseTree(params.$filter, lurl, context, localContext);
                    if (!res.$filter)
                        delete res.$filter;
                }
                else {
                    if (params[name])
                        res[name] = _getValue(params[name], ctx, false, false);
                }
            });
            if (params.$search && context && context.$searchText) {
                var v = _checkValue(context.$searchText, 'string', true, false), filter;
                var search = Array.isArray(params.$search) ? params.$search : [params.$search];
                if (search.length === 1) {
                    filter = Phoenix.utils.format('contains({0},{1})', params.$search.field, v);
                }
                else {
                    var af = ['('];
                    var len = search.length;
                    for (var i = 0; i < len; i++) {
                        af.push(Phoenix.utils.format('contains({0},{1})', search[i].field, v));
                        if (i < (len - 1))
                            af.push(' or ');
                    }
                    af.push(')');
                    filter = af.join('');
                }
                if (res.$filter)
                    res.$filter = res.$filter + ' and ' + filter;
                else
                    res.$filter = filter;
            }
            return res;
        }, _extractValue = function (value) {
            value = value || '';
            var ctx = _link.context();
            return _getValue(value, ctx, false, false);
        }, _execBasic = function (config, lurl, context, callerObject) {
            var local = callerObject && callerObject.getLocalContext ? callerObject.getLocalContext() : null;
            var cd, ldata = _defaultData(config.$data, lurl, context, local);
            if (config.$params && config.$params.dataProvider) {
                var hnd = Phoenix.customData.get(config.$params.dataProvider);
                if (hnd)
                    context = hnd(context, callerObject);
            }
            if (config.$output) {
                ldata = _defaultData(config.$data, lurl, context, local);
                cd = _outputData(config.$output, {
                    $url: lurl,
                    $context: context,
                    $data: ldata,
                    $mem: Phoenix.$mem,
                    $local: local
                });
            }
            else
                cd = context;
            cd = _execTransform(config, cd);
            return new Phoenix.utils.Promise(function (resolve, reject) {
                resolve(cd);
            });
        }, _execWSchema = function (config, lurl, context, callerObject) {
            var name = config.$params.name;
            return data.schema.get(name, config.$params.localization, undefined);
        }, _execMenu = function (config, lurl, context, callerObject) {
            var name = config.$params.name;
            return data.menu.get(name, config.$params.localization, undefined);
        }, _execOData = function (config, lurl, context, callerObject) {
            var method = config.$method || 'GET';
            var local = callerObject && callerObject.getLocalContext ? callerObject.getLocalContext() : null;
            var tp = _execBeforeTransform(config.$beforeExecute, config.$params, context);
            var params = _parseODataParams(tp, lurl, context, local);
            if (method) {
                method = _getValue(method, context, false, false);
                method = method.toUpperCase();
            }
            if (params.$entityIdNull) {
                delete params.$entityIdNull;
                if (method === 'GET' && config.$create) {
                    var rdata = $.extend(true, {}, config.$create);
                    rdata.$create = true;
                    return _utils.Promise.resolve(rdata);
                }
            }
            if (method) {
                switch (method) {
                    case "DELETE":
                        return data.odata.doDelete(params, context.etag ? context.etag : null);
                    case "POST":
                        return data.odata.doPost(params, context);
                    case "PUT":
                        var etagput = context["@odata.etag"];
                        delete context["@odata.etag"];
                        var irput = context["@odata.return"] != null;
                        delete context["@odata.return"];
                        return data.odata.doPut(params, context, etagput, irput);
                    case "PATCH":
                        var etagpatch = context["@odata.etag"];
                        delete context["@odata.etag"];
                        var irpatch = context["@odata.return"] != null;
                        delete context["@odata.return"];
                        return data.odata.doPatch(params, context, etagpatch, irpatch);
                }
            }
            var defData = _defaultData(config.$data, lurl, context, local);
            var cfg = _application.config(_application.name) || {};
            if (config.$cache === undefined) {
                if (cfg.odata && cfg.odata.cache !== undefined) {
                    cfg.odata.cache = cfg.odata.cache;
                }
                else {
                    cfg.odata = cfg.odata || {};
                    cfg.odata.cache = true;
                }
            }
            if (context) {
                if (context.hasOwnProperty('$skip') && context.$skip)
                    params.$skip = context.$skip;
                if (context.hasOwnProperty('$top') && context.$top)
                    params.$top = context.$top;
            }
            return data.odata.getRessources(params, function (ldata) {
                if ((!ldata || !ldata.documents || !ldata.documents.length) && defData) {
                    ldata.documents = ldata.documents || [];
                    ldata.documents.push(defData);
                }
                if (context) {
                    if (context.hasOwnProperty('$searchText')) {
                        ldata.searchText = context.$searchText;
                    }
                }
                var cd = ldata;
                if (config.$output)
                    cd = _outputData(config.$output, {
                        $url: lurl,
                        $context: context,
                        $data: ldata,
                        $mem: Phoenix.$mem,
                        $local: local
                    });
                cd = _execTransform(config, cd);
                return cd;
            }, config.$errors);
        }, _execLocal = function (config, lurl, context, callerObject) {
            var local = callerObject && callerObject.getLocalContext ? callerObject.getLocalContext() : null;
            var params = _parseRestParams(config.$params, lurl, context, local);
            return data.local.getRessources(params, function (ldata) {
                var cd = ldata;
                if (config.$output)
                    cd = _outputData(config.$output, {
                        $url: lurl,
                        $context: context,
                        $data: ldata,
                        $mem: Phoenix.$mem,
                        $local: local
                    });
                cd = _execTransform(config, cd);
                return cd;
            });
        }, _execRest = function (config, lurl, context, callerObject) {
            var local = callerObject && callerObject.getLocalContext ? callerObject.getLocalContext() : null;
            var tp = _execBeforeTransform(config.$beforeExecute, config.$params, context);
            var params = _parseRestParams(tp, lurl, context, local);
            if (config.$method)
                params.$method = config.$method;
            return data.rest.getRessources(params, function (ldata) {
                var cd = ldata;
                if (config.$output)
                    cd = _outputData(config.$output, {
                        $url: lurl,
                        $context: context,
                        $data: ldata,
                        $mem: Phoenix.$mem,
                        $local: local
                    });
                cd = _execTransform(config, cd);
                return cd;
            });
        }, _emitList = function (config) {
            var res = [];
            if (config.$emit) {
                if (config.$emit.$loaded || config.$emit.$changed) {
                    if (config.$emit.$loaded)
                        res.push(config.$emit.$loaded.$name);
                    if (config.$emit.$changed)
                        res.push(config.$emit.$changed.$name);
                }
                else
                    res.push(config.$emit);
            }
            return res;
        };
        data.execData = function (config, context, callerObject) {
            var lurl = _link.search(null, false);
            if (!config)
                return null;
            switch (config.$type) {
                case 'basic':
                    return _execBasic(config, lurl, context, callerObject);
                case 'odata':
                    return _execOData(config, lurl, context, callerObject);
                case 'rest':
                    return _execRest(config, lurl, context, callerObject);
                case 'local':
                    return _execLocal(config, lurl, context, callerObject);
                default:
                    var provider = _rdp.get(config.$type);
                    if (provider)
                        return provider(config, lurl, context, callerObject);
                    break;
            }
            return null;
        };
        var DataSet = (function () {
            function DataSet(config) {
                var that = this;
                that.config = _checkDataSetConfig(config);
                if (config.$default)
                    that.defaultDataset = true;
                if (that.config.$autoselect)
                    that.autoselect = true;
                that._emitters = _emitList(that.config);
                that.selectedIndex = -1;
            }
            DataSet.prototype.execute = function (context, callerObject) {
                var that = this;
                var lurl = _link.search(null, false);
                switch (that.config.$type) {
                    case "basic":
                        return _execBasic(that.config, lurl, context, callerObject);
                    case "odata":
                        return _execOData(that.config, lurl, context, callerObject);
                    case "rest":
                        return _execRest(that.config, lurl, context, callerObject);
                    case "local":
                        return _execLocal(that.config, lurl, context, callerObject);
                    case "menu":
                        return _execMenu(that.config, lurl, context, callerObject);
                    case "widget-schema":
                        return _execWSchema(that.config, lurl, context, callerObject);
                    default:
                        var provider = _rdp.get(that.config.$type);
                        if (provider)
                            return provider(that.config, lurl, context, callerObject);
                        break;
                }
                throw "Invalid dataset type";
            };
            DataSet.prototype.enumTriggers = function (addLoad, cb) {
                var that = this;
                if (that.config.$triggers) {
                    that.config.$triggers.forEach(function (tn) {
                        if (addLoad || tn != "$load") {
                            cb(tn);
                        }
                    });
                }
            };
            DataSet.prototype.enumEmitters = function (cb) {
                var that = this;
                that._emitters.forEach(cb);
            };
            DataSet.prototype.hasCustomEvents = function () {
                var that = this;
                if (that.config.$triggers) {
                    var t = that.config.$triggers;
                    if (t.length > 1)
                        return true;
                    return (t[0] != "$load");
                }
                return false;
            };
            DataSet.prototype.canExecute = function (event, context) {
                var that = this;
                if (that.config.$condition) {
                    var val = _getValue(that.config.$condition, context, false, true);
                    if (!val || val === "false")
                        return false;
                }
                return that.config.$triggers.indexOf(event) >= 0;
            };
            DataSet.prototype.data2Output = function (def, context) {
                return _outputData(def, context);
            };
            DataSet.prototype.destroy = function () {
                Phoenix.utils.log("Destroy Dataset", "destroy");
            };
            DataSet.prototype._findSelectedOData = function (ldata) {
                var that = this;
                if (ldata.documents) {
                    var index = -1;
                    var found = null;
                    if (that.config.$autoselect && typeof that.config.$autoselect == 'object') {
                        var context = {
                            $url: _link.search(null, false),
                            $mem: Phoenix.$mem
                        };
                        var memData = _outputData(that.config.$autoselect, context);
                        var props = Object.keys(memData);
                        for (var i = 0, len = ldata.documents.length; i < len; i++) {
                            var d = ldata.documents[i];
                            if (_equals(d, memData, props)) {
                                found = d;
                                index = i;
                                break;
                            }
                        }
                    }
                    return found ? {
                        item: found,
                        index: index
                    } : (ldata.documents.length ? {
                        item: ldata.documents[0],
                        index: 0
                    } : {
                        item: null,
                        index: -1
                    });
                }
                return {
                    item: null,
                    index: -1
                };
            };
            DataSet.prototype._findSelected = function (ldata) {
                var that = this;
                switch (that.config.$type) {
                    case "odata":
                    case "rest":
                        return that._findSelectedOData(ldata);
                    default:
                        {
                            return {
                                item: ldata,
                                index: 0
                            };
                        }
                }
            };
            DataSet.prototype.doAutoSelect = function (d, select) {
                var that = this;
                that.selectedIndex = -1;
                if (!that.config.$autoselect)
                    return;
                if (!d || d.nodata)
                    return select(null);
                var s = that._findSelected(d);
                that.selectedIndex = s.index;
                select(s.item);
            };
            return DataSet;
        }());
        data.DataSet = DataSet;
        data.registerDataProvider = _rdp.register;
        data.compileFilterTree = _memoryTree;
        data.acceptFilter = _acceptFilter;
        data.extractValue = _extractValue;
        data.test = { output: _outputData, parseTree: _parseTree };
    })(data = Phoenix.data || (Phoenix.data = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../core/core.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _dom = Phoenix.dom, _locale = Phoenix.locale, 
        // Create page object used in template
        _makePage = function (ii, text, icon, isActive, isDisabled) {
            return {
                number: ii,
                text: text,
                icon: icon,
                active: isActive,
                disabled: isDisabled
            };
        }, _getPages = function (currentPage, totalPages, options) {
            var pages = [];
            // Default page limits
            var startPage = 1, endPage = totalPages;
            var isMaxSized = (options.maxSize && options.maxSize < totalPages);
            // recompute if maxSize
            if (isMaxSized) {
                if (options.rotate) {
                    // Current page is displayed in the middle of the visible ones
                    startPage = Math.max(currentPage - Math.floor(options.maxSize / 2), 1);
                    endPage = startPage + options.maxSize - 1;
                    // Adjust if limit is exceeded
                    if (endPage > totalPages) {
                        endPage = totalPages;
                        startPage = endPage - options.maxSize + 1;
                    }
                }
                else {
                    // Visible pages are paginated with maxSize
                    startPage = ((Math.ceil(currentPage / options.maxSize) - 1) * options.maxSize) + 1;
                    // Adjust last page if limit is exceeded
                    endPage = Math.min(startPage + options.maxSize - 1, totalPages);
                }
            }
            // Add page number links
            for (var ii = startPage; ii <= endPage; ii++) {
                var page = _makePage(ii, ii, null, ii === currentPage, false);
                pages.push(page);
            }
            // Add links to move between page sets
            if (isMaxSized && !options.rotate) {
                if (startPage > 1) {
                    var previousPageSet = _makePage(startPage - 1, '...', null, false, false);
                    pages.unshift(previousPageSet);
                }
                if (endPage < totalPages) {
                    var nextPageSet = _makePage(endPage + 1, '...', null, false, false);
                    pages.push(nextPageSet);
                }
            }
            var p;
            //Add Previous
            if (options.directionLinks) {
                p = _makePage('prev', null, 'chevron-left', false, currentPage == 1);
                pages.unshift(p);
            }
            //Add First
            if (options.boundaryLinks) {
                p = _makePage('first', null, 'backward', false, currentPage == 1);
                pages.unshift(p);
            }
            //Add Next
            if (options.directionLinks) {
                p = _makePage('next', null, 'chevron-right', false, currentPage == totalPages);
                pages.push(p);
            }
            //Add last
            if (options.boundaryLinks) {
                p = _makePage('last', null, 'forward', false, currentPage == totalPages);
                pages.push(p);
            }
            return pages;
        };
        var Pager = (function () {
            function Pager(options) {
                var that = this, defOptions = {
                    boundaryLinks: false,
                    directionLinks: true,
                    rotate: true,
                    maxSize: 4,
                    size: "lg"
                };
                that._options = $.extend(defOptions, options || {});
                that.pages = [];
                that._updating = false;
                that.visible = false;
                that.props = {};
                that.data = {
                    currentPage: -1,
                    totalPages: 0
                };
                that._defineProps();
            }
            Pager.prototype._defineProps = function () {
                var that = this, _dp = Phoenix.utils.defineProperty;
                _dp("currentPage", that);
                _dp("totalPages", that);
            };
            Pager.prototype._notifyChange = function (propertyName) {
                var that = this;
                switch (propertyName) {
                    case "currentPage":
                        that._changed = true;
                        that._updatePages();
                        break;
                    case "totalPages":
                        that._changed = true;
                        if (that.data.currentPage >= 0)
                            that._updatePages();
                        break;
                }
            };
            Pager.prototype._renderPager = function () {
                var that = this;
                var e = that.$element.get(0);
                if (that.visible) {
                    var frag = document.createDocumentFragment();
                    var p = $('<li><a href></a><li>').get(0);
                    var span = document.createElement("span");
                    that.pages.forEach(function (page) {
                        var ii = p.cloneNode(true);
                        if (page.icon) {
                            var sp = span.cloneNode(true);
                            _dom.attr(sp, "class", _dom.iconClass(page.icon));
                            _dom.attr(sp, "page", page.number);
                            _dom.append(ii.firstChild, sp);
                        }
                        if (page.text)
                            _dom.text(ii.firstChild, page.text);
                        _dom.attr(ii, "page", page.number);
                        _dom.attr(ii.firstChild, "page", page.number);
                        if (page.disabled)
                            _dom.addClass(ii, 'disabled');
                        if (page.active)
                            _dom.addClass(ii, 'active');
                        frag.appendChild(ii);
                    });
                    that.$element.empty();
                    e.appendChild(frag);
                    _dom.removeClass(e, 'bs-none');
                }
                else
                    _dom.addClass(e, 'bs-none');
            };
            Pager.prototype._updatePages = function () {
                var that = this;
                if (that._updating)
                    return;
                that.pages = _getPages(that.data.currentPage, that.data.totalPages, that._options);
                that.visible = that.data.currentPage > 0 && that.data.totalPages > 1;
                var t = 5;
                if (!that._options.boundaryLinks)
                    t = t - 2;
                if (!that._options.directionLinks)
                    t = t - 2;
                that.visible = that.pages.length > t;
                if (that.$element) {
                    that._renderPager();
                }
            };
            Pager.prototype._setEvents = function () {
                var that = this;
                if (that.$element) {
                    that.$element.on('click', function (event) {
                        var target = event.target;
                        var page = _dom.attr(target, "page");
                        if (page) {
                            event.preventDefault();
                            event.stopPropagation();
                            if (_dom.hasClass(target, 'disabled') || _dom.hasClass(target.parentNode, 'disabled'))
                                return;
                            if (that._options.selectPage) {
                                var pn = parseInt(page, 10);
                                that._options.selectPage(isNaN(pn) ? page : pn);
                            }
                        }
                    });
                }
            };
            Pager.prototype._removeEvents = function () {
                var that = this;
                if (that.$element)
                    that.$element.off('click');
            };
            Pager.prototype.updating = function (value) {
                var that = this;
                that._updating = value;
                if (value) {
                    that._changed = false;
                }
                else {
                    if (that._changed) {
                        that._changed = false;
                        that._updatePages();
                    }
                }
            };
            Pager.prototype.render = function ($parent) {
                var that = this;
                if (!that.$element) {
                    that.$element = $('<ul class="pagination' + (that._options.size != 'default' ? (' pagination-' + that._options.size) : '') + '"></ul>');
                    that._renderPager();
                    that._setEvents();
                }
                if ($parent) {
                    if (that._options.replaceParent)
                        $parent.replaceWith(that.$element);
                    else
                        $parent.append(that.$element);
                }
            };
            Pager.prototype.destroy = function () {
                var that = this;
                that._removeEvents();
                that.$element = null;
                that._options = null;
            };
            return Pager;
        }());
        ui.Pager = Pager;
        ;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../core/core.ts" />
/// <reference path="../core/modules/application.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _error = [
            '<div role="alert" class="bs-error alert alert-danger alert-dismissible fade in">',
            '<button aria-label="{0}" data-dismiss="alert" class="close" type="button"><span aria-hidden="true">×</span></button>',
            '<h4 >{1}</h4>',
            '<p>{2}</p>',
            '<p>',
            '<a class="bs-button btn btn-default" href="{4}" role="button">{3}</a>',
            '</p>',
            '</div>'
        ];
        var _loading = [
            '<div class="bs-loader"></div>'
        ];
        var _cp = null, _history = Phoenix.history, _utils = Phoenix.utils, _external = Phoenix.external, _dom = Phoenix.dom, _link = Phoenix.link, _locale = Phoenix.locale, _application = Phoenix.application, _datasetsInfo = function (datasets) {
            var cfg = {
                emit: false,
                listen: true,
                triggers: [],
                emitters: []
            };
            Object.keys(datasets).forEach(function (dsn) {
                if (dsn == "view")
                    return;
                var ds = datasets[dsn];
                if (ds.config.$emit) {
                    ds.enumEmitters(function (event) {
                        cfg.emit = true;
                        cfg.emitters.push(event);
                    });
                }
                ds.enumTriggers(false, function (tn) {
                    cfg.listen = true;
                    if (cfg.triggers.indexOf(tn) < 0)
                        cfg.triggers.push(tn);
                });
            });
            return cfg;
        };
        var PageControl = (function () {
            function PageControl() {
                var that = this;
                that.childs = [];
                that.data = {
                    $title: '',
                    $menuleft: false,
                    $menutop: false,
                    $menuright: false,
                    $menubottom: false,
                    $hasBack: _history.hasBack(),
                    $user: {}
                };
                that.errors = [];
                that.props = {};
                that.popup = null;
                that._defineProps();
                that._setEvents();
                _external.historyChangedHandler = that._historyChanged.bind(that);
            }
            PageControl.prototype._defineProps = function () {
                var self = this, _dp = _utils.defineProperty;
                _dp("$title", self);
                _dp("$menuleft", self);
                _dp("$menutop", self);
                _dp("$menuright", self);
                _dp("$menubottom", self);
                _dp("$hasBack", self);
                _dp("$user", self);
            };
            PageControl.prototype.currentPage = function () {
                var that = this;
                var l = that.childByType("layout");
                if (l)
                    return l.data.name || "";
                return "";
            };
            PageControl.prototype.emittersFor = function (events) {
                var that = this, res = [], len = events.length;
                if (that.dataListeners) {
                    that.dataListeners.forEach(function (module) {
                        if (!module.listener.disabled && module.emit) {
                            var emitEvent = false;
                            for (var i = 0; i < len; i++) {
                                if (module.emitters.indexOf(events[i]) >= 0) {
                                    emitEvent = true;
                                }
                            }
                            if (emitEvent) {
                                res.push(module.listener);
                            }
                        }
                    });
                }
                return res;
            };
            PageControl.prototype._historyChanged = function () {
                this.props.$hasBack = _history.hasBack();
            };
            PageControl.prototype._notifyChange = function (propertyName) {
                var that = this;
                that._notifyChildren(propertyName, that.data[propertyName]);
            };
            PageControl.prototype._notifyChildOnAdd = function (child) {
                var that = this;
                if (child && child.onPageChange) {
                    Object.keys(that.props).forEach(function (pn) {
                        child.onPageChange(pn, that.props[pn]);
                    });
                }
            };
            PageControl.prototype._notifyChildren = function (propName, value) {
                var that = this;
                that.childs.forEach(function (cd) {
                    var c = cd.child;
                    if (c && c.onPageChange)
                        c.onPageChange(propName, value);
                });
            };
            PageControl.prototype.registerDataListener = function (value, parent) {
                var that = this;
                that.dataListeners = that.dataListeners || [];
                if (!value.datasets)
                    return;
                var config = _datasetsInfo(value.datasets);
                if (config.emit || config.listen) {
                    that.dataListeners.push({
                        listener: value,
                        parent: parent,
                        triggers: config.triggers,
                        listen: config.listen,
                        emitters: config.emitters,
                        emit: config.emit
                    });
                }
            };
            PageControl.prototype.removeDataListener = function (listener) {
                var that = this;
                if (!that.dataListeners)
                    return;
                var i = that.dataListeners.length;
                while (i--) {
                    var ci = that.dataListeners[i];
                    if (ci.listener == listener) {
                        that.dataListeners.splice(i, 1);
                    }
                }
            };
            PageControl.prototype.removeParentDataListener = function (parent) {
                var that = this;
                if (!that.dataListeners)
                    return;
                var i = that.dataListeners.length;
                while (i--) {
                    var ci = that.dataListeners[i];
                    if (ci.parent == parent) {
                        that.dataListeners.splice(i, 1);
                    }
                }
            };
            PageControl.prototype.emitDataEvent = function (event, value, filter) {
                var that = this;
                if (that.dataListeners) {
                    that.dataListeners.forEach(function (mod) {
                        if (filter && filter.indexOf(mod.listen) < 0)
                            return;
                        if (mod.listen && (mod.triggers.indexOf(event) >= 0) &&
                            mod.listener && mod.listener.dataEvent) {
                            if (mod.listener.ds_storeLastEvent)
                                mod.listener.ds_storeLastEvent(event, value);
                            if (!mod.listener.disabled) {
                                mod.listener.dataEvent(event, value);
                            }
                        }
                    });
                }
            };
            PageControl.prototype.childByType = function (ct) {
                var that = this;
                for (var i = 0, len = that.childs.length; i < len; i++) {
                    var c = that.childs[i];
                    if (c.type == ct)
                        return c.child;
                }
                return null;
            };
            PageControl.prototype.addChild = function (type, child) {
                var that = this;
                that.childs.push({
                    child: child,
                    type: type
                });
                that._notifyChildOnAdd(child);
            };
            PageControl.prototype.removeChild = function (child) {
                var that = this;
                var i = that.childs.length;
                while (i--) {
                    var ci = that.childs[i];
                    if (ci.child == child) {
                        that.childs.splice(i, 1);
                        break;
                    }
                }
            };
            PageControl.prototype.destroy = function () {
                var that = this;
                _external.historyChangedHandler = null;
                that._hideErrors(true);
                that._hideLoading();
                if (that.childs) {
                    var i = that.childs.length;
                    while (i--) {
                        var ci = that.childs[i];
                        that.removeDataListener(ci.child);
                    }
                    that.childs = null;
                }
                that.dataListeners = null;
                that._removeEvents();
            };
            PageControl.prototype._setEvents = function () {
                var that = this;
                $(document).on("mousedown touchstart", function (event) {
                    that._closePopup(event);
                });
                window.onerror = function (message, filename, lineno, colno, error) {
                    if (!error && filename) {
                        error = { filename: filename, lineno: lineno || 0, colno: colno || 0 };
                    }
                    if (!that.$error) {
                        that.lastError = {
                            message: message,
                            stack: error ? error.stack : null,
                            stackError: error && error.stack ? null : error
                        };
                        that._showErrors();
                    }
                };
            };
            PageControl.prototype._hideErrors = function (remove) {
                var that = this;
                if (that.$error) {
                    that.$error.off('closed.bs.alert');
                    if (remove)
                        that.$error.remove();
                    that.$error = null;
                }
            };
            PageControl.prototype._showErrors = function () {
                var that = this;
                var errorParent = _dom.find(null, "error_box");
                if (!errorParent)
                    return;
                if (!that.$error) {
                    var mailUrl = ["mailto:"];
                    mailUrl.push(_application.support);
                    mailUrl.push("?subject=" + encodeURIComponent(_application.title));
                    mailUrl.push("&body=");
                    var ctx = _link.context();
                    var d = new Date();
                    mailUrl.push(encodeURIComponent(_locale.errors.ErrorTitle + ' '));
                    mailUrl.push(encodeURIComponent(that.lastError.message));
                    mailUrl.push(encodeURIComponent('\n\n' + _locale.errors.ErrorUser + ' '));
                    mailUrl.push(encodeURIComponent(ctx.$user.name));
                    mailUrl.push(encodeURIComponent('\n\n' + _locale.errors.ErrorDate + ' '));
                    mailUrl.push(encodeURIComponent(d.toLocaleString()));
                    mailUrl.push(encodeURIComponent('\n\n' + _locale.errors.Browser + ' '));
                    mailUrl.push(encodeURIComponent(navigator.userAgent));
                    mailUrl.push(encodeURIComponent('\n\n' + _locale.errors.ErrorURI + ' '));
                    mailUrl.push(encodeURIComponent(window.location.href));
                    if (that.lastError.stack || that.lastError.stackError) {
                        mailUrl.push(encodeURIComponent('\n\n' + _locale.errors.Stack + '\n'));
                        if (that.lastError.stack)
                            mailUrl.push(encodeURIComponent(that.lastError.stack));
                        else
                            mailUrl.push(encodeURIComponent(JSON.stringify(that.lastError.stackError)));
                    }
                    mailUrl.push(encodeURIComponent('\n\n' + _locale.errors.Context + ' '));
                    mailUrl.push(encodeURIComponent(JSON.stringify(ctx)));
                    that.$error = $(_utils.format(_error.join(''), _locale.ui.Close, _locale.errors.Title, that.lastError.message, _locale.errors.SendMail, mailUrl.join('')));
                    that.$error.on('closed.bs.alert', function () {
                        that._hideErrors(false);
                    });
                    errorParent.appendChild(that.$error.get(0));
                }
            };
            PageControl.prototype._hideLoading = function () {
                var that = this;
                if (that.$loading) {
                    that.$loading.remove();
                    that.$loading = null;
                }
            };
            PageControl.prototype._showLoading = function () {
                var that = this;
                var errorParent = document.body;
                if (!errorParent)
                    return;
                if (!that.$loading) {
                    that.$loading = $(_loading.join(''));
                    errorParent.appendChild(that.$loading.get(0));
                }
            };
            PageControl.prototype.loading = function (show) {
                var that = this;
                if (show)
                    that._showLoading();
                else
                    that._hideLoading();
            };
            PageControl.prototype._removeEvents = function () {
                $(document).off("mousedown touchstart");
            };
            PageControl.prototype._closePopup = function (event) {
                var that = this;
                if (that.popup) {
                    if (!event || (that.popup.inPopup && !that.popup.inPopup(event.originalEvent ? event.originalEvent.target : event.target))) {
                        if (that.popup.hide)
                            that.popup.hide(event ? (event.originalEvent ? event.originalEvent.target : event.target) : null);
                        that.popup = null;
                    }
                }
            };
            PageControl.prototype.setPopup = function (popup) {
                var that = this;
                that._closePopup(null);
                that.popup = popup;
            };
            return PageControl;
        }());
        ui.PageControl = PageControl;
        function Page() {
            if (!_cp)
                _cp = new PageControl();
            return _cp;
        }
        ui.Page = Page;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../core/core.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _utils = Phoenix.utils, _ulocale = Phoenix.ulocale, _locale = Phoenix.locale, _dom = Phoenix.dom;
        var _patternButton = function (options) {
            if (options.pattern == "close") {
                var closeOpt = { "close": true, "type": "default", name: "close", "title": _locale.ui.Close };
                return $.extend({}, closeOpt, options);
            }
            else if (options.pattern == "validate") {
                var validateOpt = { "close": false, "type": "success", name: "validate", "title": _locale.ui.Validate };
                return $.extend({}, validateOpt, options);
            }
            return options;
        };
        var _renderButton = function (options, html, locale) {
            //options name, type, icon, title, cancel
            options = _patternButton(options);
            html.push('<button data-action="' + options.name + '" type="button"');
            html.push(' class="bs-btn-inline pull-right bs-button btn btn-' + options.type || 'default');
            html.push('"');
            if (options.close)
                html.push(' data-dismiss="modal"');
            html.push('>');
            if (options.icon) {
                html.push('<span class="' + _dom.iconClass(options.icon) + '"></span>');
                if (options.title)
                    html.push('&nbsp;');
            }
            html.push(_ulocale.tt(options.title || '', locale));
            html.push('</button>');
        };
        var _createModal = function (options, locale) {
            var html = [
                '<div class="modal fade" data-backdrop="static"  id="{0}" role="dialog" aria-labelledby="{0}_label">',
                '	<div class="modal-dialog' + (options.size ? (' modal-' + options.size) : '') + '" role="document">',
                '		<div class="modal-content">',
                '		<div class="modal-header">',
                '			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>',
                '			<h4 class="modal-title" id="{0}_label">{1}</h4>',
                '		</div>',
                '		<div class="modal-body" id="{0}_body">',
                '		</div>',
                '		<div class="modal-footer"  id="{0}_footer">'
            ];
            if (options.buttons)
                options.buttons.forEach(function (btn) {
                    _renderButton(btn, html, locale);
                });
            html.push('		</div>');
            html.push('		</div>');
            html.push('	</div>');
            html.push('</div>');
            return _utils.format(html.join(''), options.id, _ulocale.tt(options.title, locale));
        };
        var Modal = (function () {
            function Modal(options, locale) {
                this.options = options || {};
                ;
                this.$id = _utils.allocID();
                this.$locale = locale;
            }
            Modal.prototype._removeEvents = function () {
                var that = this;
                that.$element.off('click');
                that.$element.off('hidden.bs.modal');
            };
            Modal.prototype._execAction = function (name) {
                var that = this;
                if (that._clickHnd) {
                    that._clickHnd(name);
                }
            };
            Modal.prototype._addEvents = function () {
                var that = this;
                that.$element.on('hide.bs.modal', function (e) {
                    if (that._inProcessing) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
                that.$element.on('hidden.bs.modal', function (e) {
                    that._clear();
                });
                that.$element.on('click', function (e) {
                    if (!that.$element)
                        return;
                    var t = e.target, root = that.$element.get(0);
                    while (t) {
                        var action = t.getAttribute('data-action');
                        if (action) {
                            return _utils.focusDelay(function () {
                                return that._execAction(action);
                            });
                        }
                        t = (t == root) ? null : t.parentNode;
                    }
                });
            };
            Modal.prototype._clear = function () {
                var that = this;
                if (that.$element) {
                    that._removeEvents();
                    if (that.render)
                        that.render.destroy();
                    that.$element.remove();
                    that.$element = null;
                }
                that.render = null;
            };
            Modal.prototype.processing = function (value) {
                var that = this;
                that._inProcessing = value;
                _dom.processing(value);
                if (that.render && that.render.processing)
                    that.render.processing(value);
            };
            Modal.prototype.on = function (hnd) {
                this._clickHnd = hnd;
            };
            Modal.prototype.close = function () {
                var that = this;
                if (that.$element)
                    that.$element.modal('hide');
            };
            Modal.prototype.open = function () {
                var that = this;
                var opts = { id: that.$id, title: that.options.title || '', buttons: that.options.buttons || [], size: 0 };
                if (that.options.size)
                    opts.size = that.options.size;
                if (!that.$element) {
                    that.$element = $(_createModal(opts, that.$locale));
                    if (that.render)
                        that.render.render($(_dom.find(that.$element.get(0), that.$id + '_body')));
                    _dom.append(document.body, that.$element.get(0));
                    that.$element.modal({});
                    that._addEvents();
                }
            };
            Modal.prototype.destroy = function () {
                var that = this;
                that._clear();
            };
            return Modal;
        }());
        ui.Modal = Modal;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../core/core.ts" />
/// <reference path="../data/datasets.ts" />
//TODO: config.$resources || config.$schema --> config.$resources
var Phoenix;
(function (Phoenix) {
    var DatasetPlugin;
    (function (DatasetPlugin) {
        var _data = Phoenix.data, _link = Phoenix.link, _mem = Phoenix.$mem, _utils = Phoenix.utils, _updateMem = function (that, ds, value, prop) {
            if (ds.config.$emit[prop].$updateMem) {
                var patchMem = ds.data2Output(ds.config.$emit[prop].$updateMem, {
                    $item: value
                });
                _mem = $.extend(_mem, patchMem);
            }
            if (ds.config.$emit[prop].$updateLocal) {
                var local = that.getLocalContextHandler ? that.getLocalContextHandler() : null;
                if (local) {
                    var patchLocal = ds.data2Output(ds.config.$emit[prop].$updateLocal, {
                        $item: value
                    });
                    local = $.extend(local, patchLocal);
                }
            }
        }, _ds_exec = function (thisObject, event, context, dst, after, datasets, notify, contextByDs) {
            var _ctxByName = function (name) {
                return contextByDs ? (context ? context[name] : null) : context;
            };
            var that = thisObject;
            var list = [], names = [], res = dst || {}, isLoad = event == "$load", indexDefault = -1;
            var _pushDataset = function (dsName, dsnames, ctx) {
                if (!that || !that.datasets)
                    return;
                var ds = that.datasets[dsName];
                if (ds) {
                    list.push(ds.execute(ctx, that));
                    names.push(dsName);
                    if (ds.defaultDataset)
                        indexDefault = dsnames.length - 1;
                }
            };
            if (datasets) {
                if (datasets && Array.isArray(datasets)) {
                    datasets.forEach(function (dataset) {
                        if (typeof dataset === "object") {
                            if (dataset.name) {
                                list.push(_data.execData(dataset, _ctxByName(dataset.name), that));
                                names.push(dataset.name);
                            }
                        }
                        else
                            _pushDataset(dataset, names, _ctxByName(dataset));
                    });
                }
                else {
                    _pushDataset(datasets, names, _ctxByName(datasets));
                }
            }
            else if (that && that.datasets) {
                Object.keys(that.datasets).forEach(function (dataset) {
                    var ds = that.datasets[dataset];
                    var lurl = _link.search(null, false);
                    var ctx = that.ds_context();
                    if (ds && ds.canExecute(event, ctx))
                        _pushDataset(dataset, names, _ctxByName(dataset));
                });
            }
            if (list.length) {
                if (that && that.loadingHandler)
                    that.loadingHandler(true);
                _utils.Promise.all(list).then(function (resdata) {
                    var menus = [];
                    names.forEach(function (name, index) {
                        var d = resdata[index];
                        if (index == indexDefault) {
                            if (that && that.noDataHandler)
                                that.noDataHandler(!d || d.nodata, null, true);
                        }
                        res[name] = d;
                        if (that) {
                            var ds = that.datasets && that.datasets[name];
                            if (isLoad && ds && ds.$menu && that.updateMenuHandler) {
                                var a = name.split('_');
                                menus.push({ name: a[a.length - 1], data: d });
                            }
                            if (ds) {
                                that.ds_loaded(name, d);
                                if (ds.autoselect) {
                                    return ds.doAutoSelect(d, function (item) {
                                        that.ds_select(name, item);
                                    });
                                }
                            }
                        }
                    });
                    if (that && that.loadingHandler)
                        that.loadingHandler(false);
                    menus.forEach(function (menu) {
                        that.updateMenuHandler(menu.name, menu.data);
                    });
                    after(true);
                    if (that && that.watchersHandler)
                        that.watchersHandler(names);
                    if (!isLoad && notify && that && that.dataChangedHandler)
                        that.dataChangedHandler(names);
                }).catch(function (ex) {
                    if (that && that.loadingHandler)
                        that.loadingHandler(false);
                    if (that && that.errorHandler)
                        that.errorHandler(ex);
                    after(false, ex);
                    if (!isLoad && notify && that && that.dataChangedHandler)
                        that.dataChangedHandler(names);
                });
            }
            else
                after(true);
        };
        var DatasetMethods = (function () {
            function DatasetMethods() {
            }
            DatasetMethods.prototype.ds_init = function (config) {
                var that = this;
                var register = false;
                that.props = that.props || {};
                that.props.data = that.props.data || {};
                that.props.data.ds = {};
                if (config.datasets || config.$resources || config.$schema || config.$menus) {
                    if (that.datasets)
                        that.ds_destroy();
                    var resName = config.$resources || config.$schema;
                    if (resName) {
                        that.props.data.ds.view = null;
                        that.datasets = that.datasets || {};
                        that.datasets.view = new _data.DataSet({
                            $type: "widget-schema",
                            $params: {
                                name: resName,
                                localization: config.$localization
                            }
                        });
                        that.datasets.view.$schema = true;
                    }
                    if (config.$menus) {
                        Object.keys(config.$menus).forEach(function (menuName) {
                            var dn = '$menu_' + menuName;
                            that.props.data.ds[dn] = null;
                            that.datasets = that.datasets || {};
                            that.datasets[dn] = new _data.DataSet({
                                $type: "menu",
                                $params: {
                                    name: config.$menus[menuName] + '-' + menuName
                                }
                            });
                            that.datasets[dn].$menu = true;
                        });
                    }
                    if (config.datasets) {
                        Object.keys(config.datasets).forEach(function (dataset) {
                            that.props.data.ds[dataset] = null;
                            that.datasets = that.datasets || {};
                            var cds = new _data.DataSet(config.datasets[dataset]);
                            that.datasets[dataset] = cds;
                            if (!register) {
                                register = cds.hasCustomEvents() || cds.config.$emit;
                            }
                        });
                    }
                }
                return register;
            };
            DatasetMethods.prototype.ds_storeLastEvent = function (event, value) {
                var that = this;
                that._lastEvent = { event: event, value: value };
            };
            DatasetMethods.prototype.ds_LastEvent = function () {
                var that = this;
                if (that._lastEvent) {
                    var res = that._lastEvent;
                    that._lastEvent = null;
                    return res;
                }
                return null;
            };
            DatasetMethods.prototype.ds_destroy = function () {
                _utils.log("Destroy Dataset Part", "destroy");
                var that = this;
                that._lastEvent = null;
                if (that.datasets) {
                    Object.keys(that.datasets).forEach(function (dataset) {
                        var ds = that.datasets[dataset];
                        ds.destroy();
                    });
                    that.datasets = null;
                }
            };
            DatasetMethods.prototype.ds_context = function () {
                var that = this;
                var map = {
                    $url: _link.search(null, false),
                    $mem: _mem,
                    $local: that.getLocalContextHandler ? that.getLocalContextHandler() : null,
                };
                var datasets = that.props.data.ds;
                if (datasets) {
                    Object.keys(datasets).forEach(function (pn) {
                        map[pn] = datasets[pn];
                    });
                }
                return map;
            };
            DatasetMethods.prototype.ds_reemit = function (listeners, after) {
                var that = this;
                if (that.datasets) {
                    var names = Object.keys(that.datasets);
                    names.forEach(function (name) {
                        var d = that.props.data.ds[name];
                        var ds = that.datasets[name];
                        if (ds.defaultDataset) {
                            if (that.noDataHandler)
                                that.noDataHandler(!d || d.nodata, null, true);
                        }
                        that.ds_loaded(name, d);
                        if (ds.autoselect) {
                            ds.doAutoSelect(d, function (item) {
                                that.ds_select(name, item);
                            });
                        }
                    });
                }
                return after();
            };
            DatasetMethods.prototype.ds_select = function (datasetName, value) {
                var that = this;
                if (that.datasets && that.datasets[datasetName]) {
                    var ds = that.datasets[datasetName];
                    if (ds.config.$emit && that.emitHandler) {
                        if (ds.config.$emit.$changed) {
                            _updateMem(that, ds, value, '$changed');
                        }
                        that.emitHandler(ds.config.$emit.$changed ? ds.config.$emit.$changed.$name : ds.config.$emit, value);
                    }
                }
            };
            DatasetMethods.prototype.ds_loaded = function (datasetName, value) {
                var that = this;
                if (that.datasets && that.datasets[datasetName]) {
                    var ds = that.datasets[datasetName];
                    if (ds.config.$emit && ds.config.$emit.$loaded) {
                        _updateMem(that, ds, value, '$loaded');
                        that.emitHandler(ds.config.$emit.$loaded.$name, value);
                    }
                }
            };
            DatasetMethods.prototype.ds_exec = function (event, context, dst, after, datasets, notify) {
                _ds_exec(this, event, context, dst, after, datasets, notify);
            };
            return DatasetMethods;
        }());
        DatasetPlugin.DatasetMethods = DatasetMethods;
        DatasetPlugin.executeDatasets = function (datasets, context, result, handlers, after, contextByDs) {
            var thisObj = {
                loadingHandler: handlers && handlers.loading ? handlers.loading : null,
                errorHandler: handlers && handlers.error ? handlers.error : null
            };
            _ds_exec(thisObj, '', context, result, after, datasets, false, contextByDs);
        };
    })(DatasetPlugin = Phoenix.DatasetPlugin || (Phoenix.DatasetPlugin = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../core/core.ts" />
/// <reference path="../core/modules/locale.ts" />
var Phoenix;
(function (Phoenix) {
    var WidgetUtils;
    (function (WidgetUtils) {
        //Widget data
        // {$config: {$title, $titleIsHidden, $border, $style, $height, data}}
        var _dom = Phoenix.dom, _utils = Phoenix.utils, _locale = Phoenix.locale, _ulocale = Phoenix.ulocale, _widgetClass = function (cfg, options, selected) {
            var css = ["bs-island bs-widget"];
            _dom.parseStyle(cfg.$style, css);
            if (cfg.$border)
                css.push("border");
            if (options.design)
                css.push("design");
            if (selected)
                css.push("selected");
            return css.join(' ');
        }, _heightText = function (height) {
            if (!height)
                return "";
            var h = ((height + '').indexOf('%') > 0) ? height : (parseInt(height, 10) + 'px');
            return 'height:' + h + ';';
        }, _beforeWidget = function (html, data, options, llocale) {
            html.push('<div class="');
            html.push(_widgetClass(data.$config, options, data.$selected));
            html.push('"');
            if (options.design)
                html.push(' draggable="true"');
            html.push(' data-render="' + data.$id + '"');
            html.push(' id="' + data.$id + '"');
            html.push('>');
            _addTitle(html, data.$id, data.$config, llocale, false);
            html.push('<div class="bs-widget-content bs-widget-content-id"');
            var ht = _heightText(data.$config.$height);
            if (ht)
                html.push(' style="' + ht + '"');
            html.push('>');
        }, _addTitle = function (html, id, data, llocale, forceShowTitle) {
            html.push('<div class="bs-widget-title' + (forceShowTitle ? ' bs-widget-content-inv-x' : '') + (data.$titleIsHidden && !forceShowTitle ? ' bs-none' : '') + '" id="' + id + '_title">');
            var title = _ulocale.localeTitle(data.$title) || '';
            if (llocale)
                title = _ulocale.tt(data.$title || '', llocale);
            html.push(_utils.escapeHtml(title + ' '));
            if (data.icons && data.icons.length && data.links) {
                data.icons.forEach(function (icon) {
                    var l = data.links[icon.link];
                    if (l && l.$icon) {
                        html.push('<a class="bs-widget-title-icon" data-phoenix-href="link://' + icon.link + '">');
                        html.push('<span class="' + _dom.iconClass(l.$icon) + '"></span>');
                        html.push('</a>');
                    }
                });
            }
            html.push('</div>');
        }, _afterWidget = function (html, options) {
            html.push('</div></div>');
        }, _renderWiget = function (html, data, parent, model, options, llocale) {
            _beforeWidget(html, data, options, llocale);
            _afterWidget(html, options);
        }, _toHtml = function (data, options, parent, model, llocale) {
            var html = [];
            _renderWiget(html, data, parent, model, options, llocale);
            return html.join('');
        }, _loader = function () {
            return $('<div class="bs-loader"></div>');
        }, _error = function () {
            return $('<div class="alert alert-danger" role="alert"><span class="' + _dom.iconClass('exclamation-circle') + '" aria-hidden="true"></span><span></span></div>');
        }, _settings = function () {
            return $('<span class="bs-module-settings ' + _dom.iconClass('cog') + '" ></span>');
        }, _warning = function () {
            return $('<div class="alert alert-warning" role="alert"></div>');
        }, _noData = function (message, icon) {
            var html = [];
            var addIcon = icon !== false;
            icon = (icon && icon !== true) || 'cloud';
            html.push('<div class="bs-widget-content nodata">');
            html.push('<div class="bs-no-data-inside">');
            if (addIcon)
                html.push('<center class="nodata-image"><i class="' + _dom.iconClass(icon) + ' nodata-icon"></i></center>');
            html.push('<center><h4 class="nodata-text">');
            html.push(message ? message : _locale.layouts.NoData);
            html.push('</h4></center>');
            html.push('</div>');
            html.push('</div>');
            return $(html.join(''));
        };
        WidgetUtils.toHtml = _toHtml;
        WidgetUtils.cssClass = _widgetClass;
        WidgetUtils.heightText = _heightText;
        WidgetUtils.loader = _loader;
        WidgetUtils.error = _error;
        WidgetUtils.widgetTitle = _addTitle;
        WidgetUtils.settings = _settings;
        WidgetUtils.warning = _warning;
        WidgetUtils.noData = _noData;
    })(WidgetUtils = Phoenix.WidgetUtils || (Phoenix.WidgetUtils = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../core/core.ts" />
/// <reference path="./module.ts" />
/// <reference path="./datasets-plugin.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _dom = Phoenix.dom, _utils = Phoenix.utils, _locale = Phoenix.locale, _wutils = Phoenix.WidgetUtils, _link = Phoenix.link, _render = Phoenix.render;
        var Widget = (function () {
            function Widget(ldata, options, layout) {
                var that = this;
                that.item = ldata || {};
                if (!that.item.$id)
                    that.item.$id = _utils.allocID();
                ldata.$config = ldata.$config || {};
                ldata.$config.data = ldata.$config.data || {};
                that.data = ldata.$config;
                that.props = {};
                that.item.$render = that.props;
                that.props.data = ldata.$config.data;
                that.options = options || {};
                that.contentRender = null;
                that.links = ldata.$config.links;
                that._defineProps();
                that.layout = layout;
                that.$local = {};
                //datasets
                that.loadingHandler = this.loading.bind(that);
                that.noDataHandler = this.noData.bind(that);
                that.errorHandler = this.error.bind(that);
                that.emitHandler = this.emit.bind(that);
                that.getLocalContextHandler = this.getLocalContext.bind(that);
                that.dataChangedHandler = this.dataChanged.bind(that);
                that.updateMenuHandler = null;
                that._watchers = {};
                if (that.props.data.localContext) {
                    $.extend(that.$local, that.props.data.localContext);
                }
                if (that.ds_init(that.data))
                    that._listen();
            }
            //implements DatasetMethods
            Widget.prototype.ds_init = function (config) { return false; };
            Widget.prototype.ds_storeLastEvent = function (event, value) { };
            Widget.prototype.ds_LastEvent = function () { return null; };
            Widget.prototype.ds_destroy = function () { };
            Widget.prototype.ds_context = function () { return null; };
            Widget.prototype.ds_reemit = function (listeners, after) { return null; };
            Widget.prototype.ds_select = function (datasetName, value) { };
            Widget.prototype.ds_loaded = function (datasetName, value) { };
            Widget.prototype.ds_exec = function (event, context, dst, after, datasets, notify) { };
            Widget.prototype._defineProps = function () {
                var self = this, _dp = _utils.defineProperty;
                _dp("$title", self);
                _dp("$border", self);
                _dp("$height", self);
                _dp("$titleIsHidden", self);
                _dp("$settings", self);
            };
            Widget.prototype._notifyChange = function (propertyName) {
                var self = this;
                switch (propertyName) {
                    case "$title":
                        self._updateTitle();
                        break;
                    case "$border":
                    case "$titleIsHidden":
                        self._updateCssClass();
                        break;
                    case "$height":
                        self._updateHeight();
                        break;
                }
            };
            Widget.prototype._listen = function () {
                var that = this;
                if (that.layout) {
                    that.layout.registerDataListener(that);
                }
            };
            Widget.prototype._unlisten = function () {
                var that = this;
                if (that.layout) {
                    that.layout.removeDataListener(that);
                }
            };
            Widget.prototype.on = function (event, hnd) {
                var that = this;
                that.handlers = that.handlers || {};
                that.handlers[event] = hnd;
            };
            Widget.prototype._exec = function (event) {
                var that = this;
                that.handlers && that.handlers[event] && that.handlers[event]();
            };
            Widget.prototype._setEvents = function () {
                var that = this;
                var e = that.$element.get(0);
                that.$element.on('click', function (event) {
                    if (that.$settings && event.target === that.$settings.get(0)) {
                        that._exec('settings');
                    }
                    var c = _link.isCustomLink(e, event);
                    if (c)
                        _link.execCustomProtocol(c, that.ds_context(), {
                            links: that.links
                        }, null);
                });
            };
            Widget.prototype.executeLink = function (href, params) {
                var that = this;
                var c = _link.isCustomProtocol(href);
                if (c)
                    _link.execCustomProtocol({ protocol: c, value: href }, that.ds_context(), {
                        links: that.links
                    }, params);
            };
            Widget.prototype._removeEvents = function () {
                var that = this;
                that.$element.off('click');
            };
            //Called by execdataset
            Widget.prototype.dataChanged = function (datasetNames) {
                var that = this;
                if (that.onDSChanged)
                    that.onDSChanged(datasetNames);
                if (that.contentRender && that.contentRender.dataChanged)
                    that.contentRender.dataChanged();
                else if (that.options.onDataChanged)
                    that.options.onDataChanged();
            };
            Widget.prototype.execDataSet = function (datasets, context, callBack, res, notify) {
                var that = this;
                res = res || that.props.data.ds;
                that.ds_exec(null, context, res, callBack || function () { }, datasets, notify);
            };
            Widget.prototype._loadData = function (after) {
                var that = this;
                if (!that.datasets) {
                    return after(false);
                }
                that.ds_exec("$load", null, that.props.data.ds, after, null, true);
            };
            Widget.prototype._updateTitle = function () {
                var that = this;
                if (that.$element) {
                    var t = _dom.find(that.$element.get(0), that.item.$id + "_title");
                    if (t)
                        _dom.text(t, this.data.$title || '');
                }
            };
            Widget.prototype._cleanErrors = function (endLoading) {
                var that = this;
                if (that.$loader) {
                    that.$loader.remove();
                    that.$loader = null;
                }
                if (!endLoading) {
                    if (that.$settings) {
                        _dom.addClass(that.$settings.get(0), 'bs-none');
                    }
                    if (that.$noData) {
                        that.$noData.remove();
                        that.$noData = null;
                    }
                    if (that.$error) {
                        that.$error.remove();
                        that.$error = null;
                    }
                    if (that.$warning) {
                        that.$warning.remove();
                        that.$warning = null;
                    }
                }
            };
            Widget.prototype.loading = function (show) {
                var that = this;
                that._cleanErrors(!show);
                var e = that.$element ? that.$element.get(0) : null;
                if (e) {
                    if (show) {
                        _dom.addClass(e, "loading");
                        if (!that.$loader) {
                            that.$loader = _wutils.loader();
                            that.$element.append(that.$loader);
                        }
                    }
                    else {
                        _dom.removeClass(e, "loading");
                    }
                }
                if (!show) {
                    that.settings();
                }
            };
            Widget.prototype._linksState = function (show) {
                var that = this;
                if (that.$element) {
                    var e = that.$element.get(0);
                    var t = _dom.find(e, that.item.$id + "_title");
                    if (t) {
                        var matches = _dom.queryAll(t, '.bs-widget-title-icon');
                        [].forEach.call(matches, function (item) {
                            if (show)
                                _dom.removeClass(item, "bs-none");
                            else
                                _dom.addClass(item, "bs-none");
                        });
                    }
                }
            };
            Widget.prototype.noData = function (value, message, icon) {
                var that = this;
                if (!message && that.props.data.$noDataMessage)
                    message = that.props.data.$noDataMessage;
                this._cleanErrors(false);
                if (that.$element) {
                    var e = that.$element.get(0);
                    var cont = _dom.query(e, '.bs-widget-content-id');
                    if (cont) {
                        if (value)
                            _dom.addClass(cont, "bs-none");
                        else
                            _dom.removeClass(cont, "bs-none");
                        that._linksState(!value);
                    }
                    if (value) {
                        that.$noData = _wutils.noData(message, icon);
                        var hasHeight = that._updateHeight(that.$noData);
                        if (hasHeight) {
                            var inside = _dom.query(that.$noData.get(0), '.bs-no-data-inside');
                            _dom.addClass(inside, 'centred');
                        }
                        var t = _dom.find(e, that.item.$id + "_title");
                        if (t)
                            _dom.after(t, that.$noData.get(0));
                    }
                }
            };
            Widget.prototype.getLocalContext = function () {
                return this.$local;
            };
            Widget.prototype.settings = function () {
                var that = this;
                var show = (that.data.$settings && !that.$error && !that.$warning && !that.$noData);
                if (that.$settings) {
                    if (show)
                        _dom.removeClass(that.$settings.get(0), 'bs-none');
                    else
                        _dom.addClass(that.$settings.get(0), 'bs-none');
                    return;
                }
                if (!show)
                    return;
                that.$settings = _wutils.settings();
                var t = _dom.find(that.$element.get(0), that.item.$id + "_title");
                if (t)
                    _dom.after(t, that.$settings.get(0));
            };
            Widget.prototype.error = function (ex) {
                var message = ex;
                if (ex && ex.message) {
                    message = ex.message;
                }
                var that = this;
                this._cleanErrors(false);
                var e = that.$element ? that.$element.get(0) : null;
                if (e) {
                    that.$error = _wutils.error();
                    var ee = that.$error.get(0);
                    _dom.text(ee.lastChild, " " + message);
                    var t = _dom.find(e, that.item.$id + "_title");
                    if (t)
                        _dom.after(t, ee);
                }
            };
            Widget.prototype.warning = function (message) {
                var that = this;
                this._cleanErrors(false);
                var e = that.$element ? that.$element.get(0) : null;
                if (e) {
                    that.$warning = _wutils.warning();
                    var ee = that.$warning.get(0);
                    _dom.text(ee, message);
                    var t = _dom.find(e, that.item.$id + "_title");
                    if (t)
                        _dom.after(t, ee);
                }
            };
            Widget.prototype._updateHeight = function ($e) {
                var that = this;
                $e = $e || that.$element;
                var e = $e ? $e.get(0) : null;
                if (e)
                    e.style.cssText = _wutils.heightText(that.props.$height);
                return (that.props.$height ? true : false);
            };
            Widget.prototype._updateCssClass = function () {
                var that = this;
                var e = that.$element ? that.$element.get(0) : null;
                if (e)
                    e.className = _wutils.cssClass(that.data, that.options);
            };
            Widget.prototype._internalRenderContent = function ($content, append, async) {
                var that = this, Cr = _render.get(that.options.context, "widget.content.control." + that.data.$type);
                if (!that.$element)
                    return;
                if (Cr) {
                    that.contentRender = new Cr(that.props, {
                        context: that.options.context,
                        replaceParent: false,
                    }, this);
                }
                else {
                    var htmlRender = _render.get(that.options.context, "widget.content");
                    if (htmlRender) {
                        var html = [];
                        htmlRender(html, that.data, that.options);
                        $content.append($(html.join('')));
                    }
                }
                if (that.options.beforeAdd)
                    that.options.beforeAdd($content, async);
                if (that.contentRender)
                    that.contentRender.render($content);
                if (append)
                    that.$element.append($content);
            };
            Widget.prototype.watchersHandler = function (names) {
                var that = this;
                if (names)
                    names.forEach(function (name) {
                        var wbyds = that._watchers[name];
                        if (wbyds) {
                            wbyds.forEach(function (watcher) {
                                watcher(that.props.data.ds[that.props.data.ds[name]]);
                            });
                        }
                        //console.log(name + ' data changed');
                    });
            };
            Widget.prototype.render = function ($parent) {
                var that = this;
                that.$loader = null;
                that.$error = null;
                if (!that.$element) {
                    that.layout.controls[that.item.$id] = this;
                    that.$element = $(_wutils.toHtml(that.item, that.options, null, null, null));
                    that._setEvents();
                    var e = that.$element.get(0);
                    var cont = _dom.query(e, '.bs-widget-content-id');
                    that._loadData(function (async) {
                        that._internalRenderContent($(cont), false, async);
                        that.settings();
                    });
                    if ($parent) {
                        if (that.options.replaceParent)
                            $parent.replaceWith(that.$element);
                        else
                            $parent.append(that.$element);
                    }
                }
            };
            /* Start datasets methods*/
            Widget.prototype.emit = function (eventName, value, filter) {
                var that = this;
                if (that.layout) {
                    that.layout.emitDataEvent(eventName, value, filter);
                }
            };
            /* End datasets methods*/
            Widget.prototype.dataEvent = function (eventName, value) {
                var that = this;
                that.ds_exec(eventName, value, that.props.data.ds, function () { }, null, true);
            };
            Widget.prototype.destroy = function () {
                _utils.log("Destroy Module", "destroy");
                var that = this;
                if (that.contentRender) {
                    that.contentRender.destroy();
                    that.contentRender = null;
                }
                that._unlisten();
                that.ds_destroy();
                that._cleanErrors(false);
                that.item.$render = null;
                if (that.$settings)
                    that.$settings = null;
                if (that.$element) {
                    that._removeEvents();
                    that.$element = null;
                }
                that.layout = null;
                that.ondatasets = null;
            };
            Widget.prototype.watch = function (dsName, cb) {
                var that = this;
                if (that._watchers) {
                    var wbyds = that._watchers[dsName] = that._watchers[dsName] || [];
                    wbyds.push(cb);
                    if (that.props && that.props.data.ds) {
                        Phoenix.utils.nextTick(function () {
                            cb(that.props.data.ds[dsName]);
                        });
                    }
                }
            };
            Widget.prototype.unwatch = function (dsName, cb) {
                var that = this;
                if (that._watchers) {
                    var wbyds = that._watchers[dsName];
                    if (wbyds) {
                        var ii = wbyds.indexOf(cb);
                        if (ii >= 0)
                            wbyds.splice(ii, 1);
                    }
                }
            };
            return Widget;
        }());
        ui.Widget = Widget;
        _utils.applyMixins(Widget, [Phoenix.DatasetPlugin.DatasetMethods]);
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../core/core.ts" />
/// <reference path="./datasets-plugin.ts" />
/// <reference path="./page.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _utils = Phoenix.utils, _ulocale = Phoenix.ulocale, _link = Phoenix.link, _mem = Phoenix.$mem, _dom = Phoenix.dom;
        var MenuBase = (function () {
            function MenuBase(data, options) {
                this._initOptions(options);
                this.init(data, options);
            }
            //implements DatasetMethods
            MenuBase.prototype.ds_init = function (config) { return false; };
            MenuBase.prototype.ds_storeLastEvent = function (event, value) { };
            MenuBase.prototype.ds_LastEvent = function () { return null; };
            MenuBase.prototype.ds_destroy = function () { };
            MenuBase.prototype.ds_context = function () { return null; };
            MenuBase.prototype.ds_reemit = function (listeners, after) { return null; };
            MenuBase.prototype.ds_select = function (datasetName, value) { };
            MenuBase.prototype.ds_loaded = function (datasetName, value) { };
            MenuBase.prototype.ds_exec = function (event, context, dst, after, datasets, notify) { };
            MenuBase.prototype._initOptions = function (options) { };
            /* Start datasets methods*/
            MenuBase.prototype.emit = function (eventName, value, filter) {
                this.emitDataEvent(eventName, value, filter);
            };
            /* End datasets methods*/
            MenuBase.prototype.init = function (data, options) {
                _utils.log("Create Menu", "menu");
                var that = this;
                //datasets
                that.loadingHandler = this.loading.bind(that);
                that.noDataHandler = null;
                that.errorHandler = null;
                that.emitHandler = this.emit.bind(that);
                that.getLocalContextHandler = null;
                that.dataChangedHandler = null;
                that.updateMenuHandler = null;
                that.$element = null;
                that.$items = null;
                that.options = options || {};
                that.options.typeMenu = that.options.type || "left";
                that.data = {
                    name: "none"
                };
                that.page = ui.Page();
                that.page.addChild('menu-' + that.options.typeMenu, that);
                that.setMenu(data);
            };
            MenuBase.prototype.loading = function (show) {
                this.page.loading(show);
            };
            MenuBase.prototype.registerDataListener = function (value) {
                var that = this;
                if (that.page)
                    that.page.registerDataListener(value, that);
            };
            MenuBase.prototype.removeDataListener = function (listener) {
                var that = this;
                if (that.page) {
                    that.page.removeDataListener(listener);
                }
            };
            MenuBase.prototype.emitDataEvent = function (event, value, filter) {
                var that = this;
                if (that.page)
                    that.page.emitDataEvent(event, value, filter);
            };
            MenuBase.prototype.onPageChange = function (propName, value) {
                var that = this;
                if (propName == "$user" && that.items) {
                    if (that.options.auth && !that.options.autoClose) {
                        var show = that.page.props.$user && that.page.props.$user.connected;
                        if (show) {
                            var pp = _dom.find(null, that.options.parentId);
                            if (pp) {
                                that.show($(pp));
                            }
                            else {
                                that._showContent();
                            }
                        }
                        else if (that.$content && !show) {
                            that._hideContent();
                        }
                    }
                }
            };
            MenuBase.prototype.setMenu = function (data) {
                _utils.log("Set Menu", "menu");
                var that = this, hasMenu = data != null;
                data = data || {
                    name: "none"
                };
                if (!data.$groups) {
                    data.$groups = [{
                            $items: data.$items
                        }];
                    delete data.$items;
                }
                if (this.data.name !== data.name) {
                    _utils.log("Menu create && execute datasets", "menu");
                    that.data = data;
                    that.items = null;
                    that._recreateDatasets();
                    that.ds_exec("$load", null, that.props.data.ds, function () {
                        var doShow = !that.options.autoClose && that.options.parentId && hasMenu;
                        if (doShow && that.options.auth) {
                            doShow = that.page.props.$user && that.page.props.$user.connected;
                        }
                        that._prepareItems();
                        if (that.$content) {
                            that._removeContent();
                            if (hasMenu) {
                                if (doShow) {
                                    var parent = _dom.find(null, that.options.parentId);
                                    if (parent) {
                                        that.render();
                                        that.show($(parent));
                                    }
                                }
                                else
                                    that.render();
                            }
                            else
                                that._hideContent();
                        }
                        else {
                            if (doShow) {
                                var pp = _dom.find(null, that.options.parentId);
                                if (pp) {
                                    that.show($(pp));
                                }
                            }
                        }
                        that.page.props["$menu" + that.options.typeMenu] = hasMenu && that.options.autoClose;
                    }, null, true);
                }
                else {
                    _utils.log("Menu reexecute datasets", "menu");
                    that.ds_reemit(null, function () {
                        that._onPageChanged();
                        that.page.props["$menu" + that.options.typeMenu] = hasMenu && that.options.autoClose;
                    });
                }
            };
            MenuBase.prototype._onPageChanged = function () { };
            MenuBase.prototype._doCloseClick = function () { };
            MenuBase.prototype._menuShowed = function () { };
            MenuBase.prototype._executeLink = function (item, link) { };
            MenuBase.prototype._setEvents = function () {
                var that = this;
                var e = that.$content.get(0);
                that.$content.on('click', function (event) {
                    var c = _link.isCustomLink(e, event);
                    if (c && c.protocol == "click") {
                        var cs = c.value.substring(('click://').length);
                        if (cs == "close") {
                            if (that._doCloseClick)
                                return that._doCloseClick();
                        }
                        else {
                            var ii = cs.split('/');
                            that._executeLink(that.items[parseInt(ii[0], 10)], ii.length > 1 ? ii[1] : null);
                        }
                    }
                    if (that.options.autoClose) {
                        that.hide();
                    }
                });
            };
            MenuBase.prototype.renderItems = function ($content) {
                return null;
            };
            MenuBase.prototype._removeEvents = function () {
                var that = this;
                that.$content.off('click');
            };
            MenuBase.prototype._loadData = function (after) {
                var that = this;
                if (!that.datasets) {
                    return after(false);
                }
                that.ds_exec("$load", null, that.props.data.ds, after, null, true);
            };
            MenuBase.prototype._expandItem = function (item, url, mem, itemtitle, link, index) {
                var ii = { $title: '', $item: item, $index: index, $link: link };
                ii.$title = _utils.parseVariable(itemtitle, {
                    $item: item,
                    $url: url,
                    $mem: mem
                });
                return ii;
            };
            MenuBase.prototype._expandDatasetItems = function (dataset, itemtitle, link) {
                var that = this;
                var data = that.props.data.ds[dataset];
                if (data) {
                    var items = [];
                    var url = _link.search(null, false);
                    var mem = _mem;
                    if (data.documents) {
                        if (data.documents.length) {
                            data.documents.forEach(function (item, index) {
                                items.push(that._expandItem(item, url, mem, itemtitle, link, index));
                            });
                        }
                        else
                            return null;
                    }
                    else {
                        items.push(that._expandItem(data, url, mem, itemtitle, link, -1));
                    }
                    return items;
                }
                return null;
            };
            MenuBase.prototype.copyMenuItemData = function (dst, src) { };
            MenuBase.prototype._prepareItems = function () {
                var that = this;
                that.items = [];
                if (that.data.$groups) {
                    var first = true;
                    that.data.$groups.forEach(function (group) {
                        var items = null;
                        if (group.$dataset) {
                            if (!group.$link) {
                                throw "Invalid link definition. (no link)";
                            }
                            if (!group.$itemtitle) {
                                throw "Invalid link definition. (no itemtitle)";
                            }
                            items = that._expandDatasetItems(group.$dataset, group.$itemtitle, group.$link);
                        }
                        else
                            items = group.$items;
                        if (items && items.length) {
                            if (!first || group.$title || group.$dataset) {
                                var d = {
                                    divider: true,
                                    $title: null,
                                    dataset: '',
                                    isHidden: false
                                };
                                if (group.$title)
                                    d.$title = group.$title;
                                if (group.dataset) {
                                    d.dataset = group.$dataset;
                                    if (first)
                                        d.isHidden = true;
                                }
                                that.items.push(d);
                                first = false;
                            }
                        }
                        if (items) {
                            var ds = group.$dataset ? that.datasets[group.$dataset] : null;
                            items.forEach(function (item, index) {
                                var mitem = {
                                    $title: item.$title ? _utils.parseExpression(item.$title, _link.context()) : null,
                                    $dataset: null,
                                    dataset: null,
                                    $index: 0,
                                    $item: null,
                                    $link: null,
                                    $level: item.$level,
                                    selected: false
                                };
                                if (group.dataset) {
                                    mitem.dataset = group.$dataset;
                                }
                                if (item.$link)
                                    mitem.$link = item.$link;
                                if (ds && ds.autoselect)
                                    mitem.selected = ds.selectedIndex == index;
                                that.copyMenuItemData(mitem, item);
                                if (ds) {
                                    mitem.$dataset = group.$dataset;
                                    mitem.$index = item.$index;
                                    mitem.$item = item.$item;
                                }
                                that.items.push(mitem);
                                first = false;
                            });
                        }
                    });
                }
            };
            MenuBase.prototype._removeContent = function () {
                if (this.$element) {
                    this.$element.remove();
                    this.$element = null;
                }
            };
            MenuBase.prototype.renderContent = function () {
                return $('<aside></aside>');
            };
            MenuBase.prototype.show = function ($parent) {
                var that = this;
                if (that.$content) {
                    that._showContent();
                }
                else {
                    that.render($parent);
                    that._showContent();
                }
                if (that.options.autoClose) {
                    that.page.setPopup(that);
                }
            };
            MenuBase.prototype.hide = function (autoCloseChanged) {
                var that = this;
                if (!that.$content)
                    return;
                that._hideContent(autoCloseChanged);
            };
            MenuBase.prototype._hideContent = function (autoCloseChanged) {
                var that = this;
                var c = that.$content.get(0);
                _dom.addClass(c, "bs-none");
            };
            MenuBase.prototype._showContent = function () {
                var that = this;
                var c = that.$content.get(0);
                _dom.removeClass(c, "bs-none");
                that._menuShowed();
            };
            MenuBase.prototype.render = function ($parent) {
                var that = this;
                var $content = that.$content;
                //
                if (!$content) {
                    $content = that.renderContent();
                }
                if (!that.$element) {
                    that.$element = that.renderItems($content);
                    $content.append(this.$element);
                }
                if ($parent && !that.$content) {
                    that.$content = $content;
                    if (that.options.replaceParent) {
                        var p = $parent.get(0);
                        if (p && p.id) {
                            var c = that.$content.get(0);
                            if (c)
                                c.id = p.id;
                        }
                        $parent.replaceWith(that.$content);
                    }
                    else
                        $parent.append(that.$content);
                    that._setEvents();
                }
            };
            MenuBase.prototype._recreateDatasets = function () {
                var that = this;
                that.ds_destroy();
                that.removeDataListener(that);
                if (that.ds_init(that.data)) {
                    that.registerDataListener(that);
                }
            };
            MenuBase.prototype.destroy = function () {
                var that = this;
                _utils.log("Destroy Menu", "destroy");
                that.ds_destroy();
                that.removeDataListener(that);
                if (that.$content) {
                    that._removeEvents();
                    this.$content = null;
                }
                this.$element = null;
                if (that.page) {
                    that.page.removeChild(that);
                    that.page = null;
                }
            };
            MenuBase.prototype.inPopup = function (element) {
                var that = this;
                if (!that.options.autoClose)
                    return true;
                if (!element)
                    return true;
                if (that.$content) {
                    var p = that.$content.get(0);
                    var e = element;
                    while (e) {
                        if (e == p)
                            return true;
                        e = e.parentNode;
                    }
                }
                return false;
            };
            return MenuBase;
        }());
        ui.MenuBase = MenuBase;
        _utils.applyMixins(MenuBase, [Phoenix.DatasetPlugin.DatasetMethods]);
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../core/core.ts" />
/// <reference path="./datasets-plugin.ts" />
/// <reference path="./menu-base.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _link = Phoenix.link, _preferences = Phoenix.preferences, _application = Phoenix.application, _device = Phoenix.device, _utils = Phoenix.utils, _dom = Phoenix.dom;
        var Menu = (function (_super) {
            __extends(Menu, _super);
            function Menu(ldata, options) {
                _super.call(this, ldata, options);
            }
            Menu.prototype._initOptions = function (options) {
                var headerConfig = _application.configuration.header || {};
                options = options || {};
                options.replaceParent = true;
                options.canStayInPage = (_device.phone || _device.tablet ? false : true);
                options.autoClose = options.canStayInPage ? _preferences("menu_" + options.type + "_autoClose") : true;
                if (options.autoClose === undefined)
                    options.autoClose = true;
                options.auth = headerConfig.authLeftMenu;
            };
            Menu.prototype._hideContent = function (autoCloseChanged) {
                var that = this;
                var c = that.$content.get(0);
                if (that.options.bodyId) {
                    var body = _dom.find(null, that.options.bodyId);
                    if (body)
                        _dom.removeClass(body, "bs-pc-body-" + that.options.typeMenu);
                }
                _dom.removeClass(c, "bs-menu-opened");
                _dom.addClass(c, "bs-menu-closed");
                if (that.options.bodyId && (!that.options.autoClose || (autoCloseChanged && that.options.autoClose))) {
                    _utils.nextTick(function () {
                        $(window).trigger('phoenix-resize');
                        $(window).trigger('gobal-phoenix-resize');
                    });
                }
            };
            Menu.prototype._showContent = function () {
                var that = this;
                var c = that.$content.get(0);
                var doresize = false;
                if (that.options.bodyId && !that.options.autoClose) {
                    doresize = true;
                    var body = _dom.find(null, that.options.bodyId);
                    if (body)
                        _dom.addClass(body, "bs-pc-body-" + that.options.typeMenu);
                }
                _dom.removeClass(c, "bs-menu-closed");
                _dom.addClass(c, "bs-menu-opened");
                if (that.options.canStayInPage) {
                    _dom.addClass(c, "large");
                }
                else {
                    _dom.addClass(c, "phone");
                }
                if (doresize)
                    _utils.nextTick(function () {
                        $(window).trigger('phoenix-resize');
                        $(window).trigger('gobal-phoenix-resize');
                    });
            };
            Menu.prototype._switchAutoClose = function () {
                var that = this;
                var nv = !!!_preferences("menu_" + that.options.type + "_autoClose");
                _preferences("menu_" + that.options.type + "_autoClose", nv);
                that.options.autoClose = nv;
                return that._updateCloseButton(that.$content);
            };
            Menu.prototype._doCloseClick = function () {
                var that = this;
                if (!that.options.canStayInPage) {
                    that.hide();
                    return;
                }
                if (that._switchAutoClose()) {
                    that.hide(true);
                }
                else {
                    that._showContent();
                }
                that.page.props["$menu" + that.options.typeMenu] = that.options.autoClose;
            };
            Menu.prototype.copyMenuItemData = function (dst, src) {
                dst.$icon = src.$icon;
            };
            Menu.prototype._updateCloseButton = function ($content) {
                var that = this;
                var doclose = false;
                var c = $content.get(0);
                var btn = _dom.query(c, '.bs-menu-button');
                var btnIcon = _dom.query(c, '.bs-icon');
                if (that.options.canStayInPage) {
                    _dom.removeClass(btnIcon, _dom.iconClass('times', true));
                    if (that.options.autoClose) {
                        _dom.removeClass(btnIcon, _dom.iconClass('times-circle-o', true));
                        _dom.addClass(btnIcon, 'small');
                        _dom.addClass(btnIcon, _dom.iconClass('thumb-tack', true));
                        doclose = true;
                    }
                    else {
                        _dom.removeClass(btnIcon, _dom.iconClass('thumb-tack', true));
                        _dom.removeClass(btnIcon, 'small');
                        _dom.addClass(btnIcon, _dom.iconClass('times-circle-o', true));
                    }
                    _dom.removeClass(btn, "bs-none");
                }
                else {
                    _dom.removeClass(btnIcon, _dom.iconClass('thumb-tack', true));
                    _dom.removeClass(btnIcon, _dom.iconClass('times-circle-o', true));
                    _dom.addClass(btnIcon, _dom.iconClass('times', true));
                    _dom.removeClass(btn, "bs-none");
                }
                return doclose;
            };
            Menu.prototype.renderContent = function () {
                var that = this;
                var opts = that.options;
                var $content = $('<div class="bs-menu-wrap bs-menu-animate bs-menu-closed bs-menu-' + opts.typeMenu
                    + '-wrap"><div class="bs-menu-button bs-none bs-menu-' + opts.typeMenu +
                    '-close"><a class="bs-xclose" href="#" data-phoenix-href="click://close"><span class="bs-icon ' +
                    _dom.iconPrefix() + '"></span></a></div></div>');
                that._updateCloseButton($content);
                return $content;
            };
            Menu.prototype._changeSelected = function (item) {
                var that = this;
                if (that.$element) {
                    var e = that.$element.get(0).childNodes[item.$childIndex];
                    if (item.selected)
                        _dom.addClass(e, "active");
                    else
                        _dom.removeClass(e, "active");
                }
            };
            Menu.prototype._selectDatasetItem = function (dataset, item) {
                var that = this;
                that.items.forEach(function (ii) {
                    if (ii.$dataset === dataset) {
                        if (ii == item) {
                            if (!ii.selected) {
                                ii.selected = true;
                                that._changeSelected(ii);
                            }
                        }
                        else if (ii.selected) {
                            ii.selected = false;
                            that._changeSelected(ii);
                        }
                    }
                });
            };
            Menu.prototype._canClick = function (item) {
                return item.$link;
            };
            Menu.prototype.render = function ($parent) {
                _super.prototype.render.call(this, $parent);
                this._onPageChanged();
            };
            Menu.prototype.renderItems = function () {
                var that = this;
                var $element = $('<ul class="bs-item-list"></ul>');
                var e = $element.get(0);
                var ci = $('<li><a class="link"><span class="title"></span></a></li>').get(0);
                var cp = $('<li class="parent"><span class="title"></span></li>').get(0);
                var ch = $('<li class="divider"></li>').get(0);
                if (that.items) {
                    var cn = 0;
                    var len = that.items.length;
                    that.items.forEach(function (item, index) {
                        if (item.isHidden)
                            return;
                        var tmp;
                        if (item.divider) {
                            tmp = ch.cloneNode(true);
                            if (item.$title)
                                _dom.text(tmp, item.$title);
                            else
                                _dom.addClass(tmp, "empty");
                        }
                        else {
                            var isParent = false;
                            if (index < len - 1) {
                                var nc = that.items[index + 1];
                                isParent = ((nc.$level || 0) > (item.$level || 0));
                            }
                            var isLink = !!item.$link;
                            tmp = isLink ? ci.cloneNode(true) : cp.cloneNode(true);
                            if (item.$level) {
                                _dom.addClass(tmp, "level");
                                _dom.addClass(tmp, "level-" + item.$level);
                            }
                            else if (isParent) {
                                _dom.addClass(tmp, "level");
                            }
                            var aa = tmp.firstChild;
                            var ii = isLink ? aa.firstChild : aa;
                            if (item.$title) {
                                var ct = (item.$icon ? ' ' + item.$title : item.$title);
                                _dom.text(ii, ct);
                            }
                            if (item.selected) {
                                _dom.addClass(tmp, "active");
                            }
                            if (isLink) {
                                _dom.attr(aa, "data-phoenix-href", "click://" + index);
                                if (!that._canClick(item)) {
                                    _dom.removeClass(aa, "link");
                                }
                            }
                            if (item.$icon) {
                                var icon = _dom.icon(item.$icon);
                                aa.insertBefore(icon, aa.firstChild);
                            }
                        }
                        e.appendChild(tmp);
                        item.$childIndex = cn;
                        cn++;
                    });
                }
                return $element;
            };
            Menu.prototype._executeLink = function (item, link) {
                var that = this;
                var ctx = _link.context(), ds;
                if (item.$dataset) {
                    ds = that.datasets[item.$dataset];
                    ctx.$item = item.$item;
                }
                if (ds && item.$link && item.$link.$datasetSelect) {
                    if (ds.selectedIndex != item.$index) {
                        ds.selectedIndex = item.$index;
                        that.ds_select(item.$dataset, item.$item);
                        that._selectDatasetItem(item.$dataset, item);
                    }
                }
                else if (item.$link)
                    return _link.execLink(item.$link, ctx, null);
            };
            Menu.prototype._onPageChanged = function () {
                var that = this;
                if (!that.$element)
                    return;
                if (that.items) {
                    var cp = that.page.currentPage();
                    that.items.forEach(function (item, index) {
                        if (item.$link && item.$link.$page) {
                            var page = _link.pageName(item.$link);
                            var selected = page == cp;
                            if (selected && item.$link.$module)
                                selected = item.$link.$module === _application.name;
                            if (item.selected != selected) {
                                item.selected = selected;
                                that._changeSelected(item);
                            }
                        }
                    });
                }
            };
            return Menu;
        }(ui.MenuBase));
        ui.Menu = Menu;
        ;
        ui.Menuleft = Menu;
        ui.Menuright = Menu;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../core/core.ts" />
/// <reference path="../core/modules/application.ts" />
/// <reference path="../core/modules/locale.ts" />
/// <reference path="./page.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _dom = Phoenix.dom, _link = Phoenix.link, _utils = Phoenix.utils, _application = Phoenix.application, _ulocale = Phoenix.ulocale, _locale = Phoenix.locale;
        var Tabs = (function () {
            function Tabs(options, tabs) {
                var that = this, defOptions = {
                    justified: false,
                    pills: false
                };
                that._page = ui.Page();
                that._options = $.extend(defOptions, options || {});
                that._tabs = tabs || [];
            }
            Tabs.prototype._renderTabs = function () {
                var that = this;
                var e = that.$element.get(0);
                var ul = e.firstChild;
                var frag = document.createDocumentFragment();
                var p = $('<li><a href="#"></a><li>').get(0);
                var cp = that._page.currentPage();
                that._tabs.forEach(function (tab, index) {
                    var ii = p.cloneNode(true);
                    var aa = ii.firstChild;
                    _dom.text(aa, _ulocale.localeTitle(tab.$title));
                    var isDisabled = false;
                    if (tab.enabled !== undefined) {
                        if (typeof tab.enabled == "string") {
                            var sval = _utils.execAngularExpression(tab.enabled, _link.context());
                            if (!sval || sval === "undefined" || sval === "false")
                                isDisabled = true;
                        }
                        else {
                            isDisabled = !tab.enabled;
                        }
                    }
                    if (isDisabled) {
                        _dom.addClass(ii, 'disabled');
                    }
                    else
                        _dom.attr(aa, "data-phoenix-href", "click://" + index);
                    if (tab.$page) {
                        var page = _link.pageName(tab);
                        var selected = page == cp;
                        if (selected && tab.$module)
                            selected = tab.$module === _application.name;
                        if (selected)
                            tab.active = true;
                        else
                            tab.active = false;
                    }
                    if (tab.active)
                        _dom.addClass(ii, 'active');
                    frag.appendChild(ii);
                });
                _dom.empty(ul);
                _dom.append(ul, frag);
            };
            Tabs.prototype._setEvents = function () {
                var that = this;
                if (that.$element) {
                    var e = that.$element.get(0);
                    that.$element.on('click', function (event) {
                        var c = _link.isCustomLink(e, event);
                        if (c && c.protocol == "click") {
                            var cs = c.value.substring(('click://').length);
                            var ii = cs.split('/');
                            var ctx = _link.context();
                            var ctab = that._tabs[parseInt(ii[0], 0)];
                            if (ctab && ctab.$page && !ctab.disabled) {
                                _link.execLink(ctab, ctx, null);
                            }
                        }
                    });
                }
            };
            Tabs.prototype._removeEvents = function () {
                var that = this;
                if (that.$element)
                    that.$element.off('click');
            };
            Tabs.prototype.render = function ($parent) {
                var that = this;
                if (!that.$element) {
                    that.$element = $('<div class="bs-widget-content-inv bs-tabs"><ul class="nav nav-tabs"><ul></div>');
                    that._renderTabs();
                    that._setEvents();
                }
                if ($parent) {
                    if (that._options.replaceParent)
                        $parent.replaceWith(that.$element);
                    else
                        $parent.append(that.$element);
                }
            };
            Tabs.prototype.destroy = function () {
                var that = this;
                that._removeEvents();
                that.$element = null;
                that._options = null;
                that._page = null;
            };
            return Tabs;
        }());
        ui.Tabs = Tabs;
        ;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../core/core.ts" />
var Phoenix;
(function (Phoenix) {
    var LayoutUtils;
    (function (LayoutUtils) {
        LayoutUtils.LAYOUT_BLOCK = 'block';
        LayoutUtils.LAYOUT_ROW = 'row';
        LayoutUtils.LAYOUT_COLUMN = 'column';
        LayoutUtils.LAYOUT_HTML = 'html';
        LayoutUtils.LAYOUT_ACCORDION = 'accordion';
        LayoutUtils.LAYOUT_ACCORDION_GROUP = 'accordion-group';
        var EMPTY_TITLE = 'No title';
        var _dom = Phoenix.dom, _utils = Phoenix.utils, _locale = Phoenix.locale.layouts, _ulocale = Phoenix.ulocale, _render = Phoenix.render, _markEmptyRowAsBlock = function (layout) {
            if (!layout.$items.length) {
                layout.$type = LayoutUtils.LAYOUT_BLOCK;
                layout.$origin = LayoutUtils.LAYOUT_ROW;
            }
        }, _checkLayout = function (layout, parent, map, namedMap) {
            if (!layout.$id)
                layout.$id = _utils.allocID();
            if (parent)
                layout.$parentId = parent.$id;
            layout.$idDesign = layout.$id;
            layout.$idDrag = layout.$id;
            layout.$type = layout.$type || LayoutUtils.LAYOUT_BLOCK;
            layout.$items = layout.$items || [];
            if (!_onlyFields(layout)) {
                delete layout.$inline;
                delete layout.$fieldsOptions;
            }
            if (map)
                map[layout.$id] = layout;
            if (namedMap && layout.$name)
                namedMap[layout.$name] = layout;
            if (layout.$type === LayoutUtils.LAYOUT_HTML && !layout.$html) {
                layout.$html = _locale.Html;
            }
            switch (layout.$type) {
                case LayoutUtils.LAYOUT_ROW:
                    _markEmptyRowAsBlock(layout);
                    break;
            }
            if (layout.$origin && layout.$origin === layout.$type)
                delete layout.$origin;
            if (layout.$type !== LayoutUtils.LAYOUT_ACCORDION_GROUP && layout.$title && layout.$title.value === EMPTY_TITLE)
                delete layout.$title;
        }, _layoutIsVisible = function (layout) {
            if (layout.$type === LayoutUtils.LAYOUT_ACCORDION_GROUP) {
                return layout.opened;
            }
            return true;
        }, _checkField = function (field, parent, map, namedMap) {
            if (!field.$id)
                field.$id = _utils.allocID();
            if (parent)
                field.$parentId = parent.$id;
            field.$idDrag = field.$id;
            if (map)
                map[field.$id] = field;
            if (namedMap && field.$name)
                namedMap[field.$name] = field;
        }, _checkRowChilds = function (layout) {
            _markEmptyRowAsBlock(layout);
            var setCol = false;
            layout.$items.forEach(function (item) {
                item.$type = LayoutUtils.LAYOUT_COLUMN;
                if (!item.$colSize)
                    setCol = true;
            });
            if (setCol) {
                var value = Math.max(1, Math.floor(12 / layout.$items.length));
                var li = layout.$items.length - 1;
                var all = 0;
                layout.$items.forEach(function (item, index) {
                    if (index === li) {
                        value = 12 - all;
                    }
                    item.$colSize = value;
                    all += value;
                });
            }
        }, _checkAccordionChilds = function (layout) {
            if (!layout.$items.length) {
                layout.$items.push({
                    $type: LayoutUtils.LAYOUT_ACCORDION_GROUP
                });
            }
            layout.$items.forEach(function (item, index) {
                item.$type = LayoutUtils.LAYOUT_ACCORDION_GROUP;
                item.$title = item.$title || {};
                item.$title.value = item.$title.value || EMPTY_TITLE;
            });
        }, _canAddLayouts = function (layout) {
            if (layout.$type === LayoutUtils.LAYOUT_HTML)
                return false;
            if (layout.$items.length > 0) {
                var l = layout.$items[0];
                if (!l.$items)
                    return false;
            }
            return true;
        }, 
        /*
        _hasBorder = function(layout) {
        },
        */
        _needParentPadding = function (layout, parent) {
            return (layout.$type === LayoutUtils.LAYOUT_ACCORDION && !layout.$widget);
        }, _noPadding = function (layout, parent) {
            var res = true;
            if (!layout.$items.length)
                return res;
            if (layout.$type === LayoutUtils.LAYOUT_ACCORDION_GROUP && !layout.$widget)
                return false;
            layout.$items.forEach(function (item) {
                if (res)
                    res = !_needParentPadding(item, layout);
            });
            return res;
        }, _canAddFields = function (layout) {
            if (layout.$type && !layout.$items)
                layout.$items = [];
            if ((layout.$type === LayoutUtils.LAYOUT_ROW) || (layout.$type === LayoutUtils.LAYOUT_ACCORDION) || (layout.$type === LayoutUtils.LAYOUT_HTML))
                return false;
            if (layout.$items.length > 0) {
                var l = layout.$items[0];
                if (l.$type || l.$items)
                    return false;
            }
            return true;
        }, _addStdThemes = function (layout, css, options) {
            _dom.parseStyle(layout.$style, css);
            if (!options.design && layout.$isHidden) {
                css.push('bs-none');
            }
        }, _onlyFields = function (layout) {
            return !layout.$items || !layout.$items.length || layout.$items[0].$bind;
        }, _css = function (layout, parent, options) {
            var css = [], canAddLayouts, addpaddingclass;
            switch (layout.$type) {
                case LayoutUtils.LAYOUT_BLOCK:
                    addpaddingclass = true;
                    if (options.design && layout.selected) {
                        css.push('selected');
                    }
                    canAddLayouts = _canAddLayouts(layout);
                    if (canAddLayouts) {
                        if (options.design || _noPadding(layout, parent)) {
                            addpaddingclass = false;
                            if (parent)
                                css.push('no-x-padding');
                        }
                        if (options.design) {
                            css.push('drop-layouts-zone');
                            if (layout.$origin === LayoutUtils.LAYOUT_ROW) {
                                css.push('row-color');
                            }
                        }
                    }
                    if (_canAddFields(layout)) {
                        if (layout.$inline && (options.design || !layout.$html))
                            css.push('form-inline bs-inline-container');
                        if (options.design) {
                            css.push('drop-fields-zone');
                            if (!canAddLayouts) {
                                addpaddingclass = false;
                                if (parent)
                                    css.push('no-x-padding');
                            }
                        }
                    }
                    if (addpaddingclass) {
                        css.push('field-container');
                    }
                    if (!parent) {
                        css.push('bs-root-container');
                        if (!layout.form)
                            css.push('page');
                    }
                    if (options.design) {
                        css.push('design');
                        if (layout.selected)
                            css.push('selected');
                    }
                    _addStdThemes(layout, css, options);
                    break;
                case LayoutUtils.LAYOUT_ACCORDION:
                    if (options.step === 1) {
                        css.push('panel-group bs-island');
                        if (options.design) {
                            css.push('design');
                            css.push('drop-layouts-zone');
                            if (layout.selected)
                                css.push('selected');
                        }
                        _addStdThemes(layout, css, options);
                    }
                    break;
                case LayoutUtils.LAYOUT_ROW:
                    if (options.step === 1) {
                        css.push('container-fluid');
                        if (options.design) {
                            css.push('design');
                            css.push('no-x-padding');
                            if (layout.selected)
                                css.push('selected');
                        }
                        _addStdThemes(layout, css, options);
                    }
                    else if (options.step === 2) {
                        css.push(LayoutUtils.LAYOUT_ROW);
                        if (options.design) {
                            css.push('design-table');
                            css.push('row-color');
                            canAddLayouts = _canAddLayouts(layout);
                            if (canAddLayouts)
                                css.push('drop-layouts-zone');
                        }
                    }
                    break;
                case LayoutUtils.LAYOUT_ACCORDION_GROUP:
                    if (options.step === 1) {
                        css.push('panel panel-default');
                        if (options.design) {
                            css.push('design');
                            if (layout.selected)
                                css.push('selected');
                        }
                    }
                    else if (options.step === 2) {
                        css.push('panel-collapse collapse');
                        if (layout.opened)
                            css.push('in');
                    }
                    else if (options.step === 3) {
                        css.push('panel-body');
                        canAddLayouts = _canAddLayouts(layout);
                        if (canAddLayouts) {
                            if (options.design || _noPadding(layout, parent)) {
                                css.push('no-x-padding');
                                css.push('no-y-padding');
                            }
                            if (options.design)
                                css.push('drop-layouts-zone');
                        }
                        if (_canAddFields(layout)) {
                            if (layout.$inline && (options.design || !layout.$html))
                                css.push('form-inline bs-inline-container');
                            if (options.design) {
                                css.push('drop-fields-zone');
                                if (!canAddLayouts)
                                    css.push('no-x-padding');
                            }
                        }
                        _addStdThemes(layout, css, options);
                    }
                    break;
                case LayoutUtils.LAYOUT_COLUMN:
                    if (options.step === 1) {
                        if (options.design)
                            css.push('col-design col-xs-' + layout.$colSize);
                        else {
                            if (layout.$customColSize)
                                css.push(layout.$customColSize);
                            else
                                css.push('col-' + (layout.$colType || 'sm') + '-' + layout.$colSize);
                        }
                        css.push('no-x-padding');
                    }
                    else if (options.step === 2) {
                        addpaddingclass = true;
                        css.push('container-fluid');
                        canAddLayouts = _canAddLayouts(layout);
                        if (canAddLayouts) {
                            if (options.design || _noPadding(layout, parent)) {
                                addpaddingclass = false;
                                css.push('no-x-padding');
                            }
                            if (options.design && !layout.$auto)
                                css.push('drop-layouts-zone');
                        }
                        if (_canAddFields(layout)) {
                            if (layout.$inline && (options.design || !layout.$html))
                                css.push('form-inline bs-inline-container');
                            if (options.design) {
                                css.push('drop-fields-zone');
                                if (!canAddLayouts) {
                                    css.push('no-x-padding');
                                    addpaddingclass = false;
                                }
                            }
                        }
                        if (addpaddingclass)
                            css.push('field-container');
                        if (options.design) {
                            css.push('design col');
                            if (layout.$auto)
                                css.push('auto');
                            if (layout.selected)
                                css.push('selected');
                        }
                        _addStdThemes(layout, css, options);
                    }
                    break;
                case LayoutUtils.LAYOUT_HTML:
                    if (options.design) {
                        css.push('design');
                        if (layout.selected)
                            css.push('selected');
                    }
                    _addStdThemes(layout, css, options);
                    break;
            }
            return css;
        }, _setLayoutCss = function (e, layout, parent, options) {
            var css = _css(layout, parent, options), t;
            e.className = css.join(' ');
            if (layout.$type === LayoutUtils.LAYOUT_ACCORDION_GROUP && options.step === 1) {
                t = _dom.find(e, layout.$id + '_title');
                if (t)
                    _dom.text(t, (layout.$title && layout.$title.value) ? layout.$title.value : '');
            }
            else if (layout.$type === LayoutUtils.LAYOUT_HTML && options.step === 1) {
                e.innerHTML = layout.$html || '';
            }
        }, _addLayoutCss = function (html, layout, parent, options) {
            var css = _css(layout, parent, options);
            if (css.length) {
                html.push(' class="');
                html.push(css.join(' '));
                html.push('"');
            }
        }, _addId = function (html, layout, prefix) {
            html.push(' id="');
            html.push(prefix ? (prefix + '_' + layout.$id) : layout.$id);
            html.push('"');
        }, _addDataStep = function (html, step, design) {
            if (design) {
                html.push(' data-level="');
                html.push(step);
                html.push('"');
            }
        }, _addLayoutId = function (html, step, layout, design, force) {
            if (force || design) {
                html.push(' data-layout="');
                html.push(layout.$id);
                html.push('"');
                layout.$idSelect = null;
            }
            if (force || (design && step > 1)) {
                var id = layout['$idStep' + step];
                if (id) {
                    html.push(' id="');
                    html.push(id);
                    html.push('"');
                }
            }
        }, _addTitle = function (html, layout, llocale, isForm) {
            if (layout.$title && layout.$title.value === EMPTY_TITLE) {
                delete layout.$title;
                return;
            }
            if (isForm && layout.$title) {
                var size = layout.$title.size || 4;
                html.push('<h' + size);
                var css = ['bs-block-title'];
                if (layout.$title.$style)
                    _dom.parseStyle(layout.$title.$style, css);
                html.push(' data-ignore="true" class="' + css.join(' ') + '">');
                if (layout.$title.value)
                    html.push(_utils.escapeHtml(_ulocale.tt(layout.$title.value, llocale)));
                html.push('</h' + size + '>');
            }
        }, _blockBefore = function (html, layout, parent, model, llocale, design, isForm, refBlock) {
            html.push('<div');
            if (design)
                html.push(' draggable="true"');
            _addLayoutCss(html, layout, parent, {
                design: design,
                step: 1
            });
            _addLayoutId(html, 1, layout, design);
            _addId(html, layout);
            _addDataStep(html, 1, design);
            html.push('>');
            _addTitle(html, layout, llocale, isForm);
        }, _blockAfter = function (html, layout, parent, model, llocale, design) {
            html.push('</div>');
        }, _addLinkSublayout = function (html, layout, parent, model, llocale, design) {
            html.push(_utils.format('<div id="{0}_settings" class="bs-cursor-p bs-layout-detail" data-layout-detail="true"><span class="' + _dom.iconClass('cog') + '"></span></div>', layout.$id));
        }, _htmlBefore = function (html, layout, parent, model, llocale, design, refBlock) {
            html.push('<div');
            if (design)
                html.push(' draggable="true"');
            _addLayoutCss(html, layout, parent, {
                design: design,
                step: 1
            });
            _addLayoutId(html, 1, layout, design);
            _addId(html, layout);
            _addDataStep(html, 1, design);
            html.push('>');
            if (layout.$html)
                html.push(layout.$html);
        }, _htmlAfter = function (html, layout, model, llocale, design) {
            html.push('</div>');
        }, _tabBuilder = function (html, layout, parent, model, llocale, design, isForm, refBlock) {
            html.push('<li role="presentation"');
            if (layout.opened)
                html.push(' class="active"');
            html.push('>');
            html.push(_utils.format('<a href="#{0}" aria-controls="{0}"  data-layout="{0}" role="tab" data-toggle="tab">', layout.$id));
            html.push(layout.$title.value);
            html.push('</a></li>');
        }, _accordionBefore = function (html, layout, parent, model, llocale, design, isForm, refBlock) {
            _checkAccordionChilds(layout);
            if (design || !layout.$widget) {
                html.push('<div role="tablist" aria-multiselectable="true"');
                if (design)
                    html.push(' draggable="true"');
                _addLayoutCss(html, layout, parent, {
                    design: design,
                    step: 1
                });
                _addLayoutId(html, 1, layout, design);
                _addId(html, layout);
                _addDataStep(html, 1, design);
                html.push('>');
            }
            else if (layout.$widget === 'tabs') {
                // design is allways false
                html.push('<div');
                if (design)
                    html.push(' draggable="true"');
                _addLayoutCss(html, layout, parent, {
                    design: design,
                    step: 1
                });
                _addLayoutId(html, 1, layout, design);
                _addId(html, layout);
                _addDataStep(html, 1, design);
                html.push('>');
                html.push('<ul class="nav nav-tabs" role="tablist">');
                layout.$items.forEach(function (item) { return _tabBuilder(html, item, layout, model, llocale, design, isForm, refBlock); });
                html.push('</ul>');
                html.push('<div class="tab-content">');
            }
            else
                throw 'Invalid accordion $widget.';
        }, _accordionAfter = function (html, layout, parent, model, llocale, design) {
            if (design || !layout.$widget) {
                html.push('</div>');
            }
            else if (layout.$widget === 'tabs') {
                html.push('</div>'); //tab-content"
                html.push('</div>');
            }
        }, _accordionGroupBefore = function (html, layout, parent, model, llocale, design, isForm, refBlock) {
            if (design || !parent.$widget) {
                html.push('<div');
                _addLayoutCss(html, layout, parent, {
                    design: design,
                    step: 1
                });
                _addLayoutId(html, 1, layout, design);
                _addId(html, layout);
                _addDataStep(html, 1, design);
                //_addId(html, layout);
                layout.$idStep2 = layout.$id + '_s2';
                layout.$idStep3 = layout.$id + '_s3';
                layout.$idDesign = layout.$idStep3;
                if (design)
                    html.push(' draggable="true"');
                html.push('>');
                html.push('<div class="panel-heading" role="tab"');
                _addId(html, layout, "heading");
                html.push('>');
                html.push('<h4 class="panel-title bs-pointer collapsed" data-toggle="collapse" data-parent="#' + parent.$id + '"');
                if (layout.opened)
                    html.push(' aria-expanded="true"');
                else
                    html.push(' aria-expanded="false"');
                html.push(' data-target="#' + layout.$idStep2 + '" aria-controls="' + layout.$idStep2 + '"');
                html.push(' id="' + layout.$id + '_title">');
                html.push(_utils.escapeHtml(layout.$title ? layout.$title.value : ''));
                html.push('</h4>');
                html.push('</div>');
                html.push('<div role="tabpanel" aria-labelledby="heading_' + layout.$id + '"');
                _addLayoutCss(html, layout, parent, {
                    design: design,
                    step: 2
                });
                _addLayoutId(html, 2, layout, design, true);
                _addDataStep(html, 2, design);
                html.push('>');
                html.push('<div');
                _addLayoutCss(html, layout, parent, {
                    design: design,
                    step: 3
                });
                _addLayoutId(html, 3, layout, design, true);
                html.push('>');
            }
            else if (parent.$widget === 'tabs') {
                var css = ['tab-pane fade'];
                if (layout.opened)
                    css.push('in active');
                html.push('<div role="tabpanel"');
                html.push('< class="' + css.join(' ') + '"');
                layout.$idDesign = layout.$id;
                _addId(html, layout);
                html.push('>');
            }
        }, _accordionGroupAfter = function (html, layout, parent, model, llocale, design) {
            if (design || !parent.$widget) {
                html.push('</div></div></div>');
            }
            else if (parent.$widget === 'tabs') {
                html.push('</div>');
            }
        }, _rowBefore = function (html, layout, parent, model, llocale, design, isForm, refBlock) {
            html.push('<div');
            if (design)
                html.push(' draggable="true"');
            _addLayoutCss(html, layout, parent, {
                design: design,
                step: 1
            });
            _addId(html, layout);
            _addLayoutId(html, 1, layout, design);
            _addDataStep(html, 1, design);
            html.push('>');
            layout.$idStep2 = layout.$id + "_s2";
            layout.$idDesign = layout.$idStep2;
            html.push('<div');
            _addLayoutCss(html, layout, parent, {
                design: design,
                step: 2
            });
            _addLayoutId(html, 2, layout, design);
            _addDataStep(html, 2, design);
            html.push('>');
            _checkRowChilds(layout);
        }, _rowAfter = function (html, layout, parent, model, llocale, design) {
            html.push('</div></div>');
        }, _columnBefore = function (html, layout, parent, model, llocale, design, isForm, refBlock) {
            html.push('<div');
            _addLayoutCss(html, layout, parent, {
                design: design,
                step: 1
            });
            _addLayoutId(html, 1, layout, design);
            _addId(html, layout);
            _addDataStep(html, 1, design);
            html.push('>');
            html.push('<div');
            _addLayoutCss(html, layout, parent, {
                design: design,
                step: 2
            });
            if (design)
                html.push(' draggable="true"');
            layout.$idDesign = layout.$id + "_design";
            layout.$idDrag = layout.$id;
            layout.$idStep2 = layout.$idDesign;
            _addLayoutId(html, 2, layout, design);
            _addDataStep(html, 2, design);
            layout.$idSelect = layout.$idDesign;
            html.push('>');
            _addTitle(html, layout, llocale, isForm);
        }, _columnAfter = function (html, layout, parent, model, llocale, design) {
            html.push('</div></div>');
        }, _enumElements = function (layout, parent, onElement, root, param) {
            if (layout) {
                if (root && !layout.$type && !layout.$items) {
                    onElement(layout, parent, false, true, param);
                    return;
                }
                onElement(layout, parent, true, true, param);
                if (param && param.stop) {
                }
                else {
                    if (_canAddFields(layout)) {
                        if (layout.$items)
                            layout.$items.forEach(function (item) {
                                onElement(item, layout, false, true, param);
                            });
                    }
                    else {
                        if (layout.$items)
                            layout.$items.forEach(function (item) {
                                _enumElements(item, layout, onElement, false, param);
                            });
                    }
                }
                onElement(layout, parent, true, false, param);
            }
        }, _nullHtmlFieldRender = function (html, item, layout, model, options) {
            html.push('<div class="bs-island' + (options.design ? ' design' : '') + (item.$config ? ' bs-widget' : ' bs-field') + (item.selected ? ' selected"' : '"'));
            if (options.design)
                html.push(' draggable="true"');
            html.push(' data-render="' + item.$id + '"');
            html.push(' id="' + item.$id + '"');
            html.push('></div>');
        }, _nullWidgetRender = function (html, item, layout, model, options) {
            html.push('<div id="' + item.$id + '"></div>');
        }, _renderLayout = function (layout, model, html, llocale, options) {
            var wHtmlFieldRender = _render.get(options.context, 'widget') || _nullWidgetRender;
            var fHtmlFieldRender = _render.get(options.context, 'field') || _nullHtmlFieldRender;
            var isForm = layout.form;
            var p = {
                html: html
            };
            _enumElements(layout, null, function (item, parent, isLayout, before, param) {
                if (isLayout) {
                    var rb = _blockBefore;
                    var ra = _blockAfter;
                    switch (item.$type) {
                        case LayoutUtils.LAYOUT_ROW:
                            rb = _rowBefore;
                            ra = _rowAfter;
                            break;
                        case LayoutUtils.LAYOUT_COLUMN:
                            rb = _columnBefore;
                            ra = _columnAfter;
                            break;
                        case LayoutUtils.LAYOUT_ACCORDION:
                            rb = _accordionBefore;
                            ra = _accordionAfter;
                            break;
                        case LayoutUtils.LAYOUT_ACCORDION_GROUP:
                            rb = _accordionGroupBefore;
                            ra = _accordionGroupAfter;
                            break;
                        case LayoutUtils.LAYOUT_HTML:
                            rb = _htmlBefore;
                            ra = _htmlAfter;
                            break;
                    }
                    if (before) {
                        if (item.$ref && options.design) {
                            param.stop = true;
                        }
                        rb(param.html, item, parent, model, llocale, options.design, isForm, param.stop);
                        if (param.stop)
                            _addLinkSublayout(param.html, item, parent, model, llocale, options.design);
                        if (!_layoutIsVisible(item)) {
                            item.oldHtml = param.html;
                            param.html = [];
                        }
                    }
                    else {
                        if (!_layoutIsVisible(item)) {
                            item.$content = param.html;
                            param.html = item.oldHtml;
                            delete item.oldHtml;
                        }
                        if (!options.design && item.$html && item.$items && item.$items.length && _canAddFields(item)) {
                            param.html.push(_utils.format(item.$html.replace(/id="/g, 'id="{0}_'), item.$id));
                        }
                        ra(param.html, item, parent, model, llocale, options.design);
                        if (item.$ref && options.design) {
                            param.stop = false;
                        }
                    }
                }
                else {
                    if (item.$config)
                        wHtmlFieldRender(param.html, item, parent, model, options);
                    else
                        fHtmlFieldRender(param.html, item, parent, model, options);
                }
            }, true, p);
        }, _canSelectLayout = function (layout, level) {
            if (layout.$auto)
                return false;
            if (layout.$type === LayoutUtils.LAYOUT_COLUMN && level === 1)
                return false;
            return true;
        }, _check = function (layout, parentLayout, map, mapFields, namedMap, namedFieldMap) {
            _enumElements(layout, parentLayout, function (item, parent, isLayout, before) {
                if (before) {
                    if (isLayout)
                        _checkLayout(item, parent, map, namedMap);
                    else {
                        _checkField(item, parent, mapFields, namedFieldMap);
                    }
                }
            }, true);
        }, _clearMeta = function (layout, clearIds) {
            _enumElements(layout, null, function (item, parent, isLayout, before) {
                if (before) {
                    if (isLayout) {
                        if (clearIds)
                            delete item.$id;
                        delete item.$render;
                        delete item.$idDesign;
                        delete item.$idDrag;
                        delete item.$idSelect;
                        delete item.$parentId;
                        delete item.$idStep2;
                        delete item.$idStep3;
                        delete item.$content;
                        delete item.selected;
                        if (item.$type === LayoutUtils.LAYOUT_COLUMN)
                            delete item.$type;
                        else if (layout.$type === LayoutUtils.LAYOUT_HTML) {
                            if (layout.$html === _locale.Html)
                                delete layout.$html;
                        }
                        if (item.$inline === false)
                            delete item.$inline;
                        if (item.$fieldOptions) {
                            var ckeckKeys = true;
                            if (item.columns === false)
                                delete item.columns;
                            else
                                ckeckKeys = false;
                            if (item.titleIsHidden === false)
                                delete item.titleIsHidden;
                            else
                                ckeckKeys = false;
                            if (ckeckKeys && Object.keys(item.$fieldOptions).length === 0)
                                delete item.$fieldOptions;
                        }
                    }
                    else {
                        delete item.$render;
                        if (clearIds)
                            delete item.$id;
                        delete item.$parentId;
                        delete item.$idDrag;
                        delete item.selected;
                        if (item.$config) {
                            if (item.$config.data) {
                                delete item.$config.data.ds;
                                if (!Object.keys(item.$config.data).length)
                                    delete item.$config.data;
                            }
                            if (item.$config.$titleIsHidden || item.$config.$dontSaveTitle) {
                                delete item.$config.$title;
                            }
                        }
                    }
                }
            }, true);
        }, _clearMaps = function (layout, map, mapFields, namedMap, namedMapFields) {
            _enumElements(layout, null, function (item, parent, isLayout, before) {
                if (before) {
                    if (isLayout) {
                        delete map[item.$id];
                        delete namedMap[item.$id];
                    }
                    else {
                        delete mapFields[item.$id];
                        delete namedMapFields[item.$id];
                    }
                }
            }, true);
        }, _afterRemoveChild = function (layout, map, mapFields, namedMap, namedMapFields) {
            if (layout.$type === LayoutUtils.LAYOUT_ROW) {
                layout.$items.forEach(function (item) {
                    item.$type = LayoutUtils.LAYOUT_COLUMN;
                    delete item.$colSize;
                });
                _checkRowChilds(layout);
                layout.$items.forEach(function (item) {
                    _check(item, layout, map, mapFields, namedMap, namedMapFields);
                });
            }
            else if (layout.$type === LayoutUtils.LAYOUT_ACCORDION) {
                _checkAccordionChilds(layout);
                layout.$items.forEach(function (item) {
                    _check(item, layout, map, mapFields, namedMap, namedMapFields);
                });
            }
        }, _toHtml = function (layout, model, llocale, options) {
            var html = [];
            _renderLayout(layout, model, html, llocale, options);
            return html.join('');
        };
        LayoutUtils.check = _check;
        LayoutUtils.layoutVisible = _layoutIsVisible;
        LayoutUtils.clearMeta = _clearMeta;
        LayoutUtils.clearMaps = _clearMaps;
        LayoutUtils.afterRemoveChild = _afterRemoveChild;
        LayoutUtils.canSelect = _canSelectLayout;
        LayoutUtils.updateCssClass = _setLayoutCss;
        LayoutUtils.toHtml = _toHtml;
    })(LayoutUtils = Phoenix.LayoutUtils || (Phoenix.LayoutUtils = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../core/core.ts" />
/// <reference path="./module.ts" />
/// <reference path="./datasets-plugin.ts" />
/// <reference path="./page.control.ts" />
/// <reference path="./layout.ts" />
/// <reference path="./menu.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _dom = Phoenix.dom, _utils = Phoenix.utils, _locale = Phoenix.locale, _wutils = Phoenix.WidgetUtils, _link = Phoenix.link, _render = Phoenix.render, _ipc = Phoenix.ipc, _layoutUtils = Phoenix.LayoutUtils, _findSelected = function (maps) {
            var j = maps.length;
            while (j--) {
                var map = maps[j];
                var ids = Object.keys(map);
                var i = ids.length;
                while (i--) {
                    var o = map[ids[i]];
                    if (o.selected) {
                        return o;
                    }
                }
            }
            return null;
        };
        var BaseLayout = (function () {
            function BaseLayout(ldata, options, fdata, schema, locale, preferences) {
                options = this.initOptions(options);
                this.$locale = null;
                this._init(ldata, options);
            }
            BaseLayout.prototype._afterCreate = function () {
            };
            BaseLayout.prototype.initOptions = function (options) {
                return options;
            };
            BaseLayout.prototype._init = function (ldata, options) {
                //Layout
                var that = this;
                that.$element = null;
                that.$content = null;
                that.options = options || {};
                that.options.context = that.options.context || "javascript";
                that.map = {};
                that.mapFields = {};
                that.namedMap = {};
                that.namedMapFields = {};
                ldata = ldata || {};
                _layoutUtils.check(ldata, null, that.map, that.mapFields, that.namedMap, that.namedMapFields);
                that.data = ldata;
                that.data.form = that.options.form;
                ldata.map = that.map;
                ldata.fields = that.mapFields;
                that.children = {}; //Is used only in javascript mode to cleanup children
                that.controls = {}; // list of instanced modules or controls   
                that.expressionTitle = false;
                var isForm = that.options.form;
                if (!isForm) {
                    that.page = ui.Page();
                    that.page.setPopup(null);
                    that.page.addChild("layout", that);
                    if (!that.options.design) {
                        that.expressionTitle = _utils.hasExpression(ldata.$title);
                        that.page.props.$title = ldata.$title ? _utils.parseExpression(ldata.$title, _link.context()) : null;
                    }
                }
                that._setDesignListeners();
                that.pageLayoutInit();
            };
            BaseLayout.prototype.pageLayoutInit = function () { };
            BaseLayout.prototype.getSchema = function (path) { return null; };
            BaseLayout.prototype.getLookupForSchema = function (path, lookupName) { return null; };
            BaseLayout.prototype._setDesignListeners = function () { };
            BaseLayout.prototype._removeEvents = function () {
                var that = this;
                that._removeBaseEvents();
            };
            BaseLayout.prototype._addEvents = function () {
                var that = this;
                that._addBaseEvents();
            };
            BaseLayout.prototype._removeBaseEvents = function () {
                var that = this;
                that._removeAccordionEvents();
            };
            BaseLayout.prototype._addBaseEvents = function () {
                var that = this;
                that._setAccordionEvents();
            };
            BaseLayout.prototype._onSelectedChanged = function (element, data, notify) { };
            BaseLayout.prototype._showSelected = function ($element, layout) { };
            BaseLayout.prototype._setAccordionEvents = function () {
                var that = this;
                that.$element.on('show.bs.collapse hide.bs.collapse show.bs.tab hide.bs.tab', function (event) {
                    var ee = event.target;
                    if (!ee || !ee.hasAttribute('data-layout'))
                        return;
                    var id = ee.getAttribute('data-layout');
                    var l = that.getLayoutById(id);
                    if (l) {
                        var nv = event.type === "show";
                        if (l.opened === nv)
                            return;
                        if (nv) {
                            var parentLayout = that.getLayoutById(l.$parentId);
                            if (parentLayout) {
                                for (var i = 0, len = parentLayout.$items.length; i < len; i++) {
                                    var ci = parentLayout.$items[i];
                                    if (ci.opened) {
                                        ci.opened = false;
                                        that._activateLayout(ci, false);
                                        break;
                                    }
                                }
                            }
                            l.opened = nv;
                            if (l.$content)
                                that._renderLayoutContent(l);
                            else
                                that._activateLayout(l, true);
                        }
                        else {
                            that._activateLayout(l, false);
                        }
                    }
                });
            };
            BaseLayout.prototype._doDatasetEventAfterEnabled = function (child) { };
            BaseLayout.prototype._activateLayout = function (layout, value) {
                var that = this, children;
                if (value) {
                    children = that._getVisibleChildren(layout);
                    children.forEach(function (child) {
                        child.disabled = false;
                        that._doDatasetEventAfterEnabled(child);
                    });
                }
                else {
                    // disable all childrens
                    children = that._getChildrenOf(layout);
                    children.forEach(function (child) {
                        child.disabled = true;
                    });
                }
                that._refreshCurrentResizeList();
            };
            BaseLayout.prototype._removeAccordionEvents = function () {
                var that = this;
                that.$element.off('show.bs.collapse hide.bs.collapse');
            };
            BaseLayout.prototype.toString = function (layout) {
                return null;
            };
            /* Start datasets methods */
            BaseLayout.prototype.emit = function (eventName, value, filter) {
                this.emitDataEvent(eventName, value, filter);
            };
            /* End datasets methods */
            BaseLayout.prototype.openErrors = function () {
                var that = this;
                if (that.$element) {
                    var eerr = _dom.find(that.$element.get(0), that.data.$id + '_error');
                    if (eerr && eerr.firstChild) {
                        _dom.removeClass(eerr.firstChild, 'bs-none');
                    }
                }
            };
            BaseLayout.prototype._renderLayout = function (layout) {
                var that = this;
                var $e = $(_layoutUtils.toHtml(layout, null, that.$locale, {
                    design: that.options.design,
                    context: that.options.context
                }));
                that.afterRender($e);
                that._renderChildren($e);
                that.afterRenderChildren($e);
                return $e;
            };
            BaseLayout.prototype.afterRenderChildren = function ($e) {
            };
            BaseLayout.prototype.isChildOf = function (child, layout) {
                var that = this;
                var cl = that.map[child];
                while (cl) {
                    if (cl == layout)
                        return true;
                    ;
                    cl = that.map[cl.$parentId];
                }
                return false;
            };
            BaseLayout.prototype._isChildVisibleOf = function (child, layout) {
                var that = this;
                var cl = that.map[child];
                while (cl) {
                    if (!_layoutUtils.layoutVisible(cl))
                        return false;
                    if (cl == layout)
                        return true;
                    cl = that.map[cl.$parentId];
                }
                return false;
            };
            BaseLayout.prototype._getVisibleChildren = function (layout) {
                var that = this;
                var res = [];
                Object.keys(that.controls).forEach(function (cn) {
                    var c = that.controls[cn];
                    if (that.controls[cn].item)
                        if (that._isChildVisibleOf(that.controls[cn].item.$parentId, layout))
                            res.push(c);
                });
                return res;
            };
            BaseLayout.prototype._getChildrenOf = function (layout) {
                var that = this;
                var res = [];
                Object.keys(that.controls).forEach(function (cn) {
                    var c = that.controls[cn];
                    if (that.controls[cn].item)
                        if (that.isChildOf(that.controls[cn].item.$parentId, layout))
                            res.push(c);
                });
                return res;
            };
            BaseLayout.prototype._getEventListFor = function (list) {
                //var that = this;
                var res = [];
                list.forEach(function (ci) {
                    if (ci.datasets) {
                        Object.keys(ci.datasets).forEach(function (dsn) {
                            var ds = ci.datasets[dsn];
                            if (ds.enumTriggers) {
                                ds.enumTriggers(false, function (tn) {
                                    if (res.indexOf(tn) < 0)
                                        res.push(tn);
                                });
                            }
                        });
                    }
                });
                return res;
            };
            BaseLayout.prototype._refreshDataSets = function (children) { };
            BaseLayout.prototype._renderLayoutContent = function (layout) {
                var that = this;
                var cc = _dom.find(that.$element.get(0), layout.$idDesign);
                if (!cc)
                    return;
                var $p = $(cc);
                var $e = $(layout.$content.join(''));
                var parent = cc.parentNode, cb = cc.nextSibling;
                $p.detach();
                $p.append($e);
                delete layout.$content;
                if (that.options.beforeAdd)
                    that.options.beforeAdd($p, true);
                parent.insertBefore(cc, cb);
                that._renderChildren($p);
                var vc = that._getVisibleChildren(layout);
                that._refreshDataSets(vc);
                that.afterAddedInDom();
                if (that.options.design) {
                    that._removeEvents();
                    that._addEvents();
                }
            };
            BaseLayout.prototype._isVisible = function (id) {
                var that = this;
                while (true) {
                    if (!id)
                        return true;
                    var layout = that.map[id];
                    if (!layout)
                        return true;
                    if (!_layoutUtils.layoutVisible(layout))
                        return false;
                    id = layout.$parentId;
                }
            };
            BaseLayout.prototype._renderChildren = function ($e) {
                var that = this;
                var res = [];
                var e = $e.get(0);
                var wc = _render.get(that.options.context, 'widget.control');
                var fc = _render.get(that.options.context, 'field.control');
                var metaCtrls = [];
                var ctrlsByBind = {};
                var toRender = [];
                if (wc || fc) {
                    // only on javascript mode
                    Object.keys(that.mapFields).forEach(function (fn) {
                        if (that.children[fn])
                            return;
                        var fd = that.mapFields[fn];
                        if (!that._isVisible(fd.$parentId))
                            return;
                        var _constructor = fd.$config ? wc : fc;
                        var isField = _constructor === fc;
                        if (isField) {
                            var isMeta = (fd.$bind || '').indexOf('$$') === 0;
                            var schema = that.getSchema(fd.$bind), lookup = void 0;
                            if (!schema && !isMeta)
                                console.log('Schema not found for field "' + fd.$bind + '".');
                            if (fd && fd.$lookup) {
                                lookup = that.getLookupForSchema(fd.$bind, fd.$lookup);
                            }
                            _constructor = _constructor ? _constructor(fd, schema, lookup) : null;
                        }
                        if (_constructor) {
                            var p = void 0, opt = { context: that.options.context, design: that.options.design, replaceParent: true, readOnly: fd.$readOnly };
                            if (isField) {
                                p = new _constructor(fd, opt, that);
                                if (p.isMeta()) {
                                    metaCtrls.push(p);
                                }
                                else {
                                    if (fd.$bind)
                                        ctrlsByBind[fd.$bind] = p;
                                }
                            }
                            else
                                p = new _constructor(fd, opt, that);
                            var hparent = void 0;
                            if (that.options.design || !fd.$htmlParent) {
                                hparent = _dom.find(e, fd.$id);
                            }
                            else {
                                hparent = _dom.find(e, fd.$parentId + "_" + fd.$htmlParent);
                                if (hparent) {
                                    opt.replaceParent = false;
                                    var op = _dom.find(e, fd.$id);
                                    if (op)
                                        _dom.remove(op);
                                }
                                else
                                    hparent = _dom.find(e, fd.$id);
                            }
                            toRender.push({ parent: hparent, control: p });
                            //p.render($(hparent));
                            that.children[fn] = p;
                            that.controls[fn] = p;
                            if (p.resize) {
                                that.resizeList = that.resizeList || [];
                                that.resizeList.push(p);
                            }
                            res.push(p);
                        }
                    });
                    metaCtrls.forEach(function (metaControl) {
                        var bind = metaControl.getCustomBind();
                        if (bind) {
                            var parent_1 = ctrlsByBind[bind];
                            if (parent_1)
                                metaControl.setParentId(parent_1.id);
                        }
                    });
                    toRender.forEach(function (item) {
                        item.control.render($(item.parent));
                    });
                }
                that._refreshCurrentResizeList();
                return res;
            };
            BaseLayout.prototype._refreshCurrentResizeList = function () {
                var that = this;
                if (!that.resizeList)
                    that.currentResizeList = null;
                else if (!that.currentResizeList)
                    that.currentResizeList = that.resizeList.map(function (item) { return item; });
                else {
                    that.currentResizeList = [];
                    that.resizeList.forEach(function (item) {
                        if (that._isVisible(item.config.$parentId))
                            that.currentResizeList.push(item);
                    });
                }
            };
            BaseLayout.prototype._clearChildren = function () {
                var that = this;
                var children = that.children;
                that.children = {};
                that.controls = {};
                that.resizeList = null;
                that.currentResizeList = null;
                Object.keys(children).forEach(function (v) {
                    var c = children[v];
                    c.destroy();
                });
            };
            BaseLayout.prototype._refreshSelected = function () {
                var that = this;
                if (that.options.design) {
                    var o = _findSelected([that.map, that.mapFields]);
                    that._onSelectedChanged(that.$element.get(0), o, true);
                }
            };
            BaseLayout.prototype.registerDataListener = function (value) {
                var that = this;
                if (that.page)
                    that.page.registerDataListener(value, that);
            };
            BaseLayout.prototype.removeDataListener = function (listener) {
                var that = this;
                if (that.page) {
                    if (listener == that)
                        that.page.removeParentDataListener(that);
                    else
                        that.page.removeDataListener(listener);
                }
            };
            BaseLayout.prototype.emitDataEvent = function (event, value, filter) {
                var that = this;
                if (that.page)
                    that.page.emitDataEvent(event, value, filter);
            };
            BaseLayout.prototype.afterRender = function ($e) { };
            BaseLayout.prototype._internalRender = function ($parent, refresh) {
                var that = this;
                if (!that.$element) {
                    that.$element = that._renderLayout(that.data);
                    if (that.options.beforeAdd)
                        that.options.beforeAdd(that.$element, refresh);
                    that.$content.append(that.$element);
                    that._addEvents();
                    that._refreshSelected();
                    if ($parent) {
                        if (!that.options.form)
                            _dom.bodyTheme(that.data.$theme);
                        if (that.options.replaceParent)
                            $parent.replaceWith(that.$content);
                        else
                            $parent.append(that.$content);
                        that.afterAddedInDom();
                    }
                }
                return that.$content;
            };
            BaseLayout.prototype.afterAddedInDom = function () { };
            BaseLayout.prototype._callInternalRender = function ($parent, refresh) {
                var that = this;
                that._internalRender($parent, refresh);
            };
            BaseLayout.prototype.render = function ($parent) {
                var that = this, refresh;
                if (that.$content) {
                    if (that.$element) {
                        refresh = true;
                        that._clearChildren();
                        that._removeEvents();
                        if (that.options.beforeRemove)
                            that.options.beforeRemove(that.$element);
                        that.$element.remove();
                        that.$element = null;
                    }
                }
                else
                    that.$content = $('<div></div>');
                that._callInternalRender($parent, refresh);
                return that.$content;
            };
            BaseLayout.prototype._destroyDataSets = function () { };
            BaseLayout.prototype.destroy = function () {
                var that = this;
                _utils.log("Destroy Layout", "destroy");
                that._destroyDataSets();
                _ipc.unlisten(that);
                that.removeDataListener(that);
                that._clearChildren();
                if (that.page) {
                    that.page.removeChild(that);
                    that.page = null;
                }
                if (that.$element) {
                    that._removeEvents();
                    that.$element = null;
                }
                that.map = null;
                that.mapFields = null;
                that.namedMap = null;
                that.namedMapFields = null;
                _layoutUtils.clearMeta(that.data, false);
            };
            BaseLayout.prototype.check = function (layout, parent) {
                var that = this;
                var restoreMap = false;
                if (!layout) {
                    that.map = {};
                    that.mapFields = {};
                    that.namedMap = {};
                    that.namedMapFields = {};
                    parent = null;
                    layout = that.data;
                    restoreMap = true;
                }
                _layoutUtils.check(layout, parent, that.map, that.mapFields, that.namedMap, that.namedMapFields);
                if (restoreMap) {
                    layout.fields = that.mapFields;
                    layout.map = that.map;
                }
            };
            BaseLayout.prototype._afterStructureChanged = function (layout) {
                var that = this;
                that.render();
            };
            BaseLayout.prototype._afterPropsChanged = function (item) {
                var that = this;
                if (!this.$element)
                    return;
                var element = this.$element.get(0);
                if (!element)
                    return;
                var l1 = _dom.find(element, item.$id);
                var l2 = (item.$id != item.$idStep2) ? _dom.find(element, item.$idStep2) : null;
                var l3 = (item.$idStep3) ? _dom.find(element, item.idStep3) : null;
                if (l1)
                    _layoutUtils.updateCssClass(l1, item, that.getLayoutById(item.$parentId), {
                        design: that.options.design,
                        step: 1
                    });
                if (l2)
                    _layoutUtils.updateCssClass(l2, item, that.getLayoutById(item.$parentId), {
                        design: that.options.design,
                        step: 2
                    });
                if (l3)
                    _layoutUtils.updateCssClass(l3, item, that.getLayoutById(item.$parentId), {
                        design: that.options.design,
                        step: 3
                    });
                if (item.selected)
                    that._refreshSelected();
            };
            BaseLayout.prototype.removeChild = function (id) {
                var that = this;
                if (!id || !that.options.design)
                    return;
                var d = that.map[id] || that.mapFields[id];
                if (!d)
                    return;
                var p = that.map[d.$parentId];
                if (!p)
                    return;
                if (p.$auto) {
                    d = p;
                    p = that.map[d.$parentId];
                    if (!p)
                        return;
                }
                var i = p.$items.indexOf(d);
                p.$items.splice(i, 1);
                _layoutUtils.clearMaps(d, this.map, this.mapFields, that.namedMap, that.namedMapFields);
                _layoutUtils.afterRemoveChild(p, that.map, that.mapFields, that.namedMap, that.namedMapFields);
                that._afterStructureChanged(p);
            };
            BaseLayout.prototype.setDesignMode = function (value) {
                var that = this;
                if (that.options.design != value) {
                    that.options.design = value;
                    that.render();
                }
            };
            BaseLayout.prototype.getLayoutById = function (id) {
                if (!id)
                    return null;
                var that = this;
                return that.map[id];
            };
            BaseLayout.prototype.getFieldById = function (id) {
                if (!id)
                    return null;
                var that = this;
                return that.mapFields[id];
            };
            BaseLayout.prototype.select = function (id) {
                var that = this;
                var $e = that.$element;
                if (!that.options.design)
                    return;
                var o = _findSelected([that.map, that.mapFields]);
                if (o) {
                    o.selected = false;
                    that._showSelected($e, o);
                    that._onSelectedChanged($e.get(0), o, false);
                    if (o.$id == id) {
                        that._onSelectedChanged($e.get(0), null, true);
                        return;
                    }
                }
                if (!id)
                    return;
                var d = (that.map[id] ? that.map[id] : that.mapFields[id]);
                if (d) {
                    d.selected = true;
                    that._showSelected($e, d);
                    that._onSelectedChanged($e.get(0), d, true);
                }
            };
            BaseLayout.prototype.updateField = function (id, data) {
                var that = this;
                var dst = that.mapFields[id];
                if (!dst)
                    return;
                if (dst.$render && dst.$config) {
                    Object.keys(data.$config).forEach(function (pn) {
                        if (pn === "form" || pn === "data" || pn === "datasets")
                            return;
                        if (dst.$render[pn] != data.$config[pn]) {
                            dst.$render[pn] = data.$config[pn];
                        }
                    });
                    if (dst.$config.hasOwnProperty('form') || data.$config.hasOwnProperty('form'))
                        dst.$config.form = data.$config.form;
                    dst.$config.datasets = data.$config.datasets;
                    dst.$config.data = data.$config.data;
                    that._afterStructureChanged(null);
                }
                else {
                    if (_utils.equals(dst, data)) {
                        return;
                    }
                    var nkeys_1 = Object.keys(data);
                    var okeys = Object.keys(dst);
                    nkeys_1.forEach(function (pn) {
                        dst[pn] = data[pn];
                    });
                    nkeys_1.push('$id');
                    nkeys_1.push('$parentId');
                    nkeys_1.push('$idDrag');
                    okeys.forEach(function (pn) {
                        if (nkeys_1.indexOf(pn) < 0) {
                            delete dst[pn];
                        }
                    });
                    var control = that.children[id];
                    if (control) {
                        delete that.controls[id];
                        delete that.children[id];
                        control.destroy();
                    }
                    that._afterStructureChanged(null);
                }
            };
            BaseLayout.prototype._cleanIds = function (item) {
                item.$idDesign = null;
                item.$idDrag = null;
                item.$idSelect = null;
                item.$idStep2 = null;
                item.$idStep3 = null;
            };
            //convert blocks to columns
            BaseLayout.prototype._blockToCols = function (layout) {
                var that = this;
                if (layout.$items)
                    layout.$items.forEach(function (item, index) {
                        var tt = item.$origin || item.$type;
                        if (tt === "block" || tt === "column") {
                            item.$type = "column";
                            that._cleanIds(layout);
                        }
                        else {
                            var ni = { $items: [item], $auto: true, $type: "column", $colSize: item.$colSize, $customColSize: item.$customColSize };
                        }
                    });
            };
            BaseLayout.prototype._changeType = function (layout, newtype) {
                var that = this;
                var parent = that.map[layout.$parentId];
                var pp = parent && parent.$auto ? that.map[parent.$parentId] : null;
                var ot = layout.$origin || layout.$type;
                switch (ot) {
                    case "block":
                        if (newtype === "row") {
                            layout.$type = newtype;
                            that._blockToCols(layout);
                            that._cleanIds(layout);
                            that.check(layout, parent);
                        }
                        break;
                    case "column":
                        if (newtype === "row") {
                            var ni = { $items: layout.$items, $type: newtype, selected: false };
                            layout.$auto = true;
                            layout.$type = "column";
                            layout.$items = [ni];
                            if (layout.selected) {
                                layout.selected = false;
                                ni.selected = true;
                            }
                            that._blockToCols(ni);
                            that._cleanIds(layout);
                            that.check(layout, parent);
                        }
                        break;
                    case "row":
                        if (newtype === "block") {
                            if (pp) {
                                var ii = pp.$items.indexOf(parent);
                                pp.$items[ii] = layout;
                                layout.$type = parent.$type;
                                layout.$parentId = pp.$id;
                                if (parent.$type == "column") {
                                    layout.$colSize = parent.$colSize;
                                    layout.$customColSize = parent.$customColSize;
                                }
                                parent = pp;
                            }
                            else
                                layout.$type = newtype;
                            if (layout.$origin)
                                delete layout.$origin;
                            if (layout.$items) {
                                layout.$items.forEach(function (item, index) {
                                    if (item.$type) {
                                        if (item.$auto) {
                                            var ni = item.$items[0];
                                            ni.$colSize = item.$colSize;
                                            ni.$customColSize = item.$customColSize;
                                            ni.$parentId = layout;
                                            layout.$items[index] = ni;
                                            that._cleanIds(item);
                                        }
                                        else {
                                            item.$type = "block";
                                            that._cleanIds(item);
                                        }
                                    }
                                });
                            }
                            that._cleanIds(layout);
                            that.check(layout, parent);
                        }
                        break;
                    case "accordion":
                        break;
                }
            };
            BaseLayout.prototype.updateIsHidden = function (layout, isHidden) {
                var that = this;
                if (layout.$isHidden !== isHidden) {
                    layout.$isHidden = isHidden;
                    that._afterPropsChanged(layout);
                }
            };
            BaseLayout.prototype.updateLayout = function (id, data) {
                var that = this;
                var dst = that.map[id];
                var structChanged = false;
                var propsChanged = false;
                var reloadChildrens = false;
                if (dst) {
                    delete data.onlyFields;
                    if (data.$type) {
                        var ov = dst.$origin || dst.$type;
                        if (data.$type !== ov) {
                            that._changeType(dst, data.$type);
                            delete data.$type;
                            structChanged = true;
                        }
                    }
                    if (data.parent) {
                        var pdst = that.map[dst.$parentId];
                        that._disableRules = true;
                        Object.keys(data.parent).forEach(function (pn) {
                            if (data.parent[pn] !== pdst[pn]) {
                                pdst[pn] = data.parent[pn];
                                structChanged = true;
                            }
                        });
                        that._disableRules = false;
                        delete data.parent;
                    }
                    delete data.selected;
                    that._disableRules = true;
                    if (dst.$title && !data.$title) {
                        delete dst.$title;
                        structChanged = true;
                    }
                    else if (!dst.$title && data.$title) {
                        delete dst.$title;
                        dst.$title = data.$title;
                        delete data.$title;
                        structChanged = true;
                    }
                    else if (dst.$title && data.$title) {
                        Object.keys(data.$title).forEach(function (pn) {
                            if (data.$title[pn] != dst.$title[pn]) {
                                dst.$title[pn] = data.$title[pn];
                                structChanged = true;
                            }
                        });
                        delete data.$title;
                    }
                    if ((dst.$inline || false) !== (data.$inline || false)) {
                        dst.$inline = data.$inline;
                        propsChanged = true;
                        if (dst.$items.length)
                            structChanged = true;
                        delete data.$inline;
                    }
                    if (!_utils.equals(dst.$fieldsOptions, data.$fieldOptions)) {
                        dst.$fieldsOptions = data.$fieldOptions;
                        propsChanged = true;
                        if (dst.$items.length)
                            structChanged = true;
                    }
                    delete data.$fieldOptions;
                    if ((dst.$refProperty || '') !== (data.$refProperty || '')) {
                        dst.$refProperty = data.$refProperty;
                        structChanged = true;
                    }
                    if ((dst.$ref || '') !== (data.$ref || '')) {
                        dst.$ref = data.$ref;
                        if (dst.$ref) {
                            delete dst.name;
                            delete dst.form;
                            delete dst.$fieldsOptions;
                            reloadChildrens = true;
                        }
                        else {
                            delete dst.$refProperty;
                            delete dst.name;
                            delete dst.form;
                        }
                        dst.$items = [];
                        structChanged = true;
                    }
                    delete data.$ref;
                    delete data.$refProperty;
                    if ((dst.$widget || '') !== (data.$widget || '')) {
                        dst.$widget = data.$widget;
                        structChanged = true;
                    }
                    delete data.$widget;
                    Object.keys(data).forEach(function (pn) {
                        if (data[pn] !== dst[pn]) {
                            dst[pn] = data[pn];
                            propsChanged = true;
                        }
                    });
                    that._disableRules = false;
                    if (structChanged) {
                        if (reloadChildrens) {
                            return _ipc.emit('LoadNestedLayouts', {
                                data: dst,
                                after: function (ldata) {
                                    _utils.merge(ldata, dst);
                                    var parent = that.map[dst.$parentId];
                                    that._cleanIds(dst);
                                    that.check(dst, parent);
                                    that._afterStructureChanged(dst);
                                }
                            });
                        }
                        that._afterStructureChanged(dst);
                    }
                    else if (propsChanged)
                        that._afterPropsChanged(dst);
                    else
                        that._refreshSelected();
                }
            };
            return BaseLayout;
        }());
        ui.BaseLayout = BaseLayout;
        ;
        var PageLayout = (function (_super) {
            __extends(PageLayout, _super);
            function PageLayout() {
                _super.apply(this, arguments);
            }
            //implements DatasetMethods
            PageLayout.prototype.ds_init = function (config) { return false; };
            PageLayout.prototype.ds_storeLastEvent = function (event, value) { };
            PageLayout.prototype.ds_LastEvent = function () { return null; };
            PageLayout.prototype.ds_destroy = function () { };
            PageLayout.prototype.ds_context = function () { return null; };
            PageLayout.prototype.ds_reemit = function (listeners, after) { return null; };
            PageLayout.prototype.ds_select = function (datasetName, value) { };
            PageLayout.prototype.ds_loaded = function (datasetName, value) { };
            PageLayout.prototype.ds_exec = function (event, context, dst, after, datasets, notify) { };
            PageLayout.prototype.pageLayoutInit = function () {
                var that = this;
                //datasets
                that.loadingHandler = null;
                that.noDataHandler = null;
                that.errorHandler = null;
                that.emitHandler = null;
                that.getLocalContextHandler = null;
                that.dataChangedHandler = null;
                that.updateMenuHandler = this.updateMenu.bind(that);
                that._removeMenus();
                if (that.ds_init && that.ds_init(that.data)) {
                    that.registerDataListener(that);
                }
            };
            PageLayout.prototype._doDatasetEventAfterEnabled = function (child) {
                var that = this;
                if (child.ds_LastEvent && child.dataEvent) {
                    var le = child.ds_LastEvent();
                    if (le)
                        child.dataEvent(le.event, le.value);
                }
            };
            PageLayout.prototype._refreshDataSets = function (children) {
                //list --> list of new visible "datasets listeners"
                var that = this;
                if (!that.page)
                    return;
                var events = that._getEventListFor(children);
                if (events.length) {
                    var emitters = that.page.emittersFor(events);
                    //reemit events
                    emitters.forEach(function (emitter) {
                        if (emitter.ds_reemit) {
                            emitter.ds_reemit(children, function () {
                            });
                        }
                    });
                }
            };
            PageLayout.prototype._callInternalRender = function ($parent, refresh) {
                var that = this;
                if (that.datasets && that.ds_exec) {
                    that.ds_exec("$load", null, that.props.data.ds, function (dse, ex) {
                        if (ex)
                            throw ex.message;
                        that._internalRender($parent, refresh);
                    }, null, true);
                }
                else
                    that._internalRender($parent, refresh);
            };
            PageLayout.prototype._destroyDataSets = function () {
                var that = this;
                if (that.ds_destroy)
                    that.ds_destroy();
            };
            PageLayout.prototype._removeMenus = function () {
                var that = this;
                var menusTypes = ["left", "right", "top", "bottom"];
                //var menus = [];
                menusTypes.forEach(function (mn) {
                    if (!that.data.$menus || !that.data.$menus[mn]) {
                        var c = that.page.childByType("menu-" + mn);
                        if (c)
                            c.setMenu(null);
                    }
                });
            };
            PageLayout.prototype.updateMenu = function (mn, data) {
                var that = this;
                _utils.log("From Layout Update Menu : " + (data ? data.name : 'null'), "menu");
                var c = that.page.childByType("menu-" + mn);
                if (c) {
                    c.setMenu(data);
                    return;
                }
                var MenuConstructor = null;
                if (mn == "right")
                    MenuConstructor = ui.Menuright;
                else if (mn == "left")
                    MenuConstructor = ui.Menuleft;
                if (MenuConstructor) {
                    var options = {
                        type: mn,
                        bodyId: null,
                        parentId: null
                    };
                    var header = that.page.childByType("header");
                    if (header) {
                        if (header.options.bodyId)
                            options.bodyId = header.options.bodyId;
                        if (header.options[options.type + "MenuPlace"])
                            options.parentId = header.options[options.type + "MenuPlace"];
                    }
                    c = new MenuConstructor(data, options);
                }
            };
            return PageLayout;
        }(BaseLayout));
        ui.PageLayout = PageLayout;
        _utils.applyMixins(PageLayout, [Phoenix.DatasetPlugin.DatasetMethods]);
        var Layout = (function (_super) {
            __extends(Layout, _super);
            function Layout(ldata, options, fdata, schema, locale, preferences) {
                _super.call(this, ldata, options, fdata, schema, locale, preferences);
            }
            return Layout;
        }(PageLayout));
        ui.Layout = Layout;
        ui.LayoutClass = Layout;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../core/modules/locale.ts" />
/// <reference path="../../core/core.ts" />
/// <reference path="../../core/modules/ajax.ts" />
/// <reference path="../../core/modules/application.ts" />
/// <reference path="../../data/datasets.ts" />
/// <reference path="../datasets-plugin.ts" />
var Phoenix;
(function (Phoenix) {
    var Observable;
    (function (Observable) {
        var DEF_LINK = '#/definitions/';
        var DEF_LINK_LEN = DEF_LINK.length;
        Observable.INDEX_FIELD_NAME = '$index';
        Observable.SELECTED_FIELD_NAME = '$select';
        Observable.EXPANDED_FIELD_NAME = '$expand';
        var _ulocale = Phoenix.ulocale, _application = Phoenix.application, _ajax = Phoenix.ajax, _dom = Phoenix.dom, _link = Phoenix.link, _data = Phoenix.data, _utils = Phoenix.utils, _ulocale = Phoenix.ulocale, _locale = Phoenix.locale, _customData = Phoenix.customData, _localeSchema = Phoenix.locale.schema, _dsPlugin = Phoenix.DatasetPlugin, _fwFields = [Observable.INDEX_FIELD_NAME, Observable.SELECTED_FIELD_NAME, Observable.EXPANDED_FIELD_NAME], _isFwField = function (fieldName) {
            return _fwFields.indexOf(fieldName) >= 0;
        }, _registerEnumManager = function () {
            var _enumsManager = {};
            return {
                register: function (name, manager) {
                    _enumsManager[name] = manager;
                },
                get: function (name) {
                    return _enumsManager[name];
                    ;
                }
            };
        }, _registerValidator = function () {
            var _validators = {};
            return {
                register: function (name, handler) {
                    _validators[name] = handler;
                },
                get: function (name) {
                    return _validators[name];
                    ;
                }
            };
        }, _parseCapabilities = function (schema) {
            if (!schema.features) {
                schema.features = {};
                var cp = (schema.capabilities === undefined) ? 'filtrable,sortable' : schema.capabilities;
                if (cp)
                    cp.split(",").forEach(function (capability) {
                        schema.features[capability] = true;
                    });
            }
        }, _expandRefProp = function (cs, rootSchema) {
            if (cs.$ref) {
                var refEntity = cs.$ref.substr(DEF_LINK_LEN);
                var refSchema = rootSchema.definitions ? rootSchema.definitions[refEntity] : null;
                if (!refSchema)
                    throw 'Schema $ref not found : ' + cs.$ref;
                return refSchema;
            }
            return cs;
        }, _rv = _registerValidator(), _em = _registerEnumManager();
        function _enumCompositions(schema, rootSchema, path, isArray, value, cb, opts) {
            if (!cb(path, schema, rootSchema, value, isArray))
                return;
            Object.keys(schema.properties).forEach(function (name) {
                var prop = schema.properties[name];
                if (!prop.$reference) {
                    if (prop.type === 'object') {
                        var cp = path ? path + '.' + name : name;
                        _enumCompositions(prop, rootSchema, cp, false, value ? value[name] : null, cb, opts);
                    }
                    else if (prop.type === 'array') {
                        var pitems = _expandRefProp(prop.items, rootSchema);
                        if (pitems.type === 'object') {
                            var cp = path ? path + '.' + name : name;
                            _enumCompositions(pitems, rootSchema, cp, true, value ? value[name] : null, cb, opts);
                        }
                    }
                }
            });
        }
        function _copyObject(schema, rootSchema, src, dst) {
            var op = Object.keys(src);
            op.forEach(function (propertyName) {
                var srcValue = src[propertyName];
                var ps = null;
                if (schema) {
                    ps = schema.properties[propertyName];
                    if (ps && (ps.$reference || ps.$ux))
                        return;
                }
                if (!ps && propertyName.charAt(0) === '$')
                    return;
                var doDefAction = false;
                if (ps) {
                    if (ps.type === 'object') {
                        if (srcValue === null) {
                            dst[propertyName] = null;
                        }
                        else {
                            dst[propertyName] = {};
                            _copyObject(ps, rootSchema, srcValue, dst[propertyName]);
                        }
                    }
                    else if (ps.type === 'array') {
                        var pitems_1 = _expandRefProp(ps.items, rootSchema);
                        if (srcValue === null) {
                            dst[propertyName] = null;
                            return;
                        }
                        else if (pitems_1.type === 'object') {
                            if (srcValue === undefined) {
                            }
                            else if (srcValue === null) {
                                dst[propertyName] = null;
                            }
                            else {
                                dst[propertyName] = new Array(srcValue.length);
                                srcValue.forEach(function (item, index) {
                                    var dv = {};
                                    dst[propertyName][index] = dv;
                                    _copyObject(pitems_1, rootSchema, item, dv);
                                });
                            }
                        }
                        else
                            dst[propertyName] = srcValue.slice(0);
                        return;
                    }
                    else
                        dst[propertyName] = srcValue;
                }
                else {
                    if (srcValue === null)
                        dst[propertyName] = null;
                    else if (Array.isArray(srcValue)) {
                        dst[propertyName] = new Array(srcValue.length);
                        srcValue.forEach(function (item, index) {
                            if (item === null || item === undefined || typeof item !== 'object')
                                dst[propertyName][index] = item;
                            else {
                                var dv = {};
                                dst[propertyName][index] = dv;
                                _copyObject(null, rootSchema, item, dv);
                            }
                        });
                    }
                    else if (typeof srcValue === 'object') {
                        dst[propertyName] = {};
                        _copyObject(null, rootSchema, srcValue, dst[propertyName]);
                    }
                    else
                        dst[propertyName] = srcValue;
                }
            });
        }
        function _enumProps(payload, schema, rootSchema, cb) {
            _enumCompositions(schema, rootSchema, '', false, payload, function (prefix, cs, cv, array) {
                if (cv === null || cv === undefined)
                    return false;
                if (cs && cs.properties) {
                    // enum all properties
                    Object.keys(cs.properties).forEach(function (pn) {
                        var cps = cs.properties[pn];
                        if (array) {
                            cv.forEach(function (elementitem) {
                                cb(pn, cps, elementitem, { prefix: prefix });
                            });
                        }
                        else
                            cb(pn, cps, cv, { prefix: prefix });
                    });
                }
                return true;
            });
        }
        function _load$ref(refName, config) {
            if (!config.definitions)
                throw new Error('schema.definitions is null');
            var reference = refName;
            var ii = reference.indexOf(DEF_LINK);
            if (ii < 0)
                throw new Error(_utils.format('Invalid $ref. ({0})', reference));
            var path = reference.substring(ii + DEF_LINK_LEN);
            return config.definitions[path];
        }
        function _toMerge(item, cs, config) {
            var toMerge = null;
            if (item.allOf) {
                toMerge = item.allOf;
                delete item.allOf;
            }
            else if (item.$ref) {
                if (cs.indexOf(item.$ref) < 0) {
                    toMerge = [{ $ref: item.$ref }];
                    delete item.$ref;
                }
            }
            if (toMerge) {
                toMerge.forEach(function (ci) {
                    var ncs = cs.slice(0);
                    if (ci.$ref) {
                        var ref = _load$ref(ci.$ref, config);
                        ncs.push(ci.$ref);
                        delete ci.$ref;
                        _utils.merge(ref, ci);
                    }
                    _expand$Ref(ci, ncs, config);
                    _utils.merge(ci, item);
                });
            }
            return toMerge;
        }
        function _expand$Ref(item, cs, config) {
            var ccs = cs.slice(0);
            var toMerge = _toMerge(item, ccs, config);
            var toExpand = null;
            if (item.properties) {
                toExpand = item;
            }
            else if (item.type === 'array' && item.items) {
                toExpand = item.items;
            }
            if (toExpand && toExpand.properties) {
                Object.keys(toExpand.properties).forEach(function (name) {
                    var prop = toExpand.properties[name];
                    if (prop.allOf || prop.$ref) {
                        _toMerge(prop, cs, config);
                    }
                    if (prop.type === 'array' && prop.items) {
                        if (prop.items.allOf || prop.items.$ref) {
                            _toMerge(prop.items, cs, config);
                        }
                    }
                });
            }
        }
        var _sutils = {
            RATE_DECIMALS: 2,
            RATE_MAXIMUM: 1000,
            RATE_SYMBOL: '%',
            expandSchema$Ref: function (schema) {
                return _expand$Ref(schema, [], schema);
            },
            _getDefault: function (value) {
                if (value == "@date")
                    return _ulocale.date2ISO(new Date());
                return value;
            },
            checkLookup: function (lookup) {
                if (!lookup)
                    return null;
                lookup = $.extend({}, lookup);
                if (!lookup.data || lookup.data.$type != 'odata') {
                    lookup.pagination = false;
                    lookup.cache = true;
                }
                if (lookup.pagination !== false)
                    lookup.pagination = true;
                if (lookup.pagination)
                    lookup.cache = false;
                return lookup;
            },
            schema2Authoring: function (schema, rootSchema, locale) {
                var res = [];
                _enumCompositions(schema, rootSchema, '', false, null, function (prefix, cs, rs, value, array) {
                    if (array)
                        return false;
                    Object.keys(cs.properties).forEach(function (name) {
                        var ps = cs.properties[name];
                        if (!_sutils.inModel(ps, rs))
                            return;
                        //if (_sutils.isCompositionRef(ps) || _sutils.isCompositionList(ps)) return;
                        if (_sutils.isCompositionRef(ps, rs))
                            return;
                        var cp = prefix ? prefix + '.' + name : name;
                        var v = { $type: "field", $bind: cp, $title: _ulocale.tt(ps.title, locale) || cp, $widget: ps.$widget, options: ps.$widgetOptions };
                        res.push(v);
                    });
                    if (cs.links)
                        Object.keys(cs.links).forEach(function (name) {
                            var ps = cs.links[name];
                            var cp = '$links.' + name;
                            cp = prefix ? prefix + '.' + cp : cp;
                            var v = { $type: "action", $bind: cp, $title: _ulocale.tt(ps.title, locale) || cp, $widget: ps.widget, options: ps.$widgetOptions };
                            res.push(v);
                        });
                    return true;
                });
                return res;
            },
            filtrableFields: function (schema, rootSchema, locale) {
                var res = [];
                _enumCompositions(schema, rootSchema, '', false, null, function (prefix, cs, rs, value, array) {
                    if (array)
                        return false;
                    Object.keys(cs.properties).forEach(function (name) {
                        var ps = cs.properties[name];
                        if (!_sutils.inModel(ps, rs))
                            return;
                        if (_sutils.isCompositionRef(ps, rs) || _sutils.isCompositionList(ps, rs, true))
                            return;
                        var cp = prefix ? prefix + '.' + name : name;
                        if (_sutils.canFilter(ps)) {
                            var v = { name: cp, schema: _utils.copy(ps) };
                            v.schema.title = _ulocale.tt(v.schema.title || '', locale);
                            res.push(v);
                        }
                    });
                    return true;
                });
                return res;
            },
            isFwField: _isFwField,
            // copy only schema properties
            copyModel: function (schema, model, rootSchema) {
                var res = {};
                rootSchema = rootSchema || schema;
                _copyObject(schema, rootSchema, model, res);
                return res;
            },
            columns: function (schema, rootSchema, locale) {
                var res = [];
                _enumCompositions(schema, rootSchema, '', false, null, function (prefix, cs, rs, value, array) {
                    if (array)
                        return false;
                    Object.keys(cs.properties).forEach(function (name) {
                        var ps = cs.properties[name];
                        if (!_sutils.inModel(ps, rs))
                            return;
                        if (_sutils.isCompositionRef(ps, rs) || _sutils.isCompositionList(ps, rs, true))
                            return;
                        var cp = prefix ? prefix + '.' + name : name;
                        if (_sutils.canShowField(ps)) {
                            var v = { name: cp, schema: _utils.copy(ps) };
                            v.schema.title = _ulocale.tt(v.schema.title || '', locale);
                            res.push(v);
                        }
                    });
                    return true;
                });
                return res;
            },
            allData: function (lookup) {
                return !lookup.pagination;
            },
            pkFields: function (pk) {
                if (Array.isArray(pk))
                    return pk;
                else
                    return pk.split(',').map(function (v) { return v.trim(); });
            },
            entityId: function (pkValue) {
                if (typeof pkValue === 'object') {
                    var res = [];
                    return Object.keys(pkValue).map(function (pn) {
                        var v = pkValue[pn];
                        if (typeof v === 'string') {
                            return pn + '=\'' + v + '\'';
                        }
                        else {
                            return pn + '=' + v;
                        }
                    }).join(',');
                }
                else if (typeof pkValue === 'string') {
                    return '\'' + pkValue + '\'';
                }
                else {
                    return pkValue + '';
                }
            },
            extractPkValue: function (item, map) {
                if (map.length == 1)
                    return item[map[0]];
                var o = {};
                map.forEach(function (p) { o[p] = item[p]; });
                return o;
            },
            odataId: function (keys, item) {
                if (keys.length == 1) {
                    return item[keys[0]];
                }
                else {
                    var a_1 = [];
                    keys.forEach(function (key) {
                        a_1.push(key + '=' + encodeURIComponent(item[key] + ''));
                    });
                    return a_1.join(',');
                }
            },
            pk2Id: function (pk, keys) {
                if (keys.length === 1)
                    return pk;
                return JSON.stringify(pk);
            },
            id2Pk: function (id, keys) {
                if (keys.length === 1)
                    return id;
                return JSON.parse(id);
            },
            equals: function (primaryItem, item, keys) {
                if (keys.length === 1)
                    return primaryItem === item[keys[0]];
                for (var i = 0, len = keys.length; i < len; i++) {
                    var p = keys[i];
                    if (primaryItem[p] !== item[p])
                        return false;
                }
                return true;
            },
            extractBase: function (path) {
                var segments = path.split('.');
                segments.pop();
                if (segments.length)
                    return segments.join('.') + '.';
                else
                    return '';
            },
            parentPath: function (path) {
                var segments = path.split('.');
                segments.pop();
                if (segments.length)
                    return segments.join('.');
                else
                    return '';
            },
            findByPk: function (primaryItem, keys, list) {
                if (list && primaryItem) {
                    for (var i = 0, len = list.length; i < len; i++) {
                        var ii = list[i];
                        if (_sutils.equals(primaryItem, ii, keys))
                            return ii;
                    }
                }
                return null;
            },
            supportPagination: function (lookup) {
                //TODO
                return false;
            },
            executeLookup: function (lookup, data, ondata) {
                var promise = _data.execData(lookup.data, data, null);
                if (ondata) {
                    if (promise)
                        promise.then(ondata);
                    else
                        ondata(null);
                }
                else
                    return promise;
            },
            remoteSearch: function (localSearch, lookup) {
                return lookup.mapping ? lookup.mapping[localSearch] : localSearch;
            },
            lastSegment: function (bind, display) {
                var segments = bind.split('.');
                var ls = segments.pop();
                if (display && display != bind) {
                    ls = display.substring(segments.join('.').length);
                }
                return ls;
            },
            findFirst: function (value, searchField, ldata) {
                if (!value || !ldata)
                    return null;
                var sv = value.toLocaleLowerCase();
                var vlen = sv.length;
                for (var i = 0, len = ldata.length; i < len; i++) {
                    var val = ldata[i][searchField] || '';
                    if (val.toLowerCase().substr(0, vlen) === sv) {
                        return { item: ldata[i], index: i };
                    }
                }
                return null;
            },
            _states: ['$states', '$links'],
            isMetaProp: function (pn) {
                return (pn.substr(0, 2) === "$$");
            },
            isMeta: function (bind) {
                var len = '$$meta-'.length;
                if (bind.substr(0, '$$meta-'.length) === '$$meta-') {
                    return { widget: bind.substr(len) };
                }
                else
                    return null;
            },
            getLookup: function (path, lookupName, schema, rootSchema) {
                var segments = path.split('.');
                segments.pop();
                var cs = schema;
                for (var i = 0, len = segments.length; i < len; i++) {
                    if (!cs)
                        break;
                    var s = segments[i];
                    if ((cs.type == "array") && (_sutils.arrayProps.indexOf(s) >= 0)) {
                        cs = _expandRefProp(cs.items, rootSchema);
                        ;
                    }
                    else {
                        cs = cs.properties ? cs.properties[s] : null;
                    }
                }
                if (cs && cs.lookups)
                    return _sutils.checkLookup(cs.lookups[lookupName]);
                return null;
            },
            getSchema: function (path, schema, rootSchema, expandArray) {
                if (!path)
                    return schema;
                var segments = path.split('.');
                var cs = schema, link = false;
                for (var i = 0, len = segments.length; i < len; i++) {
                    if (!cs)
                        break;
                    var s = segments[i];
                    if ((cs.type == "array") && (_sutils.arrayProps.indexOf(s) >= 0)) {
                        // $item, $new 
                        cs = _expandRefProp(cs.items, rootSchema);
                    }
                    else {
                        if (s === "$links") {
                            cs = cs.links;
                            link = true;
                        }
                        else {
                            if (link) {
                                link = false;
                                cs = cs[s];
                            }
                            else {
                                cs = cs.properties ? cs.properties[s] : null;
                                if (!cs && i === (len - 1)) {
                                    if (s === Observable.INDEX_FIELD_NAME) {
                                        return { type: 'integer', title: "#", capabilities: null };
                                    }
                                    else if (s === Observable.SELECTED_FIELD_NAME) {
                                        return { type: 'boolean', title: _locale.ui.Selected, capabilities: null };
                                    }
                                    else if (s === Observable.EXPANDED_FIELD_NAME) {
                                        return { type: 'integer', title: '', capabilities: null };
                                    }
                                }
                            }
                        }
                    }
                }
                if (expandArray && cs && cs.type === 'array' && cs.items)
                    cs = _expandRefProp(cs.items, rootSchema);
                return cs;
            },
            states: ['isHidden', 'isDisabled', 'isReadOnly', 'isMandatory'],
            statesAndErrors: ['isHidden', 'isDisabled', 'isReadOnly', 'isMandatory', 'errors', 'filter', 'symbol', 'decimals'],
            linksStates: ['isHidden', 'isDisabled'],
            isLink: function (path) {
                return (path.split('.').indexOf('$links') >= 0);
            },
            _isMoney: function (schema) {
                return _sutils.isNumber(schema) && schema.format == "money";
            },
            _internalExtractEnums: function (schema, rootSchema, enums, names) {
                if (schema.name) {
                    if (names.indexOf(schema.name) >= 0)
                        return;
                    names.push(schema.name);
                }
                var _addEnum = function (enumref, parentSchema) {
                    parentSchema = parentSchema || schema;
                    if (parentSchema.enums && parentSchema.enums[enumref]) {
                        var ec = parentSchema.enums[enumref].type || "default";
                        enums[ec] = enums[ec] || {};
                        enums[ec][enumref] = parentSchema.enums[enumref];
                    }
                    else {
                        //$enumref = "Satut.codif"
                        var et = enumref.split('.');
                        if (et.length === 2) {
                            enums[et[1]] = enums[et[1]] || {};
                            enums[et[1]][et[0]] = { type: et[1] };
                        }
                    }
                };
                if (schema.lookups)
                    Object.keys(schema.lookups).forEach(function (pn) {
                        var ll = schema.lookups[pn];
                        if (ll.data.$type == "enum" && ll.data.$enumref) {
                            _addEnum(ll.data.$enumref);
                        }
                    });
                Object.keys(schema.properties).forEach(function (pn) {
                    var cs = schema.properties[pn];
                    if (!_sutils.inModel(cs, rootSchema))
                        return;
                    if (_sutils.isCompositionRef(cs, rootSchema)) {
                        _sutils._internalExtractEnums(cs, rootSchema, enums, names);
                    }
                    else if (_sutils.isCompositionList(cs, rootSchema, true)) {
                        _sutils._internalExtractEnums(_expandRefProp(cs.items, rootSchema), rootSchema, enums, names);
                    }
                    else {
                        var ps = schema;
                        if (_sutils.isSimpleList(cs, rootSchema)) {
                            cs = _expandRefProp(cs.items, rootSchema);
                            ps = cs;
                        }
                        if (cs.$enumref) {
                            _addEnum(cs.$enumref, ps);
                        }
                    }
                });
            },
            _extractEnums: function (schema, enums) {
                return _sutils._internalExtractEnums(schema, schema, enums, []);
            },
            _fillEnums: function (schema, enums) {
                _sutils._internalFillEnums(schema, schema, enums, []);
            },
            _internalFillEnums: function (schema, rootSchema, enums, names) {
                if (schema.name) {
                    if (names.indexOf(schema.name) >= 0)
                        return;
                    names.push(schema.name);
                }
                if (schema.lookups)
                    Object.keys(schema.lookups).forEach(function (pn) {
                        var ll = schema.lookups[pn];
                        if (ll.data.$type == "enum" && ll.data.$enumref) {
                            var ear = ll.data.$enumref.split('.');
                            var el = ear.length === 2 ? enums[ear[1]] : (enums[schema.enums[ll.data.$enumref].type || "default"]);
                            var en = ear.length === 2 ? ear[0] : ll.data.$enumref;
                            if (el) {
                                ll.data.$value = [];
                                var enumValues_1 = el[en];
                                enumValues_1.enum.forEach(function (ec, index) {
                                    var item = { code: ec, title: enumValues_1.enumNames[index] };
                                    if (enumValues_1.fields)
                                        _utils.extend(item, enumValues_1.fields[index]);
                                    ll.data.$value.push(item);
                                });
                            }
                        }
                    });
                Object.keys(schema.properties).forEach(function (pn) {
                    var cs = schema.properties[pn];
                    if (!_sutils.inModel(cs, rootSchema))
                        return;
                    if (_sutils.isCompositionRef(cs, rootSchema)) {
                        _sutils._internalFillEnums(cs, rootSchema, enums, names);
                    }
                    else if (_sutils.isCompositionList(cs, rootSchema, true)) {
                        _sutils._internalFillEnums(_expandRefProp(cs.items, rootSchema), rootSchema, enums, names);
                    }
                    else {
                        var parentSchema = schema;
                        if (_sutils.isSimpleList(cs, rootSchema)) {
                            cs = _expandRefProp(cs.items, rootSchema);
                            parentSchema = cs;
                        }
                        if (cs.$enumref) {
                            var ear = cs.$enumref.split('.');
                            if ((parentSchema.enums && parentSchema.enums[cs.$enumref]) || ear.length === 2) {
                                var el = ear.length === 2 ? enums[ear[1]] : enums[parentSchema.enums[cs.$enumref].type || "default"];
                                var en = ear.length === 2 ? ear[0] : cs.$enumref;
                                if (el) {
                                    var enumValues = el[en];
                                    if (enumValues) {
                                        cs.enum = enumValues.enum;
                                        cs.enumNames = enumValues.enumNames;
                                        cs.filters = enumValues.filters;
                                    }
                                }
                            }
                        }
                    }
                });
            },
            loadEnums: function (schema) {
                var allEnums = {}, hasEnums = false;
                _sutils._extractEnums(schema, allEnums);
                var res = Object.keys(allEnums).map(function (enumType) {
                    var cem = _em.get(enumType);
                    if (!cem)
                        throw "Invalid enum type: " + enumType;
                    return cem.promise(allEnums[enumType], enumType);
                });
                if (!res.length)
                    return null;
                return res;
            },
            arrayProps: ['$item', '$new', '$selected'],
            init: function (schema, rootSchema, context, value) {
                var a = value || {};
                a.$states = a.$states || {};
                Object.keys(schema.properties).forEach(function (pn) {
                    var cs = schema.properties[pn];
                    if (!_sutils.inModel(cs, rootSchema))
                        return;
                    var isMeta = _sutils.isMetaProp(pn);
                    var state = schema.states ? schema.states[pn] : null;
                    var ns = a.$states[pn] = (a.$states[pn] || {});
                    if (!isMeta) {
                        if (state) {
                            Object.keys(state).forEach(function (sn) {
                                if (ns[sn] === undefined) {
                                    ns[sn] = state[sn];
                                }
                            });
                        }
                    }
                    if (_sutils.isCompositionRef(cs, rootSchema)) {
                        // recursive	
                        if (ns.isMandatory) {
                            a[pn] = _sutils.init(cs, rootSchema, context, a[pn] || {});
                        }
                    }
                    else if (_sutils.isCompositionList(cs, rootSchema, false) || _sutils.isSimpleList(cs, rootSchema)) {
                        a[pn] = a[pn] || [];
                    }
                    else if (_sutils.isList(cs, rootSchema)) {
                        a[pn] = a[pn] || [];
                    }
                    else {
                        if (a[pn] === undefined) {
                            if (cs.default !== undefined)
                                a[pn] = _sutils._getDefault(cs.default);
                            else if (cs.enum)
                                a[pn] = cs.enum[0];
                            else {
                                switch (cs.type) {
                                    case "number":
                                    case "integer":
                                        a[pn] = 0;
                                        break;
                                }
                            }
                        }
                    }
                });
                return a;
            },
            //
            isCompositionRef: function (prop, rootSchema) {
                return prop.type === "object" && !prop.$reference;
            },
            isRef: function (prop, rootSchema) {
                return prop.type === "object" && prop.$reference;
            },
            isList: function (prop, rootSchema) {
                return prop.type === "array" && prop.$reference;
            },
            isCompositionList: function (prop, rootSchema, followRefs) {
                if (prop.type === "array" && prop.items) {
                    var pitems = _expandRefProp(prop.items, rootSchema);
                    return (pitems.type === "object" || pitems.type === "array") && (!prop.$reference || (followRefs && prop.$reference));
                }
                else
                    return false;
            },
            isSimpleList: function (prop, rootSchema) {
                if (prop.type === "array" && prop.items) {
                    var pitems = _expandRefProp(prop.items, rootSchema);
                    return (pitems.type !== "object" || pitems.type === "array") && !prop.$reference;
                }
                else
                    return false;
            },
            inModel: function (prop, rootSchema) {
                if (_sutils.isRef(prop, rootSchema))
                    return false;
                return true;
            },
            formatNumber: function (schema, value) {
                if (schema.format == "money")
                    return _ulocale.money(value, false);
                return _ulocale.decimal(value, schema.decimals || 0, null);
            },
            _title: function (title, locale) {
                if (locale)
                    return _ulocale.tt(title, locale);
                return title;
            },
            canSort: function (schema) {
                if (schema) {
                    if (schema.hidden)
                        return false;
                    _parseCapabilities(schema);
                    return schema.features.sortable;
                }
                return false;
            },
            canShowField: function (schema) {
                if (schema.hidden)
                    return false;
                return true;
            },
            canFilter: function (schema) {
                if (schema) {
                    if (schema.hidden)
                        return false;
                    _parseCapabilities(schema);
                    return schema.features.filtrable;
                }
                return false;
            },
            checkNumber: function (value, schema, locale, errors) {
                var res = true;
                if (schema.exclusiveMinimum) {
                    if (schema.minimum != undefined && value <= schema.minimum) {
                        errors.push({ message: _utils.format(_localeSchema.minNumberExclusive, _sutils._title(schema.title, locale), _sutils.formatNumber(schema, schema.minimum)) });
                        res = false;
                    }
                }
                else {
                    if (schema.minimum != undefined && value < schema.minimum) {
                        errors.push({ message: _utils.format(_localeSchema.minNumber, _sutils._title(schema.title, locale), _sutils.formatNumber(schema, schema.minimum)) });
                        res = false;
                    }
                }
                if (schema.exclusiveMaximum) {
                    if (schema.maximum != undefined && value >= schema.maximum) {
                        errors.push({ message: _utils.format(_localeSchema.maxNumberExclusive, _sutils._title(schema.title, locale), _sutils.formatNumber(schema, schema.maximum)) });
                        res = false;
                    }
                }
                else {
                    if (schema.maximum != undefined && value > schema.maximum) {
                        errors.push({ message: _utils.format(_localeSchema.maxNumber, _sutils._title(schema.title, locale), _sutils.formatNumber(schema, schema.maximum)) });
                        res = false;
                    }
                }
                return res;
            },
            _validateEmail: function (email, error) {
                var re = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
                return re.test(email);
            },
            _validateJson: function (value, error) {
                try {
                    JSON.parse(value);
                }
                catch (ex) {
                    error.ex = ex;
                    return false;
                }
                return true;
            },
            checkString: function (value, state, schema, locale, errors) {
                var res = true;
                var v = (value || '');
                if (schema.minLength && v.length < schema.minLength) {
                    errors.push({ message: _utils.format(_localeSchema.minLength, _sutils._title(schema.title, locale), schema.minLength) });
                    res = false;
                }
                if (state.isMandatory) {
                    if (v === '') {
                        errors.push({ message: _utils.format(_localeSchema.required, _sutils._title(schema.title, locale)) });
                        res = false;
                    }
                }
                if (schema.format) {
                    if (schema.format === "email") {
                        if (value && !_sutils._validateEmail(value, {})) {
                            errors.push({ message: _localeSchema.invalidEmail });
                            res = false;
                        }
                    }
                    else if (schema.format === "json") {
                        var error = {};
                        if (value && !_sutils._validateJson(value, error)) {
                            errors.push({ message: error.ex.message });
                            res = false;
                        }
                    }
                }
                return res;
            },
            validatePassword: function (orig, value, schema, state, locale, errors) {
                var res = true;
                if (state.isHidden || state.isDisabled)
                    return res;
                if (orig !== value) {
                    errors.push({ message: _localeSchema.passwordMismatch });
                    res = false;
                }
                return res;
            },
            validateSchema: function (value, schema, state, locale, errors) {
                var res = true;
                if (state) {
                    if (state.isHidden || state.isDisabled)
                        return res;
                }
                switch (schema.type) {
                    case "number":
                    case "integer":
                        res = _sutils.checkNumber(value, schema, locale, errors);
                        break;
                    case "string":
                        res = _sutils.checkString(value, state, schema, locale, errors);
                        break;
                }
                return res;
            },
            loadEnumsPromise: function (schema) {
                var enums = _sutils.loadEnums(schema);
                if (!enums) {
                    return new _utils.Promise(function (resolve, reject) {
                        resolve(schema);
                    });
                }
                return _utils.Promise.all(enums).then(function (values) {
                    var allEnums = {};
                    values.forEach(function (ev) {
                        allEnums[ev.type] = ev.enums;
                    });
                    _sutils._fillEnums(schema, allEnums);
                    return schema;
                });
            },
            loadSchemaRefs: function (schema, ldata, layout, after) {
                if (!schema)
                    return after();
                _sutils.expandSchema$Ref(schema);
                var enums = _sutils.loadEnums(schema);
                var promises = enums ? enums : [];
                var enumsCount = enums ? enums.length : 0;
                var mainData = _dutils.loadMainData(layout);
                if (mainData)
                    promises.push(mainData);
                var dataCount = mainData ? enumsCount + 1 : 0;
                if (!promises.length)
                    return after(ldata);
                _dom.processing(true);
                _utils.Promise.all(promises).then(function (values) {
                    _dom.processing(false);
                    var allEnums = {};
                    values.forEach(function (ev, index) {
                        if (index < enumsCount) {
                            allEnums[ev.type] = ev.enums;
                        }
                        else if (index < dataCount) {
                            $.extend(true, ldata, ev);
                        }
                    });
                    if (enumsCount) {
                        _sutils._fillEnums(schema, allEnums);
                    }
                    after(ldata);
                }).catch(function (ex) {
                    _dom.processing(false);
                    throw ex;
                });
            },
            stateProps: function (schema) {
                if (schema.enum && schema.filters) {
                    return ['filter'];
                }
                else if (schema.items && schema.items.enum && schema.items.filters) {
                    return ['filter'];
                }
                else if (_sutils.isNumber(schema)) {
                    return ['symbol', 'decimals'];
                }
                return null;
            },
            isPassword: function (schema) {
                return schema.type === "string" && schema.format === "password";
            },
            isDate: function (schema) {
                return schema.type === "string" && schema.format === "date";
            },
            isDateTime: function (schema) {
                return schema.type === "string" && schema.format === "date-time";
            },
            isBoolean: function (schema) {
                return schema.type === "boolean";
            },
            isSelectField: function (fieldName) {
                return fieldName === Observable.SELECTED_FIELD_NAME;
            },
            isExpandField: function (fieldName) {
                return fieldName === Observable.EXPANDED_FIELD_NAME;
            },
            isNumber: function (schema) {
                return (schema.type === 'number' || schema.type === 'integer');
            },
            isText: function (schema) {
                return schema.type === 'string' && (schema.format === 'json' || schema.format === 'memo');
            },
            isMoney: function (schema) {
                return _sutils.isNumber(schema) && schema.format === "money";
            },
            text2Value: function (textValue, schema, state) {
                if (_sutils.isNumber(schema)) {
                    var dec = state.decimals;
                    var float = _ulocale.string2Float(textValue);
                    float = parseFloat(float.toFixed(dec));
                    return float;
                }
                return textValue;
            },
            value2Text: function (value, schema, state) {
                var that = this;
                if (_sutils.isNumber(schema)) {
                    return _ulocale.decimal(value, state.decimals, null);
                }
                else
                    return value || '';
            },
            expand$Ref: function (cs, rootSchema) {
                return _expandRefProp(cs, rootSchema);
            },
            removeExpand: function (propName, expandingProperty) {
                if (!expandingProperty)
                    return propName;
                var s = expandingProperty + '.$item.';
                var ii = propName.lastIndexOf(s);
                if (ii < 0)
                    return propName;
                return propName.substr(ii + s.length);
            },
            registerValidator: _rv.register,
            getValidator: _rv.get,
            registerEnumManager: _em.register,
            getEnumManager: _em.get
        };
        var _dutils = {
            extractDatasets: function (config) {
                if (config.datasets) {
                    var datasets = Object.keys(config.datasets);
                    if (datasets.length) {
                        return datasets.map(function (dsName) {
                            var dc = $.extend({}, config.datasets[dsName], true);
                            dc.name = dsName;
                            return dc;
                        });
                    }
                }
                return null;
            },
            isQuery: function (ds) {
                return (ds.$type === 'odata' && (!ds.$method || ds.$method.toUpperCase() === 'GET') && !ds.$params.hasOwnProperty('$entityId'));
            },
            isCreateOrUpdate: function (ds) {
                return ds.$type === "odata" && ds.$params.hasOwnProperty('$entityId');
            },
            extractMainDataSource: function (config) {
                var main = null;
                if (config.datasets) {
                    var datasets = Object.keys(config.datasets);
                    if (datasets.length) {
                        datasets.forEach(function (dsName) {
                            if (config.datasets[dsName].$main)
                                main = $.extend({}, config.datasets[dsName], true);
                        });
                        if (!main)
                            main = $.extend({}, config.datasets[datasets[0]], true);
                    }
                }
                return main;
            },
            datasetsAsPromise: function (ds, transform) {
                return new _utils.Promise(function (resolve, reject) {
                    var result = {};
                    _dom.processing(true);
                    var main = null;
                    var children = [];
                    ds.forEach(function (ce) {
                        if (ce.$main)
                            main = ce;
                    });
                    if (!main)
                        main = ds[0];
                    if (main.children) {
                        Object.keys(main.children).forEach(function (name) {
                            main.children[name].name = name;
                            children.push(main.children[name]);
                        });
                    }
                    if (_dutils.isCreateOrUpdate(main)) {
                        main.$create = main.$create || {};
                    }
                    _dsPlugin.executeDatasets(ds, {}, result, {}, function (sended, ex) {
                        _dom.processing(false);
                        if (!ex) {
                            var mainData_1 = result[main.name];
                            if (children && children.length) {
                                _dom.processing(true);
                                var cresult_1 = {};
                                return _dsPlugin.executeDatasets(children, mainData_1, cresult_1, {}, function (sended, ex) {
                                    _dom.processing(false);
                                    Object.keys(cresult_1).forEach(function (name) {
                                        result[name] = cresult_1[name];
                                    });
                                    var hnd = _customData.get('datasets.transform.' + transform);
                                    if (hnd)
                                        hnd(result);
                                    resolve(mainData_1);
                                }, false);
                            }
                            else {
                                if (transform) {
                                    var hnd = _customData.get('datasets.transform.' + transform);
                                    if (hnd)
                                        hnd(result);
                                }
                                resolve(mainData_1);
                            }
                        }
                        else {
                            reject(ex);
                        }
                    });
                });
            },
            datasetAsPromise: function (ds, ldata) {
                return new _utils.Promise(function (resolve, reject) {
                    var result = {};
                    ds.name = ds.name || 'data';
                    _dom.processing(true);
                    _dsPlugin.executeDatasets([ds], ldata || {}, result, {}, function (sended, ex) {
                        _dom.processing(false);
                        if (!ex) {
                            resolve(result[ds.name]);
                        }
                        else {
                            reject(ex);
                        }
                    });
                });
            },
            loadMainData: function (config) {
                var ds = _dutils.extractDatasets(config);
                if (ds && ds.length)
                    return _dutils.datasetsAsPromise(ds, config.transform);
                return _utils.Promise.resolve(null);
            },
            dsConfig: function (datasets, prop, isQuery) {
                var dsName = prop.$reference;
                if (datasets && dsName) {
                    var keys = Object.keys(datasets);
                    if (keys.length === 1) {
                        var ds = datasets[keys[0]];
                        ;
                        ds.$main = true;
                        return ds;
                    }
                    if (typeof dsName === 'string') {
                        return datasets[dsName];
                    }
                }
                return null;
            },
        };
        var _defEnumManager = {
            _enums: {},
            promise: function (enums, enumType) {
                var res = {};
                Object.keys(enums).forEach(function (enumName) {
                    var ce = enums[enumName];
                    if (!_defEnumManager._enums[enumName]) {
                        _defEnumManager._enums[enumName] = {
                            enum: ce.enum,
                            enumNames: ce.enumNames,
                            filters: ce.filters
                        };
                    }
                    res[enumName] = _defEnumManager._enums[enumName];
                });
                return new _utils.Promise(function (resolve, reject) {
                    resolve({ type: enumType, enums: res });
                });
            }
        };
        _sutils.registerEnumManager("default", _defEnumManager);
        Observable.SchemaUtils = _sutils;
        Observable.DataUtils = _dutils;
    })(Observable = Phoenix.Observable || (Phoenix.Observable = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../core/core.ts" />
/// <reference path="./schema.data.ts" />
var Phoenix;
(function (Phoenix) {
    var Observable;
    (function (Observable) {
        var _sutils = Observable.SchemaUtils;
        var BaseState = (function () {
            function BaseState(parent, prop, value) {
            }
            BaseState.prototype.destroy = function () {
                var that = this;
                if (that._state)
                    that._state = null;
                that.parent = null;
            };
            BaseState.prototype.state = function () {
                return this._state;
            };
            BaseState.prototype._init = function (parent, prop, value, list) {
                var that = this;
                list = list || [];
                that._state = value || {};
                that.name = prop;
                that.parent = parent;
                list.forEach(function (propertyName) {
                    if (that._state[propertyName] === undefined)
                        that._state[propertyName] = false;
                    Object.defineProperty(that, propertyName, {
                        get: function () {
                            return this._state[propertyName] || false;
                        },
                        set: function (value) {
                            var self = this;
                            var oldValue = self._state[propertyName] || false;
                            if (oldValue !== value) {
                                self._state[propertyName] = value;
                                if (propertyName === "filter") {
                                    if (self.parent) {
                                        var v = self.parent.getValue(that.name);
                                        var cs = self.parent.getSchema(that.name);
                                        if (cs && cs.enum && cs.filters) {
                                            var enums = value ? cs.filters[value] : cs.enum;
                                            if (enums) {
                                                var ii = enums.indexOf(v);
                                                if (ii < 0)
                                                    self.parent.setValue(that.name, enums.length ? enums[0] : null);
                                            }
                                        }
                                    }
                                }
                                if (self.parent && self.parent.notifyStateChanged)
                                    self.parent.notifyStateChanged(that.name + '.' + propertyName, {});
                            }
                        },
                        enumerable: true
                    });
                });
            };
            return BaseState;
        }());
        Observable.BaseState = BaseState;
        ;
        var DataStates = (function (_super) {
            __extends(DataStates, _super);
            function DataStates(parent, prop, value) {
                _super.call(this, parent, prop, value);
                var ss = parent.getSchema('').properties[prop];
                var l = _sutils.states;
                if (ss) {
                    var props = _sutils.stateProps(ss);
                    if (props && props.length) {
                        l = props.concat(l);
                    }
                }
                this._init(parent, prop, value, l);
            }
            return DataStates;
        }(BaseState));
        Observable.DataStates = DataStates;
        var LinkStates = (function (_super) {
            __extends(LinkStates, _super);
            function LinkStates(parent, prop, value) {
                _super.call(this, parent, prop, value);
                this._init(parent, "$links." + prop, value, _sutils.linksStates);
            }
            return LinkStates;
        }(BaseState));
        Observable.LinkStates = LinkStates;
    })(Observable = Phoenix.Observable || (Phoenix.Observable = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../core/core.ts" />
/// <reference path="./schema.data.ts" />
var Phoenix;
(function (Phoenix) {
    var Observable;
    (function (Observable) {
        var _errorsUtils = {
            errorChanged: function (oldErrors, newErrors) {
                oldErrors = oldErrors || [];
                if (!newErrors || !newErrors.length) {
                    if (oldErrors.length)
                        return true;
                }
                else {
                    if (oldErrors.length != newErrors.length) {
                        return true;
                    }
                    else {
                        var changed = false;
                        for (var i = 0, len = oldErrors.length; i < len; i++) {
                            var oe = oldErrors[i];
                            var ne = newErrors[i];
                            if (oe.code && ne.code) {
                                if (oe.code !== ne.code) {
                                    changed = true;
                                    break;
                                }
                            }
                            else if (!oe.code || !ne.code) {
                                changed = true;
                                break;
                            }
                            else {
                                if (oe.message !== ne.message) {
                                    changed = true;
                                    break;
                                }
                            }
                        }
                        return changed;
                    }
                }
            }
        };
        var Errors = (function () {
            function Errors(parent, prop, value, nostore) {
                this._init(parent, prop, value, nostore);
            }
            Errors.prototype.destroy = function () {
                var that = this;
                if (that._errors)
                    that._errors = null;
                that.parent = null;
            };
            Errors.prototype.errors = function () {
                return this._errors;
            };
            Errors.prototype.clear = function (notify) {
                var that = this;
                if (that._errors.length) {
                    that._errors.length = 0;
                    if (notify)
                        that.notify();
                    return true;
                }
                return false;
            };
            Errors.prototype.hasErrors = function () {
                var that = this;
                return that._errors && that._errors.length ? true : false;
            };
            Errors.prototype.addErrors = function (errors, add) {
                var that = this;
                if (that.nostore) {
                    if (that.parent && that.parent.addErrors)
                        that.parent.addErrors(errors, add);
                }
                else if (add || _errorsUtils.errorChanged(that._errors, errors)) {
                    that._errors = errors || [];
                    that.notify();
                }
            };
            Errors.prototype.addError = function (message, add) {
                var that = this;
                that.addErrors([{ severity: "error", message: message }], add);
            };
            Errors.prototype.addSuccess = function (message, add) {
                var that = this;
                that.addErrors([{ severity: "success", message: message, timeout: 2 }], add);
            };
            Errors.prototype.addWarning = function (message, add) {
                var that = this;
                that.addErrors([{ severity: "warning", message: message, timeout: 2 }], add);
            };
            Errors.prototype.notify = function () {
                var that = this;
                if (that.parent && that.parent.notifyStateChanged)
                    that.parent.notifyStateChanged(that.name + '.errors', {});
            };
            Errors.prototype._init = function (parent, prop, value, nostore) {
                var that = this;
                that._errors = value || [];
                that.name = prop;
                that.parent = parent;
                that.nostore = nostore;
            };
            return Errors;
        }());
        Observable.Errors = Errors;
        Observable.errorsUtils = _errorsUtils;
    })(Observable = Phoenix.Observable || (Phoenix.Observable = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../core/core.ts" />
/// <reference path="./schema.data.ts" />
/// <reference path="../datasets-plugin.ts" />
var Phoenix;
(function (Phoenix) {
    var Observable;
    (function (Observable) {
        var _utils = Phoenix.utils, _dom = Phoenix.dom, _sutils = Observable.SchemaUtils, _dutils = Observable.DataUtils, _dsPlugin = Phoenix.DatasetPlugin;
        var QueryableDataSource = (function () {
            function QueryableDataSource(dsConfig, model) {
                if (dsConfig.$type !== 'odata')
                    throw new Error('Only odata sources are supported.');
                var that = this;
                that._config = dsConfig || {};
                that._origFilter = that._config.$params.$filter;
                that._pageSize = 0;
                that._model = model;
                that._currentPage = 1;
                if (that.isQuery()) {
                    that._pageSize = that._config.$params.$top || 0;
                    that._orderby = that._config.$params.$orderby || '';
                }
                else {
                    throw "Invalid Queryable DataSource";
                }
            }
            QueryableDataSource.prototype.initPagination = function (pageSize, currentpage, totalCount) {
                var that = this;
                that._pageSize = pageSize;
                that._totalCount = totalCount;
                that._currentPage = currentpage;
            };
            QueryableDataSource.prototype.initFromData = function (ldata) {
                var that = this;
                if (that.isQuery()) {
                    that._pageSize = ldata.pageSize;
                    that._currentPage = that._pageSize ? (Math.ceil(ldata.skip / that._pageSize) + 1) : 0;
                    that._totalCount = ldata.count;
                    that._skip = ldata.skip;
                }
            };
            Object.defineProperty(QueryableDataSource.prototype, "filter", {
                get: function () {
                    var that = this;
                    return that._filter;
                },
                set: function (value) {
                    var that = this;
                    that._filter = value;
                    if (that._filter && that._filter.value) {
                        if (that._origFilter)
                            that._config.$params.$filter = { $left: that._origFilter, $op: "AND", $right: that._filter.value };
                        else
                            that._config.$params.$filter = that._filter.value;
                    }
                    else {
                        if (that._origFilter)
                            that._config.$params.$filter = that._origFilter;
                        else
                            that._config.$params.$filter = null;
                    }
                    that.refresh(true);
                },
                enumerable: true,
                configurable: true
            });
            QueryableDataSource.prototype.pageSize = function () {
                var that = this;
                return that.isQuery() ? that._pageSize : 0;
            };
            QueryableDataSource.prototype.orderBy = function (value) {
                var that = this;
                if (value === undefined)
                    return that._orderby;
                if (value !== that._orderby) {
                    that._orderby = value;
                    that.refresh(true);
                }
                return that._orderby;
            };
            QueryableDataSource.prototype.refresh = function (resetPagination) {
                var that = this;
                return new _utils.Promise(function (resolve, reject) {
                    if (that.isQuery()) {
                        if (resetPagination)
                            that._currentPage = 0;
                        that._open().then(function () {
                            that._model.notifyPaginationChanged();
                            that._model.notifySortingChanged();
                            resolve();
                        });
                    }
                    else
                        resolve();
                });
            };
            QueryableDataSource.prototype.currentPage = function (page) {
                var that = this;
                if (page != undefined) {
                    if (that.isQuery()) {
                        var np = Math.min(page, that.totalPages());
                        if (that._currentPage != np) {
                            that._currentPage = np;
                            that._open().then(function () {
                                that._model.notifyPaginationChanged();
                            });
                        }
                    }
                    return page;
                }
                else
                    return that.isQuery() ? that._currentPage : 0;
            };
            QueryableDataSource.prototype.totalPages = function () {
                var that = this;
                return that.isQuery() ? (that._pageSize ? Math.ceil(that._totalCount / that._pageSize) : 1) : 0;
            };
            QueryableDataSource.prototype.totalCount = function () {
                var that = this;
                return that.isQuery() ? that._totalCount : 0;
            };
            QueryableDataSource.prototype.destroy = function () {
                var that = this;
                that._config = null;
                that._model = null;
            };
            QueryableDataSource.prototype.isQuery = function () {
                return _dutils.isQuery(this._config);
            };
            QueryableDataSource.prototype.open = function () {
                return this._open();
            };
            QueryableDataSource.prototype.remove = function (key, etag) {
                var that = this;
                var isQuery = that.isQuery();
                if (!isQuery)
                    return null;
                return new _utils.Promise(function (resolve, reject) {
                    var dsCfg = {
                        name: "data",
                        $type: that._config.$type,
                        $method: "DELETE",
                        $params: {
                            $module: that._config.$params.$module,
                            $entity: that._config.$params.$entity,
                            $entityId: key
                        }
                    };
                    var result = {};
                    _dom.processing(true);
                    _dsPlugin.executeDatasets([dsCfg], { etag: etag }, result, {}, function (sended, ex) {
                        _dom.processing(false);
                        if (!ex) {
                            resolve(null);
                        }
                        else {
                            if (that._model) {
                                that._model.addAjaxException(ex);
                                reject(null);
                            }
                            else
                                reject(ex);
                        }
                    });
                });
            };
            QueryableDataSource.prototype._open = function () {
                var that = this;
                that._config.name = "data";
                return new _utils.Promise(function (resolve, reject) {
                    _dom.processing(true);
                    var isQuery = that.isQuery();
                    var result = {};
                    if (isQuery) {
                        // update orderby
                        if (that._orderby) {
                            if (that._config.$params.$orderby !== that._orderby)
                                that._config.$params.$orderby = that._orderby;
                        }
                        // update pagination
                        if (that._pageSize > 0) {
                            that._config.$params.$top = that._pageSize;
                            that._config.$params.$skip = Math.max(0, that._currentPage - 1) * that._pageSize;
                            if (that._config.$params.$skip == 0)
                                delete that._config.$params.$skip;
                        }
                        else {
                            delete that._config.$params.$top;
                            delete that._config.$params.$skip;
                        }
                    }
                    _dsPlugin.executeDatasets([that._config], {}, result, {}, function (sended, ex) {
                        _dom.processing(false);
                        if (!ex) {
                            var ldata = result.data;
                            that.initFromData(ldata);
                            if (isQuery) {
                                if (that._skip && that._skip >= that._totalCount) {
                                    that._currentPage = 0;
                                    return that._open().then(function (rdata) {
                                        resolve(rdata);
                                    });
                                }
                            }
                            if (that._model) {
                                that.isQuery() ? that._model.setModel(ldata.documents) : that._model.setModel(ldata);
                            }
                            resolve(ldata);
                        }
                        else {
                            if (that._model) {
                                that._model.addAjaxException(ex);
                                reject(null);
                            }
                            else
                                reject(ex);
                        }
                    });
                });
            };
            QueryableDataSource.prototype.save = function () {
                var that = this;
                if (that.isQuery())
                    return;
                if (!that._model.validate())
                    return;
            };
            return QueryableDataSource;
        }());
        Observable.QueryableDataSource = QueryableDataSource;
    })(Observable = Phoenix.Observable || (Phoenix.Observable = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../core/core.ts" />
/// <reference path="../../core/modules/ajax.ts" />
/// <reference path="./schema.data.ts" />
/// <reference path="./state.data.ts" />
/// <reference path="./errors.data.ts" />
/// <reference path="./queryable.ts" />
var Phoenix;
(function (Phoenix) {
    var Observable;
    (function (Observable) {
        var _observable = Observable, _su = _observable.SchemaUtils, _du = _observable.DataUtils, _utils = Phoenix.utils, _ajax = Phoenix.ajax, _locale = Phoenix.locale, _ulocale = Phoenix.ulocale, _localeSchema = Phoenix.locale.schema, _createProp = function (obj, propertyName) {
            var rs = obj._rootParent._schema;
            var cs = obj._schema.properties[propertyName];
            if (!_su.inModel(cs, rs))
                return;
            Object.defineProperty(obj, propertyName, {
                get: function () {
                    var that = this;
                    var c = that._children[propertyName];
                    if (c) {
                        if (c.isNull)
                            return null;
                        if (c.isUndefined)
                            return undefined;
                        return c;
                    }
                    return that._model[propertyName];
                },
                set: function (value) {
                    var that = this;
                    var oldValue = that._model[propertyName];
                    if (oldValue !== value) {
                        if (that._beforeChange(propertyName, oldValue, value)) {
                            that._model[propertyName] = value;
                            var schema = that._schema.properties[propertyName];
                            var rootSchema = obj._rootParent._schema;
                            if (_su.isCompositionRef(schema, rootSchema)) {
                                that._setRefChild(propertyName, oldValue, value, {});
                                that._notifyChanged(propertyName, oldValue, value, 'propchange', {}, true);
                                that.notifyStateChanged(propertyName, {});
                            }
                            else if (_su.isCompositionList(schema, rootSchema, false)) {
                                that._setListChild(propertyName, oldValue, value, 'propchange', {});
                                that._notifyChanged(propertyName, oldValue, value, 'propchange', {}, true);
                                that.notifyStateChanged(propertyName, {});
                            }
                            else if (_su.isSimpleList(schema, rootSchema)) {
                                that._setSimpleListChild(propertyName, oldValue, value, 'propchange', {});
                                that._notifyChanged(propertyName, oldValue, value, 'propchange', {}, true);
                                that.notifyStateChanged(propertyName, {});
                            }
                            else if (_su.isList(schema, rootSchema)) {
                                that[propertyName].setModel(value);
                            }
                            else {
                                that._notifyChanged(propertyName, oldValue, value, 'propchange', {}, true);
                            }
                        }
                    }
                },
                enumerable: true
            });
            if (_su.isCompositionList(cs, rs, false)) {
                // add expand 
                Object.defineProperty(obj, propertyName + Observable.EXPANDED_FIELD_NAME, {
                    get: function () {
                        var that = this;
                        var list = that[propertyName];
                        if (!list.length)
                            return 0;
                        return list.$expand ? 2 : 1;
                    },
                    set: function (value) {
                        var that = this;
                        var list = that[propertyName];
                        if (value === 1)
                            list.$expand = false;
                        else if (value === 2)
                            list.$expand = true;
                    },
                    enumerable: true
                });
            }
        }, _createStateProp = function (obj, name, defvalue) {
            var ss = obj._schema.properties[name];
            var rs = obj._rootParent._schema;
            if (!_su.inModel(ss, rs))
                return;
            if (_su.isNumber(ss)) {
                if (_su.isMoney(ss)) {
                    defvalue = defvalue || {};
                    if (!defvalue.symbol)
                        defvalue.symbol = ss.symbol || _locale.number.symbol;
                    if (!defvalue.decimals)
                        defvalue.decimals = (ss.decimals !== undefined) ? ss.decimals : _locale.number.places;
                }
                else {
                    defvalue = defvalue || {};
                    if (ss.symbol !== undefined) {
                        defvalue = defvalue || {};
                        defvalue.symbol = ss.symbol;
                    }
                    if (ss.decimals !== undefined)
                        defvalue.decimals = ss.decimals;
                    else
                        defvalue.decimals = 0;
                }
            }
            obj.$states[name] = new _observable.DataStates(obj, name, defvalue);
        }, _createErrorProp = function (obj, name, defvalue) {
            var schema = obj._schema.properties[name];
            var rs = obj._rootParent._schema;
            if (!_su.inModel(schema, rs))
                return;
            obj.$errors[name] = new _observable.Errors(obj, name, defvalue, _su.isCompositionRef(schema, rs));
        }, _createStateLinks = function (obj, name, defvalue) {
            obj.$links[name] = new _observable.LinkStates(obj, name, defvalue);
        }, _dutils = {
            setValue: function (path, value, model, params) {
                model.setValue(path, value, params);
            },
            getValue: function (path, model, params) {
                return model.getValue(path, params);
            },
            getState: function (path, model, params) {
                return model.getState(path, params);
            },
            _resolveSegment: function (segment, path, value, params, val, isSet) {
                if (segment === '$item') {
                    if (params) {
                        var p = params[path];
                        if (p && p.$index !== undefined) {
                            if (isSet)
                                value[p.$index] = val;
                            return value[p.$index];
                        }
                    }
                }
                else if (segment === '$selected') {
                    if (isSet)
                        value[segment] = val;
                    return value[segment];
                }
                else if (segment === '$new') {
                    if (isSet)
                        value[segment] = val;
                    return value[segment];
                }
                else {
                    if (value && value[segment] && typeof value[segment] === 'function') {
                        if (isSet)
                            return value[segment](val);
                        return value[segment]();
                    }
                    else {
                        if (isSet)
                            value[segment] = val;
                        return value[segment];
                    }
                }
                return undefined;
            }
        };
        var DataListCore = (function () {
            function DataListCore(schema, parent, path, value, arrayParent, locale) {
                var that = this;
                that._map = {};
                that._expanded = false;
                that._selectedUids = [];
                that._selectedPks = [];
                that._model = [];
                that._items = [];
                that._path = path;
                that._parent = parent;
                that._locale = locale;
                that._arrayParent = arrayParent;
                that._rootSchema = that._parent.getRootModel().getSchema('');
                that._schema = schema;
                that._schemaItems = _su.expand$Ref(schema.items, that._rootSchema);
                that.frozen = false;
                that._setModel(value, false);
                that._createCustomProps();
            }
            Object.defineProperty(DataListCore.prototype, "$selected", {
                get: function () {
                    return this._selected;
                },
                set: function (value) {
                    var that = this;
                    if (that._selected !== value) {
                        that._selected = value;
                        if (that._parent) {
                            that._parent.notifyStateChanged(that._path + '.$selected', {}); ///????
                            that._parent._notifyChanged(that._path + '.$selected', undefined, undefined, 'propchange', {}, false);
                        }
                    }
                },
                enumerable: true,
                configurable: true
            });
            DataListCore.prototype.pushSelected = function (item, persistent) {
                var that = this;
                var id = item.$id;
                var ii = that._selectedUids.indexOf(id);
                if (ii < 0)
                    that._selectedUids.push(id);
                if (persistent && that._schemaItems.primaryKey) {
                    var keys = _su.pkFields(that._schemaItems.primaryKey);
                    id = _su.pk2Id(_su.extractPkValue(item, keys), keys);
                    ii = that._selectedPks.indexOf(id);
                    if (ii < 0) {
                        that._selectedPks.push(id);
                    }
                }
                that.$selected = item;
            };
            DataListCore.prototype.removeSelected = function (item, persistent) {
                var that = this;
                var ii = that._selectedUids.indexOf(item.$id);
                if (ii === that.$selected)
                    that.$selected = null;
                if (ii >= 0) {
                    that._selectedUids.splice(ii, 1);
                }
                if (persistent && that._schemaItems.primaryKey) {
                    var keys = _su.pkFields(that._schemaItems.primaryKey);
                    var id = _su.pk2Id(_su.extractPkValue(item, keys), keys);
                    ii = that._selectedPks.indexOf(id);
                    if (ii >= 0)
                        that._selectedPks.splice(ii, 1);
                }
            };
            DataListCore.prototype.notifyChangedProperty = function (propName) {
                var that = this;
                that._parent._notifyChanged(that._path, undefined, undefined, propName, {}, false);
            };
            DataListCore.prototype.addAjaxException = function (ex) {
                var that = this;
                return that._parent.addAjaxException(ex);
            };
            DataListCore.prototype.notifyPaginationChanged = function () { };
            DataListCore.prototype.notifyCountChanged = function () {
                this.notifyChangedProperty("count");
            };
            DataListCore.prototype.notifySortingChanged = function () { };
            DataListCore.prototype.isQueryable = function () {
                return this._queryable || false;
            };
            DataListCore.prototype.addErrors = function (errors) {
                var that = this;
                var err = that._parent.$errors[that._path];
                if (err)
                    err.addErrors(errors);
                else
                    that._parent.addErrors(errors);
            };
            DataListCore.prototype.addError = function (message) {
                var that = this;
                var errors = [{ severity: "error", message: message }];
                that.addErrors(errors);
            };
            DataListCore.prototype._createCustomProps = function () {
                var that = this;
                Object.defineProperty(that, 'length', {
                    get: function () {
                        return this._items.length;
                    },
                    enumerable: true
                });
            };
            DataListCore.prototype._destroyItems = function () {
                var that = this;
                that._selectedUids = [];
                if (that._items) {
                    that._model = [];
                    that._items = [];
                }
            };
            DataListCore.prototype.$orderby = function (value) {
                return "";
            };
            DataListCore.prototype.totalPages = function () {
                return 1;
            };
            DataListCore.prototype.totalCount = function () {
                return this._items.length;
            };
            DataListCore.prototype.length = function () {
                return this._items.length;
            };
            DataListCore.prototype.destroy = function () {
                var that = this;
                that._parent = null;
                that._arrayParent = null;
                that._destroyItems();
                that._selectedPks = null;
                that._model = null;
                that._schema = null;
                that._schemaItems = null;
                that._rootSchema = null;
            };
            DataListCore.prototype._fillItems = function () {
                var that = this;
                that._model.forEach(function (item, index) {
                    that._items.push(item);
                });
            };
            DataListCore.prototype._setModel = function (value, frozen) {
                var that = this;
                that.isNull = value === null;
                that.isUndefined = value === undefined;
                value = value || [];
                var ofv = that.frozen;
                if (frozen)
                    that.frozen = true;
                // remove && destroy items 
                that._destroyItems();
                that._model = value;
                that._fillItems();
                that.frozen = ofv;
            };
            DataListCore.prototype.setModel = function (value) {
                var that = this;
                that._setModel(value, true);
                that._parent._notifyChanged(that._path, undefined, undefined, 'set', {}, false);
                that.notifyCountChanged();
                that._parent.notifyStateChanged(that._path, {}); ///????
                that.afterSetModel();
            };
            DataListCore.prototype.afterSetModel = function () {
                var that = this;
                that.$selected = null;
            };
            DataListCore.prototype.updateParams = function (item, prop, value) {
                var that = this;
                var ii = that._items.indexOf(item);
                prop = (prop ? ('$item.' + prop) : '$item');
                var path = [];
                item._getFullPath(path);
                value[path.join('.')] = { $index: ii, $value: item };
                return prop;
            };
            DataListCore.prototype.indexOf = function (value) {
                return this._items.indexOf(value);
            };
            DataListCore.prototype.find = function (prop) {
                var keys = [];
                for (var _i = 1; _i < arguments.length; _i++) {
                    keys[_i - 1] = arguments[_i];
                }
                var props = prop.split(','), ll = props.length;
                for (var i = 0, len = this._items.length; i < len; i++) {
                    var found = true;
                    var item = this._items[i];
                    for (var j = 0; j < ll; j++) {
                        if (keys[j] !== item[props[j]]) {
                            found = false;
                            break;
                        }
                    }
                    if (found)
                        return item;
                }
                return null;
            };
            DataListCore.prototype._expandForEach = function (cb, expandingProperty, level, index) {
                this._items.forEach(function (item) {
                    cb(item, index, level);
                    index++;
                    var list = item[expandingProperty];
                    if (list && list.$expand) {
                        index = list._expandForEach(cb, expandingProperty, level + 1, index);
                    }
                });
                return index;
            };
            DataListCore.prototype.forEach = function (cb, expandingProperty) {
                if (!expandingProperty)
                    return this._items.forEach(function (item, index) { return cb(item, index, 0); });
                this._expandForEach(cb, expandingProperty, 0, 0);
            };
            DataListCore.prototype.get = function (index) { return this._items[index]; };
            Object.defineProperty(DataListCore.prototype, "$expand", {
                get: function () {
                    return this._expanded;
                },
                set: function (value) {
                    var that = this;
                    if (that._expanded !== value) {
                        var ov = that._parent[that._path + Observable.EXPANDED_FIELD_NAME];
                        that._expanded = value;
                        var nv = that._parent[that._path + Observable.EXPANDED_FIELD_NAME];
                        if (nv !== ov)
                            that._parent._notifyChanged(that._path + Observable.EXPANDED_FIELD_NAME, ov, nv, 'propchange', {}, true);
                    }
                },
                enumerable: true,
                configurable: true
            });
            return DataListCore;
        }());
        Observable.DataListCore = DataListCore;
        var DataListBase = (function (_super) {
            __extends(DataListBase, _super);
            function DataListBase() {
                _super.apply(this, arguments);
            }
            DataListBase.prototype._fillItems = function () {
                var that = this, keys = null;
                that._map = {};
                that._selectedUids = [];
                that.$selected = null;
                if (that._selectedPks.length) {
                    keys = _su.pkFields(that._schemaItems.primaryKey);
                }
                that._model.forEach(function (item, index) {
                    var citem = new Data(that._schemaItems, that._parent, that._path, item, that, false, that._locale, null);
                    that._items.push(citem);
                    that._map[citem.$id] = citem;
                    if (keys) {
                        var pkId = _su.pk2Id(_su.extractPkValue(item, keys), keys);
                        if (that._selectedPks.lastIndexOf(pkId) >= 0) {
                            citem.internalSetSelected(true, false);
                            that.pushSelected(citem, false);
                        }
                    }
                });
            };
            DataListBase.prototype._updateSelecting = function (multiSelect, expandingProperty, list) {
                var that = this;
                if (multiSelect) {
                    that._selectedUids.forEach(function (sel) {
                        var ii = that._map[sel];
                        if (ii)
                            that.pushSelected(ii, true);
                    });
                }
                else {
                    that._selectedPks = [];
                    if (that._selectedUids.length) {
                        var sel = that._selectedUids.slice(0);
                        if (!list.length)
                            list.push(sel.pop());
                        sel.forEach(function (selid) {
                            var ii = that._map[selid];
                            if (ii)
                                ii.$select = false;
                        });
                    }
                }
                if (expandingProperty) {
                    that._items.forEach(function (item) {
                        var elist = item[expandingProperty];
                        if (elist)
                            elist._updateSelecting(multiSelect, expandingProperty, list);
                    }, null);
                }
            };
            DataListBase.prototype.clearSelection = function () {
                var that = this;
                that.enumSelectedItems('', function (item) {
                    that.selectItem(false, item, false, '');
                });
            };
            DataListBase.prototype.updateSelecting = function (multiSelect, expandingProperty) {
                this._updateSelecting(multiSelect, expandingProperty, []);
            };
            DataListBase.prototype.enumSelectedItems = function (expandingProperty, cb) {
                var that = this;
                that._enumSelected(expandingProperty, function (parent, ii) {
                    if (ii)
                        cb(ii);
                });
            };
            DataListBase.prototype._enumSelected = function (expandingProperty, cb) {
                var that = this;
                if (!expandingProperty) {
                    var sel = that._selectedUids.slice(0);
                    if (!sel.length)
                        return;
                    cb(that, null);
                    sel.forEach(function (sid) {
                        var ii = that._map[sid];
                        if (ii)
                            cb(that, ii);
                    });
                }
                else {
                    that._enumSelected(null, cb);
                    that._items.forEach(function (item) {
                        var list = item[expandingProperty];
                        if (list && list.$expand)
                            list._enumSelected(expandingProperty, cb);
                    });
                }
            };
            DataListBase.prototype.selectItem = function (value, item, multiSelect, expandingProperty) {
                var that = this;
                if (!item)
                    return;
                if (value) {
                    if (!item.$select) {
                        if (multiSelect) {
                            item.$select = true;
                        }
                        else {
                            that._enumSelected(expandingProperty, function (parent, ii) {
                                if (parent && !ii) {
                                    parent._selectedUids = [];
                                }
                                else {
                                    ii.internalSetSelected(false, true);
                                }
                            });
                            item.internalSetSelected(true, true);
                            var pa = item._arrayParent;
                            if (pa)
                                pa.pushSelected(item, false);
                        }
                    }
                }
                else {
                    if (item.$select) {
                        if (multiSelect) {
                            item.$select = false;
                        }
                        else {
                            item.internalSetSelected(false, true);
                            var pa = item._arrayParent;
                            if (pa)
                                that.removeSelected(item, false);
                        }
                    }
                }
            };
            DataListBase.prototype.findById = function (id) {
                return this._map[id];
            };
            DataListBase.prototype.indexOf = function (value) {
                var that = this;
                if (typeof value !== 'object')
                    value = that.findById(value);
                return value ? that._items.indexOf(value) : null;
            };
            DataListBase.prototype._beforeRemoveItem = function (item) {
                var that = this;
                if (that.$selected === item)
                    that.$selected = null;
            };
            return DataListBase;
        }(DataListCore));
        Observable.DataListBase = DataListBase;
        var QueryList = (function (_super) {
            __extends(QueryList, _super);
            function QueryList(parentSchema, schema, parent, path, value, pageSize, pageNumber, totalCount, arrayParent, locale) {
                _super.call(this, schema, parent, path, value, arrayParent, locale);
                var that = this;
                var root = that._parent.getRootModel();
                var cfg = _du.dsConfig(root.datasets, schema, true);
                if (!cfg) {
                    throw 'Invalid config! You must define a dataset in form for the property: "' + path + '".';
                }
                that._main = cfg.$main;
                that._queryable = true;
                that._query = new Observable.QueryableDataSource(cfg, that);
                that._query.initPagination(pageSize, pageNumber, totalCount);
                if (that._main) {
                    if (root) {
                        root.onRefresh = function (options) {
                            var resetPagination = (options && options.resetPagination);
                            return that.$refresh(resetPagination);
                        };
                    }
                }
            }
            Object.defineProperty(QueryList.prototype, "filter", {
                get: function () {
                    return this._query.filter;
                },
                set: function (value) {
                    this._query.filter = value;
                    this.notifyChangedProperty('filter');
                },
                enumerable: true,
                configurable: true
            });
            QueryList.prototype.totalPages = function () {
                return this._query.totalPages();
            };
            QueryList.prototype.totalCount = function () {
                return this._query.totalCount();
            };
            QueryList.prototype.$refresh = function (resetPagination) {
                return this._query.refresh(resetPagination);
            };
            QueryList.prototype.$orderby = function (value) {
                return this._query.orderBy(value);
            };
            QueryList.prototype.notifyPaginationChanged = function () {
                this.notifyChangedProperty("pagination");
            };
            QueryList.prototype.notifyFilterChanged = function () {
                this.notifyChangedProperty("filter");
            };
            QueryList.prototype.notifySortingChanged = function () {
                this.notifyChangedProperty("sorting");
            };
            QueryList.prototype.currentPage = function (page) {
                if (page != undefined) {
                    return this._query.currentPage(page);
                }
                else
                    return this._query.currentPage();
            };
            QueryList.prototype._removeItem = function (key, etag) {
                var that = this;
                if (that._query) {
                    var p = that._query.remove(key, etag);
                    if (p.then)
                        p.then(function () {
                            that.$refresh((that._items.length > 1) ? false : true).then(function () { });
                        });
                }
            };
            QueryList.prototype.remove = function (item) {
                var that = this;
                var om = item.model(true);
                var etag = om ? om['@odata.etag'] : null;
                if (that._schemaItems && that._schemaItems.primaryKey) {
                    var pk_1 = _su.odataId(_su.pkFields(that._schemaItems.primaryKey), item);
                    if (that._schemaItems.links && that._schemaItems.links.$remove && that._schemaItems.links.$remove.confirm) {
                        var msg = that._schemaItems.links.$remove.confirm;
                        if (that._locale)
                            msg = _ulocale.tt(msg || '', that._locale);
                        _utils.confirm(null, msg, function () {
                            that._removeItem(pk_1, etag);
                        });
                    }
                    else
                        that._removeItem(pk_1, etag);
                }
            };
            QueryList.prototype.destroy = function () {
                var that = this;
                if (that._query) {
                    that._query.destroy();
                    that._query = null;
                }
                if (that._main) {
                    var root = that._parent.getRootModel();
                    if (root)
                        root.onRefresh = null;
                }
                _super.prototype.destroy.call(this);
            };
            return QueryList;
        }(DataListBase));
        Observable.QueryList = QueryList;
        var CompositionList = (function (_super) {
            __extends(CompositionList, _super);
            function CompositionList() {
                _super.apply(this, arguments);
            }
            CompositionList.prototype._destroyItems = function () {
                _super.prototype._destroyItems.call(this);
                var that = this;
                that._selectedPks = [];
            };
            CompositionList.prototype.find = function (prop) {
                var keys = [];
                for (var _i = 1; _i < arguments.length; _i++) {
                    keys[_i - 1] = arguments[_i];
                }
                var props = prop.split(','), ll = props.length;
                for (var i = 0, len = this._items.length; i < len; i++) {
                    var found = true;
                    var item = this._items[i];
                    for (var j = 0; j < ll; j++) {
                        if (keys[j] !== item[props[j]]) {
                            found = false;
                            break;
                        }
                    }
                    if (found)
                        return item;
                }
                return null;
            };
            return CompositionList;
        }(DataListBase));
        Observable.CompositionList = CompositionList;
        var SimpleCompositionList = (function (_super) {
            __extends(SimpleCompositionList, _super);
            function SimpleCompositionList() {
                _super.apply(this, arguments);
            }
            SimpleCompositionList.prototype._destroyItems = function () {
                _super.prototype._destroyItems.call(this);
                var that = this;
                that._selectedPks = [];
            };
            return SimpleCompositionList;
        }(DataListCore));
        Observable.SimpleCompositionList = SimpleCompositionList;
        var SimpleTypeList = (function (_super) {
            __extends(SimpleTypeList, _super);
            function SimpleTypeList() {
                _super.apply(this, arguments);
            }
            SimpleTypeList.prototype.push = function (item) {
                var that = this;
                that._model.push(item);
                that._items.push(item);
                that._parent._notifyChanged(that._path, undefined, item, "add", { $index: that._items.length - 1, $value: item, $id: item }, false);
                that.notifyCountChanged();
            };
            SimpleTypeList.prototype.splice = function (start, deleteCount, item) {
                if (deleteCount > 0)
                    throw "Delete count is not supported.";
                var that = this;
                that._model.splice(start, deleteCount, item);
                that._items.splice(start, deleteCount, item);
                that._parent._notifyChanged(that._path, undefined, item, "add", { $index: start, $value: item, $id: item }, false);
                that.notifyCountChanged();
            };
            SimpleTypeList.prototype.remove = function (item) {
                var that = this;
                var ii = that._items.indexOf(item);
                if (ii >= 0) {
                    that._items.splice(ii, 1);
                    that._model.splice(ii, 1);
                    that._parent._notifyChanged(that._path, undefined, item, 'remove', { $index: ii, $value: item, $id: item }, false);
                    that.notifyCountChanged();
                }
            };
            return SimpleTypeList;
        }(SimpleCompositionList));
        Observable.SimpleTypeList = SimpleTypeList;
        var DataList = (function (_super) {
            __extends(DataList, _super);
            function DataList(schema, parent, path, value, arrayParent, locale) {
                _super.call(this, schema, parent, path, value, arrayParent, locale);
                var that = this;
                that._createNewItem(false, true);
            }
            DataList.prototype._initNew = function () {
                var that = this;
                var o = _su.init(that._schemaItems, that._rootSchema, null, null);
                that._new = new Data(that._schemaItems, that._parent, that._path + '.$new', o, null, true, that._locale, null);
                that._new._notifyChanged('', undefined, o, 'propchange', {}, false);
                that._new.notifyStateChanged('', {});
            };
            DataList.prototype._createNewItem = function (init, define) {
                var that = this;
                if (define) {
                    Object.defineProperty(that, '$new', {
                        get: function () {
                            var obj = this;
                            if (!obj._new)
                                obj._initNew();
                            return obj._new;
                        },
                        set: function (value) {
                            var obj = this;
                            if (!obj._new)
                                obj._initNew();
                            obj._new._setModel(value, true);
                            obj._new._notifyChanged('', undefined, value, 'propchange', {});
                            obj._new.notifyStateChanged('', {});
                        },
                        enumerable: true
                    });
                }
                if (init && !that._new)
                    that._initNew();
            };
            DataList.prototype.updateItem = function (old, newItem) {
                var that = this;
                // validate
                if (!newItem.validate())
                    return false;
                // clear errors 
                newItem.$errors.$.addErrors([], false);
                // validate primary key
                var newModel = newItem._getModel(true);
                if (that._schemaItems.primaryKey) {
                    var keys = _su.pkFields(that._schemaItems.primaryKey);
                    var pkNewValue = _su.extractPkValue(newModel, keys);
                    var pkOldValue = _su.extractPkValue(old._getModel(true), keys);
                    var p = _su.findByPk(pkNewValue, keys, that._items);
                    if (p && p !== old) {
                        // Primary key violation
                        var msg = keys.length > 1 ? _localeSchema.uniqueColumns : _localeSchema.uniqueColumn;
                        newItem.$errors.$.addErrors([{ code: "duplicate_value", message: _utils.format(msg, keys.join(', ')) }], false);
                        return false;
                    }
                }
                // update Old object
                return true;
            };
            DataList.prototype.addNew = function () {
                var that = this;
                if (!that._new)
                    return;
                if (!that._new.validate())
                    return;
                var model = that._new._getModel(false);
                if (that._schemaItems.primaryKey) {
                    var keys = _su.pkFields(that._schemaItems.primaryKey);
                    var pkValue = _su.extractPkValue(model, keys);
                    var p = _su.findByPk(pkValue, keys, that._items);
                    // Primary key violation
                    that._parent.$errors[that._path].addErrors([], false);
                    if (p) {
                        var msg = keys.length > 1 ? _localeSchema.uniqueColumns : _localeSchema.uniqueColumn;
                        that._parent.$errors[that._path].addErrors([{ code: "duplicate_value", message: _utils.format(msg, keys.join(', ')) }], false);
                        return;
                    }
                }
                else {
                    that._parent.$errors[that._path].addErrors([], false);
                }
                that._destroyNew();
                that.push(model);
                that._createNewItem(true, false);
            };
            DataList.prototype._destroyNew = function () {
                var that = this;
                if (that._new) {
                    that._new.destroy();
                    that._new = null;
                }
            };
            DataList.prototype.destroy = function () {
                var that = this;
                that._destroyNew();
                _super.prototype.destroy.call(this);
            };
            DataList.prototype.push = function (item) {
                this.splice(-1, 0, item);
            };
            DataList.prototype.splice = function (start, deleteCount, item) {
                if (deleteCount > 0)
                    throw "Delete count is not supported.";
                var that = this;
                var ofv = that.frozen;
                that.frozen = true;
                var isPush = start < 0;
                if (isPush)
                    that._model.push(item);
                else
                    that._model.splice(start, deleteCount, item);
                var ii = new Data(that._schemaItems, that._parent, that._path, item, that, false, that._locale, null);
                if (isPush)
                    that._items.push(ii);
                else
                    that._items.splice(start, deleteCount, ii);
                that.frozen = ofv;
                that._map[ii.$id] = ii;
                if (ii.$select)
                    that.pushSelected(ii, true);
                ii._notifyChanged('', undefined, item, "add", { $index: isPush ? that._items.length - 1 : start, $id: ii.$id, $value: ii }, false);
                ii.notifyStateChanged('', {});
            };
            DataList.prototype.remove = function (item) {
                var that = this;
                var removed = null;
                var ofv = that.frozen, notify;
                that.frozen = true;
                var ii = that._items.indexOf(item);
                var id = item.$id;
                that._beforeRemoveItem(item);
                if (ii >= 0) {
                    removed = item.model();
                    notify = true;
                    that._items.splice(ii, 1);
                    that._model.splice(ii, 1);
                    that.removeSelected(item, true);
                    item.destroy();
                }
                that.frozen = ofv;
                delete that._map[id];
                if (notify) {
                    var path = (that._path ? that._path + '.' : '') + '$item';
                    that._parent._notifyChanged(path, undefined, undefined, 'remove', { $index: ii, $value: removed, $id: id }, false);
                    that._parent.notifyStateChanged(path, {}); ///????
                }
            };
            return DataList;
        }(CompositionList));
        Observable.DataList = DataList;
        var Data = (function () {
            function Data(schema, parent, path, value, arrayParent, frozen, locale, datasets, transform) {
                var that = this;
                that._rootParent = parent ? parent._rootParent : that;
                that.$id = _utils.allocID();
                that.$create = false;
                that._selected = value && value.$select ? true : false;
                that._model = {};
                that.datasets = datasets;
                that.transform = transform;
                that.$states = {};
                that.$errors = {};
                that.$links = {};
                that._path = path;
                that._locale = locale;
                that._parent = parent;
                that._schema = _su.expand$Ref(schema, that._rootParent._schema);
                if (!that._parent) {
                    that._validators = [{ name: 'schema', active: true }];
                }
                that._arrayParent = arrayParent;
                that._children = {};
                that._initFromSchema(schema);
                if (!that._parent || frozen)
                    that.frozen = true;
                if (value && value.$create) {
                    delete value.$create;
                    that.$create = true;
                }
                that._setModel(value, false);
                that.frozen = false;
                if (!that._parent) {
                    that._notifyChanged('*', undefined, value, 'propchange', {}, false);
                    that.notifyStateChanged('*', {});
                }
            }
            Data.prototype.saveModel = function () {
                var that = this;
                that._origModel = _su.copyModel(that._schema, that._model);
            };
            Data.prototype.setModel = function (value) {
                var that = this;
                that._destroyObject(that, '_children');
                that._children = {};
                that.frozen = true;
                that._setModel(value, false);
                that.frozen = false;
                if (!that._parent) {
                    that._notifyChanged('*', undefined, value, 'propchange', {}, false);
                    that.notifyStateChanged('*', {});
                }
            };
            Data.prototype.update = function (value) {
                var that = this;
                if (!value)
                    return;
                var props = Object.keys(that._schema.properties);
                var rs = that._rootParent._schema;
                props.forEach(function (name) {
                    var ss = that._schema.properties[name];
                    if (!_su.inModel(ss, rs))
                        return;
                    if (_su.isCompositionRef(ss, rs)) {
                        var ref = that[name];
                    }
                    else if (_su.isCompositionList(ss, rs, false)) {
                        that[name] = value[name];
                    }
                    else if (_su.isSimpleList(ss, rs)) {
                    }
                    else if (_su.isList(ss, rs)) {
                        that[name] = value[name];
                    }
                    else {
                        that[name] = value[name];
                    }
                });
            };
            Data.prototype.$refresh = function (options) {
                var that = this;
                if (!that._parent) {
                    if (that.onRefresh)
                        return that.onRefresh(options);
                    else {
                        return new _utils.Promise(function (resolve, reject) {
                            _du.loadMainData({ datasets: that.datasets, transform: that.transform }).then(function (data) {
                                that.update(data);
                                resolve();
                            }).catch(function (ex) {
                                that.addAjaxException(ex);
                                reject();
                            });
                        });
                    }
                }
                else
                    return _utils.Promise.resolve();
            };
            Data.prototype._validate = function (validators) {
                var that = this;
                if (!validators || !validators.length)
                    return true;
                var props = Object.keys(that._schema.properties);
                var error = false;
                //for each property validate
                var rs = that._rootParent._schema;
                props.forEach(function (name) {
                    var ss = that._schema.properties[name];
                    if (!_su.inModel(ss, rs))
                        return;
                    var state = that.$states[ss.$stateProperty || name];
                    if (state.isHidden || state.isDisabled)
                        return;
                    if (_su.isCompositionRef(ss, rs)) {
                        var ref = that[name];
                        if (ref) {
                            if (!ref._validate(validators))
                                error = true;
                        }
                        else {
                            if (state.isMandatory) {
                                that.$errors[name].addErrors([{ message: _utils.format(_localeSchema.required, _su._title(ss.title, Phoenix.locale)) }], false);
                                error = true;
                            }
                        }
                    }
                    else {
                        if (!that._execValidators(validators, name, "validate", {}, { base: that, state: state, schema: ss, value: that[name] })) {
                            error = true;
                        }
                    }
                });
                if (!that._parent) {
                    // validate root element
                    if (!that._execValidators(validators, '', "validate", {}, { base: that, state: null, schema: that._schema, value: null })) {
                        error = true;
                    }
                }
                return !error;
            };
            Data.prototype.validate = function () {
                var that = this;
                var root = that.getRootModel();
                return that._validate(root._validators);
            };
            Object.defineProperty(Data.prototype, "$select", {
                get: function () {
                    return this._selected;
                },
                set: function (value) {
                    var that = this;
                    if (that.internalSetSelected(value, true)) {
                        if (that._arrayParent) {
                            if (that._selected)
                                that._arrayParent.pushSelected(that, true);
                            else
                                that._arrayParent.removeSelected(that, true);
                        }
                    }
                },
                enumerable: true,
                configurable: true
            });
            Data.prototype.select = function (value, multiSelect, parentArray, expandingProperty) {
                var that = this;
                if (multiSelect) {
                    if (that._arrayParent)
                        that._arrayParent.selectItem(value, that, multiSelect, null);
                    return;
                }
                if (expandingProperty) {
                    parentArray.selectItem(value, that, false, expandingProperty);
                }
                else {
                    if (that._arrayParent) {
                        that._arrayParent.selectItem(value, that, false, null);
                    }
                }
            };
            Data.prototype.toggleExpand = function (expandingProperty) {
                var that = this;
                var res = false;
                if (!expandingProperty)
                    return res;
                var list = that[expandingProperty];
                if (list) {
                    list.$expand = !list.$expand;
                    res = list.$expand;
                }
                return res;
            };
            Data.prototype.enumVisibleChilds = function (expandingProperty, level, root, cb) {
                var that = this;
                var list = that[expandingProperty];
                if (list && (list.$expand || root)) {
                    list._items.forEach(function (child) {
                        cb(child, level + 1);
                        child.enumVisibleChilds(expandingProperty, level + 1, false, cb);
                    });
                }
            };
            Data.prototype.internalSetSelected = function (value, notify) {
                var that = this;
                if (that._selected !== value) {
                    that._selected = value;
                    if (notify)
                        that._notifyChanged('$select', !that._selected, value, 'propchange', {}, true);
                    return true;
                }
                return false;
            };
            Data.prototype.$index = function (value) {
                var that = this;
                if (that._arrayParent) {
                    return Math.max(that._arrayParent.indexOf(that), 0) + 1;
                }
                return 0;
            };
            Data.prototype.$save = function () {
                var that = this;
                var root = that.getRootModel();
                if (root !== that)
                    return _utils.Promise.reject(null);
                if (!that.validate())
                    return _utils.Promise.reject(null);
                var ds = _du.extractMainDataSource(that);
                if (ds && _du.isCreateOrUpdate(ds)) {
                    var mData_1 = that.model(false);
                    if (that.$create) {
                        ds.$method = 'POST';
                        delete ds.$params.$entityId;
                    }
                    else {
                        ds.$method = 'PATCH';
                        if (!that._schema.primaryKey) {
                            that.addError('Primary key is missing. Check schema.');
                            return _utils.Promise.reject(null);
                        }
                        var keys = _su.pkFields(that._schema.primaryKey);
                        var pkValue = _su.extractPkValue(mData_1, keys);
                        ds.$entityId = _su.entityId(pkValue);
                        var delta = _utils.deltaPatch(that._origModel, mData_1);
                        if (!delta)
                            return _utils.Promise.resolve(mData_1);
                        // send delta
                        mData_1 = delta;
                    }
                    return new _utils.Promise(function (resolve, reject) {
                        _du.datasetAsPromise(ds, mData_1).then(function (data) {
                            resolve();
                        }).catch(function (ex) {
                            that.addAjaxException(ex);
                            reject(null);
                        });
                    });
                }
                else
                    return _utils.Promise.reject(null);
            };
            Data.prototype.getRootModel = function () {
                return this._rootParent;
            };
            //validators
            Data.prototype.addValidator = function (name, value) {
                var root = this.getRootModel();
                root._validators.push({ name: name, active: value });
            };
            Data.prototype.activateValidator = function (name, value) {
                var that = this;
                var model = that.getRootModel();
                for (var i = 0, len = model._validators.length; i < len; i++) {
                    var v = model._validators[i];
                    if (v.name === name) {
                        v.active = value;
                        break;
                    }
                }
            };
            Data.prototype.hasValidators = function () {
                var that = this;
                var model = that.getRootModel();
                if (model._validators.length) {
                    if (model._validators.length == 1)
                        return model._validators[0].active;
                    else {
                        for (var i = 0, len = model._validators.length; i < len; i++) {
                            if (model._validators[i].active)
                                return true;
                        }
                    }
                }
                return false;
            };
            Data.prototype.getParentOf = function (bind, params) {
                return this.getValue(Observable.SchemaUtils.parentPath(bind), params);
            };
            Data.prototype.setValue = function (path, value, params) {
                var that = this;
                var v = that, segments = path.split('.'), cpath = [], propertyName = segments.pop();
                for (var i = 0, len = segments.length; i < len; i++) {
                    if (!v)
                        break;
                    var s = segments[i];
                    cpath.push(s);
                    if (s.charAt(0) == "$")
                        v = _dutils._resolveSegment(s, cpath.join('.'), v, params);
                    else
                        v = v[s];
                }
                if (v) {
                    if (propertyName.charAt(0) == "$" && !_su.isMetaProp(propertyName)) {
                        cpath.push(propertyName);
                        _dutils._resolveSegment(propertyName, cpath.join('.'), v, params, value, true);
                    }
                    else
                        v[propertyName] = value;
                }
            };
            Data.prototype._getModel = function (original) {
                var that = this;
                if (original)
                    return that._model;
                var rootModel = that.getRootModel();
                var rootSchema = rootModel ? rootModel._schema : that._schema;
                return _su.copyModel(that._schema, that._model, rootSchema);
            };
            Data.prototype.model = function (original) {
                return this._getModel(original);
            };
            Data.prototype.getRelativeValue = function (path) {
                return this.getValue(path, {});
            };
            Data.prototype.getRelativeState = function (path) {
                return this.getState(path, {});
            };
            Data.prototype.getValue = function (path, params) {
                var that = this;
                if (!path)
                    return that;
                var v = that, segments = path.split('.'), propertyName = segments.pop(), cpath = [];
                for (var i = 0, len = segments.length; i < len; i++) {
                    if (!v)
                        break;
                    var s = segments[i];
                    cpath.push(s);
                    if (s.charAt(0) == "$")
                        v = _dutils._resolveSegment(s, cpath.join('.'), v, params);
                    else
                        v = v[s];
                }
                if (v) {
                    if (propertyName && propertyName.charAt(0) == "$" && !_su.isMetaProp(propertyName)) {
                        cpath.push(propertyName);
                        return _dutils._resolveSegment(propertyName, cpath.join('.'), v, params);
                    }
                    return propertyName ? v[propertyName] : v;
                }
                return undefined;
            };
            Data.prototype._getFullPath = function (path, root) {
                var that = this;
                if (that === root)
                    return path;
                if (that._parent) {
                    that._parent._getFullPath(path, null);
                }
                if (that._path)
                    path.push(that._path);
                if (that._arrayParent) {
                    path.push('$item');
                }
            };
            Data.prototype.getSchema = function (path) {
                var that = this;
                return _su.getSchema(path, that._schema, that._rootParent._schema, false);
            };
            //TODO states for $index
            Data.prototype.getState = function (path, params) {
                var that = this;
                var segments = path.split('.'), propertyName = segments.pop(), opropertyName = propertyName, cs = that, ps, res = {}, cpath = [], islink = false;
                var len = segments.length - 1;
                var isMeta = _su.isMetaProp(propertyName);
                if (isMeta) {
                    var ms = _su.getSchema(path, that._schema, that._rootParent._schema, false);
                    if (ms && ms.$stateProperty)
                        propertyName = ms.$stateProperty;
                }
                for (var i = 0; i <= len; i++) {
                    var s = segments[i];
                    var ignoreState = false;
                    cpath.push(s);
                    if (_su.arrayProps.indexOf(s) >= 0) {
                        //xxxxxxx
                        //TODO : params for $item
                        if (s === '$selected') {
                            cs = cs[s];
                            ignoreState = true;
                        }
                        else
                            cs = cs[s];
                    }
                    else if (i === len) {
                        if (s === "$links") {
                            islink = true;
                            break;
                        }
                    }
                    if (!ignoreState) {
                        if (!cs) {
                            ps = null;
                        }
                        else {
                            ps = cs.$states[s] ? cs.$states[s].state() : null;
                            cs = cs[s];
                        }
                    }
                    else
                        ps = null;
                    if (!cs || cs.isNull || cs.isUndefined) {
                        res.isDisabled = true;
                    }
                    if (ps && ps.isHidden)
                        res.isHidden = true;
                    if (ps && ps.isDisabled)
                        res.isDisabled = true;
                    if (ps && ps.isReadOnly)
                        res.isReadOnly = true;
                    if (!cs)
                        break;
                }
                var state = {};
                if (!islink) {
                    if (propertyName === Observable.SELECTED_FIELD_NAME) {
                        return { isDisabled: false, isReadOnly: false, isHidden: false };
                    }
                    else if (propertyName === Observable.INDEX_FIELD_NAME) {
                        return { isDisabled: false, isReadOnly: true, isHidden: false };
                    }
                    else if (propertyName === Observable.EXPANDED_FIELD_NAME) {
                        return { isDisabled: false, isReadOnly: true, isHidden: false };
                    }
                }
                if (cs) {
                    var pp = '$states';
                    if (islink)
                        pp = '$links';
                    var oo = cs[pp] ? cs[pp][propertyName] : null;
                    if (oo) {
                        state = oo.state();
                        if (!islink && cs.$errors) {
                            state.errors = cs.$errors[opropertyName].errors();
                        }
                    }
                }
                return $.extend({}, state, res);
            };
            Data.prototype._setModel = function (value, frozen) {
                var that = this;
                var ofv = that.frozen;
                if (frozen)
                    that.frozen = true;
                that.isNull = value === null;
                that.isUndefined = value === undefined;
                value = value || {};
                value.$states = value.$states || {};
                value.$links = value.$links || {};
                value.$errors = value.$errors || {};
                var props = Object.keys(that._schema.properties);
                //for each property set value && state
                var rs = that._rootParent._schema;
                props.forEach(function (name) {
                    var si = that._schema.properties[name];
                    if (!_su.inModel(si, rs))
                        return;
                    var isMeta = _su.isMetaProp(name);
                    var val = value[name];
                    if (!val && (_su.isCompositionList(si, rs, false) || _su.isList(si, rs))) {
                        val = [];
                        value[name] = val;
                    }
                    if (_su.isList(si, rs))
                        that._setQueryListChild(name, val, value.pageSize, value.pageSize ? (Math.round(value.skip / value.pageSize) + 1) : 0, value.count);
                    else
                        that[name] = val;
                    if (!isMeta) {
                        if (value.$states && value.$states[name]) {
                            var ss_1 = value.$states[name];
                            Object.keys(ss_1).forEach(function (sn) { that.$states[name][sn] = ss_1[sn]; });
                        }
                        value.$states[name] = that.$states[name].state();
                    }
                    if (value.$errors && value.$errors[name]) {
                        var errors = value.$errors[name];
                        var ne_1 = [];
                        errors.forEach(function (err) { ne_1.push(err); });
                        that.$errors[name].addErrors(ne_1);
                    }
                    value.$errors[name] = that.$errors[name].errors();
                });
                //for each link set state
                if (value.$links) {
                    props = Object.keys(that._schema.links || {});
                    props.forEach(function (name) {
                        var ss = value.$links[name];
                        var dst = that.$links[name];
                        if (ss) {
                            Object.keys(ss).forEach(function (sn) { dst[sn] = ss[sn]; });
                        }
                        value.$links[name] = that.$links[name].state();
                    });
                }
                that._model = value;
                that.frozen = ofv;
            };
            Data.prototype._setRefChild = function (propertyName, oldvalue, value) {
                var that = this;
                var ofv = that.frozen;
                that.frozen = true;
                if (!that._children[propertyName])
                    that._children[propertyName] = new Data(that._schema.properties[propertyName], that, propertyName, value, null, false, that._locale, null);
                else
                    that._children[propertyName]._setModel(value, false);
                that.frozen = ofv;
            };
            Data.prototype._setListChild = function (propertyName, oldvalue, value) {
                var that = this;
                var ofv = that.frozen;
                that.frozen = true;
                if (!that._children[propertyName])
                    that._children[propertyName] = new DataList(that._schema.properties[propertyName], that, propertyName, value, null, that._locale);
                else
                    that._children[propertyName]._setModel(value, false);
                that.frozen = ofv;
            };
            Data.prototype._setSimpleListChild = function (propertyName, oldvalue, value) {
                var that = this;
                var ofv = that.frozen;
                that.frozen = true;
                if (!that._children[propertyName])
                    that._children[propertyName] = new SimpleTypeList(that._schema.properties[propertyName], that, propertyName, value, null, that._locale);
                else
                    that._children[propertyName]._setModel(value, false);
                that.frozen = ofv;
            };
            Data.prototype._setQueryListChild = function (propertyName, value, pageSize, page, totalCount) {
                var that = this;
                var ofv = that.frozen;
                that.frozen = true;
                if (that._children[propertyName])
                    that._children[propertyName].destroy();
                that._children[propertyName] = new QueryList(that._schema, that._schema.properties[propertyName], that, propertyName, value, pageSize, page, totalCount, null, that._locale);
                that.frozen = ofv;
                that._notifyChanged(propertyName, null, value, 'propchange', {}, true);
                that.notifyStateChanged(propertyName, {});
            };
            Data.prototype._initFromSchema = function (schema) {
                var that = this;
                if (!that._model)
                    return;
                var states = (schema.states ? $.extend(true, {}, schema.states) : null), links = (schema.links ? $.extend(true, {}, schema.links) : null), errors = (schema.errors ? $.extend(true, {}, schema.errors) : null);
                var npAdded = false;
                //create hidden props
                var props = Object.keys(schema.properties);
                props.forEach(function (pn) {
                    if (_su.isMetaProp(pn))
                        return;
                    var cs = schema.properties[pn];
                    if (cs.format === 'password') {
                        if (!cs.capabilities || !cs.capabilities.noConfirming) {
                            var np = '$$' + pn;
                            cs.$meta = np;
                            var ps = schema.properties[np];
                            if (!ps) {
                                ps = $.extend(true, {}, cs);
                                ps.title = Phoenix.locale.ui.Confirm;
                                // for this field use $stateProperty to get    
                                ps.$stateProperty = pn;
                                schema.properties[np] = ps;
                                npAdded = true;
                            }
                        }
                    }
                    else if (cs.format === 'rate') {
                        cs.exclusiveMinimum = true;
                        cs.exclusiveMaximum = true;
                        cs.decimals = _su.RATE_DECIMALS;
                        cs.maximum = _su.RATE_MAXIMUM;
                        cs.minimum = -_su.RATE_MAXIMUM;
                        if (cs.symbol === undefined)
                            cs.symbol = _su.RATE_SYMBOL;
                    }
                });
                if (npAdded)
                    props = Object.keys(schema.properties);
                props.forEach(function (name) {
                    _createProp(that, name);
                    if (!_su.isMetaProp(name))
                        _createStateProp(that, name, states ? states[name] : null);
                    _createErrorProp(that, name, errors ? errors[name] : null);
                });
                if (schema.links) {
                    Object.keys(schema.links).forEach(function (name) { _createStateLinks(that, name, links ? links[name] : null); });
                }
                // root error
                if (!that._parent) {
                    that.$errors.$ = new _observable.Errors(that, '$', [], false);
                }
            };
            Data.prototype.getParentModel = function (path) {
                var segments = path.split('.');
                segments.pop();
                return _dutils.getValue(segments.join('.'), this);
            };
            Data.prototype.addAjaxException = function (ex) {
                var that = this;
                if (that._parent) {
                    return that._parent.addAjaxException(ex);
                }
                var error = _ajax.extractAjaxErrors(ex);
                var errors = [];
                var firstGlbError = null;
                if (error.message) {
                    firstGlbError = { message: error.message, details: [] };
                    errors.push(firstGlbError);
                }
                if (error.list && error.list.length) {
                    error.list.forEach(function (ed) {
                        var addGlb = true;
                        if (ed.target) {
                            var m = that.getParentModel(ed.target);
                            if (m) {
                                var pn = _su.lastSegment(ed.target, null);
                                if (m.hasOwnProperty(pn)) {
                                    addGlb = false;
                                    m.$errors[pn].addError(ed.message);
                                }
                            }
                        }
                        if (addGlb) {
                            if (firstGlbError)
                                firstGlbError.details.push({ message: ed.message });
                            else
                                errors.push({ message: ed.message });
                        }
                    });
                }
                that.$errors.$.addErrors(errors);
            };
            Data.prototype.addError = function (message) {
                var that = this;
                var errors = [{ severity: "error", message: message }];
                that.addErrors(errors);
            };
            Data.prototype.addErrors = function (errors) {
                var that = this;
                if (that._arrayParent) {
                }
                else {
                    if (that._parent)
                        that._parent.addErrors(errors);
                    else {
                        if (that.$errors.$)
                            that.$errors.$.addErrors(errors);
                    }
                }
            };
            Data.prototype._beforeChange = function (propertyName, oldValue, value) {
                return true;
            };
            Data.prototype.notifyStateChanged = function (stateName, params) {
                var that = this;
                if (that.frozen || (that._arrayParent && that._arrayParent.frozen))
                    return;
                if (that._arrayParent)
                    stateName = that._arrayParent.updateParams(that, stateName, params);
                if (that._parent)
                    that._parent.notifyStateChanged(stateName ? (that._path + '.' + stateName) : that._path, params);
                else {
                    _utils.logModule('proxydata') && _utils.log("State changed: " + that._extractPropName(stateName || '', params), "proxydata");
                    if (that.onstatechanged)
                        that.onstatechanged(stateName, params);
                }
            };
            Data.prototype._extractPropName = function (pn, params) {
                Object.keys(params).sort().reverse().forEach(function (name) {
                    var p = params[name];
                    if (p && p.$index !== undefined) {
                        pn = pn.replace(name, name + '[' + p.$index + ']');
                    }
                });
                return pn;
            };
            Data.prototype._execValidators = function (validators, propertyName, event, params, ldata) {
                var that = this;
                var error = false;
                if (propertyName) {
                    if (!ldata) {
                        var value = that.getValue(propertyName, params);
                        if (value === undefined)
                            return !error;
                    }
                }
                else if (event !== 'validate')
                    return !error;
                var first = true;
                validators.forEach(function (validator) {
                    if (validator.active) {
                        if (!validator.hnd)
                            validator.hnd = _su.getValidator(validator.name);
                        if (validator.hnd) {
                            if (ldata)
                                ldata.add = !first;
                            if (!validator.hnd(event, that, { name: propertyName, params: params, locale: that._locale }, ldata)) {
                                error = true;
                            }
                            first = false;
                        }
                    }
                });
                return !error;
            };
            Data.prototype._notifyChanged = function (propertyName, oldValue, value, op, params, validate) {
                var that = this;
                if (that.frozen || (that._arrayParent && that._arrayParent.frozen))
                    return;
                if (that._arrayParent) {
                    if (op === 'propchange' && propertyName) {
                        var item = that._arrayParent.findById(that.$id);
                        if (item === that) {
                            var oid = item.$id;
                            if (params.$oid)
                                oid = params.$oid;
                            else
                                params.$oid = item.$id;
                            that._parent._notifyChanged(that._path, oldValue, value, 'upd', { $id: item.$id, property: propertyName, $oid: oid }, validate);
                        }
                    }
                    propertyName = that._arrayParent.updateParams(that, propertyName, params);
                }
                if (that._parent) {
                    that._parent._notifyChanged(propertyName ? (that._path + '.' + propertyName) : that._path, oldValue, value, op, params, validate);
                }
                else {
                    _utils.logModule('proxydata') && _utils.log('Changed: ' + that._extractPropName(propertyName || '', params) + ', operation = ' + op, 'proxydata');
                    if (that.onchange)
                        that.onchange(propertyName, oldValue, value, op, params);
                    if (validate && that._validators && that.hasValidators()) {
                        that._execValidators(that._validators, propertyName, 'propchanged', params);
                    }
                }
            };
            Data.prototype._destroyObject = function (obj, pn) {
                var o = obj[pn];
                if (o) {
                    Object.keys(o).forEach(function (name) {
                        o[name].destroy();
                        delete o[name];
                    });
                }
            };
            Data.prototype.destroy = function () {
                var that = this;
                that._parent = null;
                that._destroyObject(that, '_children');
                that._destroyObject(that, '$states');
                that._destroyObject(that, '$links');
                that._destroyObject(that, '$errors');
                that._arrayParent = null;
                that._model = null;
                that._schema = null;
                that.onRefresh = null;
                that.onchange = null;
                that.onstatechanged = null;
                that._rootParent = null;
            };
            return Data;
        }());
        Observable.Data = Data;
        Observable.ObservableUtils = _dutils;
    })(Observable = Phoenix.Observable || (Phoenix.Observable = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../core/modules/locale.ts" />
/// <reference path="../../core/core.ts" />
/// <reference path="../../core/modules/utils.ts" />
/// <reference path="../../data/datasets.ts" />
/// <reference path="./proxy.data.ts" />
/// <reference path="./schema.data.ts" />
var Phoenix;
(function (Phoenix) {
    var Observable;
    (function (Observable) {
        var _data = Phoenix.data, _utils = Phoenix.utils, _su = Observable.SchemaUtils;
        var _schemaValidator = function (event, model, params, data) {
            var res = true;
            var isValidate = event === "validate";
            if (event === "propchanged" || isValidate) {
                if (!params.name)
                    return res;
                var pn = _su.lastSegment(params.name, null);
                if (_su.arrayProps.indexOf(pn) >= 0)
                    return res;
                var value = data ? data.value : model.getValue(params.name, params.params);
                var state = data ? data.state : model.getState(params.name, params.params);
                var schema = data ? data.schema : model.getSchema(params.name);
                if (state && (state.isHidden || state.isDisabled))
                    return res;
                var llocale = params.locale;
                var errors = [];
                var base = data ? data.base : model.getParentOf(params.name, params.params);
                if (!_su.validateSchema(value, schema, state, llocale, errors))
                    res = false;
                if (isValidate) {
                    // check password
                    if (_su.isMetaProp(pn) && schema && schema.format === "password") {
                        var orig = model.getValue(_su.extractBase(params.name) + schema.$stateProperty, params.params);
                        schema = model.getValue(_su.extractBase(params.name) + schema.$stateProperty, params.params);
                        if (!_su.validatePassword(orig, value, schema, state, llocale, errors))
                            res = false;
                    }
                }
                var add = false;
                if (event === "validate" && data) {
                    add = data.add;
                }
                base.$errors[pn].addErrors(errors, add);
            }
            return res;
        };
        _su.registerValidator('schema', _schemaValidator);
    })(Observable = Phoenix.Observable || (Phoenix.Observable = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../core/core.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils;
        var FormManager = (function () {
            function FormManager() {
                this._forms = {};
                this._inAction = false;
            }
            FormManager.prototype.setInAction = function (value) {
                this._inAction = value;
            };
            FormManager.prototype.isInAction = function () {
                return this._inAction;
            };
            FormManager.prototype.broadcast = function (eventName, params) {
                var that = this;
                _utils.nextTick(function () {
                    Object.keys(that._forms).forEach(function (formName) {
                        var form = that._forms[formName];
                        form.execAction(eventName, params);
                    });
                });
            };
            FormManager.prototype.add = function (form) {
                if (form && form.data && form.data.name)
                    this._forms[form.data.name] = form;
            };
            FormManager.prototype.remove = function (form) {
                if (form && form.data && form.data.name)
                    this._forms[form.data.name] = null;
            };
            FormManager.prototype.formByName = function (form) {
                return this._forms[form];
            };
            return FormManager;
        }());
        ui.FormManager = FormManager;
        var fm = function () {
            var _cfm;
            return function () {
                if (!_cfm)
                    _cfm = new FormManager();
                return _cfm;
            };
        };
        ui.formManager = fm();
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../typings/index.d.ts" />
/// <reference path="../../core/core.ts" />
/// <reference path="../../ui/layout.control.ts" />
/// <reference path="./schema.data.ts" />
/// <reference path="./proxy.data.ts" />
/// <reference path="./formmanager.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _build = Phoenix.build, _link = Phoenix.link, _dom = Phoenix.dom, _preferences = Phoenix.preferences, _sutils = Phoenix.Observable.SchemaUtils, _outils = Phoenix.Observable.ObservableUtils, _ulocale = Phoenix.ulocale;
        var Form = (function (_super) {
            __extends(Form, _super);
            function Form(layoutData, options, ldata, schema, locale, preferences) {
                _super.call(this, layoutData, options, ldata, schema, locale, preferences);
                this._event2Layout = function (event) {
                    var that = this;
                    if (!that.$element)
                        return null;
                    var root = that.$element.get(0);
                    var t = event.target;
                    while (t) {
                        var id = t.getAttribute('data-render');
                        if (id) {
                            var ll = that.getLayoutById(id);
                            if (ll)
                                return ll;
                        }
                        t = (t === root) ? null : t.parentNode;
                    }
                    return null;
                };
                var that = this;
                if (options.module) {
                    that.module = options.module;
                    delete options.module;
                }
                if (layoutData.data) {
                    that.formData = $.extend(true, {}, layoutData.data);
                }
                that.formManager = _ui.formManager();
                that.formManager.add(that);
                that.$schema = schema || {};
                that.$rootSchema = that.$schema;
                if (options.path) {
                    that.$schema = _sutils.getSchema(options.path, that.$schema, that.$rootSchema, true);
                }
                that.$locale = locale;
                if (options && options.preferenceName) {
                    that._settingsName = options.preferenceName;
                    that._settings = preferences;
                }
                if (options && options.storageName) {
                    that._settingsName = options.storageName;
                    that._localSettings = true;
                }
                that.setData(ldata);
                that.$model.onchange = that._modelChanged.bind(that);
                that.$model.onstatechanged = that._stateChanged.bind(that);
                that.$bind = {};
                Object.keys(that.map).forEach(function (layoutId) {
                    var l = that.map[layoutId];
                    if (l.$bindState) {
                        that.$bind[l.$bindState] = that.$bind[l.$bindState] || [];
                        that.$bind[l.$bindState].push(layoutId);
                    }
                });
                Object.keys(that.$bind).forEach(function (propName) {
                    var state = that.$model.getState(propName, {});
                    if (state && state.isHidden) {
                        var l = that.$bind[propName];
                        l.forEach(function (layoutId) {
                            that.map[layoutId].$isHidden = true;
                        });
                    }
                    that.registerListenerFor(propName, that, "layout-state");
                });
                that.registerListenerFor('$', that);
                that.loadPrefs();
                if (options && options.validators)
                    options.validators.forEach(function (validatorName) {
                        that.$model.addValidator(validatorName, true);
                    });
                if (!that.options.design && that.options.externalSchema && that.options.externalLayout && !_build.release) {
                    that.options.authoringIndicator = true;
                    that.options.verticalSpacing = true;
                }
                that._afterCreate();
            }
            Form.prototype._isInDelayedAction = function () {
                if (this.formManager)
                    return this.formManager.isInAction();
                else
                    return this._internalDelayedAction;
            };
            Form.prototype._setInDelayedAction = function (value) {
                if (this.formManager)
                    this.formManager.setInAction(value);
                else
                    this._internalDelayedAction = value;
            };
            Form.prototype.initOptions = function (options) {
                options = options || {};
                options.form = true;
                return options;
            };
            Form.prototype.setData = function (ldata) {
                var that = this;
                that.$data = _sutils.init(that.$schema, that.$schema, null, ldata || {});
                if (that.options.beforeSetModel) {
                    that.options.beforeSetModel(that.$data, that);
                }
                if (!that.$model) {
                    that.$model = new Phoenix.Observable.Data(that.$schema, null, '', that.$data, null, false, that.$locale, that.data.datasets, that.data.transform);
                }
                else {
                    that.$model.setModel(that.$data);
                }
                that.$model.saveModel();
                if (that.options.afterModelCreated) {
                    that.options.afterModelCreated(that.$model, that);
                }
            };
            Form.prototype.processing = function (value) {
                var that = this;
                that._inProcessing = value;
            };
            Form.prototype._findControlByField = function (name) {
                var that = this;
                var list = [];
                Object.keys(that.controls).forEach(function (cn) {
                    var c = that.controls[cn];
                    if (c && c.$bind === name) {
                        list.push(c);
                    }
                });
                return list.length ? list : null;
            };
            //todo: remove use that._preferences 
            Form.prototype.loadPrefs = function () {
                var that = this;
                if (that._localSettings) {
                    if (that._settingsName)
                        that._settings = _preferences(that._settingsName);
                }
            };
            Form.prototype.supportSettings = function () {
                return !!this._settingsName;
            };
            Form.prototype.getFieldSettings = function (field) {
                var that = this;
                if (that._settings)
                    return that._settings[field];
                return null;
            };
            Form.prototype.setFieldSettings = function (field, settings) {
                var that = this;
                that._settings = that._settings || {};
                that._settings[field] = settings;
            };
            Form.prototype.savePrefs = function (after) {
                var that = this;
                if (that._settingsName) {
                    if (that._localSettings) {
                        that._settings = that._settings || {};
                        _preferences(that._settingsName, that._settings);
                        after();
                    }
                    else {
                        Phoenix.external.preferenceSaveHandler(that._settingsName, that._settings).then(function () {
                            after();
                        });
                    }
                }
            };
            Form.prototype.sendMessage = function (message, field, params) {
                var that = this;
                var res;
                var ctrls = that._findControlByField(field);
                if (ctrls && ctrls.length) {
                    ctrls.forEach(function (ctrl) {
                        if (ctrl.sendMessage)
                            res = ctrl.sendMessage(message, params);
                    });
                }
                return res;
            };
            Form.prototype.afterSettings = function (field, widget, sdata) {
                var that = this;
                if (that.options.settingsHandler)
                    return that.options.settingsHandler('after', field, widget, sdata);
                return sdata;
            };
            Form.prototype.beforeSettings = function (field, widget) {
                var that = this;
                if (that.options.settingsHandler)
                    return that.options.settingsHandler('before', field, widget);
                return null;
            };
            Form.prototype._createError = function () {
                var that = this;
                var css = ['bs-form-error'];
                if (that.options.verticalSpacing)
                    css.push('bs-form-vertical-space');
                else if (that.options.closeButtonHandler || that.options.authoringIndicator)
                    css.push('bs-form-settings-space');
                return $('<div id="' + that.data.$id + '_error" class="' + css.join(' ') + '"><div>').get(0);
            };
            Form.prototype._createErrorItem = function (error, show) {
                var that = this;
                var style = (error.severity == 'success' ? 'success' : ((error.severity == 'warning') ? 'warning' : 'danger'));
                var c = show ? '' : 'bs-none ';
                var html = ['<div data-error="true" class="' + c + ' alert alert-' + style + ' alert-dismissible fade in">'];
                html.push('<button type="button" data-error-close="true" class="close" aria-label="Close"><span data-error-close="true" aria-hidden="true">&times;</span></button>');
                html.push(_utils.escapeHtml(error.message));
                if (error.details && error.details.length) {
                    error.details.forEach(function (err) {
                        if (err.message)
                            html.push('<p class="bs-error-detail-item">' + _utils.escapeHtml(err.message) + '</p>');
                    });
                }
                html.push('</div>');
                return $(html.join('')).get(0);
            };
            Form.prototype.clearErrors = function () {
                var that = this;
                if (that.$element) {
                    var eerr = _dom.find(that.$element.get(0), that.data.$id + '_error');
                    if (eerr) {
                        _dom.empty(eerr);
                    }
                }
            };
            Form.prototype.showErrorItem = function (error, clear) {
                var that = this;
                if (that.$element) {
                    var eerr = _dom.find(that.$element.get(0), that.data.$id + '_error');
                    if (eerr) {
                        if (clear) {
                            _dom.empty(eerr);
                        }
                        _dom.append(eerr, that._createErrorItem(error, clear));
                    }
                }
            };
            Form.prototype.afterRenderChildren = function ($e) {
                //setup tooltip
                var $ttc = $e.find('[data-phoenix-tooltip]');
                if ($ttc["tooltip"])
                    $ttc["tooltip"]({
                        html: true,
                        container: 'body',
                        template: '<div class="tooltip bs-tooltip-help" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>'
                    });
            };
            Form.prototype.afterRender = function ($e) {
                var that = this;
                var e = $e.get(0);
                var fc = e.firstChild ? e.firstChild : e;
                if (that.options.form && !that.options.design) {
                    _dom.before(fc, that._createError());
                }
                var fdetail = function (icon, type, color, delta) {
                    var html = ['<div ' + type + '="true" class="bs-cursor-p bs-form-settings' + (color ? ' ' + color : '') + (delta ? ' ' + ' space-' + delta : '') + '" id="' + that.data.$id + '_settings">'];
                    html.push('<span ' + type + '="true" class="' + _dom.iconClass(icon) + '"></span>');
                    html.push('</div>');
                    return html.join('');
                };
                var cd = 0;
                if (that.options.closeButtonHandler) {
                    _dom.append(e, $(fdetail('times-circle-o', 'data-form-detail-close', 'red', cd)).get(0));
                    cd++;
                }
                if (that.options.authoringIndicator) {
                    _dom.append(e, $(fdetail('cog', 'data-form-settings', null, cd)).get(0));
                    cd++;
                }
            };
            Form.prototype.stateChanged = function (propName, params) {
                var that = this;
                if (params.targetId === "layout-state") {
                    if (propName === "isHidden" && params.property) {
                        var state_1 = that.$model.getState(params.property, {});
                        var l = that.$bind[params.property];
                        if (l)
                            l.forEach(function (layoutId) {
                                var layout = that.map[layoutId];
                                if (layout)
                                    that.updateIsHidden(layout, state_1.isHidden);
                            });
                    }
                }
                else if (that.$model.$errors && that.$model.$errors.$) {
                    var err = that.$model.$errors.$;
                    if (!err.hasErrors()) {
                        that.clearErrors();
                    }
                    else {
                        var le = err.errors();
                        for (var i = 0, len = le.length; i < len; i++) {
                            var ce = le[i];
                            that.showErrorItem(ce, i == 0);
                        }
                    }
                    err.clear(false);
                }
            };
            Form.prototype.getSchema = function (path) {
                var that = this;
                return _sutils.getSchema(path, that.$schema, that.$rootSchema, false);
            };
            Form.prototype.getLookupForSchema = function (path, lookupName) {
                var that = this;
                return _sutils.getLookup(path, lookupName, that.$schema, that.$rootSchema);
            };
            Form.prototype.registerListenerFor = function (field, target, id) {
                var that = this;
                var p = field;
                that._listenerChanged = true;
                that._listeners = that._listeners || {};
                that._listeners[p] = that._listeners[p] || [];
                that._listeners[p].push({ target: target, id: id || '' });
            };
            Form.prototype.unRegisterListenerFor = function (field, target) {
                var that = this;
                var p = field;
                if (that._listeners && that._listeners[p]) {
                    var i = that._listeners[p].findIndex(function (item) {
                        return item.target === target;
                    });
                    if (i >= 0) {
                        that._listeners[p].splice(i, 1);
                        that._listenerChanged = true;
                    }
                }
            };
            Form.prototype.setValue = function (path, value) {
                _outils.setValue(path, value, this.$model);
            };
            Form.prototype.getValue = function (path) {
                return _outils.getValue(path, this.$model);
            };
            Form.prototype.getParentModel = function (path) {
                var segments = path.split('.');
                segments.pop();
                return _outils.getValue(segments.join('.'), this.$model);
            };
            Form.prototype.getState = function (path) {
                var that = this;
                var res = _outils.getState(path, this.$model);
                if (that.options.design) {
                    res.isHidden = false;
                    res.isDisabled = false;
                }
                return res;
            };
            Form.prototype._enumListener = function (name, cb) {
                var that = this;
                that._listeners[name].forEach(function (target) {
                    cb(target);
                });
            };
            Form.prototype._rebuildListeners = function () {
                var that = this;
                if (that._listenerChanged) {
                    that._listenersByName = Object.keys(that._listeners);
                    that._listenerChanged = false;
                }
            };
            Form.prototype._match = function (p, cb) {
                var that = this;
                var match = p.join('.'), match2 = match + '.';
                if (that._listenersByName) {
                    that._listenersByName.forEach(function (name) {
                        if (name == match) {
                            cb(name, true, false, false);
                        }
                        else if (name === '*' || (name.indexOf(match2) == 0)) {
                            cb(name, false, true, false);
                        }
                    });
                }
            };
            Form.prototype.execAction = function (propName, actionParams, params) {
                this._modelChanged(propName, null, null, 'execute', params, actionParams);
            };
            Form.prototype.broadcast = function (eventName, params) {
                this.formManager.broadcast(eventName, params);
            };
            Form.prototype._modelChanged = function (propName, ov, nv, op, params, actionParams) {
                var that = this;
                var p = propName.split('.');
                that._rebuildListeners();
                //update controls
                params = params || {};
                if (op !== "execute") {
                    that._match(p, function (name, exact, parent, child) {
                        params.propName = name;
                        if (exact) {
                            that._enumListener(name, function (item) {
                                if (item.target.changed) {
                                    params.targetId = item.id;
                                    item.target.changed(propName, ov, nv, op, params);
                                }
                            });
                        }
                        else if (parent) {
                            that._enumListener(name, function (item) {
                                if (item.target.changed) {
                                    params.targetId = item.id;
                                    item.target.changed(propName, ov, that.getValue(name), op, params);
                                }
                            });
                        }
                    });
                }
                that.afterchanged(propName, op, params, actionParams);
                //update controls
            };
            Form.prototype.afterchanged = function (propName, op, params, actionParams) {
                var that = this;
                if (that.onaction) {
                    if (that.inAction)
                        return;
                    that.inAction = true;
                    try {
                        that.onaction({ property: propName, operation: op, params: params, actionParams: actionParams }, that.$model, that);
                    }
                    finally {
                        that.inAction = false;
                    }
                }
            };
            Form.prototype.on = function (cb) {
                this.onaction = cb;
            };
            Form.prototype._stateChanged = function (propName) {
                var that = this;
                var p = propName.split('.'), stateName, propertyName;
                if (_sutils.statesAndErrors.indexOf(p[p.length - 1]) >= 0) {
                    stateName = p.pop();
                    propertyName = p.join('.');
                }
                that._rebuildListeners();
                that._match(p, function (name, exact, parent, child) {
                    if (exact) {
                        that._enumListener(name, function (item) {
                            if (item.target.stateChanged)
                                item.target.stateChanged(stateName, { targetId: item.id, property: propertyName });
                        });
                    }
                    else if (parent) {
                        that._enumListener(name, function (item) {
                            if (item.target.stateChanged)
                                item.target.stateChanged(null, { targetId: item.id, property: propertyName });
                        });
                    }
                });
            };
            Form.prototype.destroy = function () {
                var that = this;
                that.$data = null;
                that.$schema = null;
                that.$bind = null;
                that.module = null;
                that._listeners = {};
                that._listenersByName = [];
                if (that.$model) {
                    that.$model.onchange = null;
                    that.$model.onstatechanged = null;
                    that.$model.destroy();
                    that.$model = null;
                }
                if (that.formManager) {
                    that.formManager.remove(that);
                    that.formManager = null;
                }
                _super.prototype.destroy.call(this);
            };
            Form.prototype._idComponent = function (el) {
                var that = this;
                if (!that.$element)
                    return null;
                var t = el, root = that.$element.get(0), id;
                while (t) {
                    if (!t.getAttribute)
                        return null;
                    id = t.getAttribute('data-render');
                    if (id)
                        break;
                    t = (t == root) ? null : t.parentNode;
                }
                return id ? id : null;
            };
            Form.prototype._event2FieldByElement = function (el) {
                var that = this;
                var id = that._idComponent(el);
                if (!id)
                    return null;
                return that.controls[id];
            };
            Form.prototype._event2Field = function (event) {
                var that = this;
                return that._event2FieldByElement(event.target);
            };
            Form.prototype._removeBaseEvents = function () {
                var that = this;
                that.$element.off('focusin');
                that.$element.off('focusout');
                that.$element.off('click');
                that.$element.off('keydown');
                that.$element.off('keypress');
                that.$element.off('mousedown');
                $(window).off('global-phoenix-resize');
                _super.prototype._removeBaseEvents.call(this);
            };
            Form.prototype._freeze = function (e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            };
            Form.prototype._addBaseEvents = function () {
                var that = this;
                that.$element.on('focusin', function (event) {
                    if (that._inProcessing)
                        return that._freeze(event);
                    var control = that._event2Field(event);
                    if (control && control.focusIn) {
                        if (control.focused)
                            return;
                        control.focused = true;
                        control.focusIn(event);
                    }
                });
                that.$element.on('focusout', function (event) {
                    if (that._inProcessing)
                        return that._freeze(event);
                    var control = that._event2Field(event);
                    if (control && control.focusOut) {
                        var ne = { target: event.target };
                        if (control.focusTimer) {
                            window.clearTimeout(control.focusTimer);
                            control.focusTimer = 0;
                        }
                        that._setInDelayedAction(true);
                        control.focusTimer = _utils.focusDelay(function () {
                            that._setInDelayedAction(false);
                            if (control.destroyed)
                                return;
                            control.focusTimer = 0;
                            var ae = window.document.activeElement;
                            if (ae) {
                                var c = that._event2FieldByElement(ae);
                                if (c !== control) {
                                    control.focusOut(ne);
                                    control.focused = false;
                                }
                            }
                            else {
                                control.focusOut(ne);
                                control.focused = false;
                            }
                        });
                    }
                });
                that.$element.on('click', function (event) {
                    if (that._inProcessing)
                        return that._freeze(event);
                    var control = that._event2Field(event);
                    if (control && control.click) {
                        if (control.stopProppagation)
                            control.stopProppagation(event);
                        if (control.focusClick)
                            return;
                        if (!that._isInDelayedAction() || control.focused && control.targetInControl(event.target)) {
                            return control.click(event);
                        }
                        that._setInDelayedAction(true);
                        control.focusClick = _utils.focusDelay(function () {
                            that._setInDelayedAction(false);
                            if (control.destroyed)
                                return;
                            control.focusClick = 0;
                            control.click(event);
                            return;
                        });
                    }
                    else if (!control) {
                        var target = event.target;
                        if (target) {
                            var close_1 = target.getAttribute('data-error-close');
                            if (close_1) {
                                var elem = _dom.findByAttribute(event.target, that.$element.get(0), "data-error");
                                if (elem)
                                    _dom.remove(elem);
                                that.openErrors();
                                return that._freeze(event);
                            }
                            else if (target.getAttribute('data-form-detail-close')) {
                                if (that.options.closeButtonHandler) {
                                    that.options.closeButtonHandler();
                                }
                                return that._freeze(event);
                            }
                            else if (target.getAttribute('data-form-settings')) {
                                if (that.options.authoringIndicator) {
                                    _link.execLink({ $formAuthoring: true, path: that.options.path, name: that.options.externalLayout, schema: that.options.externalSchema, locale: that.options.externalLocale }, {}, null);
                                }
                                return that._freeze(event);
                            }
                        }
                    }
                    var layout = that._event2Layout(event);
                    if (layout && layout.$actionName)
                        that.execAction(layout.$actionName);
                });
                that.$element.on('keypress', function (event) {
                    if (that._inProcessing)
                        return that._freeze(event);
                    var control = that._event2Field(event);
                    if (control && control.keypress)
                        control.keypress(event);
                });
                that.$element.on('keydown', function (event) {
                    if (that._inProcessing)
                        return that._freeze(event);
                    var control = that._event2Field(event);
                    if (control && control.keydown)
                        control.keydown(event);
                });
                that.$element.on('keyup', function (event) {
                    if (that._inProcessing)
                        return that._freeze(event);
                    var control = that._event2Field(event);
                    if (control && control.keyup)
                        control.keyup(event);
                });
                that.$element.on('mousedown', function (event) {
                    if (that._inProcessing)
                        return that._freeze(event);
                    var control = that._event2Field(event);
                    if (control && control.mousedown)
                        return control.mousedown(event);
                    return true;
                });
                $(window).on('global-phoenix-resize', function (event) {
                    if (that.currentResizeList)
                        that.currentResizeList.forEach(function (c) { c.resize(); });
                    return true;
                });
                _super.prototype._addBaseEvents.call(this);
            };
            Form.prototype.afterAddedInDom = function () {
                var that = this;
                if (that.currentResizeList)
                    that.currentResizeList.forEach(function (c) { c.resize(); });
                _super.prototype.afterAddedInDom.call(this);
            };
            return Form;
        }(ui.BaseLayout));
        ui.Form = Form;
        ;
        ui.FormClass = Form;
        function removeForm(form) {
            if (form) {
                var e = null;
                if (form.$element) {
                    e = form.$element.get(0);
                }
                form.destroy();
                if (e)
                    _dom.remove(e);
            }
        }
        ui.removeForm = removeForm;
        ui.OpenForm = null;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../typings/index.d.ts" />
/// <reference path="../../core/core.ts" />
/// <reference path="../../core/modules/ajax.ts" />
/// <reference path="../../core/modules/application.ts" />
/// <reference path="../modal.control.ts" />
/// <reference path="./form.control.ts" />
/// <reference path="./schema.data.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ajax = Phoenix.ajax, _utils = Phoenix.utils, _application = Phoenix.application, _su = Phoenix.Observable.SchemaUtils, _external = Phoenix.external;
        var ModalForm = (function (_super) {
            __extends(ModalForm, _super);
            function ModalForm(formOptions, layout, schema, data, locale, preferences) {
                _super.call(this, formOptions, locale);
                var that = this;
                var opts = formOptions.opts ? formOptions.opts : {};
                if (formOptions.validators) {
                    opts.validators = formOptions.validators;
                    delete formOptions.validators;
                }
                that.render = new ui.Form(layout, opts, data, schema, locale, preferences);
                that.render.$locale = locale;
            }
            ModalForm.prototype.on = function (hnd) {
                var that = this;
                var newHnd = function (action, data, form) {
                    return hnd(that, action, data, form);
                };
                this._clickHnd = function (name) {
                    that.render.afterchanged(name, "modal-action", {});
                };
                that.render.on(newHnd);
            };
            return ModalForm;
        }(ui.Modal));
        ui.ModalForm = ModalForm;
        var _openForm = function (formOptions, params, handler) {
            _su.loadSchemaRefs(params.schema, params.data, params.layout, function (ldata) {
                var f = new ModalForm(formOptions, params.layout, params.schema, ldata, params.locale, params.preferences);
                f.open();
                if (handler)
                    f.on(handler);
            });
        };
        var _preferenceName = function (name, config) {
            if (name && _application.name)
                return _application.name + '_form_' + name;
            return '';
        }, _prepareForm = function (layout, schema, fdata, locale, opts, after) {
            var ci = 0, li = -1, si = -1, promises = [], params = { locale: locale }, dataIndex = -1, preferencesIndex = -1;
            var config = _application.config(_application.name);
            opts = opts || {};
            if (locale && locale.$name)
                opts.externalLocale = locale.$name;
            if (!fdata || !fdata.then)
                params.data = $.extend(true, {}, fdata);
            else {
                promises.push(fdata);
                dataIndex = 0;
                ci++;
            }
            var ln;
            if (typeof layout === 'object') {
                params.layout = $.extend(true, {}, layout);
                ln = params.layout.name;
            }
            else {
                li = ci;
                ci++;
                opts.externalLayout = layout;
                ln = layout;
                promises.push(_ajax.get(config.forms + '/' + layout + '.json'));
            }
            if (typeof schema === 'object') {
                params.schema = $.extend(true, {}, schema);
            }
            else {
                si = ci;
                ci++;
                opts.externalSchema = schema;
                promises.push(_ajax.get(config.prototypes + '/' + schema + '.json'));
            }
            var preferenceName = _preferenceName(ln, config);
            if (preferenceName && _external.preferenceLoadHandler) {
                preferencesIndex = ci;
                ci++;
                opts.preferenceName = preferenceName;
                promises.push(_external.preferenceLoadHandler(preferenceName));
            }
            if (promises.length) {
                _utils.Promise.all(promises).then(function (values) {
                    if (li >= 0)
                        params.layout = values[li];
                    if (si >= 0)
                        params.schema = values[si];
                    if (dataIndex >= 0)
                        params.data = values[dataIndex];
                    if (preferencesIndex >= 0) {
                        params.preferences = values[preferencesIndex];
                    }
                    after(opts, params);
                }).catch(function (ex) {
                    console.log("TODO : show errors ");
                    console.log(ex);
                });
            }
            else
                after(opts, params);
        };
        var _OpenModalForm = function (formOptions, layout, schema, fdata, locale, handler) {
            _prepareForm(layout, schema, fdata, locale, null, function (opts, params) {
                formOptions = formOptions || {};
                formOptions.opts = opts;
                _openForm(formOptions, params, handler);
            });
        };
        var _openInlineForm = function ($parent, params, handler, opts) {
            var render = new ui.Form(params.layout, opts || { design: false }, params.data, params.schema, params.locale, params.preferences);
            render.$locale = params.locale;
            render.render($parent);
            if (handler)
                render.on(handler);
            return render;
        };
        var _loadSubLayouts = function ($parent, params, handler, formOpts, after) {
            params.layout;
        };
        var _afterLoadSchema = function ($parent, params, handler, formOpts, after) {
            _su.loadSchemaRefs(params.schema, params.data, params.layout, function (ldata) {
                params.data = ldata;
                var form = _openInlineForm($parent, params, handler, formOpts);
                if (after)
                    after(form);
            });
        };
        var _OpenFormExp = function ($parent, layout, schema, fdata, locale, handler, formOpts, after) {
            _prepareForm(layout, schema, fdata, locale, formOpts, function (opts, params) {
                _afterLoadSchema($parent, params, handler, opts, after);
            });
        };
        function _camelize(propName) {
            return 'on' + propName.charAt(0).toUpperCase() + propName.slice(1);
        }
        var FormController = (function () {
            function FormController() {
            }
            FormController.prototype.data = function () { return null; };
            FormController.prototype.initObjectState = function (model) { };
            FormController.prototype.onModelChanged = function (action, model, form) {
                var that = this;
                var pn = action.property;
                if (pn) {
                    var ii = pn.indexOf('$links.');
                    if (ii >= 0) {
                        pn = pn.replace(/\$links\./, '');
                    }
                    var c = _camelize(pn);
                    if (that[c])
                        return that[c](action, model, form);
                    ;
                }
            };
            return FormController;
        }());
        ui.FormController = FormController;
        ui.OpenModalForm = _OpenModalForm;
        ui.OpenForm = _OpenFormExp;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="../../../ui/layout.control.ts" />
/// <reference path="../schema.data.ts" />
/// <reference path="../form.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var DATE_PICKER_NAME = 'datepicker';
        var _render = Phoenix.render, _ui = ui, _dom = Phoenix.dom, _utils = Phoenix.utils, _device = Phoenix.device, _observable = Phoenix.Observable, _ulocale = Phoenix.ulocale, _locale = Phoenix.locale, _customData = Phoenix.customData, _sutils = _observable.SchemaUtils, _registerControl = function (factory, type, isEnum, widget, options) {
            isEnum = isEnum || false;
            widget = widget || '';
            if (isEnum)
                type = '*';
            options = options || {};
            var lookup = options.lookup || false;
            var format = options.format || '';
            if (options.readOnly)
                _customData.register('ui-controls-readonly-' + widget + '-' + format, factory);
            else
                _customData.register('ui-controls-' + type + '-' + isEnum + '-' + lookup + '-' + widget + '-' + format, factory);
        }, _getRegisteredControl = function (type, isEnum, widget, format, options) {
            isEnum = isEnum || false;
            if (isEnum)
                type = '*';
            widget = widget || '';
            format = format || '';
            var lookup = options && options.lookup ? true : false;
            var readOnly = options && options.readOnly ? true : false;
            if (readOnly) {
                var factory = _customData.get('ui-controls-readonly-' + widget + '-' + format);
                if (!factory && format)
                    factory = _customData.get('ui-controls-readonly-' + widget + '-');
                return factory;
            }
            else {
                var factory = _customData.get('ui-controls-' + type + '-' + isEnum + '-' + lookup + '-' + widget + '-' + format);
                if (!factory && format)
                    factory = _customData.get('ui-controls-' + type + '-' + isEnum + '-' + lookup + '-' + widget + '-');
                return factory;
            }
        }, _dateNative = function () {
            var res = false, called = false;
            return function () {
                if (called)
                    return res;
                called = true;
                if (_device.phone || _device.tablet) {
                    var elem = document.createElement('input');
                    elem.setAttribute('type', 'date');
                    res = (elem.type === 'date');
                    return res;
                }
                else
                    return false;
            };
        }, _align2Css = function (align) {
            if (align === 'center')
                return 'align-center';
            else if (align === 'right')
                return 'align-end';
            return '';
        }, _numberNative = function () {
            var res = false, called = false;
            return function () {
                if (called)
                    return res;
                called = true;
                if (_device.phone || _device.tablet) {
                    var elem = document.createElement('input');
                    elem.setAttribute('type', 'number');
                    res = (elem.type === 'number');
                    return res;
                }
                else
                    return false;
            };
        }, _transform = function (value, displayValue, transform, item) {
            var func = _customData.get("ui.html." + transform);
            if (func)
                return { value: func(value, displayValue, item), html: true };
            return { value: displayValue, html: false };
        }, _mapIcon = function (options, value, textValue) {
            var skey = value + '';
            var iconName = options.avanced.icons[value] || 'none';
            var iconClass = options.avanced.iconClass || null;
            var align = _align2Css(options.avanced.alignIcon || 'center');
            var css = [];
            if (iconName)
                css.push(iconClass ? _dom.customIconClass(iconName, iconClass) : _dom.iconClass(iconName));
            var cc = options.tableOptions && options.tableOptions.small ? 'small-table' : '';
            var dcss = ['bs-image-cell', align];
            if (options.avanced._expandItem) {
                dcss.push('bs-expand-parent');
                css.push('bs-expand-child');
            }
            if (cc)
                dcss.push(cc);
            var html = ['<div class="' + dcss.join(' ') + '"'];
            if (options.avanced._clickable)
                html.push(' data-clickable="true"');
            if (options.avanced._expandItem) {
                if (options.level)
                    html.push(' style="margin-left:' + (0.5 * options.level) + 'em;"');
                css.push('bs-expand-space');
                if (options.avanced._expandItemClass)
                    css.push(options.avanced._expandItemClass);
            }
            if (!options.display) {
                css.push('bs-image-size');
            }
            html.push('><span class="' + css.join(' ') + '"></span>');
            if (options.avanced._expandItem && options.display && options.display.value) {
                html.push('<span class="bs-expand-child">');
                html.push(' ');
                html.push(options.display.value);
                html.push('</span>');
            }
            html.push('</div>');
            return { value: html.join(''), html: true };
        }, _afutils = {
            useDatePicker: function () { return !_afutils.nativeDate() && $.fn.datepicker != null; },
            nativeDate: _dateNative(),
            nativeNumber: _numberNative(),
            addErrorDiv: function (html) {
                html.push('<div class="small text-danger bs-none" id="{0}_errors"></div>');
            },
            keyPressPassword: function (event) {
                var code = event.which;
                if (code === _dom.keys.VK_SPACE) {
                    event.preventDefault();
                    return false;
                }
                return true;
            },
            keyPressCode: function (event) {
                var code = event.which;
                if (code === _dom.keys.VK_SPACE) {
                    event.preventDefault();
                    return false;
                }
                return true;
            },
            keyPressNumber: function (event) {
                var validChars = "-0123456789,." + _locale.number.decimal;
                var code = event.which;
                if (!event.metaKey && _dom.ignoreKeys.indexOf(code) < 0) {
                    var char = String.fromCharCode(code);
                    if (validChars.indexOf(char) < 0) {
                        event.preventDefault();
                        return false;
                    }
                }
                return true;
            },
            getRegisteredControl: _getRegisteredControl,
            addContainerId: function (html, authoring) {
                if (authoring)
                    html.push(' draggable="true"');
                html.push(' data-render="{0}"');
                html.push(' id="{0}"');
            },
            containerBaseClass: function (groupClass, authoring, options) {
                var css = [groupClass, options.groupFieldClass || "bs-field-group", "bs-island"];
                if (options.inline)
                    css.push(options.inlineFieldClass || "bs-field-inline");
                if (authoring)
                    css.push(' design');
                return css.join(' ');
            },
            align2Css: _align2Css,
            fieldWrapper: function (html, options, authoring, after, customizer) {
                var _bootstrap4 = Phoenix.bootstrap4;
                if (options.inline)
                    options.columns = false;
                var groupClass = customizer && customizer.formGroup ? customizer.formGroup : "form-group";
                var css = [_afutils.containerBaseClass(groupClass, authoring, options)];
                var tag = customizer && customizer.tag ? customizer.tag : "div";
                html.push('<' + tag + ' class="');
                if (options.size)
                    css.push((_bootstrap4 ? 'form-control' : 'form-group-') + options.size);
                if (options.columns) {
                    if (!_bootstrap4)
                        css.push('form-horizontal');
                    css.push('row');
                }
                if (options.styles)
                    css.push(options.styles);
                if (options.right)
                    css.push(' pull-right');
                html.push(css.join(' '));
                html.push('"');
                _afutils.addContainerId(html, authoring);
                html.push('>');
                after();
                html.push('</' + tag + '>');
            },
            fillSelect: function (enums, input, schema) {
                if (input) {
                    var enumNames = schema.enumNames || schema.enum;
                    var oenums = schema.enum;
                    _dom.empty(input);
                    var frag = document.createDocumentFragment();
                    enums.forEach(function (en) {
                        var i = oenums.indexOf(en);
                        var et = enumNames[i] || (en + '');
                        var o = document.createElement('option');
                        _dom.attr(o, "value", en);
                        o.textContent = et;
                        _dom.append(frag, o);
                    });
                    _dom.append(input, frag);
                }
            },
            datePickerSetValue: function ($element, value) {
                $element[DATE_PICKER_NAME]('update', _ulocale.parseISODate(value || '') || '');
            },
            datePickerInitialize: function ($element, opts, onHide) {
                _dom.addClass($element.get(0), 'date');
                var o = $.extend({ language: _ulocale.currentLang, autoclose: true }, opts || {});
                $element[DATE_PICKER_NAME](o);
                if (onHide)
                    $element[DATE_PICKER_NAME]().on('hide', onHide);
            },
            datePickerDestroy: function ($element) {
                $element[DATE_PICKER_NAME]('destroy');
            },
            text2value: function (textValue, schema, state) {
                var that = this;
                if (_sutils.isDate(schema)) {
                    if (_ui.Utils.nativeDate())
                        return textValue;
                    else
                        return _ulocale.localeDate2ISO(textValue);
                }
                else if (_sutils.isNumber(schema)) {
                    return _sutils.text2Value(textValue + '', schema, state);
                }
                return textValue;
            },
            defaultOptions: { titleIsHidden: false, placeHolder: false, labelCol: 3 },
            displayValue: function (value, schema, locale, options, item, fieldName) {
                var res;
                options = options || {};
                if (_utils.isNullOrUndefined(value)) {
                    res = { value: '', html: false };
                    return res;
                }
                if (options.isTotal && _sutils.isFwField(fieldName)) {
                    res = { value: '', html: false };
                    return res;
                }
                if (schema.enum) {
                    var si = schema.enum.indexOf(value);
                    var dv = si >= 0 ? (schema.enumNames ? _ulocale.tt(schema.enumNames[si], locale) : value) : '';
                    if (options.avanced && options.avanced.transform) {
                        res = _transform(value, dv, options.avanced.transform, item);
                    }
                    else if (options.avanced && options.avanced.icons)
                        res = _mapIcon(options, value, dv);
                    else
                        res = { value: dv, html: false };
                }
                else {
                    switch (schema.type) {
                        case "string":
                            if (schema.format) {
                                switch (schema.format) {
                                    case "date":
                                        var dv = _ulocale.shortDate(value || '');
                                        if (options.avanced && options.avanced.transform)
                                            res = _transform(value, dv, options.avanced.transform, item);
                                        else
                                            res = { value: dv, html: false };
                                        break;
                                }
                            }
                            if (!res) {
                                if (options.avanced && options.avanced.transform)
                                    res = _transform(value, value, options.avanced.transform, item);
                                else if (options.avanced && options.avanced.icons)
                                    res = _mapIcon(options, value, value);
                                else
                                    res = { value: value, html: false };
                            }
                            break;
                        case "number":
                            var ndv = void 0;
                            if (options.state)
                                ndv = _ulocale.decimal(value || 0, options.state.decimals || 0, (options.useSymbol ? (options.state.symbol || '') : ''));
                            else
                                ndv = (schema.format === 'money') ? _ulocale.money(value || 0, options.useSymbol) : _ulocale.decimal(value || 0, schema.decimals || 0, (options.useSymbol ? schema.symbol : ''));
                            if (options.avanced && options.avanced.transform)
                                res = _transform(value, ndv, options.avanced.transform, item);
                            else if (options.avanced && options.avanced.icons)
                                res = _mapIcon(options, value, value);
                            else
                                res = { value: ndv, html: false };
                            break;
                        case "integer":
                            var idv = _ulocale.decimal(value || 0, 0, '');
                            if (options.avanced && options.avanced.transform)
                                res = _transform(value, idv, options.avanced.transform, item);
                            else if (options.avanced && options.avanced.icons)
                                res = _mapIcon(options, value, value);
                            else
                                res = { value: idv, html: false };
                            break;
                        case "boolean":
                            if (options.isTotal) {
                                res = { value: '', html: false };
                                return res;
                            }
                            if (options.avanced && options.avanced.transform) {
                                res = _transform(value, value ? _locale.ui.Yes : _locale.ui.No, options.avanced.transform, item);
                            }
                            else if (options.html) {
                                var html = [];
                                if ((options.avanced && options.avanced.editable) || options.editable || options.check || (options.avanced && options.avanced.icons)) {
                                    var ces = '';
                                    var curs = 'bs-cursor-d';
                                    if (options.editable) {
                                        ces = 'bs-bool-edit';
                                        curs = 'bs-cursor-p';
                                    }
                                    else {
                                        ces = 'bs-bool';
                                    }
                                    var cc = options.tableOptions && options.tableOptions.small ? ' small-table' : '';
                                    var map = options.avanced ? options.avanced.icons : null;
                                    if (!map)
                                        map = {
                                            'true': 'check-square-o',
                                            'false': 'square-o'
                                        };
                                    var iconName = map[!!value + ''];
                                    var css = [ces, curs, 'bs-image-size'];
                                    if (iconName)
                                        css.push(_dom.iconClass(iconName));
                                    html.push('<center class="bs-image-cell' + cc + '"><span data-clickable="true" class="' + css.join(' ') + '"> </span></center>');
                                    res = { value: html.join(''), html: true };
                                }
                                else {
                                    res = { value: value ? _locale.ui.Yes : _locale.ui.No, html: false };
                                }
                            }
                            else
                                res = { value: value ? _locale.ui.Yes : _locale.ui.No, html: false };
                            break;
                    }
                }
                if (!res)
                    res = { value: value, html: false };
                if (options.html && options.avanced && options.avanced.$link) {
                    var chtml = ['<a class="bs-cursor-p" data-phoenix-href="link://$link">'];
                    chtml.push(res.value);
                    chtml.push('</a>');
                    res.value = chtml.join('');
                    res.html = true;
                }
                return res;
            },
            addTooltip: function (html, description, options) {
                html.push('<span id="{0}_tooltip" data-toggle="tooltip" data-phoenix-tooltip="true" data-placement="auto" title="' + description + '" class="' + _dom.iconClass("question-circle") + ' bs-tooltip-icon');
                if (options && options.inline)
                    html.push(' bs-tooltip-icon-inline');
                html.push('"></span>');
            }
        };
        var AbsField = (function () {
            function AbsField(fp, options, form) {
                var that = this;
                that.config = fp;
                that.form = form;
                that.parent = that.form.getLayoutById(fp.$parentId);
                that.$bind = fp.$bind;
                if (fp.$name)
                    that.name = fp.$name;
                that.$display = that.config.$display || that.$bind;
                if (fp.$lookup) {
                    that.useDisplay = (that.$display !== that.$bind);
                    that.$lookup = that.form.getLookupForSchema(that.$bind, fp.$lookup);
                }
                var isMeta = _sutils.isMeta(that.$bind);
                if (isMeta)
                    that.$bind = that.getCustomBind();
                if (that.$bind) {
                    form.registerListenerFor(that.$bind, that);
                }
                if (that.useDisplay) {
                    form.registerListenerFor(that.$display, that);
                }
                that._defineProps();
                that.options = options || {};
                that.fieldOptions = fp.options || {};
                that.renderOptions = that.fieldOptions;
                that.$schema = that.$bind ? form.getSchema(that.$bind) : {};
                if (that.$schema && that.$schema.type === 'array') {
                    that.$schemaItems = _sutils.expand$Ref(that.$schema.items, that.form.$rootSchema);
                }
                that.id = fp.$id;
            }
            AbsField.prototype.getSettingsName = function (controlName) {
                var that = this;
                var a = [that.$bind, controlName];
                if (that.name)
                    a.push(that.name);
                return a.join('_');
            };
            AbsField.prototype.targetInControl = function (target) {
                var that = this;
                if (that.$element) {
                    var e = that.$element.get(0);
                    return _dom.isChildOf(e, target);
                }
                return false;
            };
            AbsField.prototype.setParentId = function (id) { };
            AbsField.prototype.isMeta = function () { return false; };
            AbsField.prototype.beforeSaveSettings = function () { return false; };
            AbsField.prototype.savePreferences = function (after) {
                var that = this;
                if (!that.form.supportSettings())
                    return after();
                if (that.beforeSaveSettings())
                    that.form.savePrefs(after);
            };
            AbsField.prototype.getCustomBind = function () {
                return '';
            };
            AbsField.prototype.setHidden = function (element) {
                if (!element)
                    return;
                if (this.state.isHidden)
                    _dom.addClass(element, "bs-none");
                else
                    _dom.removeClass(element, "bs-none");
            };
            AbsField.prototype._state = function () {
                var that = this;
                that.state = that.state || {};
                var state = that.form.getState(that.$bind);
                that.state.value = that.form.getValue(that.$bind);
                Object.keys(state).forEach(function (pn) { that.state[pn] = state[pn]; });
            };
            AbsField.prototype._defineProps = function () { };
            AbsField.prototype.render = function ($parent) { };
            AbsField.prototype.appendElement = function ($parent, options) {
                var that = this;
                if ($parent) {
                    if (that.options.replaceParent)
                        $parent.replaceWith(that.$element);
                    else
                        $parent.append(that.$element);
                }
            };
            AbsField.prototype.setEvents = function (opts) {
            };
            AbsField.prototype.removeEvents = function () { };
            AbsField.prototype.customOptions = function (opts) {
            };
            AbsField.prototype._initOptions = function (defOpts) {
                var that = this;
                var popts = {};
                // init default options from parent layout ($fieldsOptions)
                if (that.parent && that.parent.$fieldsOptions) {
                    if (that.parent.$fieldsOptions.columns) {
                        if (popts.columns === undefined) {
                            popts.columns = that.parent.$fieldsOptions.columns;
                        }
                        if (popts.labelCol === undefined && that.parent.$fieldsOptions.labelCol) {
                            popts.labelCol = that.parent.$fieldsOptions.labelCol;
                        }
                    }
                    if (that.parent.$fieldsOptions.titleIsHidden) {
                        if (popts.titleIsHidden === undefined)
                            popts.titleIsHidden = true;
                    }
                }
                var opts = $.extend({}, defOpts, popts, that.fieldOptions);
                if (that.parent.$inline)
                    opts.inline = true;
                that.customOptions(opts);
                that.renderOptions = opts;
                return opts;
            };
            AbsField.prototype.destroy = function () {
                var that = this;
                that.destroyed = true;
                that.$schema = null;
                that.parent = null;
                if (!that.$element) {
                    that.removeEvents();
                    that.$element = null;
                }
                if (that.$bind)
                    that.form.unRegisterListenerFor(that.$bind, that);
                if (that.useDisplay)
                    that.form.unRegisterListenerFor(that.$display, that);
            };
            AbsField.prototype.showErrors = function (element, errors) {
                var that = this;
                var hasErrors = errors && errors.length;
                var e = _dom.find(element, that.id + '_errors');
                if (e) {
                    if (hasErrors) {
                        _dom.text(e, errors[0].message);
                        _dom.removeClass(e, 'bs-none');
                    }
                    else {
                        _dom.addClass(e, 'bs-none');
                    }
                }
            };
            return AbsField;
        }());
        ui.AbsField = AbsField;
        ;
        if (_afutils.useDatePicker()) {
            var tdp = function (lang) {
                $.fn.datepicker.dates[lang] = {
                    days: _locale.date.weekdays,
                    daysShort: _locale.date.weekdaysShort,
                    daysMin: _locale.date.weekdaysMin,
                    months: _locale.date.months,
                    monthsShort: _locale.date.monthsShort,
                    today: _locale.date.today,
                    clear: _locale.date.clear,
                    format: _locale.date.dateShort.replace(/\//g, _locale.date.daySep),
                    titleFormat: 'MM yyyy',
                    weekStart: _locale.date.weekStart
                };
            };
            tdp(_ulocale.currentLang);
            _ulocale.register(tdp);
        }
        ui.Utils = _afutils;
        ui.registerControl = _registerControl;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="./absfield.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _dom = Phoenix.dom, _ulocale = Phoenix.ulocale;
        function _createAlert(id, options, authoring) {
            options = $.extend({ columns: false }, options);
            options.columns = false;
            var html = [];
            _ui.Utils.fieldWrapper(html, options, authoring, function () {
                html.push('<div id="{0}_alert" class="alert alert-' + (options.type || 'danger') + '" role="alert">');
                html.push('</div>');
            });
            return _utils.format(html.join(''), id);
        }
        ;
        var Alert = (function (_super) {
            __extends(Alert, _super);
            function Alert(fp, options, form) {
                _super.call(this, fp, options, form);
                this._state();
            }
            Alert.prototype._setDisabled = function (input, element) {
                var that = this;
                /* not supported */
            };
            Alert.prototype._setReadOnly = function (input, element) {
                /* nothing todo */
            };
            Alert.prototype._setMandatory = function (input, element) {
                /* not supported */
            };
            Alert.prototype._label = function () {
                var that = this;
                return that.$element ? _dom.find(that.$element.get(0), that.id + '_alert') : null;
            };
            Alert.prototype._state2UI = function () {
                var that = this, label = that._label(), element = that.$element ? that.$element.get(0) : null;
                if (label) {
                    _dom.text(label, that.state.value || '');
                    that._setDisabled(label, element);
                    that._setReadOnly(label, element);
                    that.setHidden(element);
                    that._setMandatory(label, element);
                }
            };
            Alert.prototype.changed = function (propName, ov, nv, op) {
                var that = this, label = that._label();
                if (that.state.value != nv) {
                    that.state.value = nv;
                    if (label)
                        _dom.text(label, that.state.value || '');
                }
            };
            Alert.prototype.stateChanged = function (propName, params) {
                var that = this, state = that.form.getState(that.$bind), label = that._label(), element = that.$element ? that.$element.get(0) : null;
                if (state.isHidden !== that.state.isHidden) {
                    that.state.isHidden = state.isHidden;
                    if (label)
                        that.setHidden(element);
                }
                if (state.isDisabled !== that.state.isDisabled) {
                    that.state.isDisabled = state.isDisabled;
                    if (label)
                        that._setDisabled(label, element);
                }
                if (state.isReadOnly !== that.state.isReadOnly) {
                    that.state.isReadOnly = state.isReadOnly;
                    if (label)
                        that._setReadOnly(label, element);
                }
                if (state.isMandatory !== that.state.isMandatory) {
                    that.state.isMandatory = state.isMandatory;
                    if (label)
                        that._setMandatory(label, element);
                }
            };
            Alert.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    that.$element = $(_createAlert(that.id, opts, that.options.design));
                    that._state2UI();
                }
                that.appendElement($parent, opts);
                return that.$element;
            };
            return Alert;
        }(ui.AbsField));
        ui.Alert = Alert;
        _ui.registerControl(Alert, "string", false, 'alert', null);
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../typings/index.d.ts" />
/// <reference path="./utils.ts" />
/// <reference path="./dom.ts" />
var Phoenix;
(function (Phoenix) {
    var _dom = Phoenix.dom, _utils = Phoenix.utils;
    var events;
    (function (events) {
        var EventManager = (function () {
            function EventManager() {
            }
            EventManager.prototype.disable = function () {
                this._isDisabled = true;
            };
            EventManager.prototype.enable = function () {
                this._isDisabled = false;
            };
            return EventManager;
        }());
        events.EventManager = EventManager;
        events.mouseEvents = function (eventType) {
            if (_dom.touch()) {
                switch (eventType) {
                    case 'mousedown':
                        return 'touchstart';
                    case 'mouseup':
                        return 'touchend';
                    case 'mousemove':
                        return 'touchmove';
                }
            }
            return eventType;
        };
        function isLeftButton(eventObject) {
            if (_dom.touch())
                return true;
            return eventObject.which < 2;
        }
        events.isLeftButton = isLeftButton;
        function stopEvent(eventObject) {
            eventObject.stopPropagation();
            eventObject.preventDefault();
        }
        events.stopEvent = stopEvent;
        function point(event) {
            var de = document.documentElement;
            var res;
            if (_dom.touch()) {
                var t = event.targetTouches || event.touches;
                if (t)
                    res = {
                        x: t[0].pageX || (t[0].clientX + (de.scrollLeft || document.body.scrollLeft)),
                        y: t[0].pageY || (t[0].clientY + (de.scrollTop || document.body.scrollTop))
                    };
            }
            if (!res)
                res = {
                    x: event.pageX || (event.clientX + (de.scrollLeft || document.body.scrollLeft)),
                    y: event.pageY || (event.clientY + (de.scrollTop || document.body.scrollTop))
                };
            res.x = Math.round(res.x);
            res.y = Math.round(res.y);
            return res;
        }
        events.point = point;
        events.eventManager = new EventManager();
    })(events = Phoenix.events || (Phoenix.events = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../typings/index.d.ts" />
/// <reference path="./utils.ts" />
/// <reference path="./events.ts" />
/// <reference path="./dom.ts" />
var Phoenix;
(function (Phoenix) {
    var _dom = Phoenix.dom, _utils = Phoenix.utils, _events = Phoenix.events;
    var drag;
    (function (drag_1) {
        var DragAndDropManager = (function () {
            function DragAndDropManager() {
                var that = this;
            }
            DragAndDropManager.prototype.initialize = function () {
                var that = this;
                var $doc = $(document);
                that._mu = that.mouseUp.bind(that);
                that._md = that.mouseDownEmpty.bind(that);
                $doc.on(_events.mouseEvents('mouseup'), that._mu);
                $doc.on(_events.mouseEvents('mousedown'), that._md);
            };
            DragAndDropManager.prototype.finalize = function () {
                var that = this;
                var $doc = $(document);
                if (that._mu) {
                    $doc.off(_events.mouseEvents('mouseup'), that._mu);
                    that._mu = null;
                }
                if (that._md) {
                    $doc.off(_events.mouseEvents('mousedown'), that._mu);
                    that._md = null;
                }
                that._listeners = null;
                that._current = null;
            };
            DragAndDropManager.prototype.startMouseMove = function () {
                var that = this;
                if (!that._mm) {
                    that._mm = that.mouseMove.bind(that);
                    $(document).on(_events.mouseEvents('mousemove'), that._mm);
                }
            };
            DragAndDropManager.prototype.stopMouseMove = function () {
                var that = this;
                if (that._mm) {
                    $(document).off(_events.mouseEvents('mousemove'), that._mm);
                    that._mm = null;
                }
            };
            DragAndDropManager.prototype._canExecuteEvent = function (event) {
                return !!this._current;
            };
            DragAndDropManager.prototype.mouseUp = function (eventObject) {
                var that = this;
                var current = that._current;
                if (!current)
                    return true;
                if (current.inDragging)
                    current.notifyDragEnd(false, eventObject);
                that.setCurrent(null);
                current.clear();
                return false;
            };
            DragAndDropManager.prototype.mouseDownEmpty = function (eventObject) {
                return true;
            };
            DragAndDropManager.prototype.mouseMove = function (eventObject) {
                var that = this;
                if (!that._canExecuteEvent(eventObject))
                    return;
                var current = that._current;
                if (!current)
                    return true;
                if (!current.ready(eventObject)) {
                    if (!_events.isLeftButton(eventObject)) {
                        that.setCurrent(null);
                        current.clear();
                    }
                    return true;
                }
                if (!_events.isLeftButton(eventObject)) {
                    that.cancelDrag();
                    return true;
                }
                try {
                    current.notifyDrag(eventObject);
                }
                catch (e) {
                    that.cancelDrag();
                }
                _events.stopEvent(eventObject);
                return true;
            };
            DragAndDropManager.prototype.addDrag = function (listeners) {
                var that = this;
                var cd = new DragElement(listeners);
                that._listeners = that._listeners || [];
                that._listeners.push(cd);
                return cd;
            };
            DragAndDropManager.prototype.rmvDrag = function (drag) {
                var that = this;
                if (that._listeners) {
                    var i = that._listeners.indexOf(drag);
                    if (i >= 0) {
                        that._listeners.splice(i, 1);
                        drag.finalize();
                    }
                }
            };
            DragAndDropManager.prototype.setCurrent = function (dragObject) {
                var that = this;
                if (dragObject && that._current)
                    return false;
                that._current = dragObject;
                if (!that._current)
                    that.stopMouseMove();
                return true;
            };
            DragAndDropManager.prototype.cancelDrag = function () {
                var that = this;
                var current = that._current;
                if (current) {
                    if (current.inDragging)
                        current.notifyDragEnd(true, null);
                    that.setCurrent(null);
                    current.clear();
                }
            };
            DragAndDropManager.prototype.cover = function (value, cursor, zindex) {
                var that = this;
                if (value) {
                    if (!that._coverId) {
                        that._coverId = _utils.allocID();
                        var scroll = _dom.documentScroll();
                        var client = _dom.documentClientDim();
                        client.width += scroll.left;
                        client.height += scroll.top;
                        client.width = Math.round(Math.max(client.width, document.body.offsetWidth));
                        client.height = Math.round(Math.max(client.height, Math.round(document.body.offsetHeight)));
                        var ce = document.createElement('div');
                        ce.id = that._coverId;
                        ce.style.position = 'absolute';
                        ce.style.top = '0px';
                        ce.style.left = '0px';
                        ce.style.backgroundColor = 'white';
                        ce.style.opacity = '0.01';
                        ce.style.width = client.width + 'px';
                        ce.style.height = client.height + 'px';
                        ce.style.zIndex = (zindex || 10000) + '';
                        ce.style.cursor = cursor;
                        _dom.append(document.body, ce);
                    }
                }
                else {
                    if (that._coverId) {
                        var e = _dom.find(document.body, that._coverId);
                        that._coverId = null;
                        if (e)
                            _dom.remove(e);
                    }
                }
                //
            };
            return DragAndDropManager;
        }());
        drag_1.DragAndDropManager = DragAndDropManager;
        var DragElement = (function () {
            function DragElement(elements) {
                var that = this;
                that._elements = elements;
                that._mdEvent = that.mousedown.bind(that);
                that.clear();
                that._setEvents();
            }
            DragElement.prototype.clear = function () {
                var that = this;
                //save
                var ose = that.stopEvent;
                //init
                that.mouseMoveCount = 0;
                that.minLeft = null;
                that.maxLeft = null;
                that.minTop = null;
                that.maxTop = null;
                that.currentLeft = 0;
                that.currentTop = 0;
                that.moveX = false;
                that.moveY = false;
                that.inDragging = false;
                that.coverDocument = true;
                that.cursor = 'default';
                that.startPoint = null;
                that.currentPoint = null;
                that.startOffset = null;
                that.stopEvent = false;
                that.data = {};
                that.floatElement = null;
                that.floatParent = null;
                // restore
                that.stopEvent = ose;
            };
            DragElement.prototype._removeEvents = function () {
                var that = this;
                if (that._elements) {
                    that._elements.forEach(function (e) {
                        $(e).off(_events.mouseEvents('mousedown'), that._mdEvent);
                    });
                    that._elements = null;
                }
            };
            DragElement.prototype._setEvents = function () {
                var that = this;
                if (that._elements) {
                    that._elements.forEach(function (e) {
                        $(e).on(_events.mouseEvents('mousedown'), that._mdEvent);
                    });
                }
            };
            DragElement.prototype.mousedown = function (eventObject) {
                var that = this;
                that.mouseMoveCount = 0;
                that.inDragging = false;
                if (!_events.isLeftButton(eventObject))
                    return true;
                if (!that.canStartDrag(eventObject))
                    return true;
                if (!drag_1.dragManager.setCurrent(that))
                    return true;
                that.startPoint = _events.point(eventObject);
                drag_1.dragManager.startMouseMove();
                if (that.stopEvent)
                    _events.stopEvent(eventObject);
                return false;
            };
            DragElement.prototype.finalize = function () {
                var that = this;
                that._removeEvents();
                _utils.cleanUpObject(that);
            };
            DragElement.prototype.ready = function (eventObject) {
                var that = this;
                that.mouseMoveCount++;
                if (that.mouseMoveCount == 2)
                    that.notifyDragStart(eventObject);
                return that.inDragging;
            };
            DragElement.prototype.notifyDrag = function (eventObject) {
                var that = this;
                if (!that.inDragging)
                    return;
                that.currentPoint = _events.point(eventObject);
                var e = that.floatElement;
                if (e && that.moveX) {
                    var cl = that.startOffset.left + that.currentPoint.x - that.startPoint.x;
                    if (that.minLeft !== null) {
                        if (cl < that.minLeft)
                            cl = that.minLeft;
                    }
                    if (that.maxLeft !== null) {
                        if (cl > that.maxLeft)
                            cl = that.maxLeft;
                    }
                    that.currentLeft = cl;
                    e.style.left = cl + 'px';
                }
                if (e && that.moveY) {
                    var ct = that.startOffset.top + that.currentPoint.y - that.startPoint.y;
                    if ((that.minTop !== null) && (ct < that.minTop))
                        ct = that.minTop;
                    if ((that.maxTop !== null) && (ct > that.maxTop))
                        ct = that.maxTop;
                    that.currentTop = ct;
                    e.style.top = ct + 'px';
                }
                if (that.onDrag)
                    that.onDrag(eventObject);
            };
            DragElement.prototype.notifyDragStart = function (eventObject) {
                var that = this;
                that.inDragging = true;
                _events.eventManager.disable();
                if (that.coverDocument)
                    drag_1.dragManager.cover(true, that.cursor);
                try {
                    if (that.onDragStart) {
                        if (!that.onDragStart(eventObject))
                            that.notifyDragEnd(true, eventObject);
                        if (that.floatElement)
                            that.startOffset = _dom.position(that.floatElement, that.floatParent);
                    }
                }
                catch (e) {
                }
            };
            DragElement.prototype.canStartDrag = function (event) {
                var self = this;
                if (self.canStartDragHandler)
                    return self.canStartDragHandler(event);
                else
                    return true;
            };
            DragElement.prototype.canDrop = function (value) {
                var that = this;
                if (that.coverDocument) {
                    drag_1.dragManager.cover(true, value ? that.cursor : 'no-drop');
                }
            };
            DragElement.prototype.notifyDragEnd = function (doCancel, event) {
                var that = this;
                that.inDragging = false;
                var uc = that.coverDocument;
                if (that.onDragEnd)
                    that.onDragEnd(doCancel, event);
                _utils.nextTick(function () {
                    _events.eventManager.enable();
                    if (uc)
                        drag_1.dragManager.cover(false);
                });
            };
            return DragElement;
        }());
        drag_1.DragElement = DragElement;
        drag_1.dragManager = new DragAndDropManager();
        Phoenix.dom.readyHandlers.push(function () {
            drag_1.dragManager.initialize();
        });
        var _dragData, _setDragData = function (data) {
            _dragData = data;
        }, _getDragData = function () {
            return _dragData;
        };
        drag_1.setData = _setDragData;
        drag_1.getData = _getDragData;
    })(drag = Phoenix.drag || (Phoenix.drag = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="./absfield.control.ts" />
/// <reference path="../schema.data.ts" />
/// <reference path="../../../core/modules/locale.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _dom = Phoenix.dom, _ui = ui, _ulocale = Phoenix.ulocale, _su = Phoenix.Observable.SchemaUtils;
        var _addDesign = function (id, options, authoring, html) {
            if (authoring)
                html.push(' draggable="true"');
            html.push(' data-render="{0}"');
        }, _addSortIndicator = function (th, asc) {
            var lc = _dom.icon(asc ? 'caret-up' : 'caret-down');
            _dom.addClass(lc, 'bs-basictable-sort');
            _dom.attr(lc, 'sort', 'true');
            _dom.append(th.firstElementChild, lc);
        }, _rmvSortIndicator = function (th) {
            var lc = (th.lastElementChild ? th.firstElementChild.lastElementChild : null);
            if (lc) {
                if (_dom.attr(lc, 'sort') === 'true') {
                    _dom.remove(lc);
                }
            }
        }, _getColumnsSizeParents = function (id, parent, options, isFrozen) {
            var res = [], el;
            if (options._useColGrp) {
                if (isFrozen) {
                    el = Phoenix.dom.find(parent, id + '_colgrp_frozen_header');
                    if (el)
                        res.push(el);
                    el = Phoenix.dom.find(parent, id + '_colgrp_frozen');
                    if (el)
                        res.push(el);
                    if (options.total && options.total.property) {
                        el = Phoenix.dom.find(parent, id + '_colgrp_frozen_footer');
                        if (el)
                            res.push(el);
                    }
                }
                else {
                    el = Phoenix.dom.find(parent, id + '_colgrp_header');
                    if (el)
                        res.push(el);
                    el = Phoenix.dom.find(parent, id + '_colgrp');
                    if (el)
                        res.push(el);
                    if (options.total && options.total.property) {
                        el = Phoenix.dom.find(parent, id + '_colgrp_footer');
                        if (el)
                            res.push(el);
                    }
                }
            }
            else {
                if (!options.headerIsHidden) {
                    if (isFrozen)
                        el = Phoenix.dom.find(parent, id + '_frozen_cols');
                    else
                        el = Phoenix.dom.find(parent, id + '_cols');
                    if (el)
                        res.push(el);
                }
            }
            return res;
        }, _setColumnWidth = function (colId, colsParents, width) {
            colsParents.forEach(function (parent) {
                for (var i = 0, len = parent.childNodes.length; i < len; i++) {
                    var col = parent.childNodes[i];
                    var c = _dom.attr(col, 'colid');
                    if (c === colId) {
                        col.style.width = width + 'px';
                        break;
                    }
                }
            });
        }, _updSorting = function (options, pc, colMap, orderby) {
            if (!options.sorting)
                return;
            if (pc && pc.childElementCount) {
                var aorderby = (orderby || '').split(' ');
                if (!aorderby.length)
                    aorderby = [''];
                for (var i = 0, len = pc.children.length; i < len; i++) {
                    var e = pc.children[i];
                    var cid = _dom.attr(e, 'colId');
                    if (aorderby[0] === cid) {
                        _rmvSortIndicator(e);
                        _addSortIndicator(e, aorderby.length == 1);
                    }
                    else
                        _rmvSortIndicator(e);
                }
            }
        }, _isPixel = function (value) {
            if (typeof value === 'number')
                return true;
            if (typeof value === 'string') {
                var ps = parseInt(value, 10) + '';
                if (ps === value.trim())
                    return true;
                if ((ps + 'px') === value.trim())
                    return true;
            }
            return false;
        }, _ensureWidth = function (value) {
            if (typeof value === 'number')
                return value + 'px';
            if ((parseInt(value, 10) + '') === value.trim())
                return value.trim() + 'px';
            return value;
        }, _widthFromSchema = function (schema) {
            if (_su.isBoolean(schema))
                return 50;
            if (_su.isDate(schema))
                return 110;
            if (_su.isNumber(schema))
                return 110;
            return 150;
        }, _createDetail = function (id, childBefore) {
            var res = document.createElement('tr');
            res.className = 'bs-table-row-detail';
            res.id = id + '_detail';
            var td = document.createElement('td');
            td.colSpan = childBefore.childNodes.length;
            _dom.append(res, td);
            return res;
        }, _createColsWidth = function (columns, options, isFrozen) {
            var frag = document.createDocumentFragment();
            columns.forEach(function (col) {
                var cc = document.createElement('col');
                _dom.attr(cc, 'colid', col.$bind);
                if (col.options.width)
                    cc.style.width = _ensureWidth(col.options.width);
                if (col.options.minWidth)
                    cc.style.minWidth = _ensureWidth(col.options.minWidth);
                _dom.append(frag, cc);
            });
            return frag;
        }, _createCols = function (id, columns, options, authoring, locale, orderby, isFrozen) {
            var frag = document.createDocumentFragment();
            var aorderby = (orderby || '').split(' ');
            columns.forEach(function (col, colIndex) {
                var css;
                var th = document.createElement('th');
                _dom.attr(th, 'colId', col.$bind);
                _dom.attr(th, 'data-drag', 'move');
                if (!options._useColGrp) {
                    if (col.options.width)
                        th.style.width = _ensureWidth(col.options.width);
                    if (col.options.minWidth)
                        th.style.minWidth = _ensureWidth(col.options.minWidth);
                }
                if (css)
                    th.className = css.join(' ');
                var cth = document.createElement('div');
                cth.className = 'bs-column-header';
                var p = cth;
                if (options.headerLines && options.headerLines && options.headerLines > 1) {
                    var tt = document.createElement('div');
                    tt.className = 'bs-header-rows-parent row-' + options.headerLines;
                    p = document.createElement('div');
                    p.className = 'bs-header-rows';
                    tt.appendChild(p);
                    cth.appendChild(tt);
                }
                _dom.append(p, document.createTextNode(_ulocale.tt((col.isLink ? '' : col.title) || String.fromCharCode(160), locale)));
                if (options.allowColumnResize && _isPixel(col.options.width)) {
                    var re = document.createElement('div');
                    re.className = 'bs-col-resize';
                    _dom.attr(re, 'data-drag', 'resize');
                    _dom.attr(th, 'colId', col.$bind);
                    _dom.append(cth, re);
                }
                _dom.append(th, cth);
                if (options.sorting && _su.canSort(col.schema)) {
                    css = css || [];
                    css.push('bs-cursor-p');
                    if (aorderby && aorderby.length && aorderby[0] === col.$bind) {
                        _addSortIndicator(th, orderby.length === 1);
                    }
                }
                if (css)
                    th.className = css.join(' ');
                _dom.append(frag, th);
            });
            return frag;
        }, _createGridRows = function (id, rows, values, columns, options, authoring, locale) {
            var frag = document.createDocumentFragment();
            rows && rows.forEach(function (row, rowIndex) {
                _dom.append(frag, _createGridRow(id, rowIndex, row, values, columns, options, authoring, locale));
            });
            return frag;
        }, 
        /*
        *  row: {name: fieldName, schema: {}}
        */
        _createGridRow = function (id, index, row, values, columns, options, authoring, locale) {
            var tr = document.createElement('tr');
            if (options.align === 'middle')
                _dom.addClass(tr, 'bs-va-middle');
            columns.forEach(function (col, colIndex) {
                var td = document.createElement('td');
                if (colIndex == 0) {
                    _dom.append(td, document.createTextNode(row.schema.title || String.fromCharCode(160)));
                }
                else {
                    _dom.attr(td, 'rowId', col.id);
                    _dom.attr(td, 'colId', row.name);
                    td['rowIndex'] = index;
                    td['colIndex'] = colIndex - 1;
                    var item = values.get(colIndex - 1);
                    var v = _ui.Utils.displayValue(item.getRelativeValue(row.name), row.schema, locale, { html: true, useSymbol: true, editable: row.canEdit, check: row.check, avanced: null, tableOptions: options, state: null }, item, row.name);
                    if (v.html) {
                        var $c = $(v.value);
                        _dom.append(td, $c.get(0));
                    }
                    else
                        _dom.append(td, document.createTextNode(v.value));
                }
                _dom.append(tr, td);
            });
            return tr;
        }, _setRowsSelected = function (id, value, options, parent) {
            if (options.selecting && options.selecting.row) {
                var p = [];
                var tr = _dom.find(parent, id);
                if (tr)
                    p.push(tr);
                if (options.allowFrozenColumns) {
                    tr = _dom.find(parent, id + '_frozen');
                    if (tr)
                        p.push(tr);
                }
                p.forEach(function (ctr) {
                    if (value)
                        _dom.addClass(ctr, 'bs-row-selected');
                    else
                        _dom.removeClass(ctr, 'bs-row-selected');
                });
            }
        }, _createRow = function (id, index, level, row, columns, options, authoring, locale, isOdd, isFrozen, isTotal) {
            var tr = document.createElement('tr');
            tr.id = row.$id + (isFrozen ? '_frozen' : '');
            var rcss = ['bs-table-row'];
            if (options.align === 'middle')
                rcss.push('bs-va-middle');
            if (row.$select && options.selecting && options.selecting.row) {
                if (!options.noRowSelectedIndicator)
                    rcss.push('bs-row-selected');
            }
            if (level)
                rcss.push('bs-row-level-' + level);
            tr.className = rcss.join(' ');
            if (!options._useStripedCss) {
                var isOdd_1 = index % 2 === 1;
                if (!isOdd_1)
                    _dom.addClass(tr, 'even');
            }
            columns.forEach(function (col, colIndex) {
                var td = document.createElement('td');
                var appendSpace = false;
                if (index === 0 && options.headerIsHidden && !options._useColGrp) {
                    if (col.options.width)
                        td.style.width = _ensureWidth(col.options.width);
                    if (col.options.minWidth)
                        td.style.minWidth = _ensureWidth(col.options.minWidth);
                }
                var css = [];
                if (col.options._expandItem)
                    css.push('bs-cursor-d');
                var align = col.options.align;
                if (col.schema) {
                    var isNumber = _su.isNumber(col.schema);
                    var isDate = _su.isDate(col.schema) || _su.isDateTime(col.schema);
                    if (!options._nowrap && (isNumber || isDate))
                        css.push('nowrap');
                    if (!align) {
                        if (isNumber)
                            align = 'right';
                        else if (isDate)
                            align = 'center';
                    }
                }
                if (align)
                    css.push(_ui.Utils.align2Css(align));
                if (css.length)
                    td.className = css.join(' ');
                _dom.attr(td, 'colId', col.$bind);
                var state = row.getRelativeState(col.$bind);
                if (!state.isHidden) {
                    if (col.isLink) {
                        if (!isTotal) {
                            var btn = void 0, span = void 0;
                            if (col.options.button) {
                                var _space = '';
                                btn = document.createElement('button');
                                btn.type = 'button';
                                if (state.isDisabled)
                                    btn.disabled = true;
                                var sizeCss = col.options.size === 'normal' ? '' : ' btn-' + (options.size || 'sm');
                                btn.className = 'bs-button btn btn-' + (col.options.type || 'link') + sizeCss + (state.isDisabled ? ' disabled' : '');
                                if (col.options.icon) {
                                    span = document.createElement('span');
                                    span.className = _dom.iconClass(col.options.icon);
                                    _dom.append(btn, span);
                                    _space = ' ';
                                }
                                if (col.schema.title) {
                                    var tn = document.createTextNode(_space + col.schema.title);
                                    _dom.append(btn, tn);
                                }
                            }
                            else if (col.options.icon) {
                                btn = document.createElement('center');
                                if (state.isDisabled) {
                                    _dom.addClass(btn, 'bs-disabled');
                                }
                                span = document.createElement('span');
                                var cssb = ['text-' + (col.options.type || 'default')];
                                cssb.push('bs-basictable-btn');
                                cssb.push(_dom.iconClass(col.options.icon));
                                span.className = cssb.join(' ');
                                _dom.append(btn, span);
                            }
                            else {
                                appendSpace = true;
                            }
                            if (btn) {
                                btn['$link'] = col.$bind;
                                _dom.append(td, btn);
                            }
                        }
                    }
                    else {
                        var p = td;
                        var co = col.options || {};
                        var editable = (options.editing || _su.isSelectField(col.$bind)) && !state.isDisabled && !state.isReadOnly && !state.isHidden;
                        if (!state.isHidden) {
                            var dv = null;
                            if (co.display && co.displaySchema) {
                                dv = _ui.Utils.displayValue(row.getRelativeValue(co.display), co.displaySchema, locale, { tableOptions: options, avanced: co.displayOptions || {}, state: row.getRelativeState(co.display) }, row, co.display);
                            }
                            var v = _ui.Utils.displayValue(row.getRelativeValue(col.$bind), col.schema, locale, { html: true, useSymbol: false, selectable: !state.isDisabled, editable: editable, isTotal: isTotal, check: options.editing, avanced: co, tableOptions: options, display: dv, level: level, state: state }, row, col.$bind);
                            if (v.html) {
                                var $c = $(v.value);
                                _dom.append(p, $c.get(0));
                            }
                            else {
                                if (v.value === '')
                                    appendSpace = true;
                                else
                                    _dom.append(p, document.createTextNode(v.value));
                            }
                        }
                    }
                }
                else
                    appendSpace = true;
                if (appendSpace) {
                    _dom.append(td, document.createTextNode(String.fromCharCode(160)));
                }
                _dom.append(tr, td);
            });
            return tr;
        }, _createBulkRows = function (id, rows, columns, options, authoring, locale, isFrozen, isTotal, cb) {
            var frag = document.createDocumentFragment();
            rows && rows.forEach(function (row, rowIndex) {
                var level = row.level || 0;
                if (cb)
                    cb(row.value, rowIndex, level);
                var isOdd = rowIndex % 2 === 1;
                _dom.append(frag, _createRow(id, rowIndex, level, row.value, columns, options, authoring, locale, isOdd, isFrozen, isTotal));
            });
            return frag;
        }, _createRows = function (id, rows, columns, options, authoring, locale, isFrozen, isTotal, cb) {
            var frag = document.createDocumentFragment();
            rows && rows.forEach(function (row, rowIndex, level) {
                level = level || 0;
                if (cb)
                    cb(row, rowIndex, level);
                var isOdd = rowIndex % 2 === 1;
                _dom.append(frag, _createRow(id, rowIndex, level, row, columns, options, authoring, locale, isOdd, isFrozen, isTotal));
            }, options.expandingProperty);
            return frag;
        }, _canUseColGroups = function (options, columns) {
            var that = this;
            var res = true;
            // all columns have width defined (but not minWidth)
            for (var i = 0, len = columns.length; i < len; i++) {
                var col = columns[i];
                if (!col.options.width || col.options.minWidth) {
                    res = false;
                    break;
                }
            }
            res = res && options.width !== 'auto';
            if (!res) {
                var vscrolling = options.scrolling && options.scrolling.vertical;
                if (vscrolling) {
                    throw 'To support scrolling vertical, all columns must have explicit widths but not explicit minWidth.';
                }
                if (options.editing) {
                    throw 'To support inline editing, all columns must have explicit widths but not explicit minWidth.';
                }
            }
            return res;
        }, _hasFrozenColumns = function (opts, frozenColumns) {
            var res = !!(opts.allowFrozenColumns && frozenColumns && frozenColumns.length);
            return res;
        }, _cssTable = function (options, isHeader, isFrozen, isFooter) {
            var vscrolling = options.scrolling && options.scrolling.vertical;
            var css = ['table', 'bs-control'];
            if (isHeader || isFooter) {
                css.push('table-header');
            }
            if (!isHeader && !isFooter && options._useStripedCss) {
                css.push('table-striped');
            }
            if (options._useColGrp) {
                css.push('bs-fixed');
            }
            //adde
            if (!isHeader && !isFooter && (options.editing || options.nowrap)) {
                css.push('nowrap');
                options._nowrap = true;
            }
            else if (!isHeader && !isFooter && options.allowFrozenColumns) {
                css.push('nowrap');
                options._nowrap = true;
            }
            if (options.allowFrozenColumns && !options.headerIsHidden) {
                if (isHeader)
                    css.push('headernowrap');
                else if (!vscrolling)
                    css.push('headernowrap');
            }
            css.push('bs-theme');
            if (options.border)
                css.push('table-bordered');
            if (options.small)
                css.push('bs-style-small-table');
            return css;
        }, _styleTable = function (options, isHeader, isFrozen, isFooter) {
            var style = [];
            if (isFrozen)
                return style;
            if (options.width && options.width !== 'auto') {
                style.push('min-width: ' + _ensureWidth(options.width));
            }
            return style;
        }, _createTable = function (html, options, isHeader, isFrozen, isFooter) {
            var vscrolling = options.scrolling && options.scrolling.vertical;
            var css = _cssTable(options, isHeader, isFrozen, isFooter);
            html.push('<table');
            if (css.length)
                html.push(' class="' + css.join(' ') + '"');
            html.push(' id="{0}_table');
            if (isFrozen)
                html.push('_frozen');
            if (isHeader)
                html.push('_header');
            if (isFooter)
                html.push('_footer');
            html.push('"');
            var style = _styleTable(options, isHeader, isFrozen, isFooter);
            if (style.length)
                html.push(' style="' + style.join(';') + '"');
            html.push('>');
            //if (options.description) {
            //    html.push("<caption>");
            //    _ui.Utils.addTooltip(html, options.description, options);
            //    html.push("</caption>");
            //}
            if (options._useColGrp)
                html.push('<colgroup id="{0}_colgrp' + (isFrozen ? '_frozen' : '') + (isHeader ? '_header' : '') + (isFooter ? '_footer' : '') + '"></colgroup>');
            if (isHeader) {
                if (!options.headerIsHidden)
                    html.push('<thead><tr class="bs-va-middle" id="{0}' + (isFrozen ? '_frozen' : '') + '_cols"></tr></thead>');
            }
            else if (!vscrolling) {
                if (!options.headerIsHidden)
                    html.push('<thead><tr class="bs-va-middle" id="{0}' + (isFrozen ? '_frozen' : '') + '_cols"></tr></thead>');
                if (options.total && options.total.property)
                    html.push('<tfoot id="{0}' + (isFrozen ? '_frozen' : '') + '_totals"></tfoot>');
            }
            if (isFooter) {
                if (options.total && options.total.property)
                    html.push('<tfoot id="{0}' + (isFrozen ? '_frozen' : '') + '_totals"></tfoot>');
            }
            if (!isHeader && !isFooter) {
                html.push('<tbody id="{0}');
                if (isFrozen)
                    html.push('_frozen');
                html.push('_rows"></tbody>');
            }
            html.push('</table>');
        }, _columnsWidth = function (cols) {
            var res = 0;
            cols.forEach(function (col) {
                res += parseInt(col.options.width + '', 10);
            });
            return res;
        }, _updatecolumnsWidth = function (e, id, cols) {
            var cw = _columnsWidth(cols);
            var p = _dom.find(e, id + '_frozen_header_parent');
            if (p)
                p.style.width = cw + 'px';
            p = _dom.find(e, id + '_frozen_header_sep');
            if (p) {
                if (cw)
                    _dom.removeClass(p, 'empty');
                else
                    _dom.addClass(p, 'empty');
            }
        }, _cloneForMove = function (element) {
            var fe = element.cloneNode(true);
            if (fe.tagName.toLowerCase() === 'th') {
                var tr = element.parentElement;
                var table = tr.parentElement.parentElement;
                var html = ['<div>'];
                html.push('<table class="');
                html.push(table.className);
                html.push('">');
                html.push('<thead>');
                html.push('<tr class="');
                html.push(tr.className);
                html.push('">');
                html.push('</tr></thead><table>');
                html.push('</div>');
                var ce = $(html.join('')).get(0);
                var ctr = ce.firstChild.firstChild.firstChild;
                ctr.style.height = element.offsetHeight + 'px';
                _dom.append(ctr, fe);
                fe = ce;
            }
            var p = _dom.position(element, null);
            fe.style.top = p.top + 'px';
            fe.style.left = p.left + 'px';
            fe.style.width = element.offsetWidth + 'px';
            fe.style.height = element.offsetHeight + 'px';
            fe.style.zIndex = '5000';
            fe.style.position = 'absolute';
            return fe;
        }, _createGridContainer = function (id, options, authoring, title, locale, columns, frozenColumns) {
            title = title || '';
            options._useColGrp = _canUseColGroups(options, columns);
            options._useStripedCss = !!!(options.rows && options.rows.detail);
            options = $.extend({ right: false, icon: null, type: 'default', width: 'auto', height: 'auto', size: null, scrolling: { horizontal: false } }, options);
            //create div container 
            if (options.title !== undefined)
                title = options.title;
            var html = [], css = ['bs-field-group bs-island'];
            html.push('<div id="{0}" ');
            html.push(' class="');
            if (authoring)
                css.push('design');
            html.push(css.join(' '));
            html.push('"');
            _addDesign(id, options, authoring, html);
            html.push('>');
            //create header div
            html.push('<div id="{0}_header"></div>');
            css = ['bs-basictable-group'];
            var hscrolling = options.scrolling && options.scrolling.horizontal;
            var vscrolling = options.scrolling && options.scrolling.vertical;
            if (vscrolling || options.allowFrozenColumns)
                css.push('border');
            if (hscrolling && !vscrolling)
                css.push('bs-scroll-x');
            html.push('<div id="{0}_focus" class="');
            html.push(css.join(' '));
            html.push('"');
            if (options.selecting && (options.selecting.cell || options.selecting.row)) {
                html.push(' tabindex="0" ');
            }
            html.push('>');
            if (options.allowFrozenColumns) {
                html.push('<div class="bs-table-cols">');
                var fw = _columnsWidth(frozenColumns);
                html.push('<div id="{0}_frozen_header_parent"  class="bs-table-frozen-cols" style="width:' + fw + 'px;">');
                if (vscrolling && !options.headerIsHidden) {
                    // parent of frozen header table
                    html.push('<div id="{0}_table_frozen_header" class="bs-table-header">');
                    // frozen header table 
                    _createTable(html, options, true, true, false);
                    html.push('</div>'); //bs-table-header
                }
                // parent of frozen table content
                css = ['bs-table-content-scroll frozen'];
                html.push('<div  class="' + css.join(' ') + '">');
                css = ["bs-table-content frozen"];
                html.push('<div id="{0}_frozen_scroll" class="' + css.join(' ') + '"');
                if (vscrolling) {
                    var style = [];
                    if (options.height && options.height !== "auto") {
                        style.push("height: " + parseInt(options.height + '', 10) + 'px');
                    }
                    else {
                        throw "To support scrolling vertical, the grid must have an explicit height.";
                    }
                    if (style.length)
                        html.push(' style="' + style.join(';') + '"');
                }
                html.push('>');
                html.push('<div  class="' + css.join(' ') + '">');
                _createTable(html, options, false, true, false);
                if (vscrolling) {
                    html.push('<div id="{0}_frozen_scroll_delta" class="bs-relative"></div>');
                }
                html.push('</div>');
                html.push('</div>'); // {0}_frozen_scroll
                html.push('</div>'); // 0}_frozen_header_parent
                if (vscrolling && options.total && options.total.property) {
                    html.push('<div id="{0}_table_frozen_footer" class="bs-table-header">');
                    _createTable(html, options, false, true, true);
                    html.push('</div>'); //bs-table-header
                }
                html.push('</div>'); // bs-table-frozen-cols
                html.push('<div id="{0}_frozen_header_sep" class="bs-table-cols-sep' + (frozenColumns.length ? '' : ' empty') + '"></div>');
                html.push('<div class="bs-table-free-cols">');
            }
            if (vscrolling && !options.headerIsHidden) {
                html.push('<div id="{0}_table_header" class="bs-table-header" style="padding-right:');
                html.push(_dom.scrollbar());
                html.push('px;">');
                html.push('<div id="{0}_table_header_content" class="bs-table-header-content">');
                _createTable(html, options, true, false, false);
                html.push('</div></div>');
            }
            //create div table container
            if (vscrolling) {
                html.push('<div class="bs-table-content-scroll">');
            }
            css = ["bs-table-content"];
            if (vscrolling)
                css.push("vscroll");
            html.push('<div id="{0}_master_scroll" class="' + css.join(' ') + '"');
            if (vscrolling) {
                var style = [];
                if (options.height && options.height !== "auto") {
                    style.push("height: " + parseInt(options.height + '', 10) + 'px');
                }
                else {
                    throw "To support scrolling vertical, the grid must have an explicit height.";
                }
                if (style.length)
                    html.push(' style="' + style.join(';') + '"');
            }
            html.push('>');
            // create table
            _createTable(html, options, false, false, false);
            html.push('</div>');
            if (vscrolling) {
                html.push('</div>'); //bs-table-content-scroll
                if (options.total && options.total.property) {
                    html.push('<div id="{0}_table_footer" class="bs-table-header" style="padding-right:');
                    html.push(_dom.scrollbar());
                    html.push('px;">');
                    html.push('<div id="{0}_table_footer_content" class="bs-table-header-content">');
                    _createTable(html, options, false, false, true);
                    html.push('</div>');
                    html.push('</div>');
                }
            }
            if (options.allowFrozenColumns) {
                html.push('</div>'); //bs-table-free-cols
                html.push('</div>'); //bs-table-cols
            }
            html.push('</div>');
            html.push('<center id="{0}_pagination"></center>');
            _ui.Utils.addErrorDiv(html);
            html.push('</div>');
            return _utils.format(html.join(''), id);
        }, _resizeDiv = function (parent, point) {
            var res = document.createElement('div');
            res.className = 'bs-absolute bs-col-resize-indicator';
            res.style.top = '0px';
            res.style.left = point.left + 'px';
            _dom.append(parent, res);
            return res;
        }, _updateInplaceSelect = function (inplace, svalue, value, state, parent, cell, col, opts) {
            var enums = state.filter ? col.schema.filters[state.filter] || [] : col.schema.enum;
            var ii = enums.indexOf(value);
            if (ii < 0) {
                _utils.nextTick(function () {
                    cell.item.setValue(col.$bind, enums[0]);
                });
                inplace.input.selectedIndex = 0;
            }
            else {
                inplace.input.selectedIndex = ii;
            }
        }, _updateInplaceEdit = function (inplace, svalue, value, state, parent, cell, col, opts) {
            if (col.schema.enum) {
                return _updateInplaceSelect(inplace, svalue, value, state, parent, cell, col, opts);
            }
            svalue = svalue || '';
            if (_su.isNumber(col.schema)) {
                inplace.input.value = opts.nativeNumber ? value : svalue;
                return;
            }
            if (_su.isDate(col.schema)) {
                inplace.input.value = opts.nativeDate ? value : svalue;
                return;
            }
            inplace.input.value = svalue;
        }, _createSelectInplaceEdit = function (svalue, value, state, parent, cell, col, opts) {
            var input = document.createElement("select");
            input.type = "text";
            var css = ['bs-inplace-edit bs-edit-border bs-inplace-edit-size'];
            input.className = css.join(' ');
            var enums = state.filter ? col.schema.filters[state.filter] || [] : col.schema.enum;
            var ii = enums.indexOf(value);
            _ui.Utils.fillSelect(enums, input, col.schema);
            _dom.empty(parent);
            _dom.addClass(parent, 'focused');
            _dom.append(parent, input);
            if (ii < 0) {
                _utils.nextTick(function () {
                    cell.item.setValue(col.$bind, enums[0]);
                });
                input.selectedIndex = 0;
            }
            else {
                input.selectedIndex = ii;
            }
            return { input: input, parent: input, td: parent, isInputElement: true, canSelect: false, schema: col.schema };
        }, _createInplaceLookup = function (svalue, value, state, parent, cell, col, opts) {
            var pp = document.createElement("div");
            pp.className = 'bs-inplace-parent bs-edit-border ';
            var cp = pp;
            if (opts.after) {
                cp = document.createElement("div");
                cp.className = 'bs-input-group';
                pp.appendChild(cp);
            }
            var isDatePicker = _su.isDate(col.schema) && _ui.Utils.useDatePicker();
            var input = document.createElement("input");
            input.type = opts.type || 'text';
            var css = ['bs-inplace-edit bs-inplace-edit-size'];
            if (opts.after)
                css.push('bs-input-group-main');
            input.className = css.join(' ');
            _dom.append(cp, input);
            if (opts.after) {
                var addon = document.createElement("span");
                addon.tabIndex = -1;
                addon.className = 'bs-input-group-addon bs-cursor-d add-on';
                var icon = document.createElement("span");
                icon.className = _dom.iconClass(opts.after.icon);
                _dom.append(addon, icon);
                _dom.append(cp, addon);
            }
            _dom.empty(parent);
            _dom.addClass(parent, 'focused');
            _dom.append(parent, pp);
            if (_su.isDate(col.schema)) {
                if (isDatePicker) {
                    _ui.Utils.datePickerInitialize($(pp), { showOnFocus: false }, function (e) { });
                    _ui.Utils.datePickerSetValue($(pp), value);
                }
                else
                    input.value = _ulocale.isoDatePart(value || '');
            }
            return { input: input, parent: pp, td: parent, isInputElement: true, canSelect: true, schema: col.schema };
        }, _updateEvenOdd = function (pr) {
            if (pr.childNodes.length) {
                var isOdd = false;
                for (var i = 0, len = pr.childNodes.length; i < len; i++) {
                    var e = pr.childNodes[i];
                    if (_dom.hasClass(e, "bs-table-row")) {
                        if (isOdd)
                            _dom.removeClass(e, "even");
                        else
                            _dom.addClass(e, "even");
                        isOdd = !isOdd;
                    }
                }
            }
        }, _createInplaceEdit = function (svalue, value, state, parent, cell, col, opts) {
            if (col.schema.enum) {
                return _createSelectInplaceEdit(svalue, value, state, parent, cell, col, opts);
            }
            else if (_su.isBoolean(col.schema)) {
                return { input: null, parent: null, td: parent, isInputElement: false, canSelect: false, schema: col.schema };
            }
            else if (opts.after || opts.before) {
                return _createInplaceLookup(svalue, value, state, parent, cell, col, opts);
            }
            var input = document.createElement("input");
            input.type = opts.type || 'text';
            var css = ['bs-inplace-edit bs-edit-border bs-inplace-edit-size'];
            if (col.options.align)
                css.push(_ui.Utils.align2Css(col.options.align));
            if (input.type === 'text' && col.schema.maxLength) {
                input.maxLength = col.schema.maxLength;
            }
            input.className = css.join(' ');
            _dom.empty(parent);
            _dom.addClass(parent, 'focused');
            _dom.append(parent, input);
            if (_su.isDate(col.schema)) {
                if (opts.nativeDate)
                    input.value = _ulocale.isoDatePart(value || '');
                else
                    input.value = _ulocale.shortDate(value || '');
            }
            else if (_su.isNumber(col.schema)) {
                if (opts.nativeNumber)
                    input.value = value || 0;
                else
                    input.value = svalue;
            }
            else
                input.value = svalue;
            return { input: input, parent: input, td: parent, isInputElement: true, canSelect: true, schema: col.schema };
        };
        var _gridUtil = {
            createCols: _createCols,
            createColGroup: _createColsWidth,
            updSorting: _updSorting,
            gridContainer: _createGridContainer,
            createRows: _createRows,
            createBulkRows: _createBulkRows,
            createRow: _createRow,
            setRowsSelected: _setRowsSelected,
            createGridRows: _createGridRows,
            createInplaceEdit: _createInplaceEdit,
            updateInplaceEdit: _updateInplaceEdit,
            createDetail: _createDetail,
            updateEvenOdd: _updateEvenOdd,
            ensureWidth: _ensureWidth,
            updateFrozenWidth: _updatecolumnsWidth,
            setColumnWidth: _setColumnWidth,
            hasFrozenColumns: _hasFrozenColumns,
            cloneForMove: _cloneForMove,
            isPixel: _isPixel,
            widthFromSchema: _widthFromSchema,
            resizeDiv: _resizeDiv,
            getColumnsSizeParents: _getColumnsSizeParents
        };
        ui.GridUtil = _gridUtil;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="../../../core/modules/locale.ts" />
/// <reference path="../../../core/modules/drag.ts" />
/// <reference path="./absfield.control.ts" />
/// <reference path="../errors.data.ts" />
/// <reference path="../../pager.control.ts" />
/// <reference path="./basicgrid.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _dom = Phoenix.dom, _ui = ui, _ulocale = Phoenix.ulocale, _observable = Phoenix.Observable, _gu = _ui.GridUtil, _eu = _observable.errorsUtils, _link = Phoenix.link, _locale = Phoenix.locale, _drag = Phoenix.drag, _events = Phoenix.events, _sutils = _observable.SchemaUtils;
        var MIN_COL_WIDTH = 20, MAX_COL_WIDTH = 2000;
        var withModifier = function ($event, key) {
            if (key === _dom.keys.VK_TAB && $event.shiftKey)
                return false;
            return $event.altKey || $event.ctrlKey || $event.metaKey || $event.shiftKey;
        }, checkPixels = function (val) {
            val = (val || '') + '';
            val = val.trim();
            var p = parseInt(val, 10);
            if ((p + '') === val || (p + 'px') === val || (p + ' px') === val)
                return true;
            return false;
        };
        ui.glbGridFilter = null;
        ui.glbGridSettings = null;
        var BasicGrid = (function (_super) {
            __extends(BasicGrid, _super);
            function BasicGrid(fp, options, form) {
                _super.call(this, fp, options, form);
                this._refreshGrid = function () {
                    var that = this;
                    var opts = that.renderOptions;
                    that.removeEvents();
                    that._initCols(opts);
                    that._renderColumns(opts);
                    that._renderRows(true, '', null);
                    that._renderTotalRows();
                    that.setEvents(that.renderOptions);
                    that.resize();
                };
                var that = this;
                that._view = [];
                that._viewMap = {};
                that._ignoreNotifications = false;
                if (form.supportSettings()) {
                    that._settingsName = that.getSettingsName('basicgrid');
                    that._settings = form.getFieldSettings(that._settingsName);
                }
                form.registerListenerFor(that.$bind + ".$item", that);
                if (that._settings) {
                    var origColumns = that.fieldOptions.columns || [];
                    var newColumns = that._settings.columns || [];
                    var oMap_1 = {};
                    origColumns.forEach(function (col) { oMap_1[col.$bind] = col; });
                    newColumns.forEach(function (col) {
                        var old = oMap_1[col.$bind];
                        if (old) {
                            var co = col.options || {};
                            var no = old.options || {};
                            if (co.width)
                                no.width = co.width;
                            if (co.frozen)
                                no.frozen = co.frozen;
                            col.options = no;
                        }
                    });
                    that.fieldOptions.columns = newColumns;
                    that._settings.columns = null;
                }
                if (that.fieldOptions && that.fieldOptions.total && that.fieldOptions.total.property) {
                    that._totalProperty = that.fieldOptions.total.property;
                    form.registerListenerFor(that._totalProperty, that);
                }
                that._state();
                // load config 
                that.checkOptions(that.fieldOptions);
                that._initOrigColumns(that.fieldOptions);
                that._initCols(that.fieldOptions);
                that._details = [];
            }
            BasicGrid.prototype._initOrigColumns = function (opts) {
                var that = this;
                that._originalCols = {};
                opts.columns = opts.columns || [];
                opts.columns.forEach(function (col) {
                    col.options = col.options || {};
                    if (col.$bind === _observable.EXPANDED_FIELD_NAME && col.options.display) {
                        that._originalCols[col.options.display] = $.extend(true, {}, col);
                        that._originalCols[col.options.display].options._expandItem = true;
                    }
                });
            };
            BasicGrid.prototype.checkOptions = function (opts) {
                if (opts.allowColumnMove === undefined)
                    opts.allowColumnMove = true;
                opts.align = opts.align || 'middle';
            };
            BasicGrid.prototype.beforeSaveSettings = function () {
                var that = this;
                if (that._settingsName) {
                    that._settings = { columns: [] };
                    var allCols = that.renderOptions.columns || [];
                    allCols.forEach(function (col) {
                        var cc = { $bind: col.$bind, options: null };
                        var opts = {};
                        if (col.options.frozen)
                            opts.frozen = true;
                        if (col.options.width)
                            opts.width = col.options.width;
                        cc.options = opts;
                        that._settings.columns.push(cc);
                    });
                    that.form.setFieldSettings(that._settingsName, that._settings);
                    return true;
                }
                return false;
            };
            BasicGrid.prototype._inplaceEditValue2Model = function (value, item, col) {
                var that = this;
                var state = item.getState(col.$bind);
                var nv = _sutils.text2Value(value, col.schema, state);
                var ov = item.getValue(col.$bind);
                if (nv !== ov) {
                    item.setValue(col.$bind, nv);
                    return true;
                }
                return false;
            };
            BasicGrid.prototype._inplaceEditAcceptKeys = function (key) {
                var that = this;
                if (that.inplace.schema.enum) {
                    if (key === _dom.keys.VK_UP || key === _dom.keys.VK_DOWN)
                        return false;
                }
                else if (_sutils.isDate(that.inplace.schema) && _ui.Utils.useDatePicker()) {
                    if (key === _dom.keys.VK_UP || key === _dom.keys.VK_DOWN || key === _dom.keys.VK_LEFT || key === _dom.keys.VK_RIGHT)
                        return false;
                }
                return true;
            };
            BasicGrid.prototype._inplaceEditAddEvents = function () {
                var that = this;
                if (that.inplace.schema.enum) {
                    $(that.inplace.input).on('change', function (event) {
                        var td = that.inplace.td;
                        var cell = that._td2value(td);
                        var iv = that._inplaceEditGetValue(cell);
                        if (!that._inplaceEditValue2Model(iv, cell.item, cell.col))
                            that._modifyCell(cell.item, cell.col.$bind, td);
                    });
                }
            };
            BasicGrid.prototype._inplaceEditRemoveEvents = function () {
                var that = this;
                if (that.inplace.schema.enum) {
                    $(that.inplace.input).off('change');
                }
                else if (_sutils.isDate(that.inplace.schema)) {
                    if (_ui.Utils.useDatePicker()) {
                        ui.Utils.datePickerDestroy($(that.inplace.parent));
                    }
                }
            };
            BasicGrid.prototype._inplaceEditGetValue = function (cell) {
                var that = this;
                if (!cell.item)
                    return null;
                var state = cell.item.getState(cell.col.$bind);
                if (that.inplace.schema.enum) {
                    var si = that.inplace.input.selectedIndex;
                    return state.filter ? that.inplace.schema.filters[state.filter][si] : that.inplace.schema.enum[si];
                }
                return _ui.Utils.text2value(that.inplace.input.value, that.inplace.schema, state);
            };
            BasicGrid.prototype._inpaceEditShow = function (td, isFocusIn) {
                var that = this;
                var cell = that._td2value(td);
                var value = cell.item.getValue(cell.col.$bind);
                var state = cell.item.getState(cell.col.$bind);
                var s = _sutils.value2Text(value, cell.col.schema, state);
                td.tabIndex = -1;
                var opts = { nativeNumber: false, nativeDate: false, type: 'text', after: null };
                if (_sutils.isDate(cell.col.schema)) {
                    opts.nativeDate = _ui.Utils.nativeDate();
                    if (opts.nativeDate) {
                        opts.type = 'date';
                    }
                    else {
                        if (_ui.Utils.useDatePicker())
                            opts.after = { icon: 'calendar' };
                    }
                }
                else if (_sutils.isNumber(cell.col.schema)) {
                    opts.nativeNumber = _ui.Utils.nativeNumber();
                    if (opts.nativeNumber)
                        opts.type = 'number';
                }
                that.inplace = _gu.createInplaceEdit(s, value, state, td, cell, cell.col, opts);
                that._inplaceEditAddEvents();
                if (that.inplace.isInputElement) {
                    that.inplace.input.tabIndex = 0;
                    that.inplace.input.focus();
                    if (that.inplace.canSelect)
                        _dom.select(that.inplace.input);
                }
                else {
                    // focus on td ?
                    td.tabIndex = 0;
                    td.focus();
                }
            };
            BasicGrid.prototype._inplaceEditRemove = function (isFocusOut, isDestroy) {
                var that = this;
                if (that.inplace && !isDestroy) {
                    var td = that.inplace.td;
                    if (isFocusOut) {
                        td.tabIndex = 0;
                    }
                    var cell = that._td2value(td);
                    that._inplaceEditRemoveEvents();
                    if (that.inplace.parent)
                        _dom.remove(that.inplace.parent);
                    _dom.removeClass(td, 'focused');
                    var updValue = that.inplace.input ? true : false;
                    if (updValue) {
                        var s = that._inplaceEditGetValue(cell);
                        that.inplace = null;
                        if (!cell.item)
                            return;
                        if (!that._inplaceEditValue2Model(s + '', cell.item, cell.col))
                            that._modifyCell(cell.item, cell.col.$bind, td);
                    }
                }
                that.inplace = null;
            };
            BasicGrid.prototype._inplaceEditModel2Control = function (item, field, td) {
                var that = this;
                var cell = that._td2value(td);
                var iv = that._inplaceEditGetValue(cell);
                var value = item.getValue(cell.col.$bind);
                var state = item.getState(cell.col.$bind);
                var s = _sutils.value2Text(value, cell.col.schema, state);
                var opts = { nativeNumber: _ui.Utils.nativeNumber(), nativeDate: _ui.Utils.nativeDate() };
                _gu.updateInplaceEdit(that.inplace, s, value, state, td, cell, cell.col, opts);
            };
            BasicGrid.prototype.removeEvents = function () {
                var that = this;
                if (that._scrollableMaster) {
                    $(that._scrollableMaster).off('scroll');
                }
                if (that._scrollableFrozenContent && that.fieldOptions.editing)
                    $(that._scrollableFrozenContent).off('scroll');
                that._scrollableMaster = null;
                that._scrollableHeaderOfMaster = null;
                that._scrollableFooterOfMaster = null;
                if (that._drag) {
                    _drag.dragManager.rmvDrag(that._drag);
                    that._drag = null;
                }
            };
            BasicGrid.prototype.setEvents = function (opts) {
                var that = this;
                var vscroll = opts.scrolling && opts.scrolling.vertical;
                if (vscroll) {
                    var e = that.$element.get(0);
                    that._scrollableMaster = _dom.find(e, that.id + '_master_scroll');
                    that._scrollableHeaderOfMaster = _dom.find(e, that.id + '_table_header_content');
                    if (that._totalProperty)
                        that._scrollableFooterOfMaster = _dom.find(e, that.id + '_table_footer_content');
                    var hasFrozenColumns = _gu.hasFrozenColumns(opts, that.frozenColumns);
                    that._scrollableFrozenContent = hasFrozenColumns ? _dom.find(e, that.id + '_frozen_scroll') : null;
                    that._deltaHScrollContent = hasFrozenColumns ? _dom.find(e, that.id + '_frozen_scroll_delta') : null;
                    if (that._scrollableMaster && that._scrollableHeaderOfMaster)
                        $(that._scrollableMaster).on('scroll', that.syncHeaderAndFrozenScroll.bind(that));
                    if (that._scrollableFrozenContent && that.fieldOptions.editing)
                        $(that._scrollableFrozenContent).on('scroll', that.syncMasterScroll.bind(that));
                }
                if ((opts.allowColumnResize || opts.allowColumnMove) && !opts.headerIsHidden) {
                    var drag = _drag.dragManager.addDrag([that.$element.get(0)]);
                    that._drag = drag;
                    drag.canStartDragHandler = that._canStartDrag.bind(that);
                    drag.onDragStart = that._onDragStart.bind(that);
                    drag.onDrag = that._onDrag.bind(that);
                    drag.onDragEnd = that._onDragEnd.bind(that);
                }
            };
            BasicGrid.prototype._getColsInfo = function (columns, parent) {
                var res = [];
                columns.forEach(function (col, index) {
                    var th = parent.childNodes[index];
                    if (!th.id)
                        th.id = _utils.allocID();
                    res.push({ htmlId: th.id, info: col });
                });
                return res;
            };
            BasicGrid.prototype._canStartDrag = function (event) {
                var that = this;
                var target = event.target;
                var opDrag = _dom.attr(target, 'data-drag');
                var colElement = _dom.parentByTag(that.$element.get(0), target, 'th');
                if (!colElement)
                    return;
                if (!opDrag)
                    opDrag = _dom.attr(colElement, 'data-drag');
                if (!opDrag)
                    return false;
                if (!colElement.id)
                    colElement.id = _utils.allocID();
                that._drag.data.op = opDrag;
                that._drag.data.cloneId = colElement.id;
                that._drag.data.column = _dom.attr(colElement, 'colId');
                if (!that._drag.data.column)
                    return false;
                return that['_cdd' + opDrag](event);
            };
            BasicGrid.prototype._onDragStart = function (event) {
                var that = this;
                if (that._drag.data.op)
                    return that['_sdd' + that._drag.data.op](event);
                return false;
            };
            BasicGrid.prototype._onDrag = function (event) {
                var that = this;
                if (that._drag.data.op)
                    return that["_ddd" + that._drag.data.op](event);
                return false;
            };
            BasicGrid.prototype._onDragEnd = function (cancel, event) {
                var that = this;
                if (that._drag.data.op)
                    return that['_edd' + that._drag.data.op](cancel, event);
                return false;
            };
            BasicGrid.prototype._cddresize = function (event) {
                var that = this, opts = that.renderOptions;
                if (!opts.allowColumnResize)
                    return false;
                var drag = that._drag;
                drag.coverDocument = true;
                drag.cursor = 'col-resize';
                drag.moveX = true;
                return true;
            };
            BasicGrid.prototype._sddresize = function (event) {
                var that = this;
                var drag = that._drag;
                drag.floatParent = that._gridParentFocus();
                var col = _dom.find(drag.floatParent, that._drag.data.cloneId);
                var p = _dom.position(col, drag.floatParent);
                drag.floatElement = _gu.resizeDiv(drag.floatParent, { left: Math.round(p.left + col.offsetWidth) });
                drag.minLeft = Math.round(p.left + MIN_COL_WIDTH);
                drag.maxLeft = Math.round(p.left + MAX_COL_WIDTH);
                return true;
            };
            BasicGrid.prototype._dddresize = function (event) {
                return true;
            };
            BasicGrid.prototype._eddresize = function (cancel, event) {
                var that = this;
                var drag = that._drag;
                if (!drag)
                    return;
                if (drag.floatElement) {
                    _dom.remove(drag.floatElement);
                    drag.floatElement = null;
                }
                if (cancel)
                    return;
                var col = that._colByField(drag.data.column);
                var point = _events.point(event);
                var deltaWidth = point.x - drag.startPoint.x;
                var colh = _dom.find(drag.floatParent, that._drag.data.cloneId);
                var ow = parseInt(col.options.width + '', 10);
                if (colh.offsetWidth - ow > 5) {
                    var factor = ow / colh.offsetWidth;
                    deltaWidth = Math.round(factor * deltaWidth);
                }
                var nw = Math.min(Math.max(MIN_COL_WIDTH, ow + deltaWidth), MAX_COL_WIDTH);
                that._updateColWidth(col, nw);
                that.savePreferences(function () {
                });
            };
            BasicGrid.prototype._updateColWidth = function (col, width) {
                var that = this;
                var oldvalue = Math.max(parseInt(col.options.width || '0', 10), MAX_COL_WIDTH);
                if (oldvalue === width)
                    return;
                col.options.width = width;
                var isFrozen = col.options.frozen && that.renderOptions.allowFrozenColumns;
                var colSize = _gu.getColumnsSizeParents(that.id, that.$element.get(0), that.renderOptions, isFrozen);
                _gu.setColumnWidth(col.$bind, colSize, width);
                if (isFrozen)
                    _gu.updateFrozenWidth(that.$element.get(0), that.id, that.frozenColumns);
                that.resize();
            };
            BasicGrid.prototype._cddmove = function (event) {
                var that = this, opts = that.renderOptions;
                if (!opts.allowColumnMove)
                    return false;
                var grid = that.$element.get(0);
                var drag = that._drag;
                var cloned = _dom.find(grid, drag.data.cloneId);
                drag.coverDocument = true;
                drag.cursor = 'move';
                drag.moveX = true;
                drag.moveY = true;
                drag.startOffset = _dom.position(cloned, null);
                var pc, children;
                var copts = {
                    firstDelta: 0,
                    lastDelta: -10,
                    delta: -4,
                    top: drag.startOffset.top,
                    height: cloned.offsetHeight
                };
                if (opts.allowFrozenColumns) {
                    pc = _dom.find(grid, that.id + '_frozen_cols');
                    if (pc)
                        children = _dom.childrenPositions(pc, that._getColsInfo(that.frozenColumns, pc), false, 'frozen', copts);
                }
                copts.lastDelta = 0;
                pc = _dom.find(grid, that.id + '_cols');
                if (pc) {
                    var fc = _dom.childrenPositions(pc, that._getColsInfo(that.columns, pc), false, 'free', copts);
                    if (children)
                        children = children.concat(fc);
                    else
                        children = fc;
                }
                drag.data.childrenPositions = children;
                return true;
            };
            BasicGrid.prototype._sddmove = function (event) {
                var that = this;
                var drag = that._drag;
                var toClone = _dom.find(that.$element.get(0), drag.data.cloneId);
                drag.floatElement = _gu.cloneForMove(toClone);
                _dom.append(document.body, drag.floatElement);
                return true;
            };
            BasicGrid.prototype._eddmove = function (cancel, event) {
                var that = this;
                var drag = that._drag;
                if (!drag)
                    return;
                if (drag.floatElement) {
                    _dom.remove(drag.floatElement);
                    drag.floatElement = null;
                }
                if (drag.data.mdiv) {
                    _dom.remove(drag.data.mdiv);
                    drag.data.mdiv = null;
                }
                if (cancel)
                    return;
                if (drag.data.best && drag.data.column) {
                    var info = drag.data.best.info;
                    var toMove = that._mapCols[drag.data.column];
                    if (drag.data.best.position === 'empty') {
                        //frozen --> free or free -> frozen
                        toMove.column.options.frozen = !!!toMove.column.options.frozen;
                    }
                    else {
                        if (info.$bind === toMove.column.$bind)
                            return;
                        var where = that._mapCols[info.$bind];
                        var src = toMove.column;
                        var dst = where.column;
                        var ci = toMove.tindex;
                        var ni = drag.data.best.position === 'after' ? where.tindex + 1 : where.tindex;
                        var frozenChanged = false;
                        if (!!src.options.frozen !== !!dst.options.frozen) {
                            src.options.frozen = dst.options.frozen;
                            frozenChanged = true;
                        }
                        if (ci === ni - 1) {
                            if (!frozenChanged)
                                return;
                        }
                        else {
                            // remove src
                            that.renderOptions.columns.splice(ci, 1);
                            if (ci < ni)
                                ni--;
                            // insert at ni
                            that.renderOptions.columns.splice(ni, 0, src);
                        }
                    }
                    that.savePreferences(function () {
                        that._refreshGrid();
                    });
                }
            };
            BasicGrid.prototype._dddmove = function (event) {
                var that = this;
                var drag = that._drag;
                var p = _events.point(event);
                var best = _dom.findNearest(p.x, p.y, drag.data.childrenPositions);
                if (drag.data.best != best) {
                    var pos = {
                        left: best.left,
                        top: best.top,
                        width: best.width,
                        height: best.height
                    };
                    drag.data.mdiv = _dom.showMove(drag.data.mdiv, best.vertical, pos, (best.zone === 'frozen' ? 'bs-drag-color-success' : 'bs-drag-color-info'));
                }
                drag.data.best = best;
                return true;
            };
            BasicGrid.prototype.destroy = function () {
                var that = this;
                that._destroyDetails();
                if (that.columns) {
                    that.columns.forEach(function (col) {
                        col.schema = null;
                    });
                    that.columns = null;
                }
                if (that.frozenColumns) {
                    that.frozenColumns.forEach(function (col) {
                        col.schema = null;
                    });
                    that.frozenColumns = null;
                }
                that.form.unRegisterListenerFor(that.$bind + ".$item", that);
                if (that._totalProperty) {
                    that.form.unRegisterListenerFor(that._totalProperty, that);
                }
                that._inplaceEditRemove(false, true);
                if (that._pager) {
                    that._pager.destroy();
                    that._pager = null;
                }
                if (that._toolBar) {
                    that._toolBar.destroy();
                    that._toolBar = null;
                }
                that._details = null;
                that._mapCols = null;
                that._originalCols = null;
                that._settings = null;
                that._scroller = null;
                that._rsTimer = null;
                that._scrollableMaster = null;
                that._scrollableHeaderOfMaster = null;
                that._scrollableFooterOfMaster = null;
                that._scrollableFrozenContent = null;
                that._deltaHScrollContent = null;
                _super.prototype.destroy.call(this);
            };
            BasicGrid.prototype._moveToPage = function (page) {
                var that = this;
                that.state.value.currentPage(page);
            };
            BasicGrid.prototype._onselectPage = function (page) {
                var that = this;
                switch (page) {
                    case "next":
                        that._moveToPage(Math.min(that._pager.props.totalPages, that._pager.props.currentPage + 1));
                        break;
                    case "prev":
                        that._moveToPage(Math.max(0, that._pager.props.currentPage - 1));
                        break;
                    case "first":
                        that._moveToPage(1);
                        break;
                    case "last":
                        that._moveToPage(that._pager.props.totalPages);
                        break;
                    default:
                        that._moveToPage(page);
                        break;
                }
            };
            BasicGrid.prototype._onSelectToolElement = function (toolElement) {
                var that = this;
                var toolName = toolElement.name || toolElement.id;
                if (toolElement.type === 'filter' && ui.glbGridFilter) {
                    return ui.glbGridFilter(that.getColumnsForFilter(), function (filter) {
                        that.state.value.filterManager.filterComplex = filter;
                        that.state.value.filter = that.state.value.filterManager.constructeFilter();
                    });
                }
                else if (toolElement.type === 'filterexpress') {
                    that.state.value.filterManager.filterExpress = toolElement.value;
                    that.state.value.filter = that.state.value.filterManager.constructeFilter();
                }
                else if (toolElement.type === 'settings' && ui.glbGridSettings) {
                    var params = that.getColumnsForSettings();
                    params.options = toolElement.toolData;
                    return ui.glbGridSettings(params, function (columns) {
                        that.setColumns(columns);
                    });
                }
                else if (toolElement.type === 'multiselect') {
                    that.toggleMultiselect();
                }
                else
                    that.form.execAction(that.$bind + ".$toolbar." + toolName, { toolElement: toolElement, control: that });
            };
            BasicGrid.prototype.setColumns = function (columns) {
                var that = this;
                that.renderOptions.columns = columns.map(function (col) {
                    var oldCol = that._colByField(col.$bind);
                    if (!oldCol)
                        oldCol = that._originalCols[col.$bind];
                    if (oldCol) {
                        if (oldCol.options._expandItem) {
                            col.$bind = _observable.EXPANDED_FIELD_NAME;
                        }
                        col.options = oldCol.options;
                    }
                    return col;
                });
                that.savePreferences(function () {
                    that._refreshGrid();
                });
            };
            BasicGrid.prototype._state = function () {
                _super.prototype._state.call(this);
                var that = this;
                var opts = that.fieldOptions;
                if (that.state.value.isQueryable()) {
                    // create pager
                    var options = $.extend({ size: "default", selectPage: that._onselectPage.bind(that) }, opts.pager || {});
                    that._pager = new _ui.Pager(options);
                    var p = that._pager;
                    p.props.totalPages = that.state.value.totalPages();
                    p.props.currentPage = that.state.value.currentPage();
                }
                var toolElements = [];
                if (opts.toolbar && opts.toolbar.items) {
                    var toolbarOptions = $.extend(true, {}, opts.toolbar);
                    toolbarOptions.items.forEach(function (te) {
                        te.name = te.name || te.type;
                        if (te.lookup) {
                            var dsLookup_1 = null;
                            var notify = function (data, options) {
                                options = options || {};
                                if (options.inited && options.updated)
                                    dsLookup_1.firthPage();
                                else if (data) {
                                    te.value = te.value || {};
                                    var value = { default: te.value.default, items: [], upd: true };
                                    value.items = data || [];
                                    that._toolBar.setValue(te.name, value);
                                }
                            };
                            dsLookup_1 = new _ui.DsLookup(that.$schemaItems.lookups[te.lookup], { notify: notify });
                        }
                        if (te.type === 'count')
                            te = $.extend({ right: true, value: that.state.value.totalCount() }, te);
                        else if (te.type === 'filter') {
                            te = $.extend({ value: that.state.value.filter || "", icon: 'filter' }, te);
                            that.state.value.filterManager = that.state.value.filterManager || new ui.FilterManager();
                        }
                        else if (te.type === 'multiselect') {
                            var cv = !!(opts.selecting && opts.selecting.row && opts.selecting.multiselect);
                            te = $.extend(te, { style: "default", icon: 'check', value: cv });
                        }
                        else if (te.type === 'filterexpress') {
                            te = $.extend(te, { fields: that.getColumnsForFilterExpress(te.fields) });
                            that.state.value.filterManager = that.state.value.filterManager || new ui.FilterManager();
                        }
                        toolElements.push(te);
                    });
                }
                if (toolElements.length) {
                    var toptions = { selectToolElement: that._onSelectToolElement.bind(that) };
                    that._toolBar = new _ui.ToolBar(toolElements, toptions);
                }
            };
            BasicGrid.prototype._destroyDetails = function () {
                //Destroy all inline "forms" 
                var that = this;
                if (!that._details)
                    return;
                var fm = _ui.formManager();
                that._details.forEach(function (detail) {
                    var f = fm.formByName(detail);
                    if (f)
                        f.destroy();
                });
                that._details = [];
            };
            BasicGrid.prototype._destroyDetailById = function (id) {
                var that = this;
                var ii = that._details.indexOf(id);
                if (ii >= 0)
                    that._details.splice(ii, 1);
                var f = _ui.formManager().formByName(id);
                if (f)
                    f.destroy();
            };
            BasicGrid.prototype._initCols = function (options) {
                var that = this;
                that._mapCols = {};
                if (!options.columns || !options.columns.length) {
                    options.columns = [{ $bind: '$index' }];
                }
                that.columns = [];
                that.frozenColumns = [];
                var ii = options.columns.findIndex(function (item) {
                    return _sutils.isSelectField(item.$bind);
                });
                var addSelected = options.selecting && options.selecting.row && options.selecting.multiselect;
                if (addSelected) {
                    if (ii < 0)
                        options.columns.splice(0, 0, { "$bind": _observable.SELECTED_FIELD_NAME, "options": { "width": 50, "frozen": true } });
                }
                else {
                    if (ii >= 0)
                        options.columns.splice(ii, 1);
                }
                var canExpand = !!options.expandingProperty;
                var addWidth = options.scrolling && options.scrolling.vertical || options.editing;
                var ri = [];
                options.columns.forEach(function (col, index) {
                    var c = $.extend({}, col);
                    c.options = c.options || {};
                    if (canExpand && _sutils.isExpandField(col.$bind)) {
                        c.schema = _sutils.getSchema(col.$bind, that.$schemaItems, that.form.$rootSchema, false);
                        c.$bind = options.expandingProperty + col.$bind;
                        c.options.icons = {
                            "1": options.expanding && options.expanding.plus ? options.expanding.plus : "plus",
                            "2": options.expanding && options.expanding.minus ? options.expanding.minus : "minus",
                        };
                        c.options.align = c.options.align || 'left';
                        c.options.alignIcon = c.options.alignIcon || 'left';
                        c.options._clickable = true;
                        c.options._expandItem = true;
                        if (options.expanding) {
                            if (options.expanding.style)
                                c.options._expandItemClass = options.expanding.style;
                            if (options.expanding.iconClass)
                                c.options.iconClass = options.expanding.iconClass;
                        }
                    }
                    if (!c.schema)
                        c.schema = _sutils.getSchema(col.$bind, that.$schemaItems, that.form.$rootSchema, false);
                    if (!c.schema) {
                        if (!c.schema) {
                            console.log('Field (bind) not found : ' + col.$bind);
                            return;
                        }
                    }
                    if (that._mapCols[c.$bind]) {
                        console.log('Duplicate column name  : ' + col.$bind);
                        return;
                    }
                    c.title = _ulocale.tt(c.options.title || c.schema.title, that.form.$locale);
                    if (c.options.display) {
                        c.options.displaySchema = _sutils.getSchema(c.options.display, that.$schemaItems, that.form.$rootSchema, false);
                        if (!c.title && c.options.displaySchema) {
                            c.title = _ulocale.tt(c.options.displaySchema.title, that.form.$locale);
                        }
                    }
                    if (_sutils.isLink(col.$bind)) {
                        c.isLink = true;
                    }
                    if (addWidth && !c.options.width)
                        c.options.width = _gu.widthFromSchema(c.schema);
                    if (c.options.frozen && options.allowFrozenColumns) {
                        if (!c.options.width) {
                            c.options.width = _gu.widthFromSchema(c.schema);
                        }
                        else if (!checkPixels(c.options.width)) {
                            c.options.width = 50;
                        }
                        that.frozenColumns.push(c);
                        that._mapCols[c.$bind] = { column: c, index: that.frozenColumns.length - 1, tindex: index };
                        return;
                    }
                    that.columns.push(c);
                    that._mapCols[c.$bind] = { column: c, index: that.columns.length - 1, tindex: index };
                });
            };
            BasicGrid.prototype._colByField = function (field) {
                var ff = this._mapCols[field];
                return ff ? ff.column : null;
            };
            BasicGrid.prototype._totalChanged = function (propName, ov, nv, op, params) {
                var that = this;
                if (!that.$element)
                    return;
                if (that._ignoreNotifications)
                    return false;
                switch (op) {
                    case 'set':
                    case 'propchange':
                        if (propName === params.propName) {
                            that._renderTotalRows();
                        }
                        break;
                    case 'upd':
                        if (propName === params.propName) {
                            var totals = that.form.getValue(that._totalProperty);
                            var item = params && params.$oid ? totals.findById(params.$oid) : null;
                            if (item) {
                                var prop = params.property;
                                that._modifyFooterCell(item, prop);
                            }
                        }
                        break;
                }
            };
            BasicGrid.prototype.changed = function (propName, ov, nv, op, params) {
                var that = this;
                if (!that.$element)
                    return;
                if (that._ignoreNotifications)
                    return false;
                var updOddEven = false, doResize = false, doSelectFirstCell = false;
                if (that._totalProperty && propName.indexOf(that._totalProperty) === 0) {
                    if (propName === params.propName)
                        that._totalChanged(propName, ov, nv, op, params);
                    return;
                }
                switch (op) {
                    case "count":
                        if (propName === params.propName) {
                            var t = that._toolBar;
                            if (t && t.setValue)
                                t.setValue("count", that.state.value.totalCount());
                        }
                        break;
                    case "filter":
                        if (propName === params.propName) {
                            var t = that._toolBar;
                            if (t && t.setValue)
                                t.setValue('filter', that.state.value.filter.title || '');
                        }
                        break;
                    case "pagination":
                        if (propName === params.propName) {
                            var p = that._pager;
                            if (p) {
                                p.props.totalPages = that.state.value.totalPages();
                                p.props.currentPage = that.state.value.currentPage();
                            }
                        }
                        break;
                    case 'sorting':
                        if (propName === params.propName) {
                            that._updateSorting();
                        }
                        break;
                    case 'set':
                    case 'propchange':
                        if (propName === params.propName) {
                            that._renderRows(true, '', null);
                            doResize = true;
                            doSelectFirstCell = true;
                        }
                        break;
                    case 'add':
                        that._createRow(params.$value);
                        doResize = true;
                        updOddEven = true;
                        break;
                    case 'remove':
                        that._removeRow(params.$id);
                        updOddEven = true;
                        break;
                    case 'upd':
                        if (propName === params.propName) {
                            //console.log('Grid update propName = ' + propName + ', params.property = ' + params.property + ', params.$oid = ' + params.$oid);
                            var item = params && params.$oid ? that._findById(params.$oid) : null;
                            if (item) {
                                var opts = that.renderOptions;
                                var prop = params.property;
                                if (opts.expandingProperty)
                                    prop = _sutils.removeExpand(prop, opts.expandingProperty);
                                that._modifyCell(item, prop);
                                if (_sutils.isSelectField(prop)) {
                                    if (!opts.noRowSelectedIndicator)
                                        _gu.setRowsSelected(item.$id, item.$select, that.fieldOptions, that.$element.get(0));
                                }
                            }
                        }
                        break;
                }
                if (updOddEven)
                    that._updOddEven();
                if (doResize)
                    that.resize();
                if (doSelectFirstCell)
                    that._selectFirstCell();
            };
            BasicGrid.prototype._modifyTD = function (item, field, td) {
                var that = this;
                var opts = that.renderOptions;
                var col = that._colByField(field);
                if (!col)
                    return;
                var state = item.getState(field);
                var co = col.options || {};
                var editable = (opts.editing || _sutils.isSelectField(field)) && !state.isDisabled && !state.isReadOnly && !state.isHidden;
                _dom.empty(td);
                if (state.isHidden)
                    return;
                var dv = null;
                var ii = that._viewMap[item.$id];
                var level = ii ? ii.level || 0 : 0;
                if (co.display && co.displaySchema) {
                    dv = _ui.Utils.displayValue(item.getValue(co.display), co.displaySchema, that.form.$locale, { html: true, tableOptions: opts, avanced: co.displayOptions || {}, state: item.getState(co.display) }, item, co.display);
                }
                var v = _ui.Utils.displayValue(item.getValue(field), col.schema, that.form.$locale, { html: true, useSymbol: false, editable: editable, selectable: !state.isDisabled, check: opts.editing, avanced: co, tableOptions: opts, display: dv, level: level, state: state }, item, field);
                if (v.html) {
                    var $c = $(v.value);
                    _dom.append(td, $c.get(0));
                }
                else {
                    var cv = v.value;
                    if (cv === '')
                        cv = String.fromCharCode(160);
                    _dom.append(td, document.createTextNode(cv));
                }
            };
            BasicGrid.prototype._findTR = function (id, col) {
                var that = this, opts = that.renderOptions;
                var cid = id + (col.options.frozen && opts.allowFrozenColumns ? '_frozen' : '');
                return _dom.find(that.$element.get(0), cid);
            };
            BasicGrid.prototype._id2rowId = function (id) {
                var ii = id.indexOf('_frozen');
                if (ii > 0)
                    id = id.substring(0, ii);
                return id;
            };
            BasicGrid.prototype._findtBody = function (col) {
                var that = this, opts = that.renderOptions;
                var cid = that.id + (col.options.frozen && opts.allowFrozenColumns ? '_frozen_rows' : '_rows');
                return _dom.find(that.$element.get(0), cid);
            };
            BasicGrid.prototype._modifyFooterCell = function (item, field) {
                var that = this;
                if (!that.$element)
                    return;
                var col = that._colByField(field);
                if (!col)
                    return;
                var tr = that._findTR(item.$id, col);
                if (!tr)
                    return;
                that._findCellAndModify(item, tr, field);
            };
            BasicGrid.prototype._findCellAndModify = function (item, tr, field) {
                //TODO: optimize
                var that = this;
                for (var i = 0, len = tr.childNodes.length; i < len; i++) {
                    var ctd = tr.childNodes[i];
                    var cid = _dom.attr(ctd, 'colid');
                    if (cid === field) {
                        if (that.inplace && that.inplace.input && that.inplace.td === ctd) {
                            that._inplaceEditModel2Control(item, field, ctd);
                            return;
                        }
                        that._modifyTD(item, field, ctd);
                    }
                }
            };
            BasicGrid.prototype._modifyCell = function (item, field, td) {
                var that = this;
                if (!that.$element)
                    return;
                var col = that._colByField(field);
                if (!col)
                    return;
                if (td) {
                    if (that.inplace && that.inplace.input && that.inplace.td === td) {
                        that._inplaceEditModel2Control(item, field, td);
                        return;
                    }
                    return that._modifyTD(item, field, td);
                }
                var tr = that._findTR(item.$id, col);
                if (!tr)
                    return;
                that._findCellAndModify(item, tr, field);
            };
            BasicGrid.prototype._rootElement = function () {
                return this.$element.get(0);
            };
            BasicGrid.prototype._gridParentFocus = function () {
                var that = this;
                return _dom.find(that.$element.get(0), that.id + '_focus');
            };
            BasicGrid.prototype._setErrors = function (grid, element) {
                var that = this;
                var errors = that.state.errors;
                that.showErrors(element, errors);
            };
            BasicGrid.prototype._setTableFocus = function (value) {
                var that = this;
                var table = _dom.find(that.$element.get(0), that.id + '_table');
                if (table) {
                    if (value)
                        _dom.addClass(table, 'focused');
                    else
                        _dom.removeClass(table, 'focused');
                }
                table = _dom.find(that.$element.get(0), that.id + '_table_frozen');
                if (table) {
                    if (value)
                        _dom.addClass(table, 'focused');
                    else
                        _dom.removeClass(table, 'focused');
                }
            };
            BasicGrid.prototype.focusIn = function ($event) {
                var that = this;
                if (that.$element) {
                    that._setTableFocus(true);
                    if (that.selectedCell) {
                        var c = that._cell(that.selectedCell, true);
                        if (!c) {
                            that.selectedCell = null;
                            that._selectFirstCell();
                            if (that.selectedCell)
                                c = that._cell(that.selectedCell, true);
                        }
                        if (!c)
                            return;
                        var canEdit = that.canEdit(that.selectedCell);
                        if (canEdit && !that.inplace) {
                            that._inpaceEditShow(c.td, true);
                        }
                    }
                    else {
                        that._inplaceEditRemove(false, false);
                    }
                }
            };
            BasicGrid.prototype.focusOut = function ($event) {
                var that = this;
                if (that.$element) {
                    that._setTableFocus(false);
                    that._inplaceEditRemove(true, false);
                }
            };
            BasicGrid.prototype._doTab = function (forward) {
                var that = this;
                if (forward)
                    return that._moveRightSelectedCell();
                else
                    return that._moveLeftSelectedCell();
            };
            BasicGrid.prototype.keypress = function (event) {
                var that = this;
                if (that.selectedCell) {
                    if (that.inplace && _dom.isChildOf(that.inplace.td, event.target)) {
                        var cell = that._td2value(that.inplace.td);
                        if (_sutils.isNumber(that.inplace.schema)) {
                            if (_ui.Utils.keyPressNumber(event) === false)
                                return false;
                        }
                        else if (_sutils.isBoolean(that.inplace.schema)) {
                            if (String.fromCharCode(event.which) === ' ') {
                                if (that.fieldOptions.editing) {
                                    var state = cell.item.getRelativeState(cell.col.$bind);
                                    if (!state.isDisabled && !state.isReadOnly) {
                                        var ov = cell.item.getValue(cell.col.$bind);
                                        cell.item.setValue(cell.col.$bind, !ov);
                                    }
                                }
                            }
                            event.preventDefault();
                        }
                    }
                }
            };
            BasicGrid.prototype.keydown = function ($event) {
                var that = this, key = $event.which || $event.keyCode;
                var preventDefault = false;
                if (withModifier($event, key))
                    return;
                if (that.inplace && _dom.isChildOf(that.inplace.td, $event.target)) {
                    if (!that._inplaceEditAcceptKeys(key))
                        return;
                }
                if (that.fieldOptions.selecting && that.fieldOptions.selecting.cell) {
                    switch (key) {
                        case _dom.keys.VK_TAB:
                            preventDefault = that._doTab(!$event.shiftKey);
                            break;
                        case _dom.keys.VK_UP:
                            preventDefault = that._moveUpSelectedCell(1);
                            break;
                        case _dom.keys.VK_DOWN:
                            preventDefault = that._moveDownSelectedCell(1);
                            break;
                    }
                }
                preventDefault && $event.preventDefault() && $event.stopPropagation();
            };
            BasicGrid.prototype._tr2rowId = function (tr, col) {
                var id = tr.id;
                if (col && col.options.frozen) {
                    var ii = id.indexOf('_frozen');
                    if (ii > 0) {
                        id = id.substring(0, ii);
                    }
                }
                return id;
            };
            BasicGrid.prototype._td2cell = function (td) {
                var that = this;
                var tr = td.parentNode;
                var pr = tr.parentNode;
                var c = that._colByField(_dom.attr(td, 'colid'));
                if (!c)
                    return null;
                var rid = that._tr2rowId(tr, c);
                var item = that._findById(rid);
                if (item && c)
                    return { row: rid, col: _dom.attr(td, 'colid') };
                return null;
            };
            BasicGrid.prototype._td2value = function (td) {
                var that = this;
                var tr = td.parentNode;
                var pr = tr.parentNode;
                var c = that._colByField(_dom.attr(td, 'colid'));
                var rid = that._tr2rowId(tr, c);
                var item = that._findById(rid);
                return { item: item, col: c };
            };
            BasicGrid.prototype.mousedown = function (event) {
                var that = this;
                var td = _dom.parentByTag(that.$element.get(0), event.target, 'td');
                if (td) {
                    var opts = that.renderOptions;
                    var cell = that._td2cell(td);
                    if (cell) {
                        if (that._selectCell(cell, event, true)) {
                            event.preventDefault();
                        }
                        else if (opts.selecting && opts.selecting.row && !opts.selecting.cell && !opts.selecting.multiselect) {
                            that._selectRow(cell.row);
                        }
                    }
                }
                return true;
            };
            BasicGrid.prototype._addRows = function (item, childrens) {
                var that = this;
                that._renderRows(false, item.$id, childrens);
                that._updOddEven();
            };
            BasicGrid.prototype._removeRows = function (item, childrens) {
                var that = this;
                childrens.forEach(function (child) { that._removeRow(child.value.$id); });
                that._updOddEven();
            };
            BasicGrid.prototype.click = function (event) {
                var that = this;
                var opts = that.renderOptions;
                var td = _dom.parentByTag(that.$element.get(0), event.target, 'td');
                if (td) {
                    var cell = that._td2cell(td);
                    if (cell) {
                        //that._selectCell(cell, event, false);
                        var item = that._findById(cell.row);
                        var c = that._colByField(cell.col);
                        if (item) {
                            var linkName = event && event.target && event.target.$link || event.target.parentNode.$link;
                            if (linkName) {
                                var lk = item.getRelativeState(c.$bind);
                                if (lk.isDisabled || lk.isHidden)
                                    return;
                                if (c.schema.$widgetAction) {
                                    if (that[c.schema.$widgetAction])
                                        that[c.schema.$widgetAction](item);
                                }
                                else
                                    that.form.execAction(that.$bind + '.$item.' + linkName, item);
                            }
                            else if (c) {
                                if (c.options._expandItem) {
                                    if (_dom.attr(event.target, 'data-clickable') || _dom.attr(event.target.parentNode, 'data-clickable')) {
                                        var state = item.getRelativeState(c.$bind);
                                        if (!state.isDisabled && !state.isReadOnly) {
                                            var expanded = item.toggleExpand(opts.expandingProperty);
                                            //TODO : move in modifyCell
                                            that._ignoreNotifications = true;
                                            try {
                                                var childrens_1 = [];
                                                var ii = that._viewMap[item.$id];
                                                item.enumVisibleChilds(opts.expandingProperty, ii.level, true, function (item, level) {
                                                    var ii = { level: level, value: item };
                                                    childrens_1.push(ii);
                                                });
                                                if (!childrens_1.length)
                                                    return;
                                                if (expanded)
                                                    that._addRows(item, childrens_1);
                                                else
                                                    that._removeRows(item, childrens_1);
                                            }
                                            finally {
                                                that._ignoreNotifications = false;
                                            }
                                        }
                                    }
                                }
                                else if (c.options.$link) {
                                    var a = _dom.findByAttribute(event.target, td, 'data-phoenix-href');
                                    if (a) {
                                        var state = item.getRelativeState(c.$bind);
                                        if (!state.isDisabled)
                                            _link.execLink(c.options.$link, { $item: item }, null);
                                    }
                                }
                                else if (c.options.actionName) {
                                    var state = item.getRelativeState('$links.' + c.options.actionName);
                                    if (state && !state.isDisabled)
                                        that.form.execAction(that.$bind + '.$item.$links.' + c.options.actionName, item);
                                }
                                else if (_sutils.isSelectField(c.$bind) || (opts.editing && _sutils.isBoolean(c.schema))) {
                                    if (_dom.attr(event.target, 'data-clickable')) {
                                        var state = item.getRelativeState(c.$bind);
                                        if (!state.isDisabled && !state.isReadOnly && !state.isHidden) {
                                            var ov = item.getValue(c.$bind);
                                            if (_sutils.isSelectField(c.$bind))
                                                item.select(!!!ov, opts.selecting && opts.selecting.row && opts.selecting.multiselect, that.state.value, opts.expandingProperty);
                                            else
                                                item.setValue(c.$bind, !!!ov);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                else {
                    var th = _dom.parentByTag(that.$element.get(0), event.target, 'th');
                    if (th) {
                        var cid = _dom.attr(th, 'colid');
                        if (opts.sorting && cid) {
                            var col = that._colByField(cid);
                            if (col && _sutils.canSort(col.schema)) {
                                var no = col.$bind;
                                var oldob = that.state.value.$orderby();
                                if (oldob === col.$bind) {
                                    no = col.$bind + " desc";
                                }
                                that.state.value.$orderby(no);
                            }
                        }
                    }
                }
            };
            BasicGrid.prototype._setDisabled = function (button, element) {
                var that = this;
                button.disabled = that.state.isDisabled;
            };
            BasicGrid.prototype._showSelected = function (cell, value, editable, mousedown) {
                var that = this;
                if (!cell)
                    return null;
                var coord = that._cell(cell, false);
                if (!coord)
                    return;
                if (coord.td) {
                    if (value) {
                        _dom.addClass(coord.td, "bs-cell-selected");
                        that._inplaceEditRemove(false, false);
                        if (editable && (that.focused || mousedown)) {
                            that._inpaceEditShow(coord.td, false);
                        }
                        else {
                            coord.td.tabIndex = 0;
                            coord.td.focus();
                        }
                    }
                    else {
                        _dom.removeClass(coord.td, "bs-cell-selected");
                        coord.td.tabIndex = -1;
                    }
                }
            };
            BasicGrid.prototype.canSelect = function (cell) {
                var that = this;
                var old = that.selectedCell;
                if (old && old.col === cell.col && old.row === cell.row)
                    return false;
                if (!that.fieldOptions.selecting || !that.fieldOptions.selecting.cell)
                    return false;
                var c = that._colByField(cell.col);
                if (c) {
                    var item = that._findById(cell.row);
                    if (item) {
                        var st = item.getState(c.$bind);
                        return !st.isDisabled && !st.isHidden;
                    }
                }
                return false;
            };
            BasicGrid.prototype.canEdit = function (cell) {
                var that = this;
                if (!that.fieldOptions.editing || !that.fieldOptions.selecting || !that.fieldOptions.selecting.cell)
                    return false;
                var c = that._colByField(cell.col);
                if (c.options._expandItem)
                    return false;
                var item = that._findById(cell.row);
                var st = item.getState(c.$bind);
                return !st.isReadOnly && !st.isDisabled && !st.isHidden;
            };
            BasicGrid.prototype.clearSelected = function () {
                var that = this;
                var old = that.selectedCell;
                that.selectedCell = null;
                if (old) {
                    that._showSelected(old, false, true, false);
                }
                that._gridParentFocus().tabIndex = 0;
            };
            BasicGrid.prototype._selectRow = function (id) {
                var that = this, opts = that.renderOptions;
                var multiselect = opts.selecting && opts.selecting.row && opts.selecting.multiselect;
                var item = that._findById(id);
                if (item)
                    item.select(true, multiselect, that.state.value, opts.expandingProperty);
            };
            BasicGrid.prototype._selectCell = function (cell, target, mousedown) {
                var that = this;
                if (!that.canSelect(cell))
                    return false;
                var old = that.selectedCell;
                var canEdit = that.canEdit(cell);
                that._showSelected(cell, true, canEdit, mousedown);
                that.selectedCell = cell;
                if (old) {
                    that._showSelected(old, false, true, mousedown);
                }
                else {
                    that._gridParentFocus().tabIndex = -1;
                }
                var opts = that.renderOptions;
                if (opts.selecting && opts.selecting.row && !opts.selecting.multiselect) {
                    that._selectRow(cell.row);
                }
                return true;
            };
            BasicGrid.prototype._selectFirstCell = function () {
                var that = this;
                var opts = that.fieldOptions;
                if (!opts.selecting || !opts.selecting.cell)
                    return false;
                var pr = _dom.find(that.$element.get(0), that.id + '_rows');
                if (!pr.childNodes.length)
                    return false;
                var cell = null;
                var allCols = that.frozenColumns.concat(that.columns);
                for (var i = 0, len = allCols.length; i < len; i++) {
                    var c = allCols[i];
                    if (opts.allowFrozenColumns && c.options.frozen)
                        pr = _dom.find(that.$element.get(0), that.id + '_frozen_rows');
                    var tr = pr.firstChild;
                    var rid = that._tr2rowId(tr, c);
                    cell = { col: c.$bind, row: rid };
                    if (that.canSelect(cell))
                        break;
                    cell = null;
                }
                if (cell) {
                    return that._selectCell(cell, null, false);
                }
                return false;
            };
            BasicGrid.prototype._cell = function (cell, addIndex) {
                var that = this;
                var col = that._mapCols[cell.col];
                var cIndex = col.index;
                var tr = that._findTR(cell.row, col.column);
                if (!tr)
                    return null;
                var td = tr.childNodes[cIndex];
                var res = { td: td, tr: tr, rIndex: -1, cIndex: -1 };
                if (addIndex) {
                    res.rIndex = _dom.indexOf(tr.parentNode, tr);
                    res.cIndex = cIndex;
                }
                return res;
            };
            BasicGrid.prototype._moveUpSelectedCell = function (count) {
                var that = this;
                if (!that.selectedCell)
                    return that._selectFirstCell();
                var col = that._colByField(that.selectedCell.col);
                var pos = that._cell(that.selectedCell, true);
                if (!pos) {
                    that.selectedCell = null;
                    return that._selectFirstCell();
                }
                var nri = Math.max(pos.rIndex - count, 0);
                if (nri != pos.rIndex) {
                    var pr = that._findtBody(col);
                    var tr = pr.childNodes[nri];
                    return that._selectCell({ row: that._id2rowId(tr.id), col: that.selectedCell.col }, null, false);
                }
                return false;
            };
            BasicGrid.prototype.resize = function () {
                var that = this;
                that._resize();
            };
            BasicGrid.prototype._updateFrozenColumnsHeight = function () {
                var that = this;
                var opts = that.renderOptions;
                if (that._scrollableFrozenContent) {
                    if (!opts.height || opts.height === "auto")
                        return;
                    var hasHScroll = that._scrollableMaster.scrollWidth > that._scrollableMaster.clientWidth;
                    var ns = void 0;
                    if (hasHScroll)
                        ns = _dom.scrollbar() + 'px';
                    else
                        ns = '0px';
                    if (that._deltaHScrollContent.style.height !== ns) {
                        that._deltaHScrollContent.style.height = ns;
                        that._vscroll();
                    }
                }
            };
            BasicGrid.prototype._resize = function () {
                var that = this;
                var opts = that.renderOptions;
                var vscroll = opts.scrolling && opts.scrolling.vertical;
                if (!vscroll)
                    return;
                var hasFrozenColumns = _gu.hasFrozenColumns(opts, that.frozenColumns);
                if (!hasFrozenColumns)
                    return;
                var sh = _dom.scrollbar();
                if (sh) {
                    that._updateFrozenColumnsHeight();
                }
                that._vscroll();
            };
            BasicGrid.prototype.syncHeaderAndFrozenScroll = function (e) {
                var that = this;
                if (!that._scroller || that._scroller === 'master') {
                    that._scroller = 'master';
                    that._hscroll();
                    that._vscroll();
                    that._removeScroller();
                }
            };
            BasicGrid.prototype.syncMasterScroll = function (e) {
                var that = this;
                if (!that._scroller || that._scroller === 'frozen') {
                    that._scroller = 'frozen';
                    that._vsmcroll();
                    that._removeScroller();
                }
            };
            BasicGrid.prototype._removeScroller = function () {
                var that = this;
                if (!that.fieldOptions.editing) {
                    that._scroller = null;
                    return;
                }
                if (that._rsTimer)
                    window.clearTimeout(that._rsTimer);
                that._rsTimer = window.setTimeout(function () {
                    that._scroller = null;
                    that._rsTimer = null;
                }, 50);
            };
            BasicGrid.prototype._vscroll = function () {
                var that = this;
                if (that._scrollableFrozenContent) {
                    var contentScrollTop = that._scrollableMaster.scrollTop, fcScrollTop = that._scrollableFrozenContent.scrollTop;
                    if (contentScrollTop !== fcScrollTop) {
                        that._scrollableFrozenContent.scrollTop = contentScrollTop;
                    }
                }
            };
            BasicGrid.prototype._vsmcroll = function () {
                var that = this;
                var contentScrollTop = that._scrollableMaster.scrollTop, fcScrollTop = that._scrollableFrozenContent.scrollTop;
                if (contentScrollTop !== fcScrollTop) {
                    that._scrollableMaster.scrollTop = fcScrollTop;
                }
            };
            BasicGrid.prototype._hscroll = function () {
                var that = this, contentScrollLeft = that._scrollableMaster.scrollLeft, headerScrollLeft = that._scrollableHeaderOfMaster.scrollLeft;
                if (contentScrollLeft !== headerScrollLeft)
                    that._scrollableHeaderOfMaster.scrollLeft = contentScrollLeft;
                if (that._scrollableFooterOfMaster) {
                    var footerScrollLeft = that._scrollableFooterOfMaster.scrollLeft;
                    if (contentScrollLeft !== footerScrollLeft)
                        that._scrollableFooterOfMaster.scrollLeft = contentScrollLeft;
                }
            };
            BasicGrid.prototype._moveDownSelectedCell = function (count) {
                var that = this;
                if (!that.selectedCell)
                    return that._selectFirstCell();
                var pos = that._cell(that.selectedCell, true);
                if (!pos) {
                    that.selectedCell = null;
                    return that._selectFirstCell();
                }
                var col = that._colByField(that.selectedCell.col);
                var pr = that._findtBody(col);
                var nri = Math.min(pos.rIndex + count, pr.childNodes.length - 1);
                if (nri != pos.rIndex) {
                    var tr = pr.childNodes[nri];
                    return that._selectCell({ row: that._id2rowId(tr.id), col: that.selectedCell.col }, null, false);
                }
                return false;
            };
            BasicGrid.prototype._moveRightSelectedCell = function () {
                var that = this;
                if (!that.fieldOptions.selecting || !that.fieldOptions.selecting.cell)
                    return false;
                if (!that.selectedCell)
                    return that._selectFirstCell();
                var allCols = that.frozenColumns.concat(that.columns).map(function (col) { return col.$bind; });
                ;
                var si = allCols.indexOf(that.selectedCell.col);
                var item = that._findById(that.selectedCell.row);
                if (!item || si < 0)
                    return false;
                for (var i = si + 1, len = allCols.length; i < len; i++) {
                    var c = allCols[i];
                    var cell = { col: c, row: item.$id };
                    if (that.canSelect(cell)) {
                        return that._selectCell(cell, null, false);
                    }
                }
                item = that._findNext(item.$id);
                if (item) {
                    for (var i = 0, len = si; i <= len; i++) {
                        var c = allCols[i];
                        var cell = { col: c, row: item.$id };
                        if (that.canSelect(cell)) {
                            return that._selectCell(cell, null, false);
                        }
                    }
                }
                return false;
            };
            BasicGrid.prototype._moveLeftSelectedCell = function () {
                var that = this;
                if (!that.fieldOptions.selecting || !that.fieldOptions.selecting.cell)
                    return false;
                if (!that.selectedCell)
                    return that._selectFirstCell();
                var allCols = that.frozenColumns.concat(that.columns).map(function (col) { return col.$bind; });
                ;
                var si = allCols.indexOf(that.selectedCell.col);
                var item = that._findById(that.selectedCell.row);
                if (!item || si < 0)
                    return false;
                for (var i = si - 1; i >= 0; i--) {
                    var c = allCols[i];
                    var cell = { col: c, row: item.$id };
                    if (that.canSelect(cell)) {
                        return that._selectCell(cell, null, false);
                    }
                }
                item = that._findPrev(item.$id);
                if (item) {
                    for (var i = allCols.length - 1; i >= si; i--) {
                        var c = allCols[i];
                        var cell = { col: c, row: item.$id };
                        if (that.canSelect(cell)) {
                            return that._selectCell(cell, null, false);
                        }
                    }
                }
                return false;
            };
            BasicGrid.prototype._state2UI = function () {
                var that = this;
                var grid = that._rootElement();
                var element = that.$element ? that.$element.get(0) : null;
                if (grid) {
                    that._setDisabled(grid, element);
                    that.setHidden(element);
                    that._setErrors(grid, element);
                    that._selectFirstCell();
                    if (that._toolBar) {
                        var $tt = $(_dom.find(element, that.id + '_header'));
                        that._toolBar.render($tt);
                    }
                    if (that._pager) {
                        var $pp = $(_dom.find(element, that.id + '_pagination'));
                        that._pager.render($pp);
                    }
                }
            };
            BasicGrid.prototype.stateChanged = function (propName, params) {
                var that = this;
                var state = that.form.getState(that.$bind);
                var grid = that._rootElement();
                var element = that.$element ? that.$element.get(0) : null;
                if (!propName || (propName === 'isHidden')) {
                    if (state.isHidden !== that.state.isHidden) {
                        that.state.isHidden = state.isHidden;
                        if (grid)
                            that.setHidden(element);
                    }
                }
                if (!propName || (propName === 'isDisabled')) {
                    if (state.isDisabled != that.state.isDisabled) {
                        that.state.isDisabled = state.isDisabled;
                        if (grid)
                            that._setDisabled(grid, element);
                    }
                }
                if (!propName || (propName === 'errors')) {
                    if (_eu.errorChanged(that.state.errors, state.errors)) {
                        that.state.errors = state.errors;
                        that._setErrors(grid, element);
                    }
                }
            };
            BasicGrid.prototype.stopProppagation = function (event) {
                var that = this;
                var target = event.target;
                var e = that.$element.get(0);
                while (target) {
                    if (target == e)
                        return;
                    if (target.href) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    target = target.parentNode;
                }
            };
            BasicGrid.prototype._buildView = function (item, index, level, _view, _viewMap) {
                var that = this;
                var ii = { level: level, value: item };
                _view = _view || that._view;
                _viewMap = _viewMap || that._viewMap;
                _view.push(ii);
                _viewMap[item.$id] = ii;
            };
            BasicGrid.prototype._findById = function (id) {
                var that = this;
                if (that._useView) {
                    var item = that._viewMap[id];
                    return item ? item.value : null;
                }
                return that.state.value.findById(id);
            };
            BasicGrid.prototype._findByIdEx = function (id) {
                var that = this;
                var res = { index: -1, level: 0, value: null };
                if (that._useView) {
                    var ii = that._viewMap[id];
                    if (ii) {
                        res.index = that._view.indexOf(ii);
                        res.level = ii.level;
                        res.value = ii.value;
                    }
                }
                else {
                    res.value = that.state.value.findById(id);
                    if (res.value) {
                        res.index = that.state.value.indexOf(res.value);
                    }
                }
                return res;
            };
            BasicGrid.prototype._findNext = function (id) {
                var that = this;
                if (that._useView) {
                    var ii = that._viewMap[id];
                    if (ii) {
                        var index = that._view.indexOf(ii);
                        if (that._view.length > index + 1)
                            return that._view[index + 1].value;
                    }
                }
                else {
                    var ii = that.state.value.findById(id);
                    if (ii) {
                        var index = that.state.value.indexOf(ii);
                        if (that.state.value.length() > index + 1)
                            return that.state.value.get(index + 1);
                    }
                }
                return null;
            };
            BasicGrid.prototype._findPrev = function (id) {
                var that = this;
                if (that._useView) {
                    var ii = that._viewMap[id];
                    if (ii) {
                        var index = that._view.indexOf(ii);
                        if (index > 0)
                            return that._view[index - 1].value;
                    }
                }
                else {
                    var ii = that.state.value.findById(id);
                    if (ii) {
                        var index = that.state.value.indexOf(ii);
                        if (index > 0)
                            return that.state.value.get(index - 1);
                    }
                }
                return null;
            };
            BasicGrid.prototype._renderTotalRows = function () {
                var that = this;
                if (that.$element) {
                    var opts = that.renderOptions;
                    if (that._totalProperty) {
                        var totals = that.form.getValue(that._totalProperty);
                        var pr = void 0, rows = void 0;
                        if (_gu.hasFrozenColumns(that.renderOptions, that.frozenColumns)) {
                            pr = _dom.find(that.$element.get(0), that.id + '_frozen_totals');
                            if (pr) {
                                rows = _gu.createRows(that.id, totals, that.frozenColumns, opts, that.options.design, that.form.$locale, true, true, null);
                                _dom.empty(pr);
                                _dom.append(pr, rows);
                            }
                        }
                        pr = _dom.find(that.$element.get(0), that.id + '_totals');
                        rows = _gu.createRows(that.id, totals, that.columns, opts, that.options.design, that.form.$locale, false, true, null);
                        _dom.empty(pr);
                        _dom.append(pr, rows);
                    }
                }
            };
            BasicGrid.prototype._renderRows = function (allRows, afterRow, values) {
                var that = this;
                if (that.$element) {
                    var opts = that.renderOptions;
                    var cb = null;
                    if (allRows) {
                        that._view = [];
                        that._viewMap = {};
                        that._useView = true;
                        cb = that._buildView.bind(that);
                    }
                    var pr = void 0, rows = void 0;
                    that._inplaceEditRemove(false, false);
                    that._destroyDetails();
                    if (_gu.hasFrozenColumns(that.renderOptions, that.frozenColumns)) {
                        pr = _dom.find(that.$element.get(0), that.id + '_frozen_rows');
                        if (pr) {
                            if (allRows) {
                                rows = _gu.createRows(that.id, that.state.value, that.frozenColumns, opts, that.options.design, that.form.$locale, true, false, cb);
                                cb = null;
                                _dom.empty(pr);
                                _dom.append(pr, rows);
                            }
                            else {
                                rows = _gu.createBulkRows(that.id, values, that.frozenColumns, opts, that.options.design, that.form.$locale, true, false, cb);
                                var pp = _dom.find(pr, afterRow + '_frozen');
                                _dom.after(pp, rows);
                            }
                        }
                    }
                    pr = _dom.find(that.$element.get(0), that.id + '_rows');
                    if (allRows) {
                        rows = _gu.createRows(that.id, that.state.value, that.columns, opts, that.options.design, that.form.$locale, false, false, cb);
                        _dom.empty(pr);
                        _dom.append(pr, rows);
                    }
                    else {
                        rows = _gu.createBulkRows(that.id, values, that.columns, opts, that.options.design, that.form.$locale, false, false, cb);
                        var pp = _dom.find(pr, afterRow);
                        _dom.after(pp, rows);
                    }
                }
                if (!allRows) {
                    var where = that._viewMap[afterRow];
                    var index = that._view.indexOf(where);
                    that._view.splice(index, 0, values);
                    values.forEach(function (ii) { that._viewMap[ii.value.$id] = ii; });
                }
            };
            BasicGrid.prototype.editDetail = function (item) {
                //not compatible with rozenColumns
                var that = this, id = item.$id;
                if (that.$element) {
                    var options = that.renderOptions;
                    var hfc = _gu.hasFrozenColumns(options, that.frozenColumns);
                    if (hfc)
                        return;
                    var pr = _dom.find(that.$element.get(0), that.id + '_rows');
                    var tdetail = _dom.find(pr, id + '_detail');
                    if (tdetail)
                        return;
                    var p = _dom.find(pr, id);
                    if (p) {
                        tdetail = _gu.createDetail(id, p);
                        // prepare layout
                        var rowsOpts = that.renderOptions.rows;
                        if (!rowsOpts || !rowsOpts.detail || !rowsOpts.detail.layout) {
                            throw new Error('Grid options missing: "options.rows.detail.layout".');
                        }
                        var layout = rowsOpts.detail.layout;
                        if (typeof layout === 'string' && that.renderOptions.layouts && that.renderOptions.layouts[layout])
                            layout = that.renderOptions.layouts[layout];
                        if (typeof layout === "object") {
                            layout = $.extend(true, {}, layout);
                            if (layout.name)
                                layout._name = layout.name;
                            layout.name = id;
                        }
                        // prepare schema
                        var ss = item.getSchema();
                        if (typeof ss === "object") {
                            ss.links = ss.links || {};
                            ss.links.$updateChanges = ss.links.$updateChanges || { title: _locale.ui.ApplyDetailChanges };
                        }
                        var fo = {};
                        if (rowsOpts.detail.spacing)
                            fo.verticalSpacing = true;
                        fo.closeButtonHandler = function () {
                            that.closeDetail(id);
                        };
                        if (layout._name) {
                            fo.externalLayout = layout._name;
                            fo.externalSchema = that.form.options.externalSchema;
                            fo.externalLocale = that.form.options.externalLocale;
                        }
                        fo.path = that.$bind;
                        that._details.push(id);
                        _ui.OpenForm($(tdetail.firstChild), layout, that.form.$schema, item.model(), that.form.$locale, function (action, model, form) {
                            switch (action.property) {
                                case "$links.$updateChanges":
                                    if (!that.state.value.updateItem(item, model))
                                        return;
                                    item.update(model.model());
                                    that.closeDetail(id);
                            }
                        }, fo);
                        _dom.after(p, tdetail);
                    }
                }
            };
            BasicGrid.prototype.closeDetail = function (id) {
                //not compatible with rozenColumns
                var that = this;
                that._destroyDetailById(id);
                if (that.$element) {
                    var tdetail = _dom.find(that.$element.get(0), id + '_detail');
                    if (tdetail)
                        _dom.remove(tdetail);
                }
            };
            BasicGrid.prototype._removeRow = function (id) {
                var that = this;
                that._destroyDetailById(id);
                if (that._viewMap) {
                    var ii = that._viewMap[id];
                    if (ii) {
                        delete that._viewMap[id];
                        var i = that._view.indexOf(ii);
                        if (i >= 0)
                            that._view.splice(i, 1);
                    }
                }
                if (that.$element) {
                    var toRemoveList = [];
                    var toRemove = _dom.find(that.$element.get(0), id);
                    if (toRemove)
                        toRemoveList.push({ element: toRemove, columns: that.columns });
                    if (_gu.hasFrozenColumns(that.renderOptions, that.frozenColumns)) {
                        toRemove = _dom.find(that.$element.get(0), id + '_frozen');
                        if (toRemove)
                            toRemoveList.push({ element: toRemove, columns: that.frozenColumns });
                    }
                    toRemoveList.forEach(function (re) {
                        var pr = re.element.parentNode;
                        // remove detail
                        var tdetail = _dom.find(pr, id + '_detail');
                        if (tdetail)
                            _dom.remove(tdetail);
                        if (pr.firstChild === re.element && that.renderOptions.headerIsHidden && !that.renderOptions._useColGrp && pr.childNodes.length > 1) {
                            //no header &&  not useColGrp ==> update cols width on first row
                            var tr = pr.childNodes[1];
                            re.columns.forEach(function (col, index) {
                                var td = tr.childNodes[index];
                                if (col.options.width)
                                    td.style.width = _gu.ensureWidth(col.options.width);
                                if (col.options.minWidth)
                                    td.style.minWidth = _gu.ensureWidth(col.options.minWidth);
                            });
                        }
                        _dom.remove(re.element);
                    });
                }
            };
            BasicGrid.prototype._updOddEven = function () {
                var that = this;
                if (!that.renderOptions._useStripedCss) {
                    if (that.$element) {
                        var pr = _dom.find(that.$element.get(0), that.id + '_rows');
                        _gu.updateEvenOdd(pr);
                        pr = _dom.find(that.$element.get(0), that.id + '_frozen_rows');
                        if (pr)
                            _gu.updateEvenOdd(pr);
                    }
                }
            };
            BasicGrid.prototype._createRow = function (item) {
                var that = this;
                if (that.$element) {
                    var index = 0;
                    var ii = that._viewMap[item.$id];
                    if (!ii) {
                        //TODO find level when expandingProperty is not null
                        ii = { level: 0, value: item };
                        that._view.push(ii);
                        that._view.push(item.$id);
                        index = that._view.length - 1;
                        that._viewMap[item.$id] = ii;
                    }
                    else {
                        ii = that._viewMap[item.$id];
                    }
                    var pr = void 0, nr = void 0, hasFc = _gu.hasFrozenColumns(that.renderOptions, that.frozenColumns);
                    if (hasFc) {
                        pr = _dom.find(that.$element.get(0), that.id + '_frozen_rows');
                        nr = _gu.createRow(that.id, index, ii.level, ii.value, that.frozenColumns, that.renderOptions, that.options.design, that.form.$locale, pr.childNodes.length % 2 === 1, true, false);
                        _dom.append(pr, nr);
                    }
                    pr = _dom.find(that.$element.get(0), that.id + '_rows');
                    nr = _gu.createRow(that.id, index, ii.level, ii.value, that.columns, that.renderOptions, that.options.design, that.form.$locale, pr.childNodes.length % 2 === 1, false, false);
                    _dom.append(pr, nr);
                }
            };
            BasicGrid.prototype.filtrableColumns = function () {
                var that = this;
                var schema = that.$schema;
                var schemaItems = that.$schemaItems;
                if (schema && schema.type === "array" && schemaItems && schemaItems.type === "object") {
                    return _sutils.filtrableFields(schemaItems, that.form.$rootSchema, that.form.$locale);
                }
                return [];
            };
            BasicGrid.prototype._getColumnsFromSchema = function () {
                var that = this;
                var schema = that.$schema;
                var schemaItems = that.$schemaItems;
                if (schema && schema.type === "array" && schemaItems && schemaItems.type === "object") {
                    return _sutils.columns(schemaItems, that.form.$rootSchema, that.form.$locale);
                }
                return [];
            };
            BasicGrid.prototype._getSelectedColumns = function () {
                var that = this, res = {};
                Object.keys(that._mapCols).forEach(function (key) {
                    var c = that._mapCols[key].column;
                    if (c.options._expandItem && c.options.display)
                        key = c.options.display;
                    res[key] = true;
                });
                return res;
            };
            BasicGrid.prototype._getGroupsFromSchema = function () {
                var that = this;
                var schema = that.$schema;
                var schemaItems = that.$schemaItems;
                if (schema && schema.type === "array" && schemaItems && schemaItems.type === "object" && schemaItems.groups) {
                    return schemaItems.groups;
                }
                return {};
            };
            BasicGrid.prototype.getColumnsForSettings = function () {
                var that = this;
                return {
                    schemaGroups: that._getGroupsFromSchema(),
                    schemaColumns: that._getColumnsFromSchema(),
                    selectedColumns: that._getSelectedColumns(),
                    locale: that.form.$locale
                };
            };
            BasicGrid.prototype.getColumnsForFilter = function () {
                var that = this;
                return {
                    schemaGroups: that._getGroupsFromSchema(),
                    schemaColumns: that.filtrableColumns(),
                    locale: that.form.$locale
                };
            };
            BasicGrid.prototype.getColumnsForFilterExpress = function (fields) {
                var that = this;
                var columns;
                if (fields && Array.isArray(fields)) {
                    var allColumns_1 = that._getColumnsFromSchema();
                    columns = [];
                    fields.forEach(function (field) {
                        allColumns_1.every(function (col) {
                            if (field === col.name) {
                                columns.push(col);
                                return false;
                            }
                            return true;
                        });
                    });
                }
                else
                    columns = that._getColumnsFromSchema();
                var formatCols = [];
                columns.forEach(function (col) {
                    var sc = col.schema;
                    var elt = { code: col.name, lib: sc.title || sc.name, type: sc.type };
                    if (sc.enum)
                        elt.enum = sc.enum;
                    if (sc.enumNames)
                        elt.enumNames = sc.enumNames;
                    formatCols.push(elt);
                });
                return formatCols;
            };
            BasicGrid.prototype._updateSorting = function () {
                var that = this;
                var opts = that.renderOptions;
                if (opts && opts.sorting && !opts.headerIsHidden) {
                    var pc = _dom.find(that.$element.get(0), that.id + '_cols');
                    if (pc)
                        _gu.updSorting(opts, pc, that._colByField, that.state.value.$orderby());
                    pc = _dom.find(that.$element.get(0), that.id + '_frozen_cols');
                    if (pc)
                        _gu.updSorting(opts, pc, that._colByField, that.state.value.$orderby());
                }
            };
            BasicGrid.prototype._renderColumns = function (opts) {
                var that = this;
                that._inplaceEditRemove(false, false);
                if (opts._useColGrp) {
                    // create free columns
                    var vscroll = opts.scrolling && opts.scrolling.vertical;
                    var cg = vscroll && !opts.headerIsHidden ? _dom.find(that.$element.get(0), that.id + '_colgrp_header') : null;
                    if (cg) {
                        _dom.empty(cg);
                        _dom.append(cg, _gu.createColGroup(that.columns, opts, false));
                    }
                    cg = _dom.find(that.$element.get(0), that.id + '_colgrp');
                    _dom.empty(cg);
                    _dom.append(cg, _gu.createColGroup(that.columns, opts, false));
                    // add total
                    if (opts.total && opts.total.property) {
                        cg = _dom.find(that.$element.get(0), that.id + '_colgrp_footer');
                        if (cg) {
                            _dom.empty(cg);
                            _dom.append(cg, _gu.createColGroup(that.columns, opts, true));
                        }
                    }
                    // create frozen columns
                    if (_gu.hasFrozenColumns(opts, that.frozenColumns)) {
                        var cg_1 = vscroll && !opts.headerIsHidden ? _dom.find(that.$element.get(0), that.id + '_colgrp_frozen_header') : null;
                        if (cg_1) {
                            _dom.empty(cg_1);
                            _dom.append(cg_1, _gu.createColGroup(that.frozenColumns, opts, true));
                        }
                        cg_1 = _dom.find(that.$element.get(0), that.id + '_colgrp_frozen');
                        if (cg_1) {
                            _dom.empty(cg_1);
                            _dom.append(cg_1, _gu.createColGroup(that.frozenColumns, opts, true));
                        }
                        // add total
                        if (opts.total && opts.total.property) {
                            cg_1 = _dom.find(that.$element.get(0), that.id + '_colgrp_frozen_footer');
                            if (cg_1) {
                                _dom.empty(cg_1);
                                _dom.append(cg_1, _gu.createColGroup(that.frozenColumns, opts, true));
                            }
                        }
                    }
                }
                if (!opts.headerIsHidden) {
                    var pc = _dom.find(that.$element.get(0), that.id + '_cols');
                    _dom.empty(pc);
                    _dom.append(pc, _gu.createCols(that.id, that.columns, opts, that.options.design, that.form.$locale, that.state.value.$orderby(), false));
                    if (_gu.hasFrozenColumns(opts, that.frozenColumns)) {
                        pc = _dom.find(that.$element.get(0), that.id + '_frozen_cols');
                        if (pc) {
                            _dom.empty(pc);
                            _dom.append(pc, _gu.createCols(that.id, that.frozenColumns, opts, that.options.design, that.form.$locale, that.state.value.$orderby(), true));
                        }
                    }
                }
                if (opts.allowFrozenColumns) {
                    _gu.updateFrozenWidth(that.$element.get(0), that.id, that.frozenColumns);
                }
            };
            BasicGrid.prototype.toggleMultiselect = function () {
                var that = this;
                if (!that.$element)
                    return;
                var opts = that.renderOptions;
                if (opts.selecting && opts.selecting.row) {
                    opts.selecting.multiselect = !!!opts.selecting.multiselect;
                    that.state.value.updateSelecting(opts.selecting.multiselect, opts.expandingProperty);
                    that.savePreferences(function () {
                        that._refreshGrid();
                    });
                }
            };
            BasicGrid.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    if (that.$schema.description)
                        opts.description = _ulocale.tt(that.$schema.description, that.form.$locale);
                    that.$element = $(_gu.gridContainer(that.id, opts, that.options.design, that.$schema.title, that.form.$locale, that.columns, that.frozenColumns));
                    that._renderColumns(opts);
                    that._renderRows(true, '', null);
                    that._renderTotalRows();
                    that._state2UI();
                    that.setEvents(opts);
                }
                that.appendElement($parent, opts);
                return that.$element;
            };
            return BasicGrid;
        }(ui.AbsField));
        ui.BasicGrid = BasicGrid;
        _ui.registerControl(BasicGrid, 'array', false, '', null);
        _ui.registerControl(BasicGrid, 'array', false, 'basicgrid', null);
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="./absfield.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _dom = Phoenix.dom, _ulocale = Phoenix.ulocale;
        function _createCheckBox(id, options, authoring, title) {
            var _bootstrap4 = Phoenix.bootstrap4;
            title = title || '';
            options = $.extend({ titleIsHidden: false, placeHolder: false, columns: false }, options);
            var html = [];
            _ui.Utils.fieldWrapper(html, options, authoring, function () {
                if (options.columns) {
                    html.push('<div class="no-x-padding col-sm-offset-' + options.labelCol + ' col-sm-' + (12 - options.labelCol) + '">');
                    html.push('<div class="checkbox">');
                }
                var block = false;
                if (!options.inline && !options.columns) {
                    block = true;
                    html.push('<div class="checkbox">');
                }
                html.push('<label id="{0}_check" class="' + (options.inline ? 'checkbox-inline' : (block ? (_bootstrap4 ? 'form-control-label' : 'control-label') : 'checkbox')) + '">');
                html.push('<input type="checkbox" id="{0}_input">');
                if (!options.inline)
                    html.push('&nbsp;');
                html.push(_utils.escapeHtml(title || ''));
                html.push('</label>');
                if (!options.inline && !options.columns) {
                    html.push('</div>');
                }
                if (options.columns) {
                    html.push('</div>');
                    html.push('</div>');
                }
            });
            return _utils.format(html.join(''), id);
        }
        ;
        var Check = (function (_super) {
            __extends(Check, _super);
            function Check(fp, options, form) {
                _super.call(this, fp, options, form);
                this._state();
            }
            Check.prototype._input = function () {
                var that = this, e = that.$element.get(0);
                return _dom.find(e, that.id + '_input');
            };
            Check.prototype._check = function () {
                var that = this, e = that.$element.get(0);
                return _dom.find(e, that.id + '_check');
            };
            Check.prototype.click = function (event) {
                var that = this, input = that._input(), value = input.checked || false;
                if (event.target != input)
                    return;
                if (that.state.value != value) {
                    that.state.value = value;
                    that.form.setValue(that.$bind, value);
                }
            };
            Check.prototype._setDisabled = function (input, element) {
                var that = this, check = that._check();
                if (that.state.isDisabled || that.state.isReadOnly)
                    _dom.addClass(check, "disabled");
                else
                    _dom.removeClass(check, "disabled");
                input.disabled = that.state.isDisabled;
            };
            Check.prototype._setReadOnly = function (input, element) {
                this._setDisabled(input, element);
            };
            Check.prototype._setMandatory = function (input, element) { };
            Check.prototype._state2UI = function () {
                var that = this, input = that._input(), element = that.$element ? that.$element.get(0) : null;
                if (input) {
                    input.checked = that.state.value || false;
                    that._setDisabled(input, element);
                    that._setReadOnly(input, element);
                    that.setHidden(element);
                }
            };
            Check.prototype.changed = function (propName, ov, nv, op) {
                var that = this, input = that._input();
                if (that.state.value != nv) {
                    that.state.value = nv;
                    input.checked = that.state.value || false;
                }
            };
            Check.prototype.stateChanged = function (propName, params) {
                var that = this, state = that.form.getState(that.$bind), input = that._input(), element = that.$element ? that.$element.get(0) : null;
                if (state.isHidden !== that.state.isHidden) {
                    that.state.isHidden = state.isHidden;
                    if (input)
                        that.setHidden(element);
                }
                if (state.isDisabled != that.state.isDisabled) {
                    that.state.isDisabled = state.isDisabled;
                    if (input)
                        that._setDisabled(input, element);
                }
                if (state.isReadOnly != that.state.isReadOnly) {
                    that.state.isReadOnly = state.isReadOnly;
                    if (input)
                        that._setReadOnly(input, element);
                }
                if (state.isMandatory != that.state.isMandatory) {
                    that.state.isMandatory = state.isMandatory;
                    if (input)
                        that._setMandatory(input, element);
                }
            };
            Check.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    that.$element = $(_createCheckBox(that.id, opts, that.options.design, _ulocale.tt(that.$schema.title, that.form.$locale)));
                    that._state2UI();
                }
                that.appendElement($parent, opts);
                return that.$element;
            };
            return Check;
        }(ui.AbsField));
        ui.Check = Check;
        _ui.registerControl(Check, "boolean", false, '', null);
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="../../../core/modules/locale.ts" />
/// <reference path="./absfield.control.ts" />
/// <reference path="../errors.data.ts" />
/// <reference path="./basicgrid.ts" />
/// <reference path="../modalform.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _dom = Phoenix.dom, _ui = ui, _ulocale = Phoenix.ulocale, _eu = Phoenix.Observable.errorsUtils, _gu = ui.GridUtil, _sutils = Phoenix.Observable.SchemaUtils;
        var ColumnGrid = (function (_super) {
            __extends(ColumnGrid, _super);
            function ColumnGrid(fp, options, form) {
                _super.call(this, fp, options, form);
                var that = this;
                var opts = that.fieldOptions;
                that._initAllColumns();
                form.registerListenerFor(that.$bind + ".$item", that);
                that._state();
                var fields = opts.columns.header.fields || [];
                opts.columns.header.fields = that.form.afterSettings(that.$bind, "columngrid", { columns: fields }).columns;
                var ctrSettings = that.form.getFieldSettings(that.$bind);
                if (ctrSettings) {
                    that._settings = that.form.afterSettings(that.$bind, "columngrid", ctrSettings);
                }
                that._initRows();
            }
            ColumnGrid.prototype.destroy = function () {
                var that = this;
                that.form.unRegisterListenerFor(that.$bind + ".$item", that);
            };
            ColumnGrid.prototype._initSchemaRows = function (rows) {
                var that = this;
                that.rows = [];
                rows.forEach(function (r, index) {
                    that.rows[index] = { name: r.name, canEdit: r.canEdit, check: r.check, schema: _sutils.getSchema(r.name, that.$schemaItems, that.form.$rootSchema, false) || {} };
                });
            };
            ColumnGrid.prototype._colByName = function (rn) {
                var that = this;
                for (var i = 0, len = that.rows.length; i < len; i++) {
                    var r = that.rows[i];
                    if (r.name === rn)
                        return r;
                }
                return null;
            };
            ColumnGrid.prototype.setSettings = function (settings) {
                var that = this;
                that._rrender();
            };
            ColumnGrid.prototype._initRows = function () {
                var that = this;
                if (that.rows)
                    return;
                var opts = that.fieldOptions;
                if (!opts.columns)
                    opts.columns = {};
                if (!opts.columns.header)
                    opts.columns.header = {};
                if (!opts.columns.row)
                    opts.columns.row = {};
                var fields = opts.columns.header.fields || [];
                if (that._settings && that._settings.columns && that._settings.columns.length)
                    fields = that._settings.columns;
                that._initSchemaRows(fields);
            };
            // Create columns
            ColumnGrid.prototype._initCols = function (options) {
                var that = this;
                if (!options.columns)
                    options.columns = {};
                if (!options.columns.header)
                    options.columns.header = {};
                if (!options.columns.row)
                    options.columns.row = {};
                var header = $.extend({}, options.columns.header);
                var row = options.columns.row;
                header.options = header.options || {};
                row.options = row.options || {};
                var headerBind = row.$bind, headerSchema;
                if (!row.$bind) {
                    headerBind = "$index";
                    headerSchema = { type: "integer" };
                }
                else {
                    headerSchema = _sutils.getSchema(row.$bind, that.$schemaItems, that.form.$rootSchema, false);
                }
                var columns = [];
                columns.push(header);
                if (that.state.value) {
                    that.state.value.forEach(function (item) {
                        var title = _ui.Utils.displayValue(item.getRelativeValue(headerBind), headerSchema, that.form.$locale, { html: false }, item, headerBind).value;
                        var r = $.extend({}, row);
                        r.title = title || '';
                        r.id = item.$id;
                        columns.push(r);
                    });
                }
                return columns;
            };
            ColumnGrid.prototype._modifyRow = function (value, schema, rowIndex, colIndex, opts, item, fieldName) {
                var that = this;
                var pr = _dom.find(that.$element.get(0), that.id + '_rows');
                var tr = pr.childNodes[rowIndex];
                var td = tr.childNodes[colIndex];
                var v = _ui.Utils.displayValue(value, schema, that.form.$locale, { html: true, useSymbol: false, editable: opts.editable, check: opts.check, tableOptions: that.config.options }, item, fieldName);
                _dom.empty(td);
                if (v.html) {
                    var $c = $(v.value);
                    _dom.append(td, $c.get(0));
                }
                else
                    _dom.append(td, document.createTextNode(v.value));
            };
            ColumnGrid.prototype.changed = function (propName, ov, nv, op, params) {
                var that = this;
                if (op === 'upd') {
                    var item_1 = params && params.$id ? that.state.value.findById(params.$id) : null;
                    if (item_1) {
                        that.rows.forEach(function (row, index) {
                            if (row.name === params.property) {
                                that._modifyRow(item_1.getValue(row.name), row.schema, index, that.state.value.indexOf(item_1) + 1, { editable: row.canEdit, check: row.check }, item_1, row.name);
                            }
                        });
                    }
                }
            };
            ColumnGrid.prototype._grid = function () {
                return this.$element.get(0);
            };
            ColumnGrid.prototype._setErrors = function (grid, element) {
                var that = this;
                var errors = that.state.errors;
                that.showErrors(element, errors);
            };
            ColumnGrid.prototype.click = function (event) {
                var that = this;
                var td = _dom.parentByTag(that.$element.get(0), event.target, 'td');
                if (td) {
                    var cn = _dom.attr(td, "colId");
                    if (cn) {
                        var col = that._colByName(cn);
                        if (col && col.canEdit && _sutils.isBoolean(col.schema)) {
                            if (_dom.attr(event.target, 'data-clickable')) {
                                var rid = _dom.attr(td, "rowId");
                                var item = rid ? that.state.value.findById(rid) : null;
                                if (item) {
                                    var ov = item.getValue(col.name);
                                    item.setValue(col.name, !ov);
                                }
                            }
                        }
                    }
                }
            };
            ColumnGrid.prototype._setDisabled = function (button, element) { };
            ColumnGrid.prototype._state2UI = function () {
                var that = this;
                var grid = that._grid();
                var element = that.$element ? that.$element.get(0) : null;
                if (grid) {
                    that._setDisabled(grid, element);
                    that.setHidden(element);
                    that._setErrors(grid, element);
                }
            };
            ColumnGrid.prototype.stateChanged = function (propName, params) {
                var that = this;
                var state = that.form.getState(that.$bind);
                var grid = that._grid();
                var element = that.$element ? that.$element.get(0) : null;
                if (!propName || (propName === 'isHidden')) {
                    if (state.isHidden !== that.state.isHidden) {
                        that.state.isHidden = state.isHidden;
                        if (grid)
                            that.setHidden(element);
                    }
                }
                if (!propName || (propName === 'isDisabled')) {
                    if (state.isDisabled != that.state.isDisabled) {
                        that.state.isDisabled = state.isDisabled;
                        if (grid)
                            that._setDisabled(grid, element);
                    }
                }
                if (!propName || (propName === 'errors')) {
                    if (_eu.errorChanged(that.state.errors, state.errors)) {
                        that.state.errors = state.errors;
                        that._setErrors(grid, element);
                    }
                }
            };
            ColumnGrid.prototype._renderRows = function () {
                var that = this;
                if (that.$element) {
                    var pr = _dom.find(that.$element.get(0), that.id + '_rows');
                    _dom.empty(pr);
                    _dom.append(pr, _gu.createGridRows(that.id, that.rows, that.state.value, that.columns, that.renderOptions, that.options.design, that.form.$locale));
                }
            };
            ColumnGrid.prototype._draw = function (opts) {
                var that = this;
                that.columns = that._initCols(that.fieldOptions);
                if (opts._useColGrp) {
                    var colgrp = _dom.find(that.$element.get(0), that.id + '_colgrp');
                    _dom.empty(colgrp);
                    _dom.append(colgrp, _gu.createColGroup(that.columns, opts, false));
                }
                if (!opts.headerIsHidden) {
                    var pc = _dom.find(that.$element.get(0), that.id + '_cols');
                    _dom.empty(pc);
                    _dom.append(pc, _gu.createCols(that.id, that.columns, opts, that.options.design, that.form.$locale, '', false));
                }
                that._renderRows();
                that._state2UI();
            };
            ColumnGrid.prototype._rrender = function () {
                var that = this;
                if (that.$element) {
                    that._draw(that.renderOptions);
                }
            };
            ColumnGrid.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    that.columns = that._initCols(that.fieldOptions);
                    that.$element = $(_gu.gridContainer(that.id, opts, that.options.design, that.$schema.title, that.form.$locale, that.columns, null));
                    that._draw(opts);
                    that.appendElement($parent, opts);
                    return that.$element;
                }
            };
            ColumnGrid.prototype._createRow = function (index) {
                var that = this;
                if (that.$element) {
                    var pr = _dom.find(that.$element.get(0), that.id + '_rows');
                    var nr = _gu.createRow(that.id, index, 0, that.state.value.get(index), that.columns, that.renderOptions, that.options.design, that.form.$locale, index % 2 === 1, false, false);
                    if (pr.childNodes.length >= index)
                        _dom.append(pr, nr);
                    else
                        _dom.before(pr.childNodes[index], nr);
                }
            };
            ColumnGrid.prototype._initAllColumns = function () {
                var that = this;
                var opts = that.fieldOptions;
                that._allColumns = [];
                that._allColumnsNames = [];
                if (!opts.columns)
                    opts.columns = {};
                if (!opts.columns.header)
                    opts.columns.header = {};
                var selectedColumns = [];
                var allColumns = opts.columns.header.allFields;
                allColumns.forEach(function (col) {
                    that._allColumns.push($.extend({}, col));
                    that._allColumnsNames.push(col.name);
                });
            };
            ColumnGrid.prototype._selectedColumns = function () {
                var that = this;
                var selectedColumns = [];
                var res = [];
                that.rows.forEach(function (col) {
                    selectedColumns.push(col.name);
                });
                that._allColumns.forEach(function (col) {
                    var schema = _sutils.getSchema(col.name, that.$schemaItems, that.form.$rootSchema, false);
                    if (selectedColumns.indexOf(col.name) >= 0) {
                        res.push({ name: col.name, title: schema.title });
                    }
                });
                return res;
            };
            ColumnGrid.prototype._initDataSettings = function () {
                var that = this;
                var layout = {
                    $type: "block",
                    $items: [
                        { $type: "block", $items: [] },
                        {
                            $type: "block",
                            $items: [
                                {
                                    $bind: "columns",
                                    $widget: "basicgrid",
                                    options: {
                                        border: true,
                                        align: "middle",
                                        small: true,
                                        noRowSelectedIndicator: true,
                                        headerIsHidden: true,
                                        selecting: {
                                            row: true,
                                            multiselect: true
                                        },
                                        columns: [
                                            { $bind: "caption", options: { "width": "100%" } }
                                        ]
                                    }
                                }
                            ]
                        },
                        { $type: "block", $items: [] }
                    ]
                };
                var schema = {
                    properties: {
                        columns: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    name: { type: "string" },
                                    caption: { type: "string" }
                                }
                            }
                        }
                    }
                };
                var data = { "columns": [] };
                var selectedColumns = [];
                that.rows.forEach(function (col) {
                    selectedColumns.push(col.name);
                });
                that._allColumns.forEach(function (col) {
                    var schema = _sutils.getSchema(col.name, that.$schemaItems, that.form.$rootSchema, false);
                    data.columns.push({ name: col.name, caption: schema.title, $select: selectedColumns.indexOf(col.name) >= 0 });
                });
                return { schema: schema, data: data, layout: layout };
            };
            ColumnGrid.prototype.sendMessage = function (message, params) {
                var that = this;
                switch (message) {
                    case "column-list":
                        that.openColumns(params);
                        break;
                    case "selected-cols":
                        return that._selectedColumns();
                }
            };
            ColumnGrid.prototype.stopProppagation = function (event) {
                var that = this;
                event.preventDefault();
                event.stopPropagation();
            };
            ColumnGrid.prototype.openColumns = function (params) {
                var that = this;
                var opts = that._initDataSettings();
                var fo = { "title": params.title || "Columns ...", "buttons": [{ "type": "success", "title": params.okTitle || "OK", "name": "ok" }] };
                _ui.OpenModalForm(fo, opts.layout, opts.schema, opts.data, {}, function (form, action, model, formControl) {
                    if (action.operation === "modal-action") {
                        switch (action.property) {
                            case "ok":
                                var cd_1 = { columns: [] };
                                model.columns.forEach(function (col) {
                                    if (col.$select) {
                                        var ii = that._allColumnsNames.indexOf(col.name);
                                        if (ii >= 0) {
                                            cd_1.columns.push($.extend({}, that._allColumns[ii]));
                                        }
                                    }
                                });
                                that._settings = cd_1;
                                that.form.setFieldSettings(that.$bind, that._settings);
                                that.form.savePrefs(function () {
                                    that._settings = that.form.afterSettings(that.$bind, "columngrid", cd_1);
                                    that.rows = null;
                                    that._initRows();
                                    form.close();
                                    that._rrender();
                                });
                                break;
                        }
                    }
                });
            };
            return ColumnGrid;
        }(ui.AbsField));
        ui.ColumnGrid = ColumnGrid;
        ;
        _ui.registerControl(ColumnGrid, "array", false, "columngrid", null);
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="../../../core/modules/locale.ts" />
/// <reference path="../../page.control.ts" />
/// <reference path="../schema.data.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _sutils = Phoenix.Observable.SchemaUtils, _utils = Phoenix.utils, _dom = Phoenix.dom, _locale = Phoenix.locale, _ulocale = Phoenix.ulocale, _ui = ui, _device = Phoenix.device;
        var DropItems = (function () {
            function DropItems($parent, $input, options) {
                this.opened = false;
                var that = this;
                that.page = _ui.Page();
                that.opened = false;
                that.currentList = null;
                that.$parent = $parent;
                that._checkOptions(options);
                that.options = options;
                that.$input = $input;
                that.keys = _sutils.pkFields(that.options.primaryKey);
            }
            DropItems.prototype.click = function (event) {
                var that = this;
                var li = _dom.parentByTag(that.$element.get(0), event.target, 'li');
                if (li) {
                    var pk = li['pk'];
                    if (pk) {
                        var map = that._map();
                        var sel = that._selectByPk(pk, map);
                        if (sel)
                            that._doSelect(sel, true);
                    }
                }
            };
            DropItems.prototype.inMenu = function (target) {
                var that = this;
                if (target && that.$element) {
                    return _dom.isChildOf(that.$element.get(0), target);
                }
                return false;
            };
            DropItems._itemHeight = function () {
                var that = this;
                if (!that.itemHeight) {
                    var p = $('<ul class="dropdown-menu bs-block" tabindex="0" style="visibility:hidden;"><li tabindex="-1"><a tabindex="-1" href="#">A</a></li></ul>').get(0);
                    document.body.appendChild(p);
                    var li = p.firstChild;
                    ;
                    that.itemHeight = li.offsetHeight;
                    that.deltaHeight = p.offsetHeight - that.itemHeight;
                    document.body.removeChild(p);
                }
                return this.itemHeight;
            };
            DropItems.prototype._checkOptions = function (options) {
                var that = this;
                if (!options.primaryKey)
                    throw new Error('Invalid options no primaryKey.');
                if (!options.search)
                    throw new Error('Invalid options search field.');
                options.display = options.display || options.search;
                options.maxItems = options.maxItems || 8;
            };
            DropItems.prototype._renderContent = function () {
                var that = this;
                if (!that.$element) {
                    that.$element = $('<ul class="dropdown-menu"></ul>');
                    that.$parent.get(0).appendChild(that.$element.get(0));
                }
            };
            DropItems.prototype._renderElements = function () {
                var that = this;
                if (!that.$element)
                    that._renderContent();
                if (that.currentList) {
                    var frag_1 = document.createDocumentFragment();
                    var e = that.$element.get(0);
                    that.currentList.forEach(function (item) {
                        var dId = _sutils.pk2Id(_sutils.extractPkValue(item, that.keys), that.keys);
                        var li = $('<li tabindex="-1"><a tabindex="-1" href="#">' + _utils.escapeHtml(item[that.options.display]) + '</a></li>').get(0);
                        li['pk'] = dId;
                        _dom.append(frag_1, li);
                    });
                    _dom.empty(e);
                    _dom.append(e, frag_1);
                }
            };
            DropItems.prototype._afterHide = function (doFocus) {
                var that = this;
                that.opened = false;
                if (that.page)
                    that.page.setPopup(null);
                if (that.$input)
                    that.$input.get(0).focus();
            };
            DropItems.prototype.hide = function (target) {
                var that = this;
                if (!that.opened)
                    return;
                if (that.$element) {
                    var e = that.$element.get(0);
                    _dom.removeClass(e, 'bs-block');
                    that.opened = false;
                    if (that.page)
                        that.page.setPopup(null);
                }
            };
            DropItems.prototype._selectByListIndex = function (map, li) {
                for (var i = 0, len = map.length; i < len; i++) {
                    var m = map[i];
                    if (m.listIndex === li)
                        return m;
                }
                return null;
            };
            DropItems.prototype._emptyHtmlList = function () {
                var that = this;
                if (that.$element) {
                    _dom.empty(that.$element.get(0));
                }
            };
            DropItems.prototype._show = function (selectedIndex) {
                var that = this;
                if (that.$element) {
                    var e = that.$element.get(0);
                    if (e.childNodes.length) {
                        var cs = -1;
                        var map = that._map();
                        var sel = that._findSeleted(map);
                        if (sel)
                            cs = sel.listIndex;
                        var parentWidth = that.$parent.get(0).offsetWidth;
                        e.style.minWidth = parentWidth + 'px';
                        e.style.maxHeight = (that.options.maxItems * DropItems._itemHeight() + DropItems.deltaHeight) + 'px';
                        e.style.overflowY = 'auto';
                        _dom.addClass(e, 'bs-block');
                        if (cs != selectedIndex) {
                            if (sel) {
                                var c = e.childNodes[sel.index];
                                _dom.removeClass(c, 'active');
                                sel.selected = false;
                            }
                            if (selectedIndex >= 0) {
                                sel = that._selectByListIndex(map, selectedIndex);
                                var ns = e.childNodes[sel.index];
                                _dom.addClass(ns, 'active');
                                sel.selected = true;
                                if (!that._isInView(ns, e))
                                    ns.scrollIntoView(true);
                            }
                            else {
                                e.scrollTop = 0;
                            }
                        }
                        if (that.page && that.page.popup != that)
                            that.page.setPopup(that);
                        _dom.addClass(e, 'bs-block');
                        that.opened = true;
                    }
                    else {
                        _dom.removeClass(e, 'bs-block');
                        that._afterHide(true);
                    }
                }
            };
            DropItems.prototype.triggerBlurred = function (event) {
                var that = this;
                that.hide(null);
            };
            DropItems.prototype.show = function (ldata, selectedIndex, ignoreNegativeSSelectedIndex) {
                var that = this;
                if (!ldata || !ldata.value || !ldata.value.length) {
                    that.currentList = null;
                    that.hide(null);
                    that._emptyHtmlList();
                    return;
                }
                else {
                    if (that.currentList == ldata.value) {
                        that._show(selectedIndex);
                    }
                    else {
                        that.currentList = ldata.value;
                        that._renderElements();
                        that._show(selectedIndex);
                    }
                }
            };
            DropItems.prototype._map = function () {
                var that = this, map = [], selectedFound = false;
                var e = that.$element.get(0);
                var li = 0;
                for (var i = 0, len = e.childNodes.length; i < len; i++) {
                    var c = e.childNodes[i];
                    if (c['pk']) {
                        var sel = selectedFound ? false : _dom.hasClass(c, 'active');
                        if (sel)
                            selectedFound = true;
                        map.push({ id: c['pk'], index: i, selected: sel, listIndex: li });
                        li++;
                    }
                }
                return map;
            };
            DropItems.prototype._selectByPk = function (id, map) {
                var that = this, res = null;
                var e = that.$element.get(0);
                map = map || that._map();
                for (var i = 0, len = map.length; i < len; i++) {
                    var m = map[i];
                    if (m.id === id) {
                        res = m;
                        if (m.selected)
                            break;
                        _dom.addClass(e.childNodes[m.index], 'active');
                        m.selected = true;
                    }
                    else if (m.selected) {
                        _dom.removeClass(e.childNodes[m.index], 'active');
                        m.selected = false;
                        if (res)
                            break;
                    }
                }
                return res;
            };
            DropItems.prototype._findSeleted = function (map) {
                var that = this;
                map = map || that._map();
                for (var i = 0, len = map.length; i < len; i++) {
                    var m = map[i];
                    if (m.selected)
                        return m;
                }
                return null;
            };
            DropItems.prototype._isInView = function (e, parent) {
                var that = this;
                var et = e.offsetTop, eh = e.offsetHeight;
                var st = parent.scrollTop, viewHeight = that.options.maxItems * DropItems._itemHeight();
                return et >= st && (st + viewHeight) >= (et + eh);
            };
            DropItems.prototype.move = function (value) {
                var that = this;
                if (that.$element && that.opened) {
                    var map = that._map(), e = that.$element.get(0);
                    var s = that._findSeleted(map);
                    var forward = value > 0, ii = void 0;
                    if (forward) {
                        if (s) {
                            ii = (value === 1000) ? (map.length - 1) : (map.indexOf(s) + value);
                            if (ii >= map.length) {
                                ii = map.length - 1;
                                if (map[ii].selected)
                                    return;
                            }
                        }
                        else
                            ii = 0;
                        if (ii < map.length) {
                            if (s) {
                                _dom.removeClass(e.childNodes[s.index], 'active');
                                s.selected = false;
                            }
                            var ns = e.childNodes[map[ii].index];
                            _dom.addClass(ns, 'active');
                            map[ii].selected = true;
                            if (ii == (map.length - 1)) {
                                e.scrollTop = ns.offsetTop + DropItems._itemHeight() + 1;
                            }
                            else {
                                if (!that._isInView(ns, e))
                                    ns.scrollIntoView(false);
                            }
                            that._doSelect(map[ii], false);
                        }
                    }
                    else {
                        if (s) {
                            ii = (value === -1000) ? 0 : (map.indexOf(s) + value);
                            if (ii < 0) {
                                ii = 0;
                                if (map[ii].selected)
                                    return;
                            }
                        }
                        else
                            ii = map.length - 1;
                        if (ii >= 0) {
                            if (s) {
                                _dom.removeClass(e.childNodes[s.index], 'active');
                                s.selected = false;
                            }
                            var ns = e.childNodes[map[ii].index];
                            _dom.addClass(ns, 'active');
                            map[ii].selected = true;
                            if (ii == 0)
                                e.scrollTop = 0;
                            else {
                                if (!that._isInView(ns, e))
                                    ns.scrollIntoView(true);
                            }
                            that._doSelect(map[ii], false);
                        }
                    }
                }
            };
            DropItems.prototype.select = function () {
                var that = this;
                if (that.$element && that.opened) {
                    var s = that._findSeleted();
                    if (s)
                        that._doSelect(s, true);
                }
            };
            DropItems.prototype._doSelect = function (selected, close) {
                var that = this;
                if (close) {
                    if (that.options.onselect) {
                        that.options.onselect(_sutils.findByPk(_sutils.id2Pk(selected.id, that.keys), that.keys, that.currentList));
                    }
                    that.hide(null);
                }
            };
            DropItems.prototype.inPopup = function (target) {
                var that = this;
                if (that.$element) {
                    var e = that.$element.get(0).parentNode;
                    return _dom.isChildOf(e, target);
                }
                return false;
            };
            DropItems.prototype.destroy = function () {
                var that = this;
                that.options = null;
                that.currentList = null;
                that.$input = null;
                that.$parent = null;
                that.$element = null;
            };
            DropItems.itemHeight = 0;
            DropItems.deltaHeight = 0;
            return DropItems;
        }());
        ui.DropItems = DropItems;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="../../../core/modules/locale.ts" />
/// <reference path="./absfield.control.ts" />
/// <reference path="../schema.data.ts" />
/// <reference path="../errors.data.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _dom = Phoenix.dom, _locale = Phoenix.locale, _su = Phoenix.Observable.SchemaUtils, _ulocale = Phoenix.ulocale, _ui = ui, _eu = Phoenix.Observable.errorsUtils;
        var _createInput = function (html, options, title, tagName) {
            var _bootstrap4 = Phoenix.bootstrap4;
            tagName = tagName || 'input';
            var isTextArea = tagName === "textarea";
            if (isTextArea) {
                if (options.before || options.after) {
                    delete options.before;
                    delete options.after;
                }
            }
            if (options.before || options.after) {
                html.push('<div class="input-group"');
                var style = [];
                if (options.$format === "money" || options.$format === "date") {
                    if (options.maxWidth === undefined)
                        options.maxWidth = '16em';
                }
                if (options.minWidth)
                    style.push('min-width: ' + options.minWidth + ';');
                if (options.maxWidth)
                    style.push('max-width: ' + options.maxWidth + ';');
                if (style.length)
                    html.push('  style="' + style.join("") + '"');
                html.push('>');
            }
            if (options.before) {
                html.push('<span class="bs-grp-btn input-group-addon">');
                if (options.before.icon)
                    html.push('<span class="' + _dom.iconClass(options.before.icon) + '"></span>');
                else
                    html.push(options.before.value);
                html.push('</span>');
            }
            var inputCss = ['form-control'];
            if (options.size && _bootstrap4)
                inputCss.push(' form-control-' + options.size);
            if (options.inputClass)
                inputCss.push(options.inputClass);
            html.push('<' + tagName + ' autocomplete="off" type="' + (options.type || 'text') + '" class="' + inputCss.join(' '));
            html.push('" id="{0}_input"');
            if (isTextArea) {
                html.push(' rows="' + options.rows || 3 + '"');
            }
            if (!options.before && !options.after) {
                var style = [];
                if (options.maxWidth)
                    style.push('max-width: ' + options.maxWidth + ';');
                if (options.minWidth)
                    style.push('min-width: ' + options.minWidth + ';');
                if (style.length)
                    html.push('  style="' + style.join("") + '"');
            }
            if (options.maxLength)
                html.push('  maxLength="' + options.maxLength + '"');
            if (options.placeHolder) {
                var phv = options.placeHolder === true ? title : options.placeHolder;
                html.push('  placeholder="' + phv + '"');
            }
            html.push('>');
            if (options.after) {
                html.push('<span  id="{0}_after" tabindex="-1" class="bs-grp-btn input-group-addon');
                if (options.after.icon)
                    html.push(' bs-icon-input');
                html.push('">');
                if (options.after.icon) {
                    html.push('<span class="' + _dom.iconClass(options.after.icon) + '"></span>');
                }
                else
                    html.push(options.after.value);
                html.push('</span>');
            }
            if (options.before || options.after)
                html.push('</div>');
            if (isTextArea) {
                html.push('</' + tagName + '>');
            }
            _ui.Utils.addErrorDiv(html);
        }, _createEditInput = function (id, options, authoring, title, tagName) {
            title = title || '';
            options = $.extend({ titleIsHidden: false, placeHolder: false, columns: false, labelCol: 3 }, options);
            var html = [];
            if (options.titleIsHidden) {
                options.columns = false;
            }
            _ui.Utils.fieldWrapper(html, options, authoring, function () {
                var _bootstrap4 = Phoenix.bootstrap4;
                if (!options.titleIsHidden) {
                    html.push('<label for="{0}_input" id="{0}_label"');
                    var css = ['bs-label'];
                    if (options.columns) {
                        if (_bootstrap4) {
                            css.push('form-control-label');
                        }
                        else {
                            css.push('checkbox-inline bs-cursor-d');
                        }
                        css.push('bs-lib-col col-sm-' + options.labelCol);
                    }
                    if (options.inline) {
                        css.push('checkbox-inline bs-cursor-d no-x-padding');
                    }
                    if (css.length)
                        html.push(' class="' + css.join(' ') + '"');
                    html.push('>');
                    html.push(_utils.escapeHtml(title || '') + (options.inline ? '&nbsp;' : ''));
                    if (options.description)
                        _ui.Utils.addTooltip(html, options.description, options);
                    html.push('</label>');
                }
                if (options.columns)
                    html.push('<div class="no-x-padding col-sm-' + (12 - options.labelCol) + '" id="{0}_colparent">');
                _createInput(html, options, title, tagName);
                if (options.columns)
                    html.push('</div>');
                if (options.titleIsHidden && options.description)
                    _ui.Utils.addTooltip(html, options.description, options);
            });
            return _utils.format(html.join(''), id);
        };
        var BaseEdit = (function (_super) {
            __extends(BaseEdit, _super);
            function BaseEdit(fp, options, form) {
                _super.call(this, fp, options, form);
                this._state();
            }
            BaseEdit.prototype._input = function () {
                var that = this, e = that.$element ? that.$element.get(0) : null;
                if (!e)
                    return null;
                return _dom.find(e, that.id + '_input');
            };
            BaseEdit.prototype._colParent = function () {
                var that = this, e = that.$element.get(0);
                if (that.renderOptions.columns)
                    return _dom.find(e, that.id + '_colparent');
                else
                    return null;
            };
            BaseEdit.prototype._value2Text = function () {
                var that = this;
                var input = that._input();
                if (that._isDate()) {
                    if (_ui.Utils.useDatePicker())
                        return _ulocale.parseISODate(that.state.value || '') || '';
                    else {
                        if (_ui.Utils.nativeDate()) {
                            return that.state.value || '';
                        }
                        else
                            return _ulocale.shortDate(that.state.value || '');
                    }
                }
                else
                    return that.state.value || '';
            };
            BaseEdit.prototype._isPassword = function () {
                return _su.isPassword(this.$schema);
            };
            BaseEdit.prototype._isDate = function () {
                return _su.isDate(this.$schema);
            };
            BaseEdit.prototype._isMemo = function () {
                return _su.isText(this.$schema);
            };
            BaseEdit.prototype._isNumber = function () {
                return _su.isNumber(this.$schema);
            };
            BaseEdit.prototype._isMoney = function () {
                return _su.isMoney(this.$schema);
            };
            BaseEdit.prototype._setDisabled = function (input, element) {
                input.disabled = this.state.isDisabled;
            };
            BaseEdit.prototype._setReadOnly = function (input, element) {
                input.readOnly = this.state.isReadOnly;
            };
            BaseEdit.prototype._setErrors = function (input, element) {
                var that = this;
                var errors = that.state.errors;
                if (errors && errors.length)
                    _dom.addClass(element, "has-error");
                else
                    _dom.removeClass(element, "has-error");
                that.showErrors(element, errors);
            };
            BaseEdit.prototype._setMandatory = function (input, element) {
                var that = this, v = this.state.isMandatory;
                input.required = v;
                if (v)
                    _dom.addClass(input, "bs-mandatory");
                else
                    _dom.removeClass(input, "bs-mandatory");
                if (that.renderOptions.placeHolder) {
                    input.placeholder = that.renderOptions.title + (v ? ' *' : '');
                }
                if (!that.renderOptions.titleIsHidden) {
                    var label = _dom.find(element, that.id + '_label');
                    if (label) {
                        _dom.text(label, (that.renderOptions.title || '') + (v ? ' *' : '') + (that.renderOptions.inline ? String.fromCharCode(160) : ''));
                    }
                }
            };
            BaseEdit.prototype._state2UI = function () {
                var that = this;
                var input = that._input();
                var element = that.$element ? that.$element.get(0) : null;
                if (input) {
                    that._value2Input(input);
                    that._setDisabled(input, element);
                    that._setReadOnly(input, element);
                    that.setHidden(element);
                    that._setMandatory(input, element);
                    that._setErrors(input, element);
                    that._setSymbol(element);
                }
            };
            BaseEdit.prototype._setSymbol = function (e) {
                var that = this;
                if (!that._hasSymbol || !e)
                    return;
                var after = _dom.find(e, that.id + '_after');
                if (after)
                    _dom.text(after, that.state.symbol);
            };
            BaseEdit.prototype._value2Input = function (input) {
                var that = this;
                if (that._isDate()) {
                    if (_ui.Utils.useDatePicker())
                        _ui.Utils.datePickerSetValue(that.$element, that.state.value);
                    else {
                        if (_ui.Utils.nativeDate()) {
                            input.value = _ulocale.isoDatePart(that.state.value || '');
                        }
                        else
                            input.value = _ulocale.shortDate(that.state.value || '');
                    }
                }
                else if (that._isNumber()) {
                    if (_ui.Utils.nativeNumber())
                        input.value = that.state.value || 0;
                    else
                        input.value = that._value2Text();
                }
                else
                    input.value = that._value2Text();
            };
            BaseEdit.prototype.changed = function (propName, ov, nv, op) {
                var that = this;
                if (that.useDisplay && propName === that.$bind)
                    return;
                if (!that.$element)
                    return;
                var input = that._input();
                nv = that.form.getValue(that.$display);
                if (that.state.value != nv) {
                    that.state.value = nv;
                    that._value2Input(input);
                }
                else {
                    var av = input.value;
                    var cv = that._value2Text();
                    if (av != cv)
                        that._value2Input(input);
                }
            };
            BaseEdit.prototype.stateChanged = function (propName, params) {
                var that = this;
                if (that.useDisplay && propName === that.$display)
                    return;
                var state = that.form.getState(that.$bind);
                var input = that._input();
                var element = that.$element ? that.$element.get(0) : null;
                if (!propName || (propName === 'symbol')) {
                    if (state.symbol !== that.state.symbol) {
                        that.state.symbol = state.symbol;
                        if (input)
                            that._setSymbol(element);
                    }
                }
                if (!propName || (propName === 'decimals')) {
                    if (state.decimals !== that.state.decimals) {
                        that.state.decimals = state.decimals;
                    }
                }
                if (!propName || (propName === 'isHidden')) {
                    if (state.isHidden !== that.state.isHidden) {
                        that.state.isHidden = state.isHidden;
                        if (input)
                            that.setHidden(element);
                    }
                }
                if (!propName || (propName === 'isDisabled')) {
                    if (state.isDisabled !== that.state.isDisabled) {
                        that.state.isDisabled = state.isDisabled;
                        if (input)
                            that._setDisabled(input, element);
                    }
                }
                if (!propName || (propName === 'isReadOnly')) {
                    if (state.isReadOnly !== that.state.isReadOnly) {
                        that.state.isReadOnly = state.isReadOnly;
                        if (input)
                            that._setReadOnly(input, element);
                    }
                }
                if (!propName || (propName === 'isMandatory')) {
                    if (state.isMandatory !== that.state.isMandatory) {
                        that.state.isMandatory = state.isMandatory;
                        if (input)
                            that._setMandatory(input, element);
                    }
                }
                if (!propName || (propName === 'errors')) {
                    if (_eu.errorChanged(that.state.errors, state.errors)) {
                        that.state.errors = state.errors;
                        that._setErrors(input, element);
                    }
                }
            };
            BaseEdit.prototype.destroy = function () {
                _super.prototype.destroy.call(this);
            };
            return BaseEdit;
        }(ui.AbsField));
        ui.BaseEdit = BaseEdit;
        var Edit = (function (_super) {
            __extends(Edit, _super);
            function Edit(fp, options, form) {
                _super.call(this, fp, options, form);
            }
            Edit.prototype.beforeAppend = function () { };
            Edit.prototype.mousedown = function (event) {
                var that = this;
                that._doSelect = false;
                if (!that.$element)
                    return;
                if (that.state.isDisabled)
                    return;
                var ae = window.document.activeElement;
                if (ae !== event.target) {
                    var input = that._input();
                    if (input === event.target) {
                        that._doSelect = true;
                    }
                }
                return true;
            };
            Edit.prototype.stopProppagation = function (event) {
                var that = this;
                if (that._doSelect) {
                    var input = that._input();
                    _dom.select(input);
                }
            };
            Edit.prototype.click = function (event) { };
            Edit.prototype.internalRender = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    opts.title = _ulocale.tt(that.$schema.title, that.form.$locale);
                    if (opts.placeHolder && opts.placeHolder != true)
                        opts.title = _ulocale.tt(opts.placeHolder, that.form.$locale);
                    opts.maxLength = that.$schema.maxLength;
                    if (that.$schema.description)
                        opts.description = _ulocale.tt(that.$schema.description, that.form.$locale);
                    that.$element = $(_createEditInput(that.id, opts, that.options.design, opts.title, opts.tagName));
                    that.beforeAppend();
                    that.setEvents(opts);
                    that._state2UI();
                }
                that.appendElement($parent, opts);
            };
            Edit.prototype.render = function ($parent) {
                var that = this;
                that.internalRender($parent);
            };
            Edit.prototype._text2value = function (textValue) {
                var that = this;
                return _ui.Utils.text2value(textValue, that.$schema, that.state);
            };
            Edit.prototype._value2Text = function () {
                var that = this;
                if (that._isNumber()) {
                    return _su.value2Text(that.state.value, that.$schema, that.state);
                }
                else
                    return _super.prototype._value2Text.call(this);
            };
            Edit.prototype.customOptions = function (options) {
                var that = this;
                if (that._isDate()) {
                    that.customOptionsDate(options);
                }
                else if (that._isNumber()) {
                    that.customOptionsNumber(options, that.state.symbol);
                }
                else if (that._isPassword()) {
                    that.customOptionsPassword(options);
                }
                else if (that._isMemo()) {
                    that.customOptionsMemo(options);
                }
            };
            Edit.prototype.customOptionsMemo = function (options) {
                options.tagName = 'textarea';
            };
            Edit.prototype.customOptionsPassword = function (options) {
                options.type = 'password';
            };
            Edit.prototype.customOptionsDate = function (options) {
                var that = this;
                options.$format = 'date';
                if (!_ui.Utils.nativeDate()) {
                    options.after = { icon: 'calendar' };
                    options.date = true;
                }
                else {
                    options.type = 'date';
                }
            };
            Edit.prototype.customOptionsNumber = function (options, symbol) {
                var that = this;
                options.inputClass = "bs-edit-number";
                if (symbol) {
                    options.after = { value: symbol };
                    that._hasSymbol = true;
                }
                options.$format = that.$schema.format;
                if (_ui.Utils.nativeNumber()) {
                    options.type = 'number';
                }
            };
            Edit.prototype._removeEventsDate = function () {
                var that = this;
                if (that._isDate()) {
                    that._setEventsDate();
                }
            };
            Edit.prototype._setEventsDate = function () {
                var that = this;
                if (_ui.Utils.useDatePicker()) {
                    _ui.Utils.datePickerInitialize(that.$element, { showOnFocus: true }, function (e) {
                        that.focusOut(null);
                    });
                }
            };
            Edit.prototype.setEvents = function (opts) {
                var that = this;
                if (that._isDate()) {
                    that._setEventsDate();
                }
            };
            Edit.prototype.removeEvents = function () {
                var that = this;
                if (that._isDate()) {
                    that._removeEventsDate();
                }
            };
            Edit.prototype.checkValue = function (value, after) {
                after(value);
            };
            Edit.prototype.keypress = function (event) {
                var that = this;
                if (that._isNumber()) {
                    if (_ui.Utils.keyPressNumber(event) === false)
                        return false;
                }
                else if (that._isPassword()) {
                    if (_ui.Utils.keyPressPassword(event) === false)
                        return false;
                }
            };
            Edit.prototype.equals = function (nv) {
                var that = this;
                var res = (that.state.value === nv);
                if (!res && that.state.value === undefined) {
                    if (that.$schema.type === "string") {
                        if (nv === '')
                            return true;
                    }
                }
                return res;
            };
            Edit.prototype.focusOut = function (event) {
                var that = this, input = that._input();
                var nv = that._text2value(input.value);
                if (!that.equals(nv)) {
                    that.checkValue(nv, function (cv) {
                        if (that.state.value !== cv) {
                            if (cv === '' && that.$schema.type === "string")
                                cv = undefined;
                            that.state.value = cv;
                            that.form.setValue(that.$display, that.state.value);
                        }
                        else
                            that._value2Input(input);
                    });
                }
                else if (that._isNumber()) {
                    that._value2Input(input);
                }
            };
            Edit.prototype.destroy = function () {
                _super.prototype.destroy.call(this);
            };
            return Edit;
        }(BaseEdit));
        ui.Edit = Edit;
        _ui.registerControl(Edit, "string", false, '', null);
        _ui.registerControl(Edit, "number", false, '', null);
        _ui.registerControl(Edit, "integer", false, '', null);
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="../../../core/modules/locale.ts" />
/// <reference path="./absfield.control.ts" />
/// <reference path="../schema.data.ts" />
/// <reference path="../errors.data.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _dom = Phoenix.dom, _locale = Phoenix.locale, _su = Phoenix.Observable.SchemaUtils, _ulocale = Phoenix.ulocale, _ui = ui, _eu = Phoenix.Observable.errorsUtils;
        var _createEnumsInput = function (id, options, authoring, title) {
            var _bootstrap4 = Phoenix.bootstrap4;
            title = title || '';
            options = $.extend({ titleIsHidden: false, placeHolder: false, columns: false, labelCol: 3 }, options);
            var html = [];
            if (options.titleIsHidden) {
                options.columns = false;
            }
            options.placeHolder = false;
            _ui.Utils.fieldWrapper(html, options, authoring, function () {
                if (!options.titleIsHidden) {
                    html.push('<label for="{0}_input" id="{0}_label"');
                    var css = ['bs-label'];
                    if (options.columns) {
                        if (_bootstrap4)
                            css.push('form-control-label');
                        else
                            css.push('checkbox-inline bs-cursor-d');
                        css.push('bs-lib-col col-sm-' + options.labelCol);
                    }
                    if (options.inline)
                        css.push('no-x-padding checkbox-inline bs-cursor-d');
                    if (css.length)
                        html.push(' class="' + css.join(' ') + '"');
                    html.push('>');
                    html.push(_utils.escapeHtml(title || '') + (options.inline ? '&nbsp;' : ''));
                    if (options.description)
                        _ui.Utils.addTooltip(html, options.description, options);
                    html.push('</label>');
                }
                if (options.columns)
                    html.push('<div class="no-x-padding col-sm-' + (12 - options.labelCol) + '">');
                html.push('<div class="bs-enum-list-wrap" id="{0}_input">');
                html.push('</div>');
                _ui.Utils.addErrorDiv(html);
                if (options.columns)
                    html.push('</div>');
            });
            return _utils.format(html.join(''), id);
        }, _createEnums = function (values, disabled, enums, enumsNames) {
            enumsNames = enumsNames || enums;
            var f = document.createDocumentFragment();
            var e = $('<div tabindex="0" class="bs-enum-list-row"><div class="bs-enum-list-check"><a><center><span class="' + _dom.iconClass('square-o') + '"></span></center></a></div><div class="bs-enum-list-title"></div></div>').get(0);
            enums.forEach(function (en, index) {
                var ii = e.cloneNode(true);
                if (disabled) {
                    _dom.attr(ii, "tabindex", "-1");
                    _dom.removeClass(ii, "bs-pointer");
                    _dom.addClass(ii, "bs-cursor-disabled");
                }
                else {
                    _dom.attr(ii, "tabindex", "0");
                    _dom.addClass(ii, "bs-pointer");
                    _dom.removeClass(ii, "bs-cursor-disabled");
                }
                var check = ii.firstChild.firstChild.firstChild.firstChild;
                check.className = (values && values.indexOf(en) >= 0) ? _dom.iconClass("check-square-o") : _dom.iconClass("square-o");
                var tparent = ii.lastChild;
                _dom.append(tparent, document.createTextNode(enumsNames[index])),
                    _dom.append(f, ii);
            });
            return f;
        };
        var EnumList = (function (_super) {
            __extends(EnumList, _super);
            function EnumList(fp, options, form) {
                _super.call(this, fp, options, form);
                this._state();
            }
            EnumList.prototype._setDisabled = function (input, element) {
                var that = this;
                for (var i = 0, len = input.childNodes.length; i < len; i++) {
                    var ii = input.childNodes[i];
                    if (that.state.isDisabled) {
                        _dom.attr(ii, "tabindex", "-1");
                        _dom.removeClass(ii, "bs-pointer");
                        _dom.addClass(ii, "bs-cursor-disabled");
                    }
                    else {
                        _dom.attr(ii, "tabindex", "0");
                        _dom.addClass(ii, "bs-pointer");
                        _dom.removeClass(ii, "bs-cursor-disabled");
                    }
                }
            };
            EnumList.prototype._setReadOnly = function (input, element) {
            };
            EnumList.prototype._setErrors = function (input, element) {
                var that = this;
                var errors = that.state.errors;
                that.showErrors(element, errors);
            };
            EnumList.prototype._setMandatory = function (input, element) {
            };
            EnumList.prototype._input = function () {
                var that = this, e = that.$element.get(0);
                return _dom.find(e, that.id + '_input');
            };
            EnumList.prototype._state2UI = function (isCreate) {
                var that = this;
                var input = that._input();
                var element = that.$element ? that.$element.get(0) : null;
                if (input) {
                    if (!isCreate) {
                        that._setDisabled(input, element);
                    }
                    if (!isCreate) {
                        that._setFilter();
                    }
                    that._setReadOnly(input, element);
                    that.setHidden(element);
                    that._setMandatory(input, element);
                    that._setErrors(input, element);
                }
            };
            EnumList.prototype.mousedown = function (event) {
                var that = this;
                if (!that.$element)
                    return;
                if (that.state.isDisabled || that.state.isReadOnly)
                    return;
                var ae = window.document.activeElement;
                var row = _dom.parentByClass(that.$element.get(0), event.target, "bs-enum-list-row");
                if (!row)
                    return;
                if (ae !== row) {
                    row.focus();
                }
                return true;
            };
            EnumList.prototype._getEnumsNames = function () {
                var that = this;
                if (!that.$schemaItems.enumNames)
                    return null;
                if (that.state.filter) {
                    var enums = that.$schemaItems.filters[that.state.filter];
                    var res_2 = [];
                    enums.forEach(function (en) {
                        res_2.push(that.$schemaItems.enumNames[that.$schemaItems.enum.indexOf(en)]);
                    });
                    return res_2;
                }
                else
                    return that.$schemaItems.enumNames;
            };
            EnumList.prototype._getEnums = function () {
                var that = this;
                return that.state.filter ? that.$schemaItems.filters[that.state.filter] : that.$schemaItems.enum;
            };
            EnumList.prototype._toggleEnumByIndex = function (index) {
                var that = this;
                var enums = that._getEnums();
                if (index >= 0 && index < enums.length) {
                    var en = enums[index];
                    var ii = that.state.value.indexOf(en);
                    if (ii >= 0) {
                        that.state.value.remove(en);
                    }
                    else {
                        that.state.value.push(en);
                    }
                }
            };
            EnumList.prototype.keypress = function (event) {
                var that = this;
                if (event.which == 32) {
                    var row = _dom.parentByClass(that.$element.get(0), event.target, "bs-enum-list-row");
                    if (!row)
                        return;
                    that._toggleEnumByIndex(_dom.indexOf(row.parentNode, row));
                }
            };
            EnumList.prototype.click = function (event) {
                var that = this;
                if (!that.$element)
                    return;
                if (that.state.isDisabled || that.state.isReadOnly)
                    return;
                var row = _dom.parentByClass(that.$element.get(0), event.target, "bs-enum-list-row");
                if (!row)
                    return;
                that._toggleEnumByIndex(_dom.indexOf(row.parentNode, row));
            };
            EnumList.prototype.changed = function (propName, ov, nv, op, params) {
                var that = this;
                if (!that.$element)
                    return;
                var ii = that._input(), ie = -1;
                var enums = that._getEnums();
                var enumsNames = that._getEnumsNames();
                switch (op) {
                    case "add":
                        ie = enums.indexOf(params.$id);
                        if (ie >= 0) {
                            that._setItemValue(ii.childNodes[ie], true);
                        }
                        break;
                    case "remove":
                        ie = enums.indexOf(params.$id);
                        if (ie >= 0) {
                            that._setItemValue(ii.childNodes[ie], false);
                        }
                        break;
                    case "propchange":
                        _dom.empty(ii);
                        var ff = _createEnums(that.state.value, that.state.isDisabled, enums, enumsNames);
                        _dom.empty(ii);
                        _dom.append(ii, ff);
                        break;
                }
            };
            EnumList.prototype._setFilter = function () {
                var that = this;
                var nf = that.state.filter;
                var enums = that._getEnums();
                var nv = [];
                that.state.value.forEach(function (en) {
                    if (enums.indexOf(en) >= 0)
                        nv.push(en);
                });
                that.form.setValue(that.$bind, nv);
            };
            EnumList.prototype.stateChanged = function (propName, params) {
                var that = this;
                var state = that.form.getState(that.$bind);
                var element = that.$element ? that.$element.get(0) : null;
                var input = element ? that._input() : null;
                if (!propName || (propName === 'isHidden')) {
                    if (state.isHidden !== that.state.isHidden) {
                        that.state.isHidden = state.isHidden;
                        if (element)
                            that.setHidden(element);
                    }
                }
                if (!propName || (propName === 'isDisabled')) {
                    if (state.isDisabled != that.state.isDisabled) {
                        that.state.isDisabled = state.isDisabled;
                        if (element)
                            that._setDisabled(input, element);
                    }
                }
                if (!propName || (propName === 'isReadOnly')) {
                    if (state.isReadOnly != that.state.isReadOnly) {
                        that.state.isReadOnly = state.isReadOnly;
                    }
                }
                if (!propName || (propName === 'filter')) {
                    if (state.filter != that.state.filter) {
                        that.state.filter = state.filter;
                        if (element)
                            that._setFilter();
                    }
                }
                if (!propName || (propName === 'isMandatory')) {
                    if (state.isMandatory != that.state.isMandatory) {
                        that.state.isMandatory = state.isMandatory;
                    }
                }
                if (!propName || (propName === 'errors')) {
                    if (_eu.errorChanged(that.state.errors, state.errors)) {
                        that.state.errors = state.errors;
                        that._setErrors(null, element);
                    }
                }
            };
            EnumList.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    if (that.$schema.description)
                        opts.description = _ulocale.tt(that.$schema.description, that.form.$locale);
                    that.$element = $(_createEnumsInput(that.id, opts, that.options.design, _ulocale.tt(that.$schema.title, that.form.$locale)));
                    var ff = _createEnums(that.state.value, that.state.isDisabled, that._getEnums(), that._getEnumsNames());
                    var ii = that._input();
                    _dom.append(ii, ff);
                    that._state2UI(true);
                }
                that.appendElement($parent, opts);
                return that.$element;
            };
            EnumList.prototype._setItemValue = function (item, value) {
                var check = item.firstChild.firstChild.firstChild.firstChild;
                check.className = value ? _dom.iconClass("check-square-o") : _dom.iconClass("square-o");
            };
            EnumList.prototype.destroy = function () {
                _super.prototype.destroy.call(this);
            };
            return EnumList;
        }(ui.AbsField));
        ui.EnumList = EnumList;
        _ui.registerControl(EnumList, "array", false, 'enums-list', null);
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="./absfield.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _dom = Phoenix.dom, _ulocale = Phoenix.ulocale;
        var Group = (function (_super) {
            __extends(Group, _super);
            function Group(fp, options, form) {
                _super.call(this, fp, options, form);
                this._state();
            }
            Group.prototype._item = function (ii) {
                var that = this, e = that.$element.get(0);
                return _dom.find(e, that.id + '_item_' + ii);
            };
            Group.prototype.click = function (event) {
                var that = this, target = event.target;
                if (that.state.isReadOnly)
                    return;
                if (target && target.id) {
                    var prefix = that.id + "_item_";
                    if (target.id.indexOf(prefix) === 0) {
                        var index = parseInt(target.id.substring(prefix.length), 10);
                        var value = that.$schema.enum[index];
                        if (value != that.state.value) {
                            that.form.setValue(that.$bind, value);
                        }
                    }
                }
            };
            Group.prototype._setDisabled = function (element) {
                if (!element)
                    return;
                var that = this;
                that._enumItems(function (btn, value) {
                    btn.disabled = (that.state.isDisabled || that.state.isReadOnly);
                });
            };
            Group.prototype._enumItems = function (cb) {
                var that = this;
                that.$schema.enum.forEach(function (val, index) {
                    var item = that._item(index);
                    cb(item, val);
                });
            };
            Group.prototype._setMandatory = function (element) { };
            Group.prototype._state2UI = function (cb) {
                var that = this, element = that.$element ? that.$element.get(0) : null;
                if (!element)
                    return;
                var ii = that.$schema.enum.indexOf(that.state.value);
                if (ii >= 0) {
                    var item = that._item(ii);
                    if (item)
                        cb(item);
                }
                that._setDisabled(element);
                that.setHidden(element);
            };
            Group.prototype._getDefaultItem = function () {
                var that = this, element = that.$element ? that.$element.get(0) : null;
                if (!element)
                    return;
                var ii = that.$schema.enum.indexOf(that.state.value);
                if (ii >= 0) {
                    return that._item(ii);
                }
                else
                    return;
            };
            Group.prototype.stateChanged = function (propName, params) {
                var that = this, state = that.form.getState(that.$bind), element = that.$element ? that.$element.get(0) : null;
                if (state.isHidden !== that.state.isHidden) {
                    that.state.isHidden = state.isHidden;
                    that.setHidden(element);
                }
                if (state.isDisabled != that.state.isDisabled) {
                    that.state.isDisabled = state.isDisabled;
                    that._setDisabled(element);
                }
                if (state.isReadOnly != that.state.isReadOnly) {
                    that.state.isReadOnly = state.isReadOnly;
                    that._setDisabled(element);
                }
                if (state.isMandatory != that.state.isMandatory) {
                    that.state.isMandatory = state.isMandatory;
                    that._setMandatory(element);
                }
            };
            return Group;
        }(ui.AbsField));
        ui.Group = Group;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="./group.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _dom = Phoenix.dom, _ulocale = Phoenix.ulocale;
        var _createGroupBtns = function (id, options, authoring, title, enums, enumsNames) {
            title = title || '';
            options = $.extend({ titleIsHidden: false, placeHolder: false, columns: false }, options);
            var html = [];
            _ui.Utils.fieldWrapper(html, options, authoring, function () {
                var _bootstrap4 = Phoenix.bootstrap4;
                //add label: 
                var addDiv = !options.columns && !options.inline;
                if (!options.titleIsHidden) {
                    html.push('<label for="{0}_input" id="{0}_label"');
                    var cssLabel = ['bs-label'];
                    if (options.columns) {
                        if (_bootstrap4) {
                            cssLabel.push('form-control-label');
                        }
                        else {
                            cssLabel.push('checkbox-inline bs-cursor-d');
                        }
                        cssLabel.push('bs-lib-col col-sm-' + options.labelCol);
                    }
                    else if (options.inline) {
                        cssLabel.push('checkbox-inline bs-cursor-d no-x-padding');
                    }
                    if (cssLabel.length)
                        html.push(' class="' + cssLabel.join(' ') + '"');
                    html.push('>');
                    html.push(_utils.escapeHtml(title || '') + (options.inline ? '&nbsp;' : ''));
                    html.push('</label>');
                }
                if (options.columns)
                    html.push('<div class="no-x-padding col-sm-' + (12 - options.labelCol) + '">');
                if (addDiv)
                    html.push('<div>');
                var css = ['btn-group'];
                html.push('<div class="' + css.join(' ') + '">');
                enums.forEach(function (enumName, index) {
                    html.push('<button tabindex="-1" type="button" id="{0}_item_' + index + '" class="btn btn-' + _dom.bootstrapStyles.secondary + '"');
                    if (options.width) {
                        html.push(' style="width:' + options.width + '"');
                    }
                    html.push('>');
                    html.push(_utils.escapeHtml(enumsNames[index] || ''));
                    html.push('</button>');
                });
                if (addDiv)
                    html.push('</div>');
                html.push('</div>');
            });
            if (options.columns)
                html.push('</div>');
            return _utils.format(html.join(''), id);
        };
        var BtnGroup = (function (_super) {
            __extends(BtnGroup, _super);
            function BtnGroup(fp, options, form) {
                _super.call(this, fp, options, form);
                this._state();
            }
            BtnGroup.prototype._state2UI = function () {
                _super.prototype._state2UI.call(this, function (item) {
                    _dom.addClass(item, 'btn-primary');
                    _dom.removeClass(item, 'btn-' + _dom.bootstrapStyles.secondary);
                    item.tabIndex = 0;
                });
            };
            BtnGroup.prototype.changed = function (propName, ov, nv, op) {
                var that = this;
                if (that.state.value != nv) {
                    that.state.value = nv;
                    if (!that.$element)
                        return;
                    _super.prototype._enumItems.call(this, function (btn, value) {
                        if (that.state.value === value) {
                            btn.tabIndex = 0;
                            if (that.focused)
                                btn.focus();
                            _dom.addClass(btn, 'btn-' + _dom.bootstrapStyles.primary);
                            _dom.removeClass(btn, 'btn-' + _dom.bootstrapStyles.secondary);
                        }
                        else {
                            _dom.addClass(btn, 'btn-' + _dom.bootstrapStyles.secondary);
                            _dom.removeClass(btn, 'btn-' + _dom.bootstrapStyles.primary);
                            btn.tabIndex = -1;
                        }
                    });
                }
            };
            BtnGroup.prototype.keydown = function ($event) {
                var that = this;
                var preventDefault = false;
                if (that.state.isReadOnly)
                    return;
                if ($event.altKey || $event.ctrlKey || $event.metaKey || $event.shiftKey)
                    return;
                var kc = $event.which || $event.keyCode;
                switch (kc) {
                    case _dom.keys.VK_LEFT:
                        //left
                        var cci = that.$schema.enum.indexOf(that.state.value);
                        if (cci > 0) {
                            var nv = that.$schema.enum[cci - 1];
                            that.form.setValue(that.$bind, nv);
                        }
                        break;
                    case _dom.keys.VK_RIGHT:
                        //right
                        var ci = that.$schema.enum.indexOf(that.state.value);
                        if (ci >= 0 && (ci < that.$schema.enum.length - 1)) {
                            var nv = that.$schema.enum[ci + 1];
                            that.form.setValue(that.$bind, nv);
                        }
                        break;
                    default:
                        break;
                }
                preventDefault && $event.preventDefault() && $event.stopPropagation();
            };
            BtnGroup.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    var enumNames = that.$schema.enumNames || that.$schema.enum;
                    enumNames = enumNames.map(function (v) { return _ulocale.tt(v, that.form.$locale); });
                    that.$element = $(_createGroupBtns(that.id, opts, that.options.design, _ulocale.tt(that.$schema.title, that.form.$locale), that.$schema.enum, enumNames));
                    that._state2UI();
                }
                that.appendElement($parent, opts);
                return that.$element;
            };
            return BtnGroup;
        }(ui.Group));
        ui.BtnGroup = BtnGroup;
        _ui.registerControl(BtnGroup, '*', true, 'grpbtn', null);
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="./absfield.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _dom = Phoenix.dom, _ulocale = Phoenix.ulocale;
        function _createLabel(id, options, authoring, title) {
            var _bootstrap4 = Phoenix.bootstrap4;
            title = title || '';
            options = $.extend({ columns: false }, options);
            var simulateCols = options.columns;
            options.columns = false;
            if (simulateCols) {
                options.styles = "no-x-padding";
            }
            var html = [];
            var customizer = { formGroup: "form-group" };
            if (simulateCols && !_bootstrap4)
                customizer.formGroup += " form-horizontal";
            _ui.Utils.fieldWrapper(html, options, authoring, function () {
                html.push('<label id="{0}_label"');
                var css = ['bs-label'];
                if (simulateCols) {
                    if (_bootstrap4)
                        css.push('form-control-label');
                    else
                        css.push('checkbox-inline bs-cursor-d');
                    css.push('col-sm-12 bs-lib-col');
                }
                if (options.inline) {
                    css.push('checkbox-inline bs-cursor-d no-x-padding');
                }
                if (css.length)
                    html.push(' class="' + css.join(' ') + '"');
                if (options.parentId)
                    html.push(' for="' + options.parentId + '_input"');
                html.push('>');
                html.push(_utils.escapeHtml(title || '') + (options.inline ? '&nbsp;' : ''));
                if (options.description)
                    _ui.Utils.addTooltip(html, options.description, options);
                html.push('</label>');
            }, customizer);
            return _utils.format(html.join(''), id);
        }
        ;
        var Label = (function (_super) {
            __extends(Label, _super);
            function Label(fp, options, form) {
                _super.call(this, fp, options, form);
                this._state();
            }
            Label.prototype.isMeta = function () { return true; };
            Label.prototype.setParentId = function (id) { this._parentId = id; };
            Label.prototype.getCustomBind = function () {
                var that = this;
                if (that.config && that.config.options && that.config.options.$bind)
                    return that.config.options.$bind;
                return _super.prototype.getCustomBind.call(this);
            };
            Label.prototype._setDisabled = function (input, element) {
                var that = this;
                // TODO
            };
            Label.prototype._setReadOnly = function (input, element) {
                /* nothing todo */
            };
            Label.prototype._setMandatory = function (input, element) {
                var that = this, v = this.state.isMandatory;
                var label = that._label();
                if (label) {
                    _dom.text(label, that.renderOptions.title + (v ? ' *' : '') + (that.renderOptions.inline ? String.fromCharCode(160) : ''));
                }
            };
            Label.prototype._label = function () {
                var that = this;
                return that.$element ? _dom.find(that.$element.get(0), that.id + '_label') : null;
            };
            Label.prototype._state2UI = function () {
                var that = this, label = that._label(), element = that.$element ? that.$element.get(0) : null;
                if (label) {
                    that._setDisabled(label, element);
                    that._setReadOnly(label, element);
                    that.setHidden(element);
                    that._setMandatory(label, element);
                }
            };
            Label.prototype.stateChanged = function (propName, params) {
                var that = this, state = that.form.getState(that.$bind), label = that._label(), element = that.$element ? that.$element.get(0) : null;
                if (state.isHidden !== that.state.isHidden) {
                    that.state.isHidden = state.isHidden;
                    if (label)
                        that.setHidden(element);
                }
                if (state.isDisabled != that.state.isDisabled) {
                    that.state.isDisabled = state.isDisabled;
                    if (label)
                        that._setDisabled(label, element);
                }
                if (state.isReadOnly != that.state.isReadOnly) {
                    that.state.isReadOnly = state.isReadOnly;
                    if (label)
                        that._setReadOnly(label, element);
                }
                if (state.isMandatory != that.state.isMandatory) {
                    that.state.isMandatory = state.isMandatory;
                    if (label)
                        that._setMandatory(label, element);
                }
            };
            Label.prototype._title = function () {
                var that = this;
                if (that.$schema && that.$schema.title)
                    return that.$schema.title;
                return (that.config && that.config.options && that.config.options.title) ? that.config.options.title : '';
            };
            Label.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    opts.title = _ulocale.tt(that._title(), that.form.$locale);
                    if (that.$schema.description)
                        opts.description = _ulocale.tt(that.$schema.description, that.form.$locale);
                    if (that._parentId)
                        opts.parentId = that._parentId;
                    that.$element = $(_createLabel(that.id, opts, that.options.design, opts.title));
                    that._state2UI();
                }
                that.appendElement($parent, opts);
                return that.$element;
            };
            return Label;
        }(ui.AbsField));
        ui.Label = Label;
        _ui.registerControl(Label, 'meta', false, 'label', null);
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="./absfield.control.ts" />
/// <reference path="../form.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _utils = Phoenix.utils, _ui = ui, _dom = Phoenix.dom, _ulocale = Phoenix.ulocale;
        function _addDesign(id, options, authoring, html) {
            if (authoring)
                html.push(' draggable="true"');
            html.push(' data-render="{0}"');
        }
        function _createButton(id, options, authoring, title) {
            title = title || '';
            options = $.extend({ right: false, icon: null, type: 'default', size: null }, options);
            if (options.title !== undefined)
                title = options.title;
            var html = [];
            if (!options.inline) {
                html.push('<div class="bs-field-group"');
                _ui.Utils.addContainerId(html, authoring);
                html.push('>');
            }
            html.push('<button type="button"');
            html.push(' class="bs-button btn btn-' + _dom.bootstrapStyles[options.type]);
            if (options.size)
                html.push(' btn-' + options.size);
            if (!options.inline) {
                html.push(' btn-block');
            }
            else {
                html.push(' bs-btn-inline');
                if (options.right)
                    html.push(' pull-right');
            }
            html.push(' bs-island');
            if (authoring)
                html.push(' design');
            if (options.style)
                html.push(' ' + options.style);
            html.push('"');
            if (options.inline) {
                _ui.Utils.addContainerId(html, authoring);
            }
            html.push('>');
            if (options.icon) {
                html.push('<span class="' + _dom.iconClass(options.icon) + '"></span>');
                if (title && !options.titleIsHidden)
                    html.push('&nbsp;');
            }
            if (!options.titleIsHidden)
                html.push(title || '');
            html.push('</button>');
            if (!options.inline) {
                html.push('</div>');
            }
            return _utils.format(html.join(''), id);
        }
        ;
        var Link = (function (_super) {
            __extends(Link, _super);
            function Link(fp, options, form) {
                _super.call(this, fp, options, form);
                this._state();
            }
            Link.prototype._button = function () {
                var that = this;
                return that.renderOptions.inline ? that.$element.get(0) : that.$element.get(0).firstChild;
            };
            Link.prototype.click = function (event) {
                var that = this;
                that.form.execAction(that.$bind);
            };
            Link.prototype._setDisabled = function (button, element) {
                var that = this;
                button.disabled = that.state.isDisabled;
                if (that.state.isDisabled)
                    _dom.addClass(button, 'disabled');
                else
                    _dom.removeClass(button, 'disabled');
            };
            Link.prototype._state2UI = function () {
                var that = this;
                var button = that._button();
                var element = that.$element ? that.$element.get(0) : null;
                if (button) {
                    that._setDisabled(button, element);
                    that.setHidden(element);
                }
            };
            Link.prototype.stateChanged = function (propName, params) {
                var that = this;
                var state = that.form.getState(that.$bind);
                var button = that._button();
                var element = that.$element ? that.$element.get(0) : null;
                if (state.isHidden !== that.state.isHidden) {
                    that.state.isHidden = state.isHidden;
                    if (button)
                        that.setHidden(element);
                }
                if (state.isDisabled != that.state.isDisabled) {
                    that.state.isDisabled = state.isDisabled;
                    if (button)
                        that._setDisabled(button, element);
                }
            };
            Link.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    that.$element = $(_createButton(that.id, opts, that.options.design, _ulocale.tt(that.$schema ? that.$schema.title : that.$bind, that.form.$locale)));
                    that._state2UI();
                }
                that.appendElement($parent, opts);
                return that.$element;
            };
            return Link;
        }(ui.AbsField));
        ui.Link = Link;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="../../../core/modules/locale.ts" />
/// <reference path="../../../data/datasets.ts" />
/// <reference path="../schema.data.ts" />
/// <reference path="./absfield.control.ts" />
/// <reference path="./edit.control.ts" />
/// <reference path="./dropitems.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _sutils = Phoenix.Observable.SchemaUtils, _data = Phoenix.data, _utils = Phoenix.utils, _dom = Phoenix.dom, _locale = Phoenix.locale, _ulocale = Phoenix.ulocale, _ui = ui, _device = Phoenix.device;
        var specialKeyCodeMap = {
            27: "esc",
            9: "tab",
            13: "enter",
            33: "pgUp",
            34: "pgDown",
            35: "end",
            36: "home",
            38: "up",
            40: "down",
            115: 'f4'
        };
        var withModifier = function ($event) {
            return $event.altKey || $event.ctrlKey || $event.metaKey || $event.shiftKey;
        }, defOptions = {
            autoComplete: false,
            maxItems: -1
        }, _lookupEnumValue2Text = function (value, $lookup) {
            if (value === "" || value === null || value === undefined) {
                return '';
            }
            if ($lookup && $lookup.data && $lookup.data.$value) {
                var values = $lookup.data.$value;
                for (var i = 0, len = values.length; i < len; i++) {
                    var item = values[i];
                    if (item.code === value)
                        return item.title;
                }
                return value || '';
            }
            return value || '';
        }, _filterData = function (ldata, filter, context) {
            if (ldata.value)
                ldata = ldata.value;
            if (filter) {
                var res_3 = [];
                var f_1 = _data.compileFilterTree(filter, null, context, null);
                ldata.forEach(function (item) {
                    if (_data.acceptFilter(f_1, item))
                        res_3.push(item);
                });
                return res_3;
            }
            return ldata;
        };
        var Lookup = (function (_super) {
            __extends(Lookup, _super);
            function Lookup(fp, options, form) {
                _super.call(this, fp, options, form);
                var that = this;
                that.lookupOptions = defOptions;
                that.eventBus = new Phoenix.utils.SingleEventBus(50);
                that.onselectItemHandler = that._onselectItem.bind(that);
                that.isEnum = (that.$lookup && that.$lookup.data && that.$lookup.data.$type === 'enum');
            }
            Lookup.prototype.customOptions = function (options) {
                options.after = { icon: 'chevron-down' };
            };
            Lookup.prototype._value2Text = function () {
                var that = this;
                if (that.isEnum) {
                    return _lookupEnumValue2Text(that.state.value, that.$lookup);
                }
                else
                    return that.state.value || '';
            };
            //TEST
            Lookup.prototype._getSource = function (options) {
                var that = this;
                var pm = that.form.getParentModel(that.$bind);
                //options: {search: '', select: false,  find: false, findFirst: true}
                if (!that.$lookup.data || !that.$lookup.data.$type) {
                    return _utils.dataAsPromise(null);
                }
                if (that.$lookup.data.$type === 'inline' || that.$lookup.data.$type === 'enum')
                    return _utils.dataAsPromise(_filterData(that.$lookup.data.$value, (that.$lookup.data && that.$lookup.data.$params ? that.$lookup.data.$params.$filter : null), pm.model(true)));
                if (_sutils.allData(that.$lookup)) {
                    if (that.$lookup.cache && that.hasCachedData)
                        return _utils.dataAsPromise(that.cachedData);
                    else
                        return _sutils.executeLookup(that.$lookup, that.form.getParentModel(that.$bind));
                }
                else
                    return _sutils.executeLookup(that.$lookup, that.form.getParentModel(that.$bind));
            };
            Lookup.prototype._filterResult = function (ldata, opts) {
                var that = this;
                if (ldata && Array.isArray(ldata)) {
                    ldata = { value: ldata };
                }
                else if (ldata && ldata.documents) {
                    ldata.value = ldata.documents;
                    delete ldata.documents;
                }
                if (_sutils.allData(that.$lookup)) {
                    if (that.$lookup.cache && !that.hasCachedData) {
                        that.hasCachedData = true;
                        that.cachedData = ldata;
                    }
                    if (opts.findFirst && !opts.search)
                        return null;
                    if (opts.search && ldata && ldata.value) {
                        if (opts.findFirst) {
                            var fi = _sutils.findFirst(opts.search, that.isEnum ? 'title' : _sutils.remoteSearch(_sutils.lastSegment(that.$bind, that.$display), that.$lookup), ldata.value);
                            if (fi)
                                return { value: [fi.item] };
                            return null;
                        }
                    }
                }
                return ldata;
            };
            Lookup.prototype._findselected = function (ldata, opts) {
                var that = this;
                if (opts.search && opts.select && ldata && ldata.value) {
                    var fi = _sutils.findFirst(opts.search, that.isEnum ? 'title' : _sutils.remoteSearch(_sutils.lastSegment(that.$bind, that.$display), that.$lookup), ldata.value);
                    if (fi)
                        return fi.index;
                }
                return -1;
            };
            Lookup.prototype._findValue = function (search, after) {
                var that = this;
                if (!search && search === '')
                    that.eventBus.push(null, function (ldata) { after(null); }, true);
                var opts = { search: search, select: false, findFirst: true, find: false };
                that.eventBus.push(that._getSource(opts), function (ldata) {
                    ldata = that._filterResult(ldata, opts);
                    if (ldata && ldata.value && ldata.value.length)
                        after(ldata.value[0]);
                    else
                        after(null);
                }, true);
            };
            Lookup.prototype._onselectItem = function (value) {
                var that = this;
                that.eventBus.push(value, function (ldata) {
                    var mapping = Object.keys(that.$lookup.mapping);
                    var base = _sutils.extractBase(that.$bind);
                    mapping.forEach(function (key) {
                        that.form.setValue(base + key, ldata ? ldata[that.$lookup.mapping[key]] || '' : '');
                    });
                    var input = that._input();
                    if (input.value != that._value2Text())
                        that._value2Input(input);
                }, true);
            };
            Lookup.prototype._checkPopupMenu = function () {
                var that = this;
                if (!that.menu) {
                    var input = that._input();
                    var $parent = that.$element;
                    if (that.renderOptions.columns) {
                        $parent = $(that._colParent());
                    }
                    that.menu = new ui.DropItems($parent, input, {
                        primaryKey: that.$lookup.primaryKey,
                        search: that.isEnum ? 'title' : _sutils.remoteSearch(_sutils.lastSegment(that.$bind, that.$display), that.$lookup),
                        onselect: that.onselectItemHandler
                    });
                }
            };
            Lookup.prototype.mousedown = function (event) {
                var that = this;
                if (that.menu && that.menu.opened && that.menu.inMenu(event.target)) {
                    event.stopPropagation();
                    return false;
                }
                return _super.prototype.mousedown.call(this, event);
            };
            Lookup.prototype.stopProppagation = function (event) {
                var that = this;
                _super.prototype.stopProppagation.call(this, event);
                if (that.menu && that.menu.opened && that.menu.inMenu(event.target)) {
                    event.preventDefault();
                    event.stopPropagation();
                }
            };
            Lookup.prototype.click = function (event) {
                var that = this;
                var input = that._input();
                if (_dom.isChildOf(input.parentNode.lastChild, event.target)) {
                    if (_sutils.supportPagination(that.$lookup)) {
                    }
                    else {
                        that._checkPopupMenu();
                        if (that.menu.opened)
                            this.eventBus.push(null, function (ldata) { that.menu.hide(event.target); }, true);
                        else {
                            var opts = { search: input.value, select: true, find: false, findFirst: false };
                            that.eventBus.push(that._getSource(opts), function (ldata) {
                                ldata = that._filterResult(ldata, opts);
                                var si = -1;
                                if (opts.select)
                                    si = that._findselected(ldata, opts);
                                that.menu.show(ldata, si, false);
                            }, true);
                        }
                    }
                }
                else if (that.menu && that.menu.opened && that.menu.inMenu(event.target)) {
                    that.menu.click(event);
                }
            };
            Lookup.prototype.beforeAppend = function () {
                var that = this;
                //_sutils.executeLookup(that.$lookup, null, function(data) {
                //});
            };
            Lookup.prototype._managePreventDefault = function (keyName, $event) {
                var preventDefault;
                switch (keyName) {
                    case 'up':
                    case 'pgDown':
                    case 'pgUp':
                    case 'home':
                    case 'end':
                        preventDefault = !withModifier($event);
                        break;
                    case 'down':
                        if ($event.ctrlKey) {
                            preventDefault = true;
                            keyName = 'f4';
                        }
                        else
                            preventDefault = !withModifier($event);
                        break;
                    default:
                        preventDefault = false;
                }
                preventDefault && $event.preventDefault() && $event.stopPropagation();
                return keyName;
            };
            Lookup.prototype._shouldTrigger = function (keyName, $event) {
                var trigger;
                switch (keyName) {
                    case 'tab':
                        trigger = !withModifier($event);
                        break;
                    default:
                        trigger = true;
                }
                return trigger;
            };
            Lookup.prototype.setEvents = function (opts) {
                var that = this;
                $(that._input()).on('input', function () {
                    that.inputChanged();
                });
            };
            Lookup.prototype.removeEvents = function () {
                var that = this;
                $(that._input()).off('input');
            };
            Lookup.prototype.inputChanged = function () {
                var that = this;
                var input = that._input();
                that.modified = (input.value != that._value2Text());
                that.trigger('inputChanged', null);
            };
            Lookup.prototype.checkValue = function (nv, after) {
                var that = this;
                var input = that._input();
                var modified = (input.value != that._value2Text());
                if (modified) {
                    that._findValue(input.value, function (val) {
                        that._onselectItem(val);
                    });
                }
                else
                    after(that.state.value);
            };
            Lookup.prototype.keydown = function ($event) {
                var that = this, keyName = specialKeyCodeMap[$event.which || $event.keyCode];
                keyName = that._managePreventDefault(keyName, $event);
                if (keyName && that._shouldTrigger(keyName, $event)) {
                    that.trigger(keyName + 'Keyed', $event);
                }
            };
            Lookup.prototype.focusOut = function (event) {
                var that = this;
                if (that.menu && that.menu.opened)
                    this.eventBus.push(null, function (ldata) { that.menu.hide(null); }, true);
                _super.prototype.focusOut.call(this, event);
                //console.log("focus-out")
            };
            Lookup.prototype.focusIn = function (event) {
                //console.log("focus-in")
                var that = this;
                this.trigger('focused');
            };
            Lookup.prototype.trigger = function (event, $event) {
                var that = this;
                var input = that._input();
                if (that.menu && that.menu.opened) {
                    switch (event) {
                        case 'escKeyed':
                            that.eventBus.push(null, function (ldata) { that.menu.hide(null); }, true);
                            break;
                        case "enterKeyed":
                            that.eventBus.push(null, function (ldata) { that.menu.select(); }, true);
                            break;
                        case 'upKeyed':
                            that.eventBus.push(null, function (ldata) { that.menu.move(-1); }, true);
                            break;
                        case 'downKeyed':
                            that.eventBus.push(null, function (ldata) { that.menu.move(1); }, true);
                            break;
                        case 'homeKeyed':
                            that.eventBus.push(null, function (ldata) { that.menu.move(-1000); }, true);
                            break;
                        case 'endKeyed':
                            that.eventBus.push(null, function (ldata) { that.menu.move(1000); }, true);
                            break;
                        case 'pgDownKeyed':
                            that.eventBus.push(null, function (ldata) { that.menu.move(7); }, true);
                            break;
                        case 'pgUpKeyed':
                            that.eventBus.push(null, function (ldata) { that.menu.move(-7); }, true);
                            break;
                        case 'inputChanged':
                            var opts = { search: input.value, select: true, find: false, findFirst: false };
                            this.eventBus.push(that._getSource(opts), function (ldata) {
                                if (that.menu && that.menu.opened) {
                                    opts.search = input.value;
                                    ldata = that._filterResult(ldata, opts);
                                    var si = -1;
                                    if (opts.select)
                                        si = that._findselected(ldata, opts);
                                    that.menu.show(ldata, si, true);
                                }
                            }, false);
                            break;
                    }
                }
                else {
                    if (event == 'f4Keyed') {
                        if (_sutils.supportPagination(that.$lookup)) {
                        }
                        else {
                            if (!that.menu || !that.menu.opened) {
                                that._checkPopupMenu();
                                var opts = { search: input.value, select: true, find: false, findFirst: false };
                                that.eventBus.push(that._getSource(opts), function (ldata) {
                                    ldata = that._filterResult(ldata, opts);
                                    var si = -1;
                                    if (opts.select)
                                        si = that._findselected(ldata, opts);
                                    that.menu.show(ldata, si, false);
                                }, true);
                            }
                        }
                    }
                }
            };
            Lookup.prototype.destroy = function () {
                var that = this;
                that.onselectItemHandler = null;
                that.cachedData = null;
                if (that.menu) {
                    that.menu.destroy();
                    that.menu = null;
                }
                _super.prototype.destroy.call(this);
            };
            return Lookup;
        }(ui.Edit));
        ui.Lookup = Lookup;
        _ui.registerControl(Lookup, 'string', false, '', { lookup: true });
        _ui.registerControl(Lookup, 'number', false, '', { lookup: true });
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="../../../core/modules/locale.ts" />
/// <reference path="./absfield.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _dom = Phoenix.dom, _locale = Phoenix.locale, _ulocale = Phoenix.ulocale, _ui = ui, _device = Phoenix.device, _observable = Phoenix.Observable, _odata = Phoenix.data.odata, _du = _observable.DataUtils;
        var _createPicture = function (id, options, authoring, title, editable) {
            var html = [];
            title = title || '';
            _ui.Utils.fieldWrapper(html, options, authoring, function () {
                var _bootstrap4 = Phoenix.bootstrap4;
                if (!options.titleIsHidden) {
                    html.push('<label id="{0}_label"');
                    var css = ['bs-label'];
                    if (options.columns) {
                        if (_bootstrap4) {
                            css.push('form-control-label');
                        }
                        else {
                            css.push('checkbox-inline bs-cursor-d');
                        }
                        css.push('bs-lib-col col-sm-' + options.labelCol);
                    }
                    if (options.inline) {
                        css.push('checkbox-inline bs-cursor-d no-x-padding');
                    }
                    if (css.length)
                        html.push(' class="' + css.join(' ') + '"');
                    html.push('>');
                    html.push(_utils.escapeHtml(title || '') + (options.inline ? '&nbsp;' : ''));
                    if (options.description)
                        _ui.Utils.addTooltip(html, options.description, options);
                    html.push('</label>');
                }
                if (options.columns)
                    html.push('<div class="no-x-padding col-sm-' + (12 - options.labelCol) + '">');
                if (options.inline)
                    html.push('<span id="{0}_alt" class="bs-no-image">');
                else
                    html.push('<div id="{0}_alt" class="bs-no-image">');
                if (editable)
                    html.push('<input id="{0}_upload" class="bs-hidden-file" accept="image/*" type="file" />');
                var imgCss = ['bs-none bs-relative'];
                if (!options.inline)
                    imgCss.push(_bootstrap4 ? 'img-fluid' : 'img-responsive');
                html.push('<img id="{0}_img" class="');
                html.push(imgCss.join(' '));
                html.push('"/>');
                if (editable)
                    html.push('<div id="{0}_remove" class="bs-rt-button bs-image-remove bs-none"><span class="' + _dom.iconClass('times-circle') + '"></span></div>');
                if (options.inline)
                    html.push('</span>');
                else
                    html.push('</div>');
                if (options.columns)
                    html.push('</div>');
            }, null);
            return _utils.format(html.join(''), id);
        };
        var BasePicture = (function (_super) {
            __extends(BasePicture, _super);
            function BasePicture(fp, options, form) {
                _super.call(this, fp, options, form);
                this._state();
            }
            BasePicture.prototype._setDisabled = function (element) {
            };
            BasePicture.prototype._setReadOnly = function (element) {
                this._setDisabled(element);
            };
            BasePicture.prototype._setMandatory = function (element) { };
            BasePicture.prototype._state2UI = function () {
                var that = this, img = that._img(), element = that.$element ? that.$element.get(0) : null;
                if (img) {
                    that._showValue(that.state.value);
                    that._setDisabled(element);
                    that._setReadOnly(element);
                    that.setHidden(element);
                }
            };
            BasePicture.prototype._showValue = function (value) {
            };
            BasePicture.prototype.changed = function (propName, ov, nv, op) {
                var that = this, img = that._img();
                if (that.state.value !== nv) {
                    that.state.value = nv;
                    that._showValue(that.state.value);
                }
            };
            BasePicture.prototype.stateChanged = function (propName, params) {
                var that = this, state = that.form.getState(that.$bind), element = that.$element ? that.$element.get(0) : null;
                if (state.isHidden !== that.state.isHidden) {
                    that.state.isHidden = state.isHidden;
                    if (element)
                        that.setHidden(element);
                }
                if (state.isDisabled != that.state.isDisabled) {
                    that.state.isDisabled = state.isDisabled;
                    if (element)
                        that._setDisabled(element);
                }
                if (state.isReadOnly != that.state.isReadOnly) {
                    that.state.isReadOnly = state.isReadOnly;
                    if (element)
                        that._setReadOnly(element);
                }
                if (state.isMandatory != that.state.isMandatory) {
                    that.state.isMandatory = state.isMandatory;
                    if (element)
                        that._setMandatory(element);
                }
            };
            BasePicture.prototype._img = function () {
                var that = this, e = that.$element.get(0), img = e ? _dom.find(e, that.id + '_img') : null;
                return img;
            };
            BasePicture.prototype._altimg = function () {
                var that = this, e = that.$element.get(0), img = e ? _dom.find(e, that.id + '_alt') : null;
                return img;
            };
            BasePicture.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    opts.title = _ulocale.tt(that.$schema.title, that.form.$locale);
                    that.$element = $(_createPicture(that.id, opts, that.options.design, opts.title, that.editable));
                    that._state2UI();
                    that.setEvents(opts);
                }
                that.appendElement($parent, opts);
                return that.$element;
            };
            return BasePicture;
        }(ui.AbsField));
        ui.BasePicture = BasePicture;
        var Picture = (function (_super) {
            __extends(Picture, _super);
            function Picture(fp, options, form) {
                _super.call(this, fp, options, form);
                this.editable = true;
            }
            Picture.prototype._createImage = function (event) {
                var that = this;
                var files = event.target.files; // FileList object
                if (files && files.length) {
                    var f = files[0];
                    if (!f.type.match('image.*'))
                        return;
                    var URL = window.URL || window['webkitURL'];
                    if (URL) {
                        var nv_1 = {
                            id: that.state.value ? that.state.value.id : undefined,
                            fileName: f.name,
                            value: '',
                            url: that.state.value ? that.state.value.url : undefined,
                            contentType: f.type,
                        };
                        if (f.type === 'image/svg+xml') {
                            var reader = new FileReader();
                            reader.onload = function (e) {
                                nv_1.value = reader.result;
                                that.form.setValue(that.$bind, nv_1);
                            };
                            reader.readAsDataURL(f);
                        }
                        else {
                            var img = document.createElement('img');
                            var canvas = document.createElement("canvas");
                            img.src = URL.createObjectURL(f);
                            img.onload = function () {
                                var div = 1;
                                var v = (img.width * img.height);
                                if (v > 1200000) {
                                    div = 2;
                                }
                                else if (v > 2400000) {
                                    div = 4;
                                }
                                else if (v > 4000000) {
                                    div = 8;
                                }
                                canvas.width = img.width / div;
                                canvas.height = img.height / div;
                                var ctx = canvas.getContext("2d");
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                nv_1.value = canvas.toDataURL();
                                that.form.setValue(that.$bind, nv_1);
                            };
                        }
                    }
                }
            };
            Picture.prototype._removeImage = function () {
                var that = this;
                var nv = {
                    id: that.state.value ? that.state.value.id : undefined,
                    value: ''
                };
                that.form.setValue(that.$bind, nv);
            };
            Picture.prototype.click = function (event) {
                var that = this;
                if (!that.state.isDisabled && !that.state.isReadOnly) {
                    var rId = that.id + '_remove';
                    if (event.target.id === rId || event.target.parentNode.id === rId) {
                        that._removeImage();
                    }
                    else {
                        var upload = that._upload();
                        upload.click();
                    }
                }
            };
            Picture.prototype._upload = function () {
                var that = this, e = that.$element.get(0), input = e ? _dom.find(e, that.id + '_upload') : null;
                return input;
            };
            Picture.prototype.setEvents = function (opts) {
                var that = this;
                var input = that._upload();
                if (input) {
                    $(input).on("change", function (event) {
                        that._createImage(event);
                    });
                }
            };
            Picture.prototype.removeEvents = function () {
                var that = this;
                var input = that._upload();
                if (input)
                    $(input).off("change");
            };
            Picture.prototype._setDisabled = function (element) {
                var that = this, upload = that._upload();
                upload.disabled = that.state.isDisabled || that.state.isReadOnly;
                that._showRemoveImage(that.state.value);
            };
            Picture.prototype._showRemoveImage = function (value) {
                var that = this;
                var isRemoveVisible = (!that.state.isHidden && !that.state.isDisabled && !that.state.isReadOnlyd);
                if (isRemoveVisible)
                    isRemoveVisible = value && (value.url || value.value);
                var tmvElem = that._rmv();
                if (tmvElem) {
                    if (isRemoveVisible)
                        _dom.removeClass(tmvElem, 'bs-none');
                    else
                        _dom.addClass(tmvElem, 'bs-none');
                }
            };
            Picture.prototype._rmv = function () {
                var that = this, e = that.$element.get(0), img = e ? _dom.find(e, that.id + '_remove') : null;
                return img;
            };
            Picture.prototype._showValue = function (value) {
                var that = this, img = that._img(), alt = that._altimg();
                if (img) {
                    var hasImage = false;
                    if (value) {
                        if (value.value !== undefined) {
                            if (value.value) {
                                img.src = value.value;
                                hasImage = true;
                            }
                            else
                                img.src = '';
                        }
                        else if (value.url) {
                            if (value.url.indexOf('{{baseUrl}}') >= 0) {
                                var ds = _du.extractMainDataSource(that.form.$model);
                                if (!ds) {
                                    ds = { $module: that.renderOptions.$module, $context: that.renderOptions.$context };
                                }
                                var baseUrl = _odata.baseUrl(ds);
                                var surl = _utils.execAngularExpression(value.url, { baseUrl: _odata.baseUrl(ds) || '' });
                                img.src = _odata.addImageUrlToken(surl);
                            }
                            else
                                img.src = '';
                            hasImage = true;
                        }
                        else
                            img.src = '';
                    }
                    else
                        img.src = '';
                    if (hasImage) {
                        _dom.removeClass(img, 'bs-none');
                        _dom.removeClass(alt, 'bs-no-image');
                    }
                    else {
                        _dom.addClass(img, 'bs-none');
                        _dom.addClass(alt, 'bs-no-image');
                    }
                    that._showRemoveImage(value);
                }
            };
            return Picture;
        }(BasePicture));
        ui.Picture = Picture;
        var ImageUrl = (function (_super) {
            __extends(ImageUrl, _super);
            function ImageUrl(fp, options, form) {
                _super.call(this, fp, options, form);
                this.editable = false;
            }
            ImageUrl.prototype._showValue = function (value) {
                var that = this, img = that._img(), alt = that._altimg();
                if (img) {
                    var hasImage = false;
                    if (value) {
                        img.src = value;
                        hasImage = true;
                    }
                    if (hasImage) {
                        _dom.removeClass(img, 'bs-none');
                        _dom.removeClass(alt, 'bs-no-image');
                    }
                    else {
                        _dom.addClass(img, 'bs-none');
                        _dom.addClass(alt, 'bs-no-image');
                    }
                }
            };
            return ImageUrl;
        }(BasePicture));
        ui.ImageUrl = ImageUrl;
        _ui.registerControl(Picture, "string", false, '', { format: 'stream' });
        _ui.registerControl(ImageUrl, "string", false, 'imageurl', {});
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="./group.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _dom = Phoenix.dom, _ulocale = Phoenix.ulocale;
        var _createRadioGroups = function (id, options, authoring, title, enums, enumsNames) {
            title = title || '';
            options = $.extend({ titleIsHidden: false, placeHolder: false, columns: false, horizontal: false }, options);
            var html = [];
            var customize = null;
            _ui.Utils.fieldWrapper(html, options, authoring, function () {
                var _bootstrap4 = Phoenix.bootstrap4;
                if (!options.titleIsHidden) {
                    html.push('<label for="{0}_input" id="{0}_label"');
                    var css = ['bs-label'];
                    if (options.columns) {
                        if (_bootstrap4) {
                            css.push('form-control-label');
                        }
                        else {
                            css.push('checkbox-inline bs-cursor-d');
                        }
                        css.push('bs-lib-col col-sm-' + options.labelCol);
                    }
                    if (options.inline) {
                        css.push('checkbox-inline bs-cursor-d no-x-padding');
                    }
                    if (css.length)
                        html.push(' class="' + css.join(' ') + '"');
                    html.push('>');
                    html.push(_utils.escapeHtml(title || '') + (options.inline ? '&nbsp;' : ''));
                    if (options.description)
                        _ui.Utils.addTooltip(html, options.description, options);
                    html.push('</label>');
                    if (!options.inline && options.horizontal)
                        html.push('<div></div>'); //line
                }
                if (options.columns)
                    html.push('<div class="no-x-padding  col-sm-' + (12 - options.labelCol) + '">');
                var lc = options.inline || options.horizontal ? ["radio-inline"] : [];
                enums.forEach(function (enumName, index) {
                    if (!options.inline && !options.horizontal)
                        html.push('<div id="{0}_radio" class="radio">');
                    html.push('<label');
                    if (lc.length)
                        html.push(' class="' + lc.join(' ') + '"');
                    html.push('>');
                    html.push('<input type="radio" name="{0}_input" id="{0}_item_' + index + '" value="' + enumName + '">');
                    html.push('&nbsp;');
                    html.push(_utils.escapeHtml(enumsNames[index] || ''));
                    html.push('</label>');
                    if (!options.inline && !options.horizontal)
                        html.push('</div>');
                });
                if (options.columns)
                    html.push('</div>');
            }, customize);
            return _utils.format(html.join(''), id);
        };
        var RadioGroup = (function (_super) {
            __extends(RadioGroup, _super);
            function RadioGroup(fp, options, form) {
                _super.call(this, fp, options, form);
                this._state();
            }
            RadioGroup.prototype._state2UI = function () {
                _super.prototype._state2UI.call(this, function (item) {
                    item.checked = true;
                });
            };
            RadioGroup.prototype.changed = function (propName, ov, nv, op) {
                var that = this;
                if (that.state.value != nv) {
                    that.state.value = nv;
                    var ii = that.$schema.enum.indexOf(that.state.value);
                    var input = _super.prototype._item.call(this, ii);
                    if (input)
                        input.checked = true;
                }
            };
            RadioGroup.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    var enumNames = that.$schema.enumNames || that.$schema.enum;
                    enumNames = enumNames.map(function (v) { return _ulocale.tt(v, that.form.$locale); });
                    if (that.$schema.description)
                        opts.description = _ulocale.tt(that.$schema.description, that.form.$locale);
                    that.$element = $(_createRadioGroups(that.id, opts, that.options.design, _ulocale.tt(that.$schema.title, that.form.$locale), that.$schema.enum, enumNames));
                    that.setEvents(opts);
                    that._state2UI();
                }
                that.appendElement($parent, opts);
                return that.$element;
            };
            return RadioGroup;
        }(ui.Group));
        ui.RadioGroup = RadioGroup;
        _ui.registerControl(RadioGroup, "*", true, "radio", null);
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="./absfield.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _dom = Phoenix.dom, _ulocale = Phoenix.ulocale;
        function _createReadOnly(id, options, authoring, title, valuepattern) {
            title = title || '';
            options = $.extend({ titleIsHidden: false }, options);
            var html = [];
            _ui.Utils.fieldWrapper(html, options, authoring, function () {
                html.push('<div style="background-color: red;">' + title + '</div>');
            });
            return _utils.format(html.join(''), id);
        }
        ;
        var ReadOnlyField = (function (_super) {
            __extends(ReadOnlyField, _super);
            function ReadOnlyField(fp, options, form) {
                _super.call(this, fp, options, form);
                var that = this;
                that._map = [];
                if (fp.options && fp.options.$expression) {
                    that.$expression = fp.options.$expression;
                    _utils.extractAngularVars(that.$expression, that._map);
                }
                else {
                    that.$expression = _utils.format('{0}: {{{1}}}', _utils.escapeHtml(_ulocale.tt(that.$schema.title, that.form.$locale)), that.$bind);
                    that._map.push({ name: that.$bind });
                }
                that._map.forEach(function (map) {
                    if (map.name != that.$bind) {
                        map.schema = form.getSchema(map.name);
                        that.form.registerListenerFor(map.name, that);
                    }
                    else
                        map.schema = that.$schema;
                });
                this._state();
            }
            ReadOnlyField.prototype._state = function () {
                var that = this;
                that.state = that.state || {};
                that.state.values = that.state.values || {};
                that.state.fvalues = that.state.fvalues || {};
                var state = that.form.getState(that.$bind);
                that.state.isHidden = state.isHidden;
                that._refreshValues();
            };
            ReadOnlyField.prototype._refreshValues = function () {
                var that = this;
                that._map.forEach(function (map) {
                    that.state.values[map.name] = that.form.getValue(map.name);
                    var cs = that.form.getState(map.name);
                    that.state.fvalues[map.name] = _ui.Utils.displayValue(that.state.values[map.name], map.schema, that.form.$locale, { html: false, useSymbol: true, state: cs }, that.state.values, map.name).value;
                });
            };
            ReadOnlyField.prototype._value2UI = function () {
                var that = this, element = that.$element ? that.$element.get(0) : null;
                var nv = _utils.execAngularExpression(that.$expression, that.state.fvalues, true);
                var r = $('<div>' + nv + '</div>').get(0);
                _dom.empty(element);
                while (r.childNodes.length > 0) {
                    element.appendChild(r.childNodes[0]);
                }
            };
            ReadOnlyField.prototype._findMap = function (pn) {
                var that = this;
                for (var i = 0, len = that._map.length; i < len; i++) {
                    var cm = that._map[i];
                    if (cm.name === pn)
                        return cm;
                }
                return null;
            };
            ReadOnlyField.prototype.changed = function (propName, ov, nv, op) {
                var that = this;
                that._refreshValues();
                that._value2UI();
            };
            ReadOnlyField.prototype.stateChanged = function (propName, params) {
                var that = this, state = that.form.getState(that.$bind), element = that.$element ? that.$element.get(0) : null;
                if (state.isHidden !== that.state.isHidden) {
                    that.state.isHidden = state.isHidden;
                    if (element)
                        that.setHidden(element);
                }
                if (state.symbol !== that.state.symbol)
                    state.symbol = that.state.symbol;
                if (state.decimals !== that.state.decimals)
                    state.decimals = that.state.decimals;
            };
            ReadOnlyField.prototype._state2UI = function () {
                var that = this, element = that.$element ? that.$element.get(0) : null;
                if (element) {
                    that.setHidden(element);
                    that._value2UI();
                }
            };
            ReadOnlyField.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    that.$element = $(_createReadOnly(that.id, opts, that.options.design, _ulocale.tt(that.$schema.title, that.form.$locale), ''));
                    that._state2UI();
                }
                that.appendElement($parent, opts);
                return that.$element;
            };
            ReadOnlyField.prototype.destroy = function () {
                var that = this;
                that._map.forEach(function (map) {
                    if (map.name != that.$bind) {
                        that.form.unRegisterListenerFor(map.name, that);
                    }
                });
                _super.prototype.destroy.call(this);
            };
            return ReadOnlyField;
        }(ui.AbsField));
        ui.ReadOnlyField = ReadOnlyField;
        _ui.registerControl(ReadOnlyField, "*", false, '', { readOnly: true });
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="../../../core/modules/locale.ts" />
/// <reference path="./absfield.control.ts" />
/// <reference path="../schema.data.ts" />
/// <reference path="../errors.data.ts" />
/// <reference path="./edit.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _dom = Phoenix.dom, _locale = Phoenix.locale, _su = Phoenix.Observable.SchemaUtils, _ulocale = Phoenix.ulocale, _ui = ui;
        ;
        var _createSelectInput = function (id, options, authoring, title, enums, enumsNames) {
            title = title || '';
            options = $.extend({ titleIsHidden: false, placeHolder: false, columns: false, labelCol: 3 }, options);
            var html = [];
            if (options.titleIsHidden) {
                options.columns = false;
            }
            options.placeHolder = false;
            _ui.Utils.fieldWrapper(html, options, authoring, function () {
                var _bootstrap4 = Phoenix.bootstrap4;
                if (!options.titleIsHidden) {
                    html.push('<label for="{0}_input" id="{0}_label"');
                    var css = ['bs-label'];
                    if (options.columns) {
                        if (_bootstrap4) {
                            css.push('form-control-label');
                        }
                        else {
                            css.push('checkbox-inline bs-cursor-d');
                        }
                        css.push('bs-lib-col col-sm-' + options.labelCol);
                    }
                    if (options.inline) {
                        css.push('no-x-padding checkbox-inline bs-cursor-d');
                    }
                    if (css.length)
                        html.push(' class="' + css.join(' ') + '"');
                    html.push('>');
                    html.push(_utils.escapeHtml(title || '') + (options.inline ? '&nbsp;' : ''));
                    if (options.description)
                        _ui.Utils.addTooltip(html, options.description, options);
                    html.push('</label>');
                }
                if (options.columns)
                    html.push('<div class="no-x-padding col-sm-' + (12 - options.labelCol) + '">');
                html.push('<select class="form-control');
                if (options.size && _bootstrap4)
                    html.push(' form-control-' + options.size);
                html.push('" id="{0}_input"');
                var style = [];
                if (options.maxWidth)
                    style.push('max-width: ' + options.maxWidth + ';');
                if (options.minWidth)
                    style.push('min-width: ' + options.minWidth + ';');
                if (style.length)
                    html.push(' style="' + style.join('') + '"');
                html.push('>');
                enums.forEach(function (en, index) {
                    html.push('<option value="' + en + '">' + enumsNames[index] + '</option>');
                });
                html.push('</select>');
                _ui.Utils.addErrorDiv(html);
                if (options.columns)
                    html.push('</div>');
                if (options.titleIsHidden && options.description)
                    _ui.Utils.addTooltip(html, options.description, options);
            });
            return _utils.format(html.join(''), id);
        };
        var Select = (function (_super) {
            __extends(Select, _super);
            function Select(fp, options, form) {
                _super.call(this, fp, options, form);
            }
            Select.prototype.fillSelect = function (enums) {
                var that = this;
                _ui.Utils.fillSelect(enums, that._input(), that.$schema);
            };
            Select.prototype._state2UI = function () {
                var that = this;
                var input = that._input();
                if (input)
                    that._setFilter(true);
                _super.prototype._state2UI.call(this);
            };
            Select.prototype._setFilter = function (inRender) {
                var that = this;
                var cf = that.state.filter;
                if (inRender && !cf)
                    return;
                var enums = cf ? that.$schema.filters[cf] || [] : that.$schema.enum;
                that.fillSelect(enums);
                if (!inRender) {
                    var ii = enums.indexOf(that.state.value);
                    if (ii < 0) {
                        that.form.setValue(that.$display, enums.length ? enums[0] : null);
                    }
                    else {
                        var input = that._input();
                        if (input)
                            that._value2Input(input);
                    }
                }
            };
            Select.prototype.stateChanged = function (propName, params) {
                var that = this;
                var state = that.form.getState(that.$bind);
                _super.prototype.stateChanged.call(this, propName, params);
                if (!propName || (propName === 'filter')) {
                    if (that.state.filter !== state.filter) {
                        that.state.filter = state.filter;
                        that._setFilter(false);
                    }
                }
            };
            Select.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    var enumNames = that.$schema.enumNames || that.$schema.enum;
                    enumNames = enumNames.map(function (v) { return _ulocale.tt(v + '', that.form.$locale); });
                    opts.title = _ulocale.tt(that.$schema.title, that.form.$locale);
                    if (that.$schema.description)
                        opts.description = _ulocale.tt(that.$schema.description, that.form.$locale);
                    var cf = that.state.filter;
                    var enums = cf ? that.$schema.filters[cf] || [] : that.$schema.enum;
                    if (cf) {
                    }
                    that.$element = $(_createSelectInput(that.id, opts, that.options.design, opts.title, enums, enumNames));
                    that._state2UI();
                    that.setEvents(opts);
                }
                that.appendElement($parent, opts);
                return that.$element;
            };
            Select.prototype.removeEvents = function () {
                var that = this;
                var input = that._input();
                $(input).off("change");
            };
            Select.prototype._value2Input = function (input) {
                var that = this;
                input.selectedIndex = that.state.filter ? that.$schema.filters[that.state.filter].indexOf(that.state.value) : that.$schema.enum.indexOf(that.state.value);
            };
            Select.prototype.setEvents = function (opts) {
                var that = this;
                var input = that._input();
                $(input).on("change", function (event) {
                    var ii = that._input();
                    var iv = that.state.filter ? that.$schema.filters[that.state.filter][ii.selectedIndex] : that.$schema.enum[ii.selectedIndex];
                    if (that.state.value !== iv) {
                        that.state.value = iv;
                        that.form.setValue(that.$display, that.state.value);
                    }
                });
            };
            return Select;
        }(ui.BaseEdit));
        ui.Select = Select;
        _ui.registerControl(Select, "*", true, '', null);
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../../../typings/index.d.ts" />
/// <reference path="../../../core/core.ts" />
/// <reference path="./absfield.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _dom = Phoenix.dom, _ulocale = Phoenix.ulocale;
        function _createToggle(id, options, authoring, title) {
            title = title || '';
            options = $.extend({ titleIsHidden: false, placeHolder: false, columns: false }, options);
            var html = [];
            _ui.Utils.fieldWrapper(html, options, authoring, function () {
                var _bootstrap4 = Phoenix.bootstrap4;
                if (!options.titleIsHidden) {
                    var css = ['bs-label'];
                    html.push('<label for="{0}_input" id="{0}_label"');
                    if (options.columns) {
                        if (_bootstrap4) {
                            css.push('form-control-label');
                        }
                        else {
                            css.push('checkbox-inline');
                        }
                        css.push('bs-lib-col col-sm-' + options.labelCol);
                    }
                    if (options.inline) {
                        css.push('checkbox-inline no-x-padding');
                    }
                    if (css.length)
                        html.push(' class="' + css.join(' ') + '"');
                    html.push('>');
                    html.push(_utils.escapeHtml(title || '') + (options.inline ? '&nbsp;' : ''));
                    if (options.description)
                        _ui.Utils.addTooltip(html, options.description, options);
                    html.push('</label>');
                }
                if (options.columns)
                    html.push('<div class="no-x-padding col-sm-' + (12 - options.labelCol) + '" id="{0}_colparent">');
                _createInput(html, options, title);
                if (options.columns)
                    html.push('</div>');
                if (options.titleIsHidden && options.description)
                    _ui.Utils.addTooltip(html, options.description, options);
            });
            return _utils.format(html.join(''), id);
        }
        ;
        function _createInput(html, options, title) {
            html.push('<input class="tgl tgl-light" id="{0}_input" type="checkbox">');
            html.push('<label class="tgl-btn" for="{0}_input"></label>');
        }
        ;
        var Toggle = (function (_super) {
            __extends(Toggle, _super);
            function Toggle(fp, options, form) {
                _super.call(this, fp, options, form);
                this._state();
            }
            Toggle.prototype._check = function () {
                var that = this, e = that.$element.get(0);
                return _dom.find(e, that.id + '_input');
            };
            Toggle.prototype.click = function (event) {
                var that = this, input = that._check(), value = input.checked || false;
                if (event.target != input)
                    return;
                if (that.state.value != value) {
                    that.state.value = value;
                    that.form.setValue(that.$bind, value);
                }
            };
            Toggle.prototype._setDisabled = function (input, element) {
                var that = this, check = that._check();
                if (that.state.isDisabled || that.state.isReadOnly)
                    _dom.addClass(check, "disabled");
                else
                    _dom.removeClass(check, "disabled");
                input.disabled = that.state.isDisabled;
            };
            Toggle.prototype._setReadOnly = function (input, element) {
                this._setDisabled(input, element);
            };
            Toggle.prototype._setMandatory = function (input, element) { };
            Toggle.prototype._state2UI = function () {
                var that = this, input = that._check(), element = that.$element ? that.$element.get(0) : null;
                if (input) {
                    input.checked = that.state.value || false;
                    that._setDisabled(input, element);
                    that._setReadOnly(input, element);
                    that.setHidden(element);
                }
            };
            Toggle.prototype.changed = function (propName, ov, nv, op) {
                var that = this, input = that._check();
                if (that.state.value != nv) {
                    that.state.value = nv;
                    input.checked = that.state.value || false;
                }
            };
            Toggle.prototype.stateChanged = function (propName, params) {
                var that = this, state = that.form.getState(that.$bind), input = that._check(), element = that.$element ? that.$element.get(0) : null;
                if (state.isHidden !== that.state.isHidden) {
                    that.state.isHidden = state.isHidden;
                    if (input)
                        that.setHidden(element);
                }
                if (state.isDisabled != that.state.isDisabled) {
                    that.state.isDisabled = state.isDisabled;
                    if (input)
                        that._setDisabled(input, element);
                }
                if (state.isReadOnly != that.state.isReadOnly) {
                    that.state.isReadOnly = state.isReadOnly;
                    if (input)
                        that._setReadOnly(input, element);
                }
                if (state.isMandatory != that.state.isMandatory) {
                    that.state.isMandatory = state.isMandatory;
                    if (input)
                        that._setMandatory(input, element);
                }
            };
            Toggle.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    if (that.$schema.description)
                        opts.description = _ulocale.tt(that.$schema.description, that.form.$locale);
                    that.$element = $(_createToggle(that.id, opts, that.options.design, _ulocale.tt(that.$schema.title, that.form.$locale)));
                    that._state2UI();
                }
                that.appendElement($parent, opts);
                return that.$element;
            };
            return Toggle;
        }(ui.AbsField));
        ui.Toggle = Toggle;
        _ui.registerControl(Toggle, "boolean", false, 'toggle', null);
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../core/core.ts" />
/// <reference path="./schema.data.ts" />
/// <reference path="./controls/absfield.control.ts" />
/// <reference path="./controls/link.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _render = Phoenix.render, _ui = ui, _observable = Phoenix.Observable, _sutils = Phoenix.Observable.SchemaUtils;
        var _controlFactory = function (fd, schema, lookup) {
            if (_sutils.isLink(fd.$bind)) {
                return ui.Link;
            }
            var meta = _sutils.isMeta(fd.$bind);
            if (meta) {
                return _ui.Utils.getRegisteredControl('meta', false, meta.widget, '', {});
            }
            if (!schema)
                return null;
            var options;
            if (fd.$readOnly) {
                options = options || {};
                options.readOnly = true;
            }
            if (lookup) {
                options = options || {};
                options.lookup = true;
            }
            return _ui.Utils.getRegisteredControl(schema.type, schema.enum ? true : false, fd.$widget, schema.format, options);
        };
        _render.register("javascript", 'field.control', _controlFactory);
        _render.register("angular", 'field.control', _controlFactory);
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../core/core.ts" />
/// <reference path="../core/modules/locale.ts" />
/// <reference path="../ui/form/modalform.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _locale = Phoenix.locale, _utils = Phoenix.utils, schema = {
            type: "object",
            properties: {
                message: {
                    type: "string"
                }
            }
        }, layout = {
            name: "alert",
            $type: "block",
            $items: [{ $bind: "message", $readOnly: true, options: { $expression: "{{message}}" } }]
        };
        var _alert = function (title, message, after) {
            title = title || _locale.ui.Info;
            var opt = {
                title: title,
                buttons: [
                    {
                        type: "primary",
                        title: _locale.ui.Ok,
                        name: "ok"
                    }
                ]
            };
            var ldata = { message: message };
            ui.OpenModalForm(opt, layout, schema, ldata, Phoenix.locale, function (modal, action, data, formcontrol) {
                if (action.operation === "modal-action") {
                    switch (action.property) {
                        case "ok":
                            modal.close();
                            if (after)
                                after();
                            break;
                    }
                }
            });
        };
        _utils.alert = function (title, message, after) {
            _alert(title, message, after);
        };
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../core/core.ts" />
/// <reference path="../core/modules/application.ts" />
/// <reference path="../ui/form/modalform.control.ts" />
/// <reference path="../ui/datasets-plugin.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _locale = Phoenix.locale, _utils = Phoenix.utils, _external = Phoenix.external, _application = Phoenix.application, _dsPlugin = Phoenix.DatasetPlugin, _dom = Phoenix.dom, _ui = ui;
        var layoutPassword = {
            "name": "form",
            "$type": "block",
            "$items": [
                {
                    "$bind": "oldPwd"
                },
                {
                    "$bind": "newPwd"
                },
                {
                    "$bind": "$$newPwd"
                }
            ]
        };
        var _changePasswordHandler = function (after) {
            var schemaPassword = {
                "type": "object",
                "properties": {
                    "oldPwd": { "title": _locale.ui.password.oldPassword, "type": "string", "format": "password", "capabilities": { noConfirming: true } },
                    "newPwd": { "title": _locale.ui.password.newPassword, "type": "string", "format": "password", "minLength": 8 }
                },
                "states": {
                    "oldPwd": { "isMandatory": true },
                    "newPwd": { "isMandatory": true }
                }
            };
            var fo = { "title": _locale.ui.password.change, "buttons": [{ "pattern": "validate" }] };
            _ui.OpenModalForm(fo, layoutPassword, schemaPassword, {}, {}, function (form, action, model, formControl) {
                switch (action.property) {
                    case "validate":
                        if (!model.validate())
                            return;
                        var result = {};
                        var ds = _application.configuration && _application.configuration.application &&
                            _application.configuration.application.authentication ? _application.configuration.application.authentication.changePasswordDs : null;
                        if (!ds) {
                            form.close();
                            return;
                        }
                        _dom.processing(true);
                        var toSend = {
                            oldPwd: model.oldPwd,
                            newPwd: model.newPwd
                        };
                        ds.name = "data";
                        _dsPlugin.executeDatasets([ds], toSend, result, [], function (sended, ex) {
                            if (!ex) {
                                _dom.processing(false);
                                form.close();
                                if (after)
                                    after();
                            }
                            else {
                                model.addAjaxException(ex);
                                _dom.processing(false);
                            }
                        });
                        break;
                }
            });
        };
        _external.changePasswordHandler = _changePasswordHandler;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../core/core.ts" />
/// <reference path="../core/modules/locale.ts" />
/// <reference path="../ui/form/modalform.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _locale = Phoenix.locale, _utils = Phoenix.utils, schema = {
            type: "object",
            properties: {
                message: {
                    type: "string"
                }
            }
        }, layout = {
            name: "confirm",
            $type: "block",
            $items: [{ $bind: "message", $readOnly: true, options: { $expression: "{{message}}" } }]
        };
        var _confirm = function (title, message, onsuccess) {
            title = title || _locale.ui.Warning;
            var opt = {
                title: title,
                buttons: [
                    {
                        type: "default",
                        title: _locale.ui.No,
                        name: "no"
                    },
                    {
                        type: "primary",
                        title: _locale.ui.Yes,
                        name: "yes"
                    }
                ]
            };
            var ldata = { message: message };
            ui.OpenModalForm(opt, layout, schema, ldata, Phoenix.locale, function (modal, action, data, formcontrol) {
                if (action.operation === "modal-action") {
                    switch (action.property) {
                        case "yes":
                            modal.close();
                            if (onsuccess)
                                onsuccess();
                            break;
                        case "no":
                            modal.close();
                            break;
                    }
                }
            });
        };
        ui.confirmDlg = _confirm;
        _utils.confirm = function (title, message, success) {
            _confirm(title, message, success);
        };
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../core/core.ts" />
/// <reference path="../data/odata-provider.ts" />
var Phoenix;
(function (Phoenix) {
    var data;
    (function (data) {
        var _data = data, _utils = Phoenix.utils;
        var OdataEnumManager = (function () {
            function OdataEnumManager(moduleName, entity, enumTypeField, enumCodeField, enumTitleField, enumOrderByField, fields) {
                var that = this;
                that._enums = {};
                that._entity = entity;
                that._module = moduleName;
                that._typeField = enumTypeField;
                that._codeField = enumCodeField;
                that._titleField = enumTitleField;
                that._orderByField = enumOrderByField;
                that._fields = fields;
            }
            OdataEnumManager.prototype.promise = function (enums, enumType) {
                var res = {};
                var missedEnums = [];
                var that = this;
                var odataFilter = [];
                Object.keys(enums).forEach(function (enumName) {
                    var ce = enums[enumName];
                    if (!that._enums[enumName]) {
                        missedEnums.push({ name: enumName, config: ce });
                        var tff = that._typeField + ' eq \'' + enumName + '\'';
                        if (ce.filter)
                            tff = '(' + tff + ' and ' + ce.filter + ')';
                        odataFilter.push(tff);
                    }
                    else {
                        res[enumName] = that._enums[enumName];
                    }
                });
                if (!missedEnums.length)
                    return new _utils.Promise(function (resolve, reject) {
                        resolve({ type: enumType, enums: res });
                    });
                var params = {
                    "$top": 1000,
                    "nocount": true,
                    "$entity": that._entity,
                    "$module": that._module,
                    "$filter": odataFilter.join(' or '),
                    "$orderby": that._typeField + "," + that._orderByField
                };
                return _data.odata.getRessources(params, function (ldata) {
                    ldata.documents && ldata.documents.forEach(function (item) {
                        var code = item[that._codeField];
                        var title = item[that._titleField];
                        var type = item[that._typeField];
                        if (!res[type]) {
                            res[type] = { enum: [], enumNames: [] };
                            that._enums[type] = res[type];
                        }
                        if (that._fields) {
                            res[type].fields = res[type].fields || [];
                            var ff_1 = [];
                            var fv_1 = {};
                            that._fields.forEach(function (fn) {
                                if (item[fn])
                                    ff_1.push(item[fn]);
                                fv_1[fn] = item[fn];
                            });
                            res[type].fields.push(fv_1);
                            if (ff_1.length) {
                                var fn = ff_1.join('$');
                                res[type].filters = res[type].filters || {};
                                res[type].filters[fn] = res[type].filters[fn] || [];
                                res[type].filters[fn].push(code);
                            }
                        }
                        res[type].enum.push(code);
                        res[type].enumNames.push(title);
                    });
                    return { type: enumType, enums: res };
                });
            };
            return OdataEnumManager;
        }());
        data.OdataEnumManager = OdataEnumManager;
    })(data = Phoenix.data || (Phoenix.data = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../core/core.ts" />
/// <reference path="../core/modules/locale.ts" />
/// <reference path="../ui/form/modalform.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _locale = Phoenix.locale, _utils = Phoenix.utils, schema = {
            type: "object",
            properties: {
                value: {
                    type: "string"
                }
            }
        }, layout = {
            name: "prompt",
            $type: "block",
            $items: [{ $bind: "value", options: { titleIsHidden: true } }]
        };
        var _prompt = function (title, defaultValue, onsuccess) {
            title = title || _locale.ui.Warning;
            var opt = {
                title: title,
                buttons: [
                    {
                        type: "primary",
                        title: _locale.ui.Ok,
                        name: "ok"
                    }
                ]
            };
            var ldata = { value: defaultValue || '' };
            ui.OpenModalForm(opt, layout, schema, ldata, Phoenix.locale, function (modal, action, data, formcontrol) {
                if (action.operation === "modal-action") {
                    switch (action.property) {
                        case "ok":
                            var nv = data.value;
                            modal.close();
                            if (onsuccess)
                                onsuccess(nv);
                            break;
                    }
                }
            });
        };
        _utils.prompt = function (title, defaultValue, success) {
            _prompt(title, defaultValue, success);
        };
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../core/modules/locale.ts" />
/// <reference path="../core/core.ts" />
/// <reference path="../core/modules/application.ts" />
/// <reference path="../data/datasets.ts" />
/// <reference path="../ui/form/schema.data.ts" />
var Phoenix;
(function (Phoenix) {
    var _ulocale = Phoenix.ulocale, _application = Phoenix.application, _ajax = Phoenix.ajax;
    var Data;
    (function (Data) {
        var _data = Phoenix.data, _utils = Phoenix.utils, _su = Phoenix.Observable.SchemaUtils, _dom = Phoenix.dom, _application = Phoenix.application, _schema = {
            getRessources: function (schemaName, ondata) {
                var _after = function (cd) {
                    if (ondata)
                        cd = ondata(cd);
                    return cd;
                };
                var config = _application.config(_application.name);
                if (!config)
                    throw "Application configuration not found.";
                var lurl = config.prototypes + '/' + schemaName;
                var p1 = Phoenix.ajax.get(lurl, {}, function (ldata) {
                    return ldata;
                });
                return new _utils.Promise(function (resolve, reject) {
                    p1.then(function (schema) {
                        _dom.processing(true);
                        _su.loadEnumsPromise(schema).then(function (schema) {
                            _dom.processing(false);
                            resolve(_after(schema));
                        }).catch(function (ex) {
                            _dom.processing(false);
                            reject(ex);
                        });
                    }).catch(function (ex) {
                        reject(ex);
                    });
                });
            }
        }, _execLoadSchema = function (config, lurl, context, callerObject) {
            return _schema.getRessources(config.$params.$url, function (ldata) {
                return ldata;
            });
        };
        _data.registerDataProvider("form-meta", _execLoadSchema);
    })(Data = Phoenix.Data || (Phoenix.Data = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ulocale = Phoenix.ulocale, _utils = Phoenix.utils, _ajax = Phoenix.ajax, _dom = Phoenix.dom, _link = Phoenix.link, _render = Phoenix.render, _html = '<div id="{0}" class="" style="width:{1};height:{2}"></div>';
        var FilterExpress = (function () {
            /*******************************
            ************ METHODS
            *******************************/
            function FilterExpress(fieldList, cb) {
                this._oldFilter = null;
                this._id = _utils.allocID();
                this._fieldList = this._completeFieldList($.extend(true, [], fieldList));
                this._cb = cb;
            }
            FilterExpress.prototype.destroy = function () {
                // Events
                this._nodeSelect.off("click");
                this._nodeValidate.off("click");
                this._nodeMain.off("blur");
                this._removeEditEvents();
                // Nodes
                _dom.find(this._nodeParent[0], this._id).remove();
                // Variables
                this._id = null;
                this._fieldList = null;
                this._cb = null;
                this._selectedField = null;
                this._nodeMain = null;
                this._nodeSelect = null;
                this._nodeSelectButtonTxt = null;
                this._nodeEdit = null;
                this._nodeValidate = null;
                this._nodeSelectedLi = null;
            };
            // Called at instanciation of component
            FilterExpress.prototype.render = function ($parent) {
                var that = this;
                that._nodeParent = $parent;
                $parent.append(that._internalRender());
                // Change field event
                that._nodeSelect.click(function (e) {
                    var code = e.target.attributes["code"].value;
                    var field = that._getFieldByCode(code);
                    if (field)
                        that._changeField(field);
                });
                // Validate filter event
                that._nodeValidate.click(function () {
                    that._applyFilter();
                });
                // focusOut event
                that._nodeMain.get(0).addEventListener("blur", function (e) {
                    var parent = false;
                    if (e.relatedTarget) {
                        var node = e.relatedTarget;
                        do {
                            if (_dom.hasClass(node, "bs-filterexpress")) {
                                parent = true;
                                break;
                            }
                            node = node.parentNode;
                        } while (node && !parent);
                    }
                    if (!parent && e.target == that._nodeEdit.get(0) && that._oldFilter && that._oldFilter.code) {
                        if (that._selectedField.code !== that._oldFilter.code)
                            that._changeField(that._getFieldByCode(that._oldFilter.code));
                        that._nodeEdit.val(that._oldFilter.value);
                    }
                }, true);
            };
            FilterExpress.prototype._internalRender = function () {
                var that = this;
                // Create nodes
                that._nodeMain = $("<div class='bs-filterexpress' id='" + that._id + "'></div>");
                var nodeGroup = $("<div class='input-group'></div>");
                var nodeGroupBtn = $("<div class='input-group-btn'></div>");
                var txtNodeButton = "<button type='button' ";
                txtNodeButton += "class='btn btn-default dropdown-toggle' data-toggle='dropdown' ";
                txtNodeButton += "aria-haspopup='true' aria-expanded='false'></button>";
                var nodeSelectButton = $(txtNodeButton);
                that._nodeSelectButtonTxt = $("<span>" + FilterExpress.FIELD_SELECT_TEXT_DEFAULT + " </span>");
                var nodeSelectButtonGlyph = $("<span class='caret'></span>");
                // Fill fields in selectNode
                that._nodeSelect = $("<ul class='dropdown-menu'></ul>");
                that._fieldList.forEach(function (field) {
                    var nodeOption = $("<li class='bs-cursor-p'><a code='" + field.code + "'>" + field.lib + "</a></li>");
                    that._nodeSelect.append(nodeOption);
                });
                // Add editNode
                that._nodeEdit = $("<input type='text' class='form-control' aria-label='...'>");
                // Add validateNode
                var nodeGroupBtnValidate = $("<div class='input-group-btn'></div>");
                that._nodeValidate = $("<button class='btn btn-default' type='submit'><span class='" + _dom.iconClass(FilterExpress.VALIDATE_ICON_DEFAULT) + "'></span> " + FilterExpress.VALIDATE_TEXT_DEFAULT + "</button>");
                // Append nodes to mainNode
                that._nodeMain.append(nodeGroup);
                nodeGroup.append(nodeGroupBtn);
                nodeGroup.append(that._nodeEdit);
                nodeGroup.append(nodeGroupBtnValidate);
                nodeGroupBtn.append(nodeSelectButton);
                nodeGroupBtn.append(that._nodeSelect);
                nodeSelectButton.append(that._nodeSelectButtonTxt);
                nodeSelectButton.append(nodeSelectButtonGlyph);
                nodeGroupBtnValidate.append(that._nodeValidate);
                if (that._fieldList && that._fieldList[0])
                    that._changeField(that._fieldList[0]);
                return that._nodeMain;
            };
            FilterExpress.prototype._getFieldByCode = function (code) {
                var that = this;
                var result = null;
                that._fieldList.forEach(function (field) {
                    if (field.code === code)
                        result = field;
                });
                return result;
            };
            FilterExpress.prototype._changeEditField = function (field) {
                var that = this;
                that._removeEditEvents();
                var oldHTMLNodeEdit;
                var newHTMLNodeEdit;
                newHTMLNodeEdit = that._getEditField(field).get(0);
                oldHTMLNodeEdit = that._nodeEdit.get(0);
                var parent = oldHTMLNodeEdit.parentNode;
                parent.replaceChild(newHTMLNodeEdit, oldHTMLNodeEdit);
                that._nodeEdit = $(newHTMLNodeEdit);
                newHTMLNodeEdit.focus();
                // events 
                if (field.enum) {
                    _dom.addClass(that._nodeValidate.get(0), "bs-none");
                    that._nodeEdit.change(function (e) {
                        if (e.target === that._nodeEdit.get(0))
                            that._applyFilter();
                    });
                    that._nodeEdit.get(0).style.borderTopRightRadius = "4px";
                    that._nodeEdit.get(0).style.borderBottomRightRadius = "4px";
                }
                else {
                    _dom.removeClass(that._nodeValidate.get(0), "bs-none");
                    // touch enter event
                    that._nodeEdit.keyup(function (e) {
                        if (e.keyCode == 13)
                            that._applyFilter();
                    });
                    // input focus event
                    that._nodeEdit.focus(function (e) {
                        that._nodeEdit.get(0).select();
                    });
                }
            };
            FilterExpress.prototype._getEditField = function (field) {
                var textNode;
                switch (field.format) {
                    case FilterExpress.FORMAT_INTEGER:
                        textNode = "<input type='number' class='form-control' aria-label='...'>";
                        break;
                    case FilterExpress.FORMAT_STRING:
                        textNode = "<input type='text' class='form-control' aria-label='...'>";
                        break;
                    case FilterExpress.FORMAT_ENUM:
                        textNode = "<select class='form-control'>";
                        if (field.enum) {
                            field.enum.forEach(function (option, index) {
                                var elib = field.enumNames && field.enumNames[index] ? field.enumNames[index] : option;
                                textNode += "<option value='" + option + "'>" + elib + "</option>";
                            });
                        }
                        textNode += "</select>";
                        break;
                }
                return $(textNode);
            };
            FilterExpress.prototype._removeEditEvents = function () {
                this._nodeEdit.off("focus");
                this._nodeEdit.off("keyup");
                this._nodeEdit.off("change");
            };
            FilterExpress.prototype._getOpField = function (field) {
                var op;
                switch (field.format) {
                    case FilterExpress.FORMAT_INTEGER:
                        op = FilterExpress.OP_INTEGER;
                        break;
                    case FilterExpress.FORMAT_STRING:
                        op = FilterExpress.OP_STRING;
                        break;
                    case FilterExpress.FORMAT_ENUM:
                        op = FilterExpress.OP_ENUM;
                        break;
                    default:
                        op = "";
                        break;
                }
                return op;
            };
            FilterExpress.prototype._checkFilter = function (filter) {
                if (!filter)
                    return true;
                if (filter.code == "")
                    return false;
                if (filter.op == "")
                    return false;
                return true;
            };
            FilterExpress.prototype._completeFieldList = function (fields) {
                fields.forEach(function (field) {
                    if (field.enum && Array.isArray(field.enum)) {
                        field.format = "enum";
                        field.enum.splice(0, 0, "");
                        if (field.enumNames)
                            field.enumNames.splice(0, 0, "");
                    }
                    else
                        field.format = field.type === "number" ? "integer" : field.type;
                });
                return fields;
            };
            FilterExpress.prototype._changeField = function (field) {
                var that = this;
                if (field) {
                    that._nodeSelectButtonTxt.text(field.lib + " ");
                    that._changeEditField(field);
                    that._selectedField = field;
                }
                // Style changed
                if (that._nodeSelectedLi)
                    that._nodeSelectedLi.removeClass("bs-row-selected");
                if (field) {
                    var liNode = _dom.query(that._nodeSelect.get(0), "a[code='" + field.code + "']");
                    if (liNode) {
                        that._nodeSelectedLi = $(liNode.parentNode);
                        that._nodeSelectedLi.addClass("bs-row-selected");
                    }
                }
            };
            FilterExpress.prototype._applyFilter = function () {
                var that = this;
                if (that._selectedField) {
                    var val = that._nodeEdit.val();
                    var filter_1 = val === "" ? null : { "code": that._selectedField.code, "op": that._getOpField(that._selectedField), "values": [that._nodeEdit.val()] };
                    if (that._cb && that._checkFilter(filter_1)) {
                        that._oldFilter = { code: that._selectedField.code, value: val };
                        that._cb(filter_1);
                    }
                }
            };
            // Constants
            FilterExpress.FIELD_SELECT_TEXT_DEFAULT = "Choix du champ";
            FilterExpress.VALIDATE_TEXT_DEFAULT = ""; // "Valider"
            FilterExpress.VALIDATE_ICON_DEFAULT = "search";
            FilterExpress.FORMAT_STRING = "string";
            FilterExpress.FORMAT_INTEGER = "integer";
            FilterExpress.FORMAT_ENUM = "enum";
            FilterExpress.OP_STRING = "like";
            FilterExpress.OP_INTEGER = "in";
            FilterExpress.OP_ENUM = "in";
            return FilterExpress;
        }());
        ui.FilterExpress = FilterExpress;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../../js/core/core.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var dsPlugin = Phoenix.DatasetPlugin, _dom = Phoenix.dom;
        var DsLookup = (function () {
            function DsLookup(ds, options) {
                var that = this;
                that._init = false;
                that._options = options || {};
                that._notify = options.notify;
                that._ds = ds || {};
                that._ds.mapping = that._ds.mapping || {};
                that._ds.mapping.code = that._ds.mapping.code || "code";
                that._ds.mapping.libelle = that._ds.mapping.libelle || that._ds.mapping.lib || "lib";
                var $params = ds.data.$params || {};
                that._pageSize = $params.$top || null;
                that.searchText = null;
                that._count = 0;
                that._page = 0;
                that._items = [];
                that._initData();
            }
            DsLookup.prototype._initData = function () {
                var that = this, res = {};
                var _ds = that._ds.data || {};
                var ds = {
                    "name": "dataset",
                    "$type": _ds.$type || "odata",
                    "$params": {
                        "$entity": _ds.$params.$entity,
                        "$module": _ds.$params.$module,
                        "$aggregation": "$count"
                    }
                };
                _dom.processing(true);
                dsPlugin.executeDatasets([ds], {}, res, null, function (sended, ex) {
                    _dom.processing(false);
                    if (!ex) {
                        that._init = true;
                        that._count = res.dataset;
                        that._notify(null, { inited: true, updated: true });
                    }
                }, false);
            };
            Object.defineProperty(DsLookup.prototype, "items", {
                get: function () {
                    return this._items;
                },
                set: function (value) {
                    if (value) {
                        this._items = value;
                        this._notifyChange("items");
                    }
                },
                enumerable: true,
                configurable: true
            });
            DsLookup.prototype._notifyChange = function (propName) {
                var that = this;
                switch (propName) {
                    case "items":
                        that._notify(that.items, {});
                        break;
                }
            };
            DsLookup.prototype.getNbPages = function () {
                var that = this;
                return Math.ceil(that._count / that._pageSize);
            };
            DsLookup.prototype._getSkip = function (page) {
                var that = this;
                return that._pageSize ? page * that._pageSize : 0;
            };
            DsLookup.prototype._getPage = function (page, context) {
                var that = this;
                if (!that._init)
                    return;
                var ds = $.extend(true, {}, that._ds.data), res = {};
                ds.name = "dataset";
                ds.$params = ds.$params || {};
                ds.$params.$skip = that._getSkip(page);
                context = context || {};
                if (that.searchText)
                    context.$searchText = that.searchText;
                _dom.processing(true);
                dsPlugin.executeDatasets([ds], context, res, null, function (sended, ex) {
                    _dom.processing(false);
                    if (!ex) {
                        var data_3 = res.dataset;
                        if (data_3 && that._count != data_3.count) {
                            that._count = data_3.count;
                            that._page = 0;
                            that._notify(null, { updated: true });
                        }
                        if (data_3.documents) {
                            data_3.documents = data_3.documents.map(function (item) {
                                return { code: item[that._ds.mapping.code], libelle: item[that._ds.mapping.libelle] };
                            });
                            that.items = data_3.documents;
                        }
                    }
                }, false);
            };
            DsLookup.prototype.currentPage = function () {
                return this._page;
            };
            DsLookup.prototype.toPage = function (page) {
                var that = this;
                if (page >= 0 && page < that.getNbPages()) {
                    that._page = page;
                    that._getPage(page);
                }
            };
            DsLookup.prototype.nextPage = function () {
                var that = this;
                var page = that._page + 1;
                if (page < that.getNbPages()) {
                    that._page = page;
                    that._getPage(page);
                }
            };
            DsLookup.prototype.prevPage = function () {
                var that = this;
                var page = that._page - 1;
                if (page >= 0) {
                    that._page = page;
                    that._getPage(page);
                }
            };
            DsLookup.prototype.firthPage = function () {
                var that = this;
                that._page = 0;
                that._getPage(0);
            };
            DsLookup.prototype.lastPage = function () {
                var that = this;
                var page = that.getNbPages() - 1;
                that._page = page;
                that._getPage(page);
            };
            DsLookup.prototype.search = function (searchText) {
                var that = this;
                that.searchText = searchText ? searchText : null;
                if (that._ds.data.$params.$search)
                    that._getPage(0);
            };
            DsLookup.prototype.remove = function () {
            };
            return DsLookup;
        }());
        ui.DsLookup = DsLookup;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../../js/core/modules/locale.ts" />
/// <reference path="../../js/ui/form/form.control.ts" />
/// <reference path="../../js/ui/form/controls/absfield.control.ts" />
/// <reference path="./filter-lookup.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _ulocale = Phoenix.ulocale, _dom = Phoenix.dom, _sutils = Phoenix.Observable.SchemaUtils;
        var ListeOperateurs = (function () {
            function ListeOperateurs() {
                this.liste = [];
            }
            ListeOperateurs.prototype.add = function (code, lib, isBinary, options) {
                var that = this;
                var op = {
                    code: code,
                    libelle: lib || code,
                    isBinary: isBinary,
                    options: options || {}
                };
                op.options.symbol = options.symbol || lib || code;
                if (isBinary) {
                    op.options.liaison = op.options.liaison || "et";
                }
                that.liste.push(op);
            };
            ListeOperateurs.prototype.gets = function () {
                return this.liste;
            };
            ListeOperateurs.prototype.get = function (code) {
                return this.liste.find(function (item) { return item.code == code; });
            };
            ListeOperateurs.prototype.remove = function (code) {
                var index = this.liste.findIndex(function (item) { return item.code == code; });
                if (index >= 0)
                    this.liste.splice(index, 1);
            };
            return ListeOperateurs;
        }());
        ui.ListeOperateurs = ListeOperateurs;
        var ListeChamps = (function () {
            function ListeChamps() {
                this.liste = [];
            }
            ListeChamps.prototype.add = function (code, lib, type, options) {
                var that = this;
                that.liste.push({
                    code: code,
                    libelle: lib || code,
                    type: type || "string",
                    options: options || {}
                });
            };
            ListeChamps.prototype.get = function (code) {
                return this.liste.find(function (item) { return item.code == code; });
            };
            ListeChamps.prototype.gets = function () {
                return this.liste;
            };
            ListeChamps.prototype.remove = function (code) {
                var index = this.liste.findIndex(function (item) { return item.code == code; });
                if (index >= 0)
                    this.liste.splice(index, 1);
            };
            return ListeChamps;
        }());
        ui.ListeChamps = ListeChamps;
        var Filter = (function () {
            function Filter(id, code, op, values) {
                var that = this;
                that.id = id;
                that.code = code;
                that.op = op;
                that.values = values || [];
            }
            Filter.prototype.getValues = function () {
                return this.values.map(function (item) {
                    if (item && item.code)
                        return item.code;
                    return item;
                });
            };
            Filter.prototype.getValueNames = function () {
                return this.values.map(function (item) {
                    if (item && item.lib)
                        return item.lib;
                    return item;
                });
            };
            return Filter;
        }());
        ui.Filter = Filter;
        var ListeFilters = (function () {
            function ListeFilters(filters) {
                this.liste = [];
                this.filters = filters;
                this.compteur = 0;
            }
            ListeFilters.prototype.add = function (champCode, opCode, values) {
                var that = this;
                var filter = new Filter(that.compteur++, champCode, opCode, values);
                that.liste.push(filter);
                that.filters.push(filter);
                return filter;
            };
            ListeFilters.prototype.add2 = function (champCode, opCode, values) {
                var that = this;
                var filter = new Filter(that.compteur++, champCode, opCode, values);
                that.liste.push(filter);
                return filter;
            };
            ListeFilters.prototype.set = function (id, data) {
                var that = this;
                var filter;
                var index = -1;
                that.liste.forEach(function (item, i) {
                    if (item.id == id) {
                        filter = item;
                        index = i;
                    }
                });
                if (filter) {
                    filter.op = data.op;
                    filter.values = data.values || [];
                }
                if (index >= 0 && index < that.filters.length) {
                    var f = that.filters.get(index);
                    if (f) {
                        f.code = filter.code;
                        f.op = filter.op;
                        f.values = filter.values;
                    }
                }
                return filter;
            };
            ListeFilters.prototype.get = function (id) {
                return this.liste.find(function (item) { return item.id == id; });
            };
            ListeFilters.prototype.getByIndex = function (index) {
                return this.liste[index];
            };
            //getCode(values) {
            //    let id = -1;
            //    this.liste.forEach(function (filter) {
            //        let isOK = true;
            //        if (Array.isArray(values)) {
            //            values.forEach(function (v, indexV) {
            //                if (filter.values[indexV] && v != filter.values[indexV]) {
            //                    isOK = false;
            //                    return false;
            //                }
            //            });
            //        }
            //        else if (filter.values[0] != values)
            //            isOK = false;
            //        if (isOK) {
            //            code = filter.code;
            //            return false;
            //        }
            //    });
            //    return code;
            //}
            ListeFilters.prototype.gets = function () {
                return this.liste;
            };
            ListeFilters.prototype.getsByChamp = function (codeChamp) {
                var filters = [];
                this.liste.forEach(function (item) {
                    if (item.code == codeChamp)
                        filters.push(item);
                });
                return filters;
            };
            ListeFilters.prototype.remove = function (id) {
                var that = this;
                var index = that.liste.findIndex(function (item) { return item.id == id; });
                if (index >= 0) {
                    that.liste.splice(index, 1);
                    that.filters.remove(that.filters.get(index));
                }
            };
            ListeFilters.prototype.removeAll = function () {
                var that = this;
                that.liste.splice(0);
                that.filters.forEach(function (item, index) { that.filters.remove(that.filters.get(index)); });
            };
            ListeFilters.prototype.removeAllByChamp = function (champCode) {
                var that = this;
                that.liste.forEach(function (item, index) {
                    if (item.code == champCode) {
                        that.liste.splice(index, 1);
                        that.filters.remove(that.filters.get(index));
                    }
                });
            };
            return ListeFilters;
        }());
        ui.ListeFilters = ListeFilters;
        var ListeTypes = (function () {
            function ListeTypes() {
                this.liste = [];
            }
            ListeTypes.prototype.addType = function (code, lib, operateurs) {
                this.liste.push({
                    code: code,
                    libelle: lib || code,
                    operateurs: operateurs || []
                });
            };
            ListeTypes.prototype.addOperateur = function (codeType, codeOp) {
                this.liste.find(function (item) { return item.code == codeType; }).operateurs.push(codeOp);
            };
            ListeTypes.prototype.getOperateurs = function (codeType) {
                return this.liste.find(function (item) { return item.code == codeType; }).operateurs;
            };
            return ListeTypes;
        }());
        ui.ListeTypes = ListeTypes;
        var FilterListView = (function () {
            function FilterListView(listeChamps, listeFilters, listeOperateurs, callBack, options, filter) {
                this.listeChamps = listeChamps;
                this.listeFilters = listeFilters;
                this.listeOperateurs = listeOperateurs;
                this.filter = filter;
                this.callBack = callBack;
                this.options = options || {};
                this.data = {};
                this.init();
            }
            FilterListView.prototype.init = function () {
                var that = this;
                that.model = {
                    type: "object",
                    properties: {
                        filters: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    code: { type: "string" },
                                    libelle: { type: "string" },
                                    selected: { type: "string" }
                                }
                            }
                        }
                    },
                    links: {
                        validate: {
                            title: "Valider",
                            isHidden: that.options.btnValidate != true
                        }
                    }
                };
                that.layout = {
                    name: "form",
                    $type: "block",
                    $items: [
                        {
                            $type: "block",
                            $items: [
                                {
                                    $type: "block",
                                    $items: [
                                        { $bind: "filters", "$widget": "tagview" }
                                    ]
                                },
                                {
                                    $type: "block",
                                    $inline: true,
                                    $items: [
                                        {
                                            $bind: "$links.validate",
                                            options: {
                                                type: "success",
                                                right: true
                                            }
                                        }
                                    ]
                                }
                            ],
                            $title: {
                                value: "Filtres sélectionnés",
                                size: 5,
                                style: ""
                            }
                        }
                    ]
                };
                that.data.filters = that.listeFilters.gets().map(function (item) {
                    var op = that.listeOperateurs.get(item.op);
                    var champ = that.listeChamps.get(item.code);
                    var lib = champ.libelle + " " + op.options.symbol + " ";
                    if (op.isBinary)
                        lib += item.values[0] + " " + op.options.liaison + " " + item.values[1];
                    else {
                        lib += item.getValueNames().join(", ");
                    }
                    return {
                        code: item.id,
                        libelle: lib,
                        selected: that.filter && that.filter.id == item.id ? true : false
                    };
                });
            };
            FilterListView.prototype.render = function (parent) {
                var that = this;
                if (parent)
                    _ui.OpenForm($(parent), that.layout, that.model, that.data, {}, function (action, data, formControl) {
                        switch (action.property) {
                            case "upd":
                                that.callBack("EDIT", { id: action.actionParams.code });
                                break;
                            case "remove":
                                that.callBack("REMOVE", { id: action.actionParams.code });
                                break;
                            case "$links.validate":
                                that.callBack("VALIDE", {});
                                break;
                        }
                    });
            };
            return FilterListView;
        }());
        var ValueModel = (function () {
            function ValueModel(type, op, options) {
                this.valueModel = null;
                var that = this;
                that.type = type;
                that.op = op;
                that.options = $.extend(true, {}, options);
                that.valueModel = that.getInstance();
            }
            ValueModel.prototype.getInstance = function () {
                var that = this;
                var options = that.addDefaultOptions(that.options);
                if (that.op.isBinary)
                    return new ModelTwoVal(options);
                else if (that.op.code === "vide" || that.op.code === "nvide")
                    return new ModelVideVal(options);
                else if (that.type === "enum")
                    return new ModelEnumVal(options);
                else if (that.type === "lookup")
                    return new ModelLookupVal(options);
                else if ((that.op.code === "in" || that.op.code === "nin") && that.type != "decimal" && that.type != "money" && that.type != "date")
                    return new ModelMultiVal(options);
                else
                    return new ModelOneVal(options);
            };
            ValueModel.prototype.init = function (after) {
                this.valueModel.init(after);
            };
            ValueModel.prototype.addDefaultOptions = function (options) {
                var that = this;
                switch (that.type) {
                    case "integer":
                        options.type = "number";
                        break;
                    case "decimal":
                        options.type = "number";
                        // "symbol": "jours",
                        // "decimals": 0
                        options.decimals = options.decimals || 5;
                        break;
                    case "money":
                        options.type = "number";
                        options.format = "money";
                        break;
                    case "date":
                        options.type = "string",
                            options.format = "date";
                        options.title = "Date";
                        break;
                    default:
                        options.type = that.type || "string";
                }
                return options;
            };
            ValueModel.prototype.getModel = function () {
                if (this.valueModel)
                    return this.valueModel.getModel();
                return null;
            };
            ValueModel.prototype.getLayout = function () {
                if (this.valueModel)
                    return this.valueModel.getLayout();
                return null;
            };
            ValueModel.prototype.getData = function () {
                if (this.valueModel)
                    return this.valueModel.getData();
                return null;
            };
            ValueModel.prototype.getValues = function () {
                if (this.valueModel)
                    return this.valueModel.getValues();
                return null;
            };
            ValueModel.prototype.setValues = function (data, $type) {
                if (this.valueModel)
                    return this.valueModel.setValues(data, $type);
                return null;
            };
            ValueModel.prototype.setValuesByFilter = function (data) {
                if (this.valueModel)
                    this.valueModel.setValuesByFilter(data);
            };
            return ValueModel;
        }());
        var ModelVal = (function () {
            function ModelVal(options) {
            }
            ModelVal.prototype.init = function (after) {
                if (after)
                    after();
            };
            ModelVal.prototype.getModel = function () {
                return this.model;
            };
            ModelVal.prototype.getLayout = function () {
                return this.layout;
            };
            ModelVal.prototype.getData = function () {
                return this.data;
            };
            ModelVal.prototype.getValues = function () { };
            ModelVal.prototype.setValues = function (data, type) { };
            ModelVal.prototype.setValuesByFilter = function (data) { };
            return ModelVal;
        }());
        var ModelVideVal = (function (_super) {
            __extends(ModelVideVal, _super);
            function ModelVideVal(options) {
                _super.call(this, options);
            }
            ModelVideVal.prototype.getValues = function () {
                return [""];
            };
            return ModelVideVal;
        }(ModelVal));
        var ModelOneVal = (function (_super) {
            __extends(ModelOneVal, _super);
            function ModelOneVal(options) {
                _super.call(this, options);
                var that = this;
                that.options = options || {};
                that.model = {
                    type: "object",
                    properties: {
                        value: {
                            title: that.options.title || "Valeur",
                            type: that.options.type || "string"
                        }
                    },
                    states: {
                        value: {
                            isMandatory: true
                        }
                    }
                };
                if (that.options.format)
                    that.model.properties.value.format = that.options.format;
                if (that.options.decimals)
                    that.model.properties.value.decimals = that.options.decimals;
                that.layout = {
                    name: "filter-value",
                    $type: "block",
                    $items: [
                        {
                            $items: [{ $bind: "value", options: { titleIsHidden: true, placeHolder: true } }],
                            $colSize: 12
                        }
                    ]
                };
                that.data = { value: null };
            }
            ModelOneVal.prototype.getValues = function () {
                if (this.data.value)
                    return [this.data.value];
                return null;
            };
            ModelOneVal.prototype.setValues = function (data) {
                this.data.value = data["value"];
            };
            ModelOneVal.prototype.setValuesByFilter = function (data) {
                this.data.value = data[0];
            };
            return ModelOneVal;
        }(ModelVal));
        var ModelTwoVal = (function (_super) {
            __extends(ModelTwoVal, _super);
            function ModelTwoVal(options) {
                _super.call(this, options);
                var that = this;
                that.options = options || {};
                that.model = {
                    type: "object",
                    properties: {
                        value1: {
                            title: (options.title || "Valeur") + " 1",
                            type: options.type || "string"
                        },
                        value2: {
                            title: (options.title || "Valeur") + " 2",
                            type: options.type || "string"
                        }
                    },
                    states: {
                        value1: {
                            isMandatory: true
                        },
                        value2: {
                            isMandatory: true
                        }
                    }
                };
                if (that.options.format) {
                    that.model.properties.value1.format = that.options.format;
                    that.model.properties.value2.format = that.options.format;
                }
                if (that.options.decimals) {
                    that.model.properties.value1.decimals = that.options.decimals;
                    that.model.properties.value2.decimals = that.options.decimals;
                }
                that.layout = {
                    name: "filter-value",
                    $type: "block",
                    $items: [
                        {
                            $type: "row",
                            $items: [
                                {
                                    $items: [{ $bind: "value1", options: { titleIsHidden: true, placeHolder: true } }],
                                    $colSize: 6
                                },
                                {
                                    $items: [{ $bind: "value2", options: { titleIsHidden: true, placeHolder: true } }],
                                    $colSize: 6
                                }
                            ]
                        }
                    ]
                };
                that.data = { value1: null, value2: null };
            }
            ModelTwoVal.prototype.getValues = function () {
                var that = this;
                if (that.data.value1 && that.data.value2)
                    return [that.data.value1, that.data.value2];
                return null;
            };
            ModelTwoVal.prototype.setValues = function (data) {
                this.data.value1 = data["value1"];
                this.data.value2 = data["value2"];
            };
            ModelTwoVal.prototype.setValuesByFilter = function (data) {
                this.data.value1 = data[0];
                this.data.value2 = data[1];
            };
            return ModelTwoVal;
        }(ModelVal));
        var ModelMultiVal = (function (_super) {
            __extends(ModelMultiVal, _super);
            function ModelMultiVal(options) {
                _super.call(this, options);
                var that = this;
                that.options = options || {};
                that.model = {
                    type: "object",
                    properties: {
                        value: {
                            title: 'Valeur',
                            type: "string"
                        }
                    },
                    states: {
                        value: {
                            isMandatory: true
                        }
                    }
                };
                if (that.options.format)
                    that.model.properties.value.format = that.options.format;
                that.layout = {
                    name: "filter-value",
                    $type: "block",
                    $items: [
                        {
                            $items: [{ $bind: "value", options: { titleIsHidden: true, placeHolder: 'Une ou plusieurs valeurs (séparées par un ";" : val1;val2;...)' } }],
                            $colSize: 12
                        }
                    ]
                };
                that.data = { value: null };
            }
            ModelMultiVal.prototype.getValues = function () {
                var that = this;
                if (!that.data.value)
                    return null;
                var vals = that.data.value.split(";");
                if (that.options.type == "number")
                    vals = vals.map(function (item) {
                        return parseInt(item, 10);
                    });
                return vals;
            };
            ModelMultiVal.prototype.setValues = function (data) {
                var that = this;
                if (!data["value"])
                    return;
                var values = data["value"].split(";");
                values = values.map(function (item) {
                    return item.replace(/\"/g, "");
                });
                var vals = [];
                values.forEach(function (item) {
                    if (that.options.type == "number") {
                        if ((new RegExp('^[0-9]+$')).test(item))
                            vals.push(item);
                    }
                    else
                        vals.push(item);
                });
                that.data.value = vals.join(";");
            };
            ModelMultiVal.prototype.setValuesByFilter = function (data) {
                this.data.value = data.join(";");
            };
            return ModelMultiVal;
        }(ModelVal));
        var ModelEnumVal = (function (_super) {
            __extends(ModelEnumVal, _super);
            function ModelEnumVal(options) {
                _super.call(this, options);
                var that = this;
                that.options = options || {};
                that.options.enumName = that.options.enumName || that.options.champName;
                that.model = {
                    type: "object",
                    properties: {
                        value: {
                            title: "List",
                            type: "array",
                            items: {
                                type: "string",
                                enums: {},
                                $enumref: "list"
                            }
                        }
                    },
                    states: {
                        value: {
                            isMandatory: true
                        }
                    }
                };
                that.model.properties.value.items.enums[that.options.enumName] = {
                    type: "default",
                    enum: [],
                    enumNames: []
                };
                that.model.properties.value.items.$enumref = that.options.enumName;
                that.layout = {
                    name: "filter-value",
                    $type: "block",
                    $items: [
                        {
                            $items: [{
                                    $bind: "value",
                                    $widget: "enums-list",
                                    options: {
                                        titleIsHidden: true
                                    }
                                }],
                            $colSize: 12
                        }
                    ]
                };
                that.options.enum && that.options.enum.forEach(function (item) {
                    that.model.properties.value.items.enums[that.options.enumName].enum.push(item.code);
                    that.model.properties.value.items.enums[that.options.enumName].enumNames.push(item.libelle || item.code);
                });
                that.data = { value: [] };
            }
            ModelEnumVal.prototype.getValues = function () {
                var that = this;
                if (that.data.value && that.data.value.length) {
                    return that.data.value.map(function (item) {
                        var elt = null;
                        that.options.enum.forEach(function (it, i) {
                            if (item == it.code) {
                                elt = it;
                                return false;
                            }
                        });
                        return { code: item, lib: elt.libelle || elt.lib || item };
                    });
                }
                return [];
            };
            ModelEnumVal.prototype.setValues = function (data) {
                this.data.value = data["value"];
            };
            ModelEnumVal.prototype.setValuesByFilter = function (data) {
                this.data.value = data.map(function (item) {
                    return item.code;
                });
            };
            return ModelEnumVal;
        }(ModelVal));
        var ModelLookupVal = (function (_super) {
            __extends(ModelLookupVal, _super);
            function ModelLookupVal(options) {
                _super.call(this, options);
                var that = this;
                that.options = options || {};
                that.model = {
                    type: "object",
                    properties: {
                        value: {
                            title: "List",
                            type: "array",
                            ds: that.options.lookupSchema || null,
                            items: {
                                type: "object",
                                properties: {
                                    code: {
                                        type: "string"
                                    },
                                    lib: {
                                        type: "string"
                                    }
                                }
                            }
                        }
                    },
                    states: {
                        value: {
                            isMandatory: true
                        }
                    }
                };
                that.layout = {
                    name: "filter-value",
                    $type: "block",
                    $items: [
                        {
                            $items: [{
                                    $bind: "value",
                                    $widget: "lookup-list",
                                    options: {
                                        titleIsHidden: true
                                    }
                                }],
                            $colSize: 12
                        }
                    ]
                };
                that.data = { value: [] };
            }
            ModelLookupVal.prototype.getValues = function () {
                var that = this;
                if (that.data.value && that.data.value.length)
                    return that.data.value;
                return [];
            };
            ModelLookupVal.prototype.setValues = function (data) {
                this.data.value = data["value"];
            };
            ModelLookupVal.prototype.setValuesByFilter = function (data) {
                this.data.value = data;
            };
            return ModelLookupVal;
        }(ModelVal));
        var FilterEditView = (function () {
            function FilterEditView(champ, listeFilters, listeOperateurs, listeTypes, callBack, filter, options) {
                this.champ = champ;
                this.filter = filter;
                this.listeFilters = listeFilters;
                this.listeOperateurs = listeOperateurs;
                this.listeTypes = listeTypes;
                this.callBack = callBack;
                this.options = options || {};
                this.data = { operateur: null, values: [] };
            }
            FilterEditView.prototype.renderOperateur = function () {
                var that = this;
                var model = {
                    type: "object",
                    properties: {
                        champ: {
                            title: "Filtre",
                            type: "string"
                        },
                        operateur: {
                            title: "Opérateur",
                            type: "string",
                            enum: [],
                            enumNames: []
                        }
                    },
                    states: {
                        champ: {
                            isReadOnly: true,
                            isHidden: that.options.showLabel == false
                        },
                        operateur: {
                            isHidden: that.options.showOperateur == false
                        }
                    }
                };
                var layout = {
                    name: "filter-operateur",
                    $type: "block",
                    $items: [
                        {
                            $type: "block",
                            $items: [
                                {
                                    $bind: "champ",
                                    $readOnly: true,
                                    options: {
                                        $expression: "{{champ}}"
                                    }
                                },
                                { $bind: "operateur", options: { titleIsHidden: true } }
                            ]
                        }
                    ]
                };
                var properties = model.properties;
                var states = model.states;
                // Champ
                that.data.champ = that.champ.libelle;
                // Opérateurs
                var unType = that.champ.options.format || that.champ.type;
                properties.operateur.enum = that.listeTypes.getOperateurs(unType);
                properties.operateur.enum.forEach(function (item) {
                    properties.operateur.enumNames.push(that.listeOperateurs.get(item).libelle);
                });
                if (that.filter)
                    that.data.operateur = that.filter.op;
                else
                    that.data.operateur = properties.operateur.enum[0];
                if (that.options.showLabel == false && that.options.showOperateur == false)
                    return;
                var parent = _dom.query(that.container, ".operateur");
                if (parent) {
                    var oldForm = _ui.formManager().formByName('filter-operateur');
                    _ui.removeForm(oldForm);
                    _ui.OpenForm($(parent), layout, model, that.data, {}, function (action, data, formControl) {
                        var model;
                        switch (action.property) {
                            case "operateur":
                                if (action.operation == "propchange") {
                                    var op = that.listeOperateurs.get(data.model().operateur);
                                    that.data.operateur = data.model().operateur;
                                    that.renderValue(op);
                                }
                                break;
                        }
                    });
                }
            };
            FilterEditView.prototype.renderValue = function (op) {
                var that = this;
                var parent = _dom.query(that.container, ".value");
                if (parent) {
                    var oldForm = _ui.formManager().formByName('filter-value');
                    _ui.removeForm(oldForm);
                    var options = that.champ.options || {};
                    options.champName = that.champ.code;
                    that.modelType = new ValueModel(that.champ.options.format || that.champ.type, op, options);
                    that.modelType && that.modelType.init(function () {
                        var model = that.modelType.getModel();
                        var layout = that.modelType.getLayout();
                        if (model && layout) {
                            var ldata = void 0;
                            if (that.filter)
                                that.modelType.setValuesByFilter(that.filter.values);
                            ldata = that.modelType.getData();
                            _ui.OpenForm($(parent), layout, model, ldata, {}, function (action, data, formControl) {
                                switch (action.operation) {
                                    case "propchange":
                                        that.modelType.setValues(data.model());
                                        that.data.values = that.modelType.getValues();
                                        break;
                                    default:
                                        that.modelType.setValues(data.model());
                                        that.data.values = that.modelType.getValues();
                                        break;
                                }
                            });
                        }
                        else
                            that.data.values = that.modelType.getValues();
                    });
                }
            };
            FilterEditView.prototype.renderButton = function () {
                var that = this;
                var model = {
                    type: "object",
                    properties: {},
                    links: {
                        add: {
                            title: "Ajouter"
                        }
                    }
                };
                var layout = {
                    name: "filter-link",
                    $type: "block",
                    $items: [
                        {
                            $inline: true,
                            $items: [
                                {
                                    $bind: "$links.add",
                                    options: {
                                        type: "primary",
                                        icon: "plus",
                                        right: true
                                    }
                                }
                            ],
                            $colSize: 12
                        }
                    ]
                };
                var parent = _dom.query(that.container, ".link");
                if (parent) {
                    var oldForm = _ui.formManager().formByName('filter-link');
                    _ui.removeForm(oldForm);
                    _ui.OpenForm($(parent), layout, model, that.data, {}, function (action, data, formControl) {
                        switch (action.property) {
                            case "$links.add":
                                var fm = _ui.formManager();
                                var fvalue = fm.formByName('filter-value');
                                if (!data.validate() || (fvalue && !fvalue.$model.validate()))
                                    return;
                                var model_1 = data.model();
                                if (that.data.values && that.data.values.length) {
                                    that.callBack({ code: that.champ.code, op: that.data.operateur, values: that.data.values });
                                }
                                break;
                        }
                    });
                }
            };
            FilterEditView.prototype.render = function (parent) {
                var that = this;
                var _html = [
                    '<div>',
                    '<div class="operateur">',
                    '</div>',
                    '<div class="value">',
                    '</div>',
                    '<div class="link">',
                    '</div>',
                    '</div>'
                ];
                if (parent) {
                    that.container = parent;
                    _dom.empty(parent);
                    _dom.append(parent, $(_html.join("")).get(0));
                    that.renderOperateur();
                    that.renderValue(that.listeOperateurs.get(that.data.operateur));
                    that.renderButton();
                }
            };
            return FilterEditView;
        }());
        var RenderModel1 = (function () {
            function RenderModel1(listeChamps, listeChampsArbre, listeFilters, listeOperateurs, listeTypes, options) {
                this.listeChamps = listeChamps;
                this.listeChampsArbre = listeChampsArbre;
                this.listeFilters = listeFilters;
                this.listeOperateurs = listeOperateurs;
                this.listeTypes = listeTypes;
                this.options = options || {};
            }
            RenderModel1.prototype.createContainer = function () {
                var that = this;
                var _html = [
                    '<div class="row">',
                    '<div class="col-sm-5 champ-list">',
                    '</div>',
                    '<div class="col-sm-7 filter-edit">',
                    '</div>',
                    '</div>',
                    '<div class="row">',
                    '<div class="col-sm-12 filter-list">',
                    '</div>',
                    '</div>'
                ];
                that.container = document.createElement("div");
                _dom.addClass(that.container, "filter-view");
                that.container.innerHTML = _html.join("");
                that.champListView = _dom.query(that.container, ".champ-list");
                that.filterListView = _dom.query(that.container, ".filter-list");
                that.filterEditView = _dom.query(that.container, ".filter-edit");
            };
            RenderModel1.prototype.render = function () {
                var that = this;
                that.createContainer();
                if (that.listeChamps.gets().length) {
                    that.showChampList();
                    that.selecteChamp(that, that.listeChamps.gets()[0].code);
                }
                return that.container;
            };
            RenderModel1.prototype.showChampList = function () {
                // let that = this;
                // let list = $('<div class="list-group"></div>').get(0);
                // list.addEventListener("click", function (event) {
                //     item = <HTMLLinkElement>event.target;
                //     if (item["href"]) {
                //         var href = _dom.attr(item, 'href');
                //         if (href === '#') {
                //             event.preventDefault();
                //             event.stopPropagation();
                //         }
                //     }
                //     let champCode = _dom.attr(item, "data-code");
                //     if (champCode)
                //         that.selecteChamp(that, champCode);
                // }, false);
                // let listHeightSize = 70 * (that.options.listSize || 7);
                // let containerScroll = $('<div style="overflow-y:auto;max-height:' + listHeightSize + 'px;"></div>').get(0);
                // _dom.append(containerScroll, list);
                // _dom.append(that.champListView, containerScroll);
                // let item = $('<a href="#" class="list-group-item"></a>').get(0);
                // that.listeChamps && that.listeChamps.gets().forEach(function (champ, key) {
                //     let itemClone = <HTMLLinkElement>item.cloneNode(true);
                //     _dom.attr(itemClone, "data-code", champ.code);
                //     _dom.text(itemClone, champ.libelle);
                //     _dom.append(list, itemClone);
                // });
                var that = this;
                that._multiSelectList = new ui.MultiSelectList(this.listeChampsArbre, { maxHeight: "auto" }, function (data) {
                    if (data && data.data.name)
                        that.selecteChamp(that, data.data.name);
                });
                var listHeightSize = 70 * (that.options.listSize || 7);
                var containerScroll = $('<div style="border: 1px solid #dddddd; overflow:auto;max-height:' + listHeightSize + 'px;"></div>').get(0);
                that._multiSelectList.render(containerScroll);
                _dom.append(that.champListView, containerScroll);
            };
            RenderModel1.prototype.selecteChamp = function (that, codeChamp) {
                // let oldItem = _dom.query(that.champListView, ".active");
                // let newItem = _dom.query(that.champListView, 'a[data-code="' + codeChamp + '"]');
                // if (oldItem)
                //     _dom.removeClass(oldItem, "active");
                // if (newItem)
                //     _dom.addClass(newItem, "active");
                that._multiSelectList.addItem(codeChamp);
                that.updateFilter(that, codeChamp);
                var filters = that.listeFilters.getsByChamp(codeChamp);
                var filter = null;
                if (filters && filters.length)
                    filter = filters[0];
                that.showFilterList(that, filter);
            };
            RenderModel1.prototype.showFilterList = function (that, filter) {
                var editView = new FilterListView(that.listeChamps, that.listeFilters, that.listeOperateurs, function (action, data) {
                    if (action == "EDIT") {
                        var filter_2 = that.listeFilters.get(data.id);
                        if (filter_2)
                            that.selecteChamp(that, filter_2.code);
                    }
                    else if (action == "REMOVE")
                        that.removeFilter(that, data.id);
                    else if (action == "VALIDE")
                        that.valideFilters();
                }, that.options, filter);
                _dom.empty(that.filterListView);
                editView.render(that.filterListView);
            };
            RenderModel1.prototype.updateFilter = function (that, codeChamp) {
                var champ = that.listeChamps.get(codeChamp);
                var filters = that.listeFilters.getsByChamp(codeChamp);
                var filter = null;
                if (filters && filters.length)
                    filter = filters[0];
                var editView = new FilterEditView(champ, that.listeFilters, that.listeOperateurs, that.listeTypes, function (data) {
                    that.addFilter(that, data);
                }, filter, that.options);
                _dom.empty(that.filterEditView);
                editView.render(that.filterEditView);
            };
            RenderModel1.prototype.addFilter = function (that, data) {
                var filters = that.listeFilters.getsByChamp(data.code);
                var filter;
                if (!that.options.multiple && filters && filters.length)
                    filter = that.listeFilters.set(filters[0].id, data);
                else
                    filter = that.listeFilters.add(data.code, data.op, data.values);
                that.showFilterList(that, filter);
            };
            RenderModel1.prototype.removeFilter = function (that, codeFilter) {
                var codeChamp = that.listeFilters.get(codeFilter).code;
                that.listeFilters.remove(codeFilter);
                that.selecteChamp(that, codeChamp);
            };
            RenderModel1.prototype.valideFilters = function () { };
            return RenderModel1;
        }());
        var RenderModel2 = (function (_super) {
            __extends(RenderModel2, _super);
            function RenderModel2(listeChamps, listeChampsArbre, listeFilters, listeOperateurs, listeTypes, options, callback) {
                options.btnValidate = true;
                _super.call(this, listeChamps, listeChampsArbre, listeFilters, listeOperateurs, listeTypes, options);
                this._callback = callback;
            }
            RenderModel2.prototype.createContainer = function () {
                var that = this;
                var _html = [
                    '<div class="row">',
                    '<div class="col-sm-12 filter-list">',
                    '</div>',
                    '</div>',
                    '<div class="row">',
                    '<div class="col-xs-12">',
                    '<h5 class="bs-block-title" data-ignore="true">' + (that.options.title || "Filtre") + '</h5>',
                    '</div>',
                    '</div>',
                    '<div class="row">',
                    '<div class="col-sm-4 champ-list">',
                    '</div>',
                    '<div class="col-sm-8 filter-edit">',
                    '</div>',
                    '</div>'
                ];
                that.container = document.createElement("div");
                _dom.addClass(that.container, "filter-view");
                that.container.innerHTML = _html.join("");
                that.champListView = _dom.query(that.container, ".champ-list");
                that.filterListView = _dom.query(that.container, ".filter-list");
                that.filterEditView = _dom.query(that.container, ".filter-edit");
            };
            RenderModel2.prototype.valideFilters = function () {
                this._callback("VALIDE");
            };
            return RenderModel2;
        }(RenderModel1));
        var TagView = (function (_super) {
            __extends(TagView, _super);
            function TagView(fp, options, form) {
                _super.call(this, fp, options, form);
                var that = this;
                form.registerListenerFor(that.$bind + ".$item", that);
                this._state();
            }
            TagView.prototype._state = function () {
                var that = this;
                that.state = that.state || {};
                var state = that.form.getState(that.$bind);
                Object.keys(state).forEach(function (pn) {
                    that.state[pn] = state[pn];
                });
                that.state.value = that.form.getValue(that.$bind);
            };
            TagView.prototype.click = function (event) {
                var that = this;
                var target = event.target;
                if (target.nodeName.toUpperCase() == "LI" || target.nodeName.toUpperCase() == "I") {
                    var tag = target;
                    if (target.nodeName.toUpperCase() == "I")
                        tag = _dom.parentByTag(that.$element.get(0), target, "LI");
                    var tagId_1 = -1;
                    if (tag)
                        tagId_1 = parseInt(_dom.attr(tag, "data-id"), 10);
                    if (tagId_1 < 0)
                        return;
                    tag = null;
                    var model_2 = null;
                    that.state.value.forEach(function (item, index) {
                        if (item.code == tagId_1) {
                            model_2 = item.model();
                            return false;
                        }
                    });
                    if (!model_2)
                        return;
                    var btnType = _dom.attr(target, "data-id");
                    if (btnType == "REMOVE")
                        that.form.execAction("remove", model_2);
                    else
                        that.form.execAction("upd", model_2);
                }
            };
            TagView.prototype._state2UI = function () {
                var that = this;
                that.createContainer(that.id);
                that.state.value && that.state.value.forEach(function (tag) {
                    that.addTag(tag);
                });
            };
            TagView.prototype.destroy = function () {
                var that = this;
                that.form.unRegisterListenerFor(that.$bind + ".$item", that);
                _super.prototype.destroy.call(this);
            };
            TagView.prototype.changed = function (propName, ov, nv, op, obj) {
                var that = this;
                if (op == "add") {
                    that.addTag(nv);
                }
                else if (op == "remove") {
                    that.removeTag(obj.$value.code);
                }
            };
            TagView.prototype.stateChanged = function (propName, params) {
                var that = this, state = that.form.getState(that.$bind), element = that.$element ? that.$element.get(0) : null;
                if (element && state.isHidden !== that.state.isHidden) {
                    that.state.isHidden = state.isHidden;
                    that.setHidden(element);
                }
            };
            TagView.prototype.addTag = function (tag) {
                var that = this;
                var item = document.createElement("li");
                _dom.addClass(item, "item");
                _dom.addClass(item, "boxed-tags-item");
                _dom.addClass(item, "bs-cursor-p");
                _dom.addClass(item, "btn-primary");
                if (tag.selected)
                    _dom.addClass(item, "focus");
                _dom.attr(item, "data-id", tag.code);
                //item.innerHTML = tag.libelle + ' <i data-id="UPDATE" class="glyphicon glyphicon-pencil" ></i><i data-id="REMOVE" class="glyphicon glyphicon-remove" ></i>';
                item.innerHTML = tag.libelle + ' <i data-id="REMOVE" class="glyphicon glyphicon-remove" ></i>';
                _dom.append(that.$element.get(0), item);
            };
            TagView.prototype.removeTag = function (id) {
                var that = this;
                var tag = _dom.query(that.$element.get(0), 'li[data-id="' + id + '"]');
                _dom.remove(tag);
            };
            TagView.prototype.createContainer = function (id) {
                var that = this;
                that.$element = $(_utils.format('<ul id="{0}" data-render="{0}" class="boxed-tags" draggable="true"></ul>', id));
            };
            TagView.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    that.setEvents(null);
                    that._state2UI();
                }
                that.appendElement($parent, opts);
                return that.$element;
            };
            return TagView;
        }(ui.AbsField));
        _ui.registerControl(TagView, "array", false, 'tagview');
        var CheckBoxList = (function () {
            function CheckBoxList(options) {
                var that = this;
                that.options = options || {};
                that._elements = [];
                that._values = [];
            }
            Object.defineProperty(CheckBoxList.prototype, "elements", {
                get: function () {
                    return this._elements;
                },
                set: function (value) {
                    if (value) {
                        this._elements = value;
                        this._notifyChange("elements");
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(CheckBoxList.prototype, "values", {
                get: function () {
                    return this._values;
                },
                set: function (value) {
                    if (value) {
                        this._values = value;
                        this._notifyChange("values");
                    }
                },
                enumerable: true,
                configurable: true
            });
            CheckBoxList.prototype._notifyChange = function (propName) {
                var that = this;
                switch (propName) {
                    case "elements":
                        _dom.empty(that.$element.get(0));
                        that.renderElements(that.elements || [], that.values || [], that.options || {});
                        break;
                }
            };
            CheckBoxList.prototype.findVal = function (val) {
                var index = -1;
                this.values.forEach(function (item, i) {
                    if (item == val) {
                        index = i;
                        return false;
                    }
                });
                return index;
            };
            CheckBoxList.prototype.render = function ($parent) {
                var that = this;
                if (!that.$element) {
                    that.$element = $('<div class="row bs-checkboxlist"></div>');
                    that.renderElements(that.elements, that.values, that.options);
                    that.setEvents(null);
                }
                if ($parent) {
                    if (that.options.replaceParent)
                        $parent.replaceWith(that.$element);
                    else
                        $parent.append(that.$element);
                }
                return that.$element;
            };
            CheckBoxList.prototype.destroy = function () {
                var that = this;
                that._removeEvents();
                that.$element = null;
                that.options = null;
            };
            CheckBoxList.prototype.removeVal = function (val) {
                var that = this;
                var index = that.findVal(val);
                if (index >= 0)
                    that.values.splice(index, 1);
            };
            CheckBoxList.prototype.addVal = function (val) {
                this.values.push(val);
            };
            CheckBoxList.prototype.setEvents = function (opts) {
                var that = this;
                if (that.$element) {
                    that.$element.on('click', function (event) {
                        if (that.options.isDisabled || that.options.isReadOnly)
                            return;
                        var row = _dom.parentByClass(that.$element.get(0), event.target, "bs-checkboxlist-list");
                        if (!row)
                            return;
                        that._toggleEnumByIndex(_dom.indexOf(row.parentNode, row));
                    });
                }
            };
            CheckBoxList.prototype._removeEvents = function () {
                var that = this;
                if (that.$element)
                    that.$element.off('click');
            };
            CheckBoxList.prototype.renderElements = function (elements, values, options) {
                var that = this;
                var f = document.createDocumentFragment();
                if (!elements.length) {
                    var e = $('<center><div class="bs-lv-nodata">Aucun résultat trouvé ...</div></center>').get(0);
                    _dom.append(f, e);
                }
                else {
                    options = options || {};
                    //let e: HTMLElement = $('<div tabindex="0" class="bs-checkboxlist-list checkbox-inline"><div class="bs-checkboxlist-list-check"><a><center><span class="' + _dom.iconClass('square-o') + '"></span></center></a></div><div class="bs-checkboxlist-list-title"></div></div>').get(0);
                    var e_1 = $('<div tabindex="0" class="bs-checkboxlist-list col-lg-6 col-xs-12 checkbox-inline"><div class="bs-checkboxlist-list-check"><a><span class="' + _dom.iconClass('square-o') + '"></span></a></div><div class="bs-checkboxlist-list-title"></div></div>').get(0);
                    elements.forEach(function (en, index) {
                        var ii = e_1.cloneNode(true);
                        if (options.disabled) {
                            _dom.attr(ii, "tabindex", "-1");
                            _dom.removeClass(ii, "bs-pointer");
                            _dom.addClass(ii, "bs-cursor-disabled");
                        }
                        else {
                            _dom.attr(ii, "tabindex", "0");
                            _dom.addClass(ii, "bs-pointer");
                            _dom.removeClass(ii, "bs-cursor-disabled");
                        }
                        var check = ii.firstChild.firstChild.firstChild;
                        check.className = (values && values.indexOf(en.code) >= 0) ? _dom.iconClass("check-square-o") : _dom.iconClass("square-o");
                        var tparent = ii.lastChild;
                        _dom.append(tparent, document.createTextNode(en.libelle)),
                            _dom.append(f, ii);
                    });
                }
                _dom.append(that.$element.get(0), f);
            };
            CheckBoxList.prototype._inputs = function () {
                return this.$element.get(0);
            };
            CheckBoxList.prototype._setItemValue = function (item, value) {
                var check = item.firstChild.firstChild.firstChild;
                check.className = value ? _dom.iconClass("check-square-o") : _dom.iconClass("square-o");
            };
            CheckBoxList.prototype._toggleEnumByIndex = function (index) {
                var that = this;
                if (index >= 0 && index < that.elements.length) {
                    var e = that.elements[index];
                    var ii = that.findVal(e.code);
                    var inputs = that._inputs();
                    if (ii >= 0) {
                        that._setItemValue(inputs.childNodes[index], false);
                        that.removeVal(e.code);
                        if (that.options.onSelectItem)
                            that.options.onSelectItem("remove", { id: index, value: e, data: e });
                    }
                    else {
                        that._setItemValue(inputs.childNodes[index], true);
                        that.addVal(e.code);
                        if (that.options.onSelectItem)
                            that.options.onSelectItem("add", { id: index, value: e, data: e });
                    }
                }
            };
            return CheckBoxList;
        }());
        ui.CheckBoxList = CheckBoxList;
        var LookupList = (function (_super) {
            __extends(LookupList, _super);
            function LookupList(fp, options, form) {
                _super.call(this, fp, options, form);
                var that = this;
                form.registerListenerFor(that.$bind + ".$item", that);
                this._state();
            }
            LookupList.prototype._state = function () {
                var that = this;
                that.state = that.state || {};
                var state = that.form.getState(that.$bind);
                Object.keys(state).forEach(function (pn) {
                    that.state[pn] = state[pn];
                });
                that.state.value = that.form.getValue(that.$bind);
            };
            LookupList.prototype.click = function (event) {
            };
            LookupList.prototype._state2UI = function () {
            };
            LookupList.prototype.destroy = function () {
                var that = this;
                that.form.unRegisterListenerFor(that.$bind + ".$item", that);
                _super.prototype.destroy.call(this);
            };
            LookupList.prototype.changed = function (propName, ov, nv, op, obj) {
                //let that = this;
                //that._list.values = that._getValues();
            };
            LookupList.prototype.stateChanged = function (propName, params) {
            };
            LookupList.prototype._createContainer = function (id, authoring, title, options) {
                var that = this;
                var html = [
                    '<div id="{0}" data-render="{0}">',
                    '<label for="{0}_input" id="{0}_label" class="' + (!title ? "bs-none" : "") + '">' + (title || '') + '</label>',
                    '<div id="{0}_toolbar"></div>',
                    '<br />',
                    '<div id="{0}_list"></div>',
                    '<center id="{0}_paginer"></center>',
                    '</div>'
                ];
                return _utils.format(html.join(''), id);
            };
            LookupList.prototype._onSelectToolElement = function (toolElement) {
                var that = this;
                if (toolElement.name === "search")
                    that._lookup.search(toolElement.value);
            };
            LookupList.prototype.createToolBar = function (id, options) {
                var that = this;
                if (!that.$element)
                    return;
                if (!that._toolbar) {
                    var toolElements = [{
                            "name": "search",
                            "type": "search",
                            "right": false
                        }];
                    options = $.extend({ selectToolElement: that._onSelectToolElement.bind(that) });
                    that._toolbar = new _ui.ToolBar(toolElements, options);
                    var container = _dom.query(that.$element.get(0), "#" + id + "_toolbar");
                    if (!container)
                        return;
                    that._toolbar.render($(container));
                }
            };
            LookupList.prototype._onSelectPaginer = function (page) {
                var that = this;
                switch (page) {
                    case "next":
                        that._lookup.nextPage();
                        break;
                    case "prev":
                        that._lookup.prevPage();
                        break;
                    case "first":
                        that._lookup.firthPage();
                        break;
                    case "last":
                        that._lookup.lastPage();
                        break;
                    default:
                        that._lookup.toPage(page - 1);
                        break;
                }
            };
            LookupList.prototype.createPaginer = function (id, options) {
                var that = this;
                if (!that.$element)
                    return;
                if (!that._pager) {
                    options = $.extend({ size: "default", boundaryLinks: true, selectPage: that._onSelectPaginer.bind(that) }, options);
                    that._pager = new _ui.Pager(options);
                    var container = _dom.query(that.$element.get(0), "#" + id + "_paginer");
                    if (!container)
                        return;
                    that._pager.render($(container));
                }
                var p = that._pager;
                p.props.totalPages = that._lookup.getNbPages();
                p.props.currentPage = that._lookup.currentPage() + 1;
            };
            LookupList.prototype._onSelectCheckBoxList = function (action, data) {
                var that = this;
                if (action === "add")
                    that.state.value.push({ code: data.value.code, lib: data.value.libelle });
                else if (action === "remove")
                    that.state.value.remove(that.state.value.find("code", data.value.code));
            };
            LookupList.prototype._getValues = function () {
                var that = this;
                var ld = $.extend(true, {}, that.state.value);
                ld._items = ld._items.map(function (item) {
                    return item.code;
                });
                return ld._items;
            };
            LookupList.prototype.createList = function (id, options) {
                var that = this;
                if (!that.$element)
                    return;
                if (!that._list) {
                    that._list = new _ui.CheckBoxList({ onSelectItem: that._onSelectCheckBoxList.bind(that) });
                    that._list.values = that._getValues();
                    var container = _dom.query(that.$element.get(0), "#" + id + "_list");
                    if (!container)
                        return;
                    that._list.render($(container));
                }
            };
            LookupList.prototype.createLookup = function (options) {
                var that = this;
                if (that.$schema.ds) {
                    var notify = function (data, options) {
                        options = options || {};
                        if (options.inited && options.updated)
                            that._lookup.firthPage();
                        else if (data) {
                            if (that.$schema.ds.data.$params.$search)
                                that.createToolBar(that.id, {});
                            that.createList(that.id, {});
                            that._list.elements = data;
                            that.createPaginer(that.id, that.renderOptions.pager);
                        }
                    };
                    that._lookup = new _ui.DsLookup(that.$schema.ds, { notify: notify });
                }
            };
            LookupList.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    that.setEvents(null);
                    that.$element = $(that._createContainer(that.id, _ulocale.tt(that.$schema.title, that.form.$locale), that.options.design, opts));
                    that.createLookup({});
                    that._state2UI();
                }
                that.appendElement($parent, opts);
                return that.$element;
            };
            return LookupList;
        }(ui.AbsField));
        _ui.registerControl(LookupList, "array", false, 'lookup-list', null);
        var ComposantFilter = (function (_super) {
            __extends(ComposantFilter, _super);
            function ComposantFilter(fp, options, form) {
                _super.call(this, fp, options, form);
                this.renderInternal = function (context, options) {
                    var that = this;
                    if (!that.$element)
                        return;
                    var view;
                    switch (options["renderModel"]) {
                        case "model2":
                            view = new RenderModel2(that.listeChamps, that.listeChampsArbre, that.listeFilters, that.listeOperateurs, that.listeTypes, options, function (action, data) {
                                if (action == "VALIDE")
                                    that.form.execAction("validate", {});
                            });
                            break;
                        default:
                            view = new RenderModel1(that.listeChamps, that.listeChampsArbre, that.listeFilters, that.listeOperateurs, that.listeTypes, options);
                    }
                    _dom.append(that.$element.get(0), view.render());
                };
                this.createContainer = function (id) {
                    return _utils.format('<div id="{0}" data-render="{0}" class="bs-filter"></div>', id);
                };
                this._state();
                this.options = options || {};
                this.initData();
            }
            ComposantFilter.prototype.initData = function () {
                var that = this;
                // reporter sur un fichier json les labels
                that.listeOperateurs = new ListeOperateurs();
                that.listeOperateurs.add("in", "égal à", false, { symbol: "=" });
                that.listeOperateurs.add("nin", "différent de", false, { symbol: "!=" });
                that.listeOperateurs.add("gt", "supérieur à", false, { symbol: ">" });
                that.listeOperateurs.add("ge", "supérieur ou égal à", false, { symbol: ">=" });
                that.listeOperateurs.add("lt", "inférieur à", false, { symbol: "<" });
                that.listeOperateurs.add("le", "inférieur ou égal à", false, { symbol: "<=" });
                that.listeOperateurs.add("between", "entre", true, { symbol: "entre" });
                that.listeOperateurs.add("nbetween", "pas entre", true, { symbol: "pas entre" });
                that.listeOperateurs.add("like", "contient", false, { symbol: "contient" });
                that.listeOperateurs.add("nlike", "ne contient pas", false, { symbol: "ne contient pas" });
                that.listeOperateurs.add("vide", "vide", false, { symbol: "est vide" });
                that.listeOperateurs.add("nvide", "pas vide", false, { symbol: "n'est pas vide" });
                that.listeTypes = new ListeTypes();
                that.listeTypes.addType("decimal", "Décimal", ["in", "nin", "gt", "ge", "lt", "le", "between", "nbetween", "vide", "nvide"]);
                that.listeTypes.addType("money", "Money", ["in", "nin", "gt", "ge", "lt", "le", "between", "nbetween", "vide", "nvide"]);
                that.listeTypes.addType("integer", "Entier", ["in", "nin", "gt", "ge", "lt", "le", "between", "nbetween", "vide", "nvide"]);
                that.listeTypes.addType("date", "Date", ["in", "nin", "gt", "ge", "lt", "le", "between", "nbetween", "vide", "nvide"]);
                that.listeTypes.addType("string", "Chaîne de caractères", ["in", "nin", "like", "nlike", "vide", "nvide"]);
                that.listeTypes.addType("enum", "Enum", ["in", "nin", "vide", "nvide"]);
                that.listeTypes.addType("lookup", "Lookup", ["in", "nin", "vide", "nvide"]);
                that.listeTypes.addType("boolean", "Booléen", ["in", "nin", "vide", "nvide"]);
                that.listeChamps = new ListeChamps();
                var champs = that.state.value && that.state.value.champs ? that.state.value.champs : [];
                champs.forEach(function (item) {
                    var options = {};
                    if (item.lookup) {
                        options["lookupSchema"] = _sutils.getLookup(that.$bind, item.lookup, that.$schema, that.form.$rootSchema);
                        options["lookup"] = item.lookup;
                        options["format"] = "lookup";
                    }
                    else if (item.enum && item.enum.length) {
                        options["enum"] = item.enum;
                        options["enumName"] = item.enumName;
                        options["format"] = "enum";
                    }
                    else if (item.type === "boolean") {
                        options["enum"] = [{ code: "true", libelle: "Vrai" }, { code: "false", libelle: "Faux" }];
                        options["format"] = "enum";
                    }
                    else {
                        options["decimals"] = item.decimals;
                        options["format"] = item.format || null;
                    }
                    that.listeChamps.add(item.code, item.libelle, item.type, options);
                });
                var filters = that.state.value && that.state.value.filters ? that.state.value.filters : [];
                that.listeFilters = new ListeFilters(filters);
                filters.forEach(function (item) {
                    var values = [];
                    item.values.forEach(function (value) {
                        values.push(value);
                    });
                    var values2 = [];
                    if (item.values2) {
                        item.values2.forEach(function (value) {
                            values2.push(value);
                        });
                    }
                    that.listeFilters.add2(item.code, item.op, values2.length ? values2 : values);
                });
                that.listeChampsArbre = that.state.value && that.state.value.entree ? that.state.value.model().entree : null;
                if (!that.listeChampsArbre)
                    that.listeChampsArbre = that.listeChamps.gets().map(function (item) {
                        return { name: item.code, title: item.libelle };
                    });
            };
            ComposantFilter.prototype._state = function () {
                var that = this;
                that.state = that.state || {};
                var state = that.form.getState(that.$bind);
                Object.keys(state).forEach(function (pn) {
                    that.state[pn] = state[pn];
                });
                that.state.value = that.form.getValue(that.$bind);
            };
            ComposantFilter.prototype.click = function (event) { };
            ComposantFilter.prototype._setDisabled = function (input, element) { };
            ComposantFilter.prototype._setReadOnly = function (input, element) { };
            ComposantFilter.prototype._setMandatory = function (input, element) { };
            ComposantFilter.prototype._state2UI = function () { };
            ComposantFilter.prototype.changed = function (propName, ov, nv, op) { };
            ComposantFilter.prototype.stateChanged = function (propName, params) { };
            ComposantFilter.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    that.$element = $(that.createContainer(that.id));
                    _dom.empty(that.$element.get(0));
                    opts.id = that.id;
                    opts.title = that.$schema.title || "";
                    opts = $.extend(true, opts, that.renderOptions);
                    that.renderInternal({ data: that.state.value }, opts);
                    that.setEvents(null);
                    that._state2UI();
                }
                that.appendElement($parent, opts);
                return that.$element;
            };
            ComposantFilter.prototype.destroy = function () {
                _super.prototype.destroy.call(this);
            };
            return ComposantFilter;
        }(ui.AbsField));
        ui.ComposantFilter = ComposantFilter;
        _ui.registerControl(ComposantFilter, "object", false, 'filter');
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../../js/core/core.ts" />
/// <reference path="../../js/ui/form/modalform.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui;
        var _addField2 = function (fieldList, code, libelle, type, options) {
            options = options || {};
            var champ = {
                code: code,
                libelle: libelle,
                type: type,
                format: options.format || null,
                decimals: options.decimals,
                enum: options.enum,
                enumName: options.enumName,
                lookup: options.lookup
            };
            fieldList.push(champ);
        }, _addField = function (fieldList, code, libelle, type, decimals, enums, enumName) {
            var options = {};
            options["decimals"] = decimals;
            options["enum"] = enums;
            options["enumName"] = enumName;
            _addField2(fieldList, code, libelle, type, options);
        }, _toPhenix = function (champs, filters) {
            if (!champs || !filters)
                return null;
            var constructeOdata = function (oFilters, op) {
                var tmpFilters = [];
                var isImpair = oFilters.length % 2 != 0;
                var length = isImpair ? oFilters.length - 1 : oFilters.length;
                for (var i = 0; i < length; i += 2) {
                    tmpFilters.push({ $left: oFilters[i], $op: op, $right: oFilters[i + 1] });
                }
                if (isImpair)
                    tmpFilters.push(oFilters[oFilters.length - 1]);
                if (tmpFilters.length >= 2)
                    tmpFilters = constructeOdata(tmpFilters, op);
                return tmpFilters;
            };
            var constructeFilter = function (filter) {
                var champ = champs.find(function (item) { return item.code == filter.code; });
                var op = filter.op == "in" ? "eq" : filter.op;
                op = op == "nin" ? "ne" : op;
                var values = filter.values.map(function (item) {
                    if (item.code)
                        return item.code;
                    return item;
                });
                if (op == "between" || op == "nbetween") {
                    if (op == "between")
                        return between(filter.code, champ.type, values[0], values[1]);
                    else
                        return { $op: "not", $right: between(filter.code, champ.type, values[0], values[1]) };
                }
                else {
                    values = values.map(function (item) {
                        var value = null;
                        switch (op) {
                            case "like":
                                value = like(filter.code, champ.type, item);
                                break;
                            case "nlike":
                                value = { $op: "not", $right: like(filter.code, champ.type, item) };
                                break;
                            case "vide":
                                value = { $left: filter.code, $op: "eq", $right: { type: "string", value: '' } };
                                break;
                            case "nvide":
                                value = { $left: filter.code, $op: "ne", $right: { type: "string", value: '' } };
                                break;
                            default:
                                value = { $left: filter.code, $op: op, $right: { type: champ.type, value: item } };
                        }
                        return value;
                    });
                    return constructeOdata(values, "or")[0];
                }
                function between(code, type, value1, value2) {
                    return {
                        $left: { $left: code, $op: "ge", $right: { type: type, value: value1 } },
                        $op: "and",
                        $right: { $left: code, $op: "le", $right: { type: type, value: value2 } }
                    };
                }
                function like(code, type, value) {
                    return {
                        $left: 'contains(' + code + ',\'' + value + '\')',
                        $op: null,
                        $right: null
                    };
                }
            };
            var oFilters = [];
            filters.forEach(function (filter) {
                oFilters.push(constructeFilter(filter));
            });
            return constructeOdata(oFilters, "and")[0];
        };
        ui.filterData = {
            filter: {
                champs: [],
                filters: [],
                entree: []
            }
        };
        _ui["glbGridFilter"] = function (params, callback, locale) {
            if (!params.schemaColumns.length)
                return;
            var layout = {
                "name": "filtre",
                "$type": "block",
                "$items": [
                    {
                        "$type": "block",
                        "$items": [
                            {
                                "$bind": "filter",
                                "$widget": "filter",
                                "options": {
                                    "renderModel": "model1"
                                }
                            }
                        ]
                    }
                ],
                "form": true
            };
            var model = {
                "type": "object",
                "properties": {
                    "filter": {
                        "type": "object",
                        "title": "Filtre",
                        "properties": {
                            "champs": {
                                "type": "array",
                                "items": {
                                    "type": "object",
                                    "properties": {
                                        "code": { "type": "string" },
                                        "libelle": { "type": "string" },
                                        "type": { "type": "string" },
                                        "format": { "type": "string" },
                                        "decimals": { "type": "number" },
                                        "enumName": { "type": "string" },
                                        "enum": {
                                            "type": "array",
                                            "items": {
                                                "type": "object",
                                                "properties": {
                                                    "code": { "type": "string" },
                                                    "libelle": { "type": "string" }
                                                }
                                            }
                                        },
                                        "lookup": {
                                            "type": "string"
                                        }
                                    }
                                }
                            },
                            "filters": {
                                "type": "array",
                                "items": {
                                    "type": "object",
                                    "properties": {
                                        "code": { "type": "string" },
                                        "op": { "type": "string" },
                                        "values": {
                                            "type": "array",
                                            "items": {
                                                "type": "string"
                                            }
                                        },
                                        "values2": {
                                            "type": "array",
                                            "items": {
                                                "type": "object",
                                                "properties": {
                                                    "code": {
                                                        "type": "string"
                                                    },
                                                    "lib": {
                                                        "type": "string"
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            },
                            "entree": {
                                "type": "array",
                                "items": {
                                    "type": "object",
                                    "properties": {
                                        "title": {
                                            "type": "string"
                                        },
                                        "name": {
                                            "type": "string"
                                        },
                                        "items": {
                                            "type": "array"
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            };
            if (ui.filterData.filter.champs.length)
                ui.filterData.filter.champs.splice(0);
            params.schemaColumns.forEach(function (item) {
                var sc = $.extend(true, {}, item.schema);
                switch (sc.type) {
                    case "number":
                        if (sc.decimals > 0)
                            sc.type = "decimal";
                        else
                            sc.type = "integer";
                        break;
                }
                if (item.schema.enum) {
                    sc.enum = item.schema.enum.map(function (en, i) {
                        return { code: en, libelle: item.schema.enumNames ? item.schema.enumNames[i] : en };
                    });
                }
                _ui.filter.addField2(ui.filterData.filter.champs, item.name, sc.title, sc.type, { decimals: sc.decimals, enum: sc.enum, format: sc.format });
            });
            if (ui.filterData.filter.entree)
                ui.filterData.filter.entree = ui.multiSelectUtils.transformPropsToMultiselectFormat(params.schemaColumns, params.schemaGroups);
            var opts = { "title": "Filtre", "buttons": [{ "pattern": "validate" }] };
            _ui.OpenModalForm(opts, layout, model, ui.filterData, locale, function (form, action, model, formControl) {
                switch (action.property) {
                    case "validate":
                        if (!model.validate())
                            return;
                        ui.filterData = model.model();
                        var $filter = null;
                        if (ui.filterData.filter.filters.length)
                            $filter = _ui.filter.format.toPhenix(ui.filterData.filter.champs, ui.filterData.filter.filters);
                        if (callback)
                            callback({ value: $filter, title: formatFiltersForTooltip(ui.filterData.filter.filters, ui.filterData.filter.champs) });
                        form.close();
                        break;
                }
            });
            function formatFiltersForTooltip(filters, champs) {
                var tooltip = [];
                filters.forEach(function (item) {
                    champs.forEach(function (champ) {
                        if (item.code === champ.code) {
                            item.lib = champ.libelle;
                            return false;
                        }
                    });
                    var format = (item.lib || item.code) + " " + getSymbol(item.op);
                    if (item.op === "vide" || item.op === "nvide")
                        format += " vide";
                    else if (item.op === "between" || item.op === "nbetween")
                        format += " " + item.values[0] + " et " + item.values[1];
                    else {
                        if (item.getValueNames)
                            format += " " + item.getValueNames().join(",");
                        else
                            format += " " + item.values.join(",");
                    }
                    if (tooltip.length)
                        tooltip.push(" et ");
                    tooltip.push(format);
                });
                function getSymbol(op) {
                    var symb;
                    switch (op) {
                        case "in":
                            symb = "=";
                            break;
                        case "nin":
                            symb = "!=";
                            break;
                        case "like":
                            symb = "contient";
                            break;
                        case "nlike":
                            symb = "ne contient pas";
                            break;
                        case "vide":
                            symb = "est";
                            break;
                        case "nvide":
                            symb = "n'est pas";
                            break;
                        case "gt":
                            symb = ">";
                            break;
                        case "ge":
                            symb = ">=";
                            break;
                        case "lt":
                            symb = "<";
                            break;
                        case "le":
                            symb = "<=";
                            break;
                        case "between":
                            symb = "entre";
                            break;
                        case "nbetween":
                            symb = "pas entre";
                            break;
                        default:
                            symb = op;
                    }
                    return symb;
                }
                return tooltip.join("");
            }
        };
        ui.filter = {
            format: {
                toPhenix: _toPhenix
            },
            addField: _addField,
            addField2: _addField2
        };
        var FilterManager = (function () {
            function FilterManager() {
                this.filterComplex = null;
                this.filterExpress = null;
            }
            FilterManager.prototype.constructeFilter = function () {
                var that = this;
                if (that.filterComplex && that.filterComplex.value && that.filterExpress && that.filterExpress.value)
                    return { title: that.filterComplex.title + " et " + that.filterExpress.title, value: { $left: that.filterComplex.value, $op: "AND", $right: that.filterExpress.value } };
                else if (that.filterComplex && that.filterComplex.value)
                    return that.filterComplex;
                else if (that.filterExpress && that.filterExpress.value)
                    return that.filterExpress;
                return { title: "", value: null };
            };
            return FilterManager;
        }());
        ui.FilterManager = FilterManager;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../../js/core/core.ts" />
/// <reference path="../../js/ui/form/modalform.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui;
        _ui["glbGridSettings"] = function (params, callback, locale) {
            var layout = {
                "name": "settings",
                "$type": "block",
                "$items": [
                    {
                        "$type": "block",
                        "$items": [
                            {
                                "$bind": "mselect",
                                "$widget": "multiselectlist",
                                "options": {
                                    multiSelect: true
                                }
                            }
                        ]
                    }
                ],
                "form": true
            };
            var model = {
                "properties": {
                    "mselect": {
                        "type": "object",
                        "properties": {
                            "entree": {
                                "type": "array",
                                "items": {
                                    "type": "object",
                                    "properties": {
                                        "title": {
                                            "type": "string"
                                        },
                                        "name": {
                                            "type": "string"
                                        },
                                        "items": {
                                            "type": "array"
                                        }
                                    }
                                }
                            },
                            "sortie": {
                                "type": "array",
                                "items": {
                                    "type": "object",
                                    "properties": {
                                        "title": {
                                            "type": "string"
                                        },
                                        "name": {
                                            "type": "string"
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            };
            params.options = params.options || {};
            var ldata = {
                mselect: {
                    entree: ui.multiSelectUtils.transformPropsToMultiselectFormat(params.schemaColumns, params.schemaGroups, params.options.columnsLimited),
                    sortie: ui.multiSelectUtils.transformSelectedColumnsToMultiSelectFormat(params.schemaColumns, params.selectedColumns, params.schemaGroups, params.options.columnsLimited)
                }
            };
            var opts = { "title": params.locale && params.locale.settingsTitle ? params.locale.settingsTitle : "Options", "buttons": [{ "pattern": "validate" }] };
            _ui.OpenModalForm(opts, layout, model, ldata, locale, function (form, action, model, formControl) {
                switch (action.property) {
                    case "validate":
                        if (!model.validate())
                            return;
                        var sortie = model.model().mselect.sortie;
                        if (sortie <= 0)
                            return;
                        var columns = ui.multiSelectUtils.transformMultiSelectColumnsToGridColumnsFormat(sortie);
                        if (callback)
                            callback(columns);
                        form.close();
                        break;
                }
            });
        };
        var _transformPropsToMultiselectFormat = function (columns, groups, columnsLimited) {
            var gs = groups && groups.items ? groups.items : [];
            var fields = groups && groups.fields ? groups.fields : [];
            var items = groups && groups.items ? $.extend(true, [], gs) : [];
            if (columnsLimited)
                constructeLimitItems(items, fields, columns);
            else
                constructeItems(items, columns);
            function constructeLimitItems(items, fields, columns) {
                items.forEach(function (item) {
                    item.items = item.items || [];
                    constructeLimitItems(item.items, item.fields || [], columns);
                });
                fields.forEach(function (field) {
                    columns.every(function (column) {
                        if (field.name === column.name) {
                            field.title = column.schema.title || column.name;
                            return false;
                        }
                        return true;
                    });
                    items.push(field);
                });
            }
            function constructeItems(groups, columns) {
                columns.forEach(function (column) {
                    var item = {
                        name: column.name,
                        title: column.schema.title || column.name
                    };
                    var g = getGroup(groups, column.schema.group);
                    if (g) {
                        g.items = g.items || [];
                        g.items.push(item);
                    }
                    else
                        groups.push(item);
                });
                function getGroup(groups, name) {
                    var that = this;
                    var item = null;
                    groups.every(function (g) {
                        if (g.name === name) {
                            item = g;
                            return false;
                        }
                        else if (g.items) {
                            item = getGroup(g.items, name);
                            if (item)
                                return false;
                        }
                        return true;
                    });
                    return item;
                }
            }
            return items;
        }, _transformMultiSelectColumnsToGridColumnsFormat = function (columns) {
            var cols = [];
            columns.forEach(function (col) {
                cols.push({ $bind: col.name, options: {} });
            });
            return cols;
        }, _transformSelectedColumnsToMultiSelectFormat = function (columns, selectedColumns, groups, columnsLimited) {
            groups = groups && groups.items ? groups.items : [];
            var cols = [];
            Object.keys(selectedColumns).forEach(function (name) {
                var isSelected = !columnsLimited ? true : (getColumn(groups || [], name) ? true : false);
                if (isSelected)
                    columns.every(function (col) {
                        if (col.name === name) {
                            if (selectedColumns[name])
                                cols.push({ name: name, title: col.schema.title || col.name });
                            return false;
                        }
                        return true;
                    });
            });
            function getColumn(groups, name) {
                var column = null;
                groups.every(function (group) {
                    if (group.name === name)
                        column = group;
                    if ((group.items || group.fields) && !column)
                        column = getColumn(group.fields || group.items, name);
                    if (column)
                        return false;
                    return true;
                });
                return column;
            }
            return cols;
        };
        ui.multiSelectUtils = {
            transformPropsToMultiselectFormat: _transformPropsToMultiselectFormat,
            transformMultiSelectColumnsToGridColumnsFormat: _transformMultiSelectColumnsToGridColumnsFormat,
            transformSelectedColumnsToMultiSelectFormat: _transformSelectedColumnsToMultiSelectFormat
        };
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../../js/core/modules/locale.ts" />
/// <reference path="../../js/ui/form/form.control.ts" />
/// <reference path="../../js/ui/form/controls/absfield.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _ulocale = Phoenix.ulocale, _dom = Phoenix.dom, _sutils = Phoenix.Observable.SchemaUtils;
        var MultiSelectList = (function () {
            function MultiSelectList(data, options, callback) {
                var that = this;
                var defaultOptions = {
                    mapping: {
                        id: "name",
                        lib: "title"
                    },
                    expandIcon: "plus-sign",
                    collapseIcon: "minus-sign",
                    checkedIcon: 'check',
                    uncheckedIcon: 'unchecked',
                    itemIcon: "",
                    groupIcon: "",
                    multiSelect: false,
                    showTags: false,
                    groupLink: false,
                    itemLink: true,
                    border: false,
                    maxHeight: "300px"
                };
                that._options = $.extend(true, defaultOptions, options);
                that._name = that._options.mapping.id;
                that._title = that._options.mapping.libelle || that._options.mapping.lib;
                that._data = data || [];
                that._callback = callback || null;
                that._nodes = $.extend(true, [], data);
                that._selectedItems = [];
                that._init();
            }
            Object.defineProperty(MultiSelectList.prototype, "selectedItems", {
                get: function () {
                    return this._selectedItems;
                },
                set: function (value) {
                    var that = this;
                    that._selectedItems = value;
                    that._selectedItems.forEach(function (item) {
                        that.addItem(item[that._name]);
                    });
                },
                enumerable: true,
                configurable: true
            });
            MultiSelectList.prototype._init = function () {
                var that = this;
                that._contructeNodes(that._nodes, that._options);
            };
            MultiSelectList.prototype._getGroupNode = function (groups, name) {
                var that = this;
                var group = null;
                groups.every(function (node) {
                    if (node.items) {
                        group = node[that._name] === name ? node : null;
                        if (!group)
                            group = that._getGroupNode(node.items, name);
                    }
                    if (group)
                        return false;
                    return true;
                });
                return group;
            };
            MultiSelectList.prototype._getItemNode = function (items, name) {
                var that = this;
                var item = null;
                items.every(function (node) {
                    item = (!node.items && node[that._name] === name) ? node : null;
                    if (!item && node.items)
                        item = that._getItemNode(node.items, name);
                    if (item)
                        return false;
                    return true;
                });
                return item;
            };
            MultiSelectList.prototype._getItem = function (items, name) {
                var that = this;
                var item = null;
                items.every(function (elt) {
                    if (elt[that._name] === name) {
                        item = elt;
                        return false;
                    }
                    if (elt.items) {
                        item = that._getItem(elt.items, name);
                        if (item)
                            return false;
                    }
                    return true;
                });
                return item;
            };
            MultiSelectList.prototype._getSelectedItemIndex = function (name) {
                var that = this;
                var index = -1;
                that._selectedItems.every(function (elt, i) {
                    if (elt[that._name] === name) {
                        index = i;
                        return false;
                    }
                    return true;
                });
                return index;
            };
            MultiSelectList.prototype._itemsIsSelected = function (items) {
                var that = this;
                var isOk = true;
                items.every(function (item) {
                    var trouve = false;
                    that._selectedItems.every(function (elt) {
                        if (elt[that._name] == item[that._name]) {
                            trouve = true;
                            return false;
                        }
                        return true;
                    });
                    if (!trouve) {
                        isOk = false;
                        return false;
                    }
                    return true;
                });
                return isOk;
            };
            MultiSelectList.prototype._itemsIsUnselected = function (items) {
                var that = this;
                var isOk = true;
                items.every(function (item) {
                    that._selectedItems.every(function (elt) {
                        if (elt[that._name] == item[that._name]) {
                            isOk = false;
                            return false;
                        }
                        return true;
                    });
                    if (!isOk)
                        return false;
                    return true;
                });
                return isOk;
            };
            MultiSelectList.prototype._contructeNodes = function (items, options) {
                var that = this;
                if (Array.isArray(items) && items.length) {
                    constructeItems(items, null, 0, true, options);
                    if (options.showTags) {
                        that._addTags(that._nodes);
                    }
                }
                function constructeItems(items, parent, level, show, options) {
                    var html = $(that._template().item).get(0);
                    if (!that._options.border)
                        _dom.addClass(html, "noborder");
                    items.forEach(function (item) {
                        if (!item[that._name])
                            return;
                        item.level = level || 0;
                        item.show = (show == true);
                        item.parent = parent || null;
                        item.component = html.cloneNode();
                        if (item.items) {
                            item.tagsSize = 0;
                            constructeItems(item.items, item, (item.level + 1), false, options);
                        }
                        var pr = item.parent;
                        while (pr) {
                            pr.tagsSize++;
                            pr = pr.parent;
                        }
                        for (var i = 1; i <= item.level; i++)
                            _dom.append(item.component, $(that._template().indent).get(0));
                        if (item.items) {
                            var iconDisplay = that._createIcon(item.component, options.expandIcon, "icon-group bs-cursor-p");
                            _dom.attr(iconDisplay, "data-event", "click");
                            _dom.attr(iconDisplay, "data-action", "expand");
                            if (options.multiSelect && options.groupLink) {
                                var iconCheck = that._createIcon(item.component, options.uncheckedIcon, "icon-check bs-cursor-p");
                                _dom.attr(iconCheck, "data-event", "click");
                                _dom.attr(iconCheck, "data-action", "uncheckG");
                            }
                            else if (options.groupLink) {
                                _dom.attr(item.component, "data-event", "click");
                                _dom.attr(item.component, "data-action", "selectitem");
                                _dom.addClass(item.component, "bs-cursor-p");
                            }
                            that._createIcon(item.component, options.groupIcon);
                        }
                        else {
                            var iconDisplay = that._createIcon(item.component);
                            _dom.addClass(iconDisplay, "icon-exist");
                            if (options.multiSelect && options.itemLink) {
                                var iconCheck = that._createIcon(item.component, options.uncheckedIcon, "icon-check bs-cursor-p");
                                _dom.attr(iconCheck, "data-event", "click");
                                _dom.attr(iconCheck, "data-action", "uncheck");
                            }
                            else if (options.itemLink) {
                                _dom.attr(item.component, "data-event", "click");
                                _dom.attr(item.component, "data-action", "selectitem");
                                _dom.addClass(item.component, "bs-cursor-p");
                            }
                            that._createIcon(item.component, options.itemIcon);
                        }
                        _dom.append(item.component, $('<span>' + (item[that._title] || item[that._name]) + '</span>').get(0));
                        _dom.attr(item.component, "data-id", item[that._name]);
                    });
                }
            };
            MultiSelectList.prototype._addTags = function (nodes) {
                var that = this;
                nodes.forEach(function (node) {
                    if (node.items) {
                        var badge = $(that._template().badge).get(0);
                        _dom.append(badge, document.createTextNode("" + node.tagsSize));
                        _dom.append(node.component, badge);
                        that._addTags(node.items);
                    }
                });
            };
            MultiSelectList.prototype._template = function () {
                return {
                    list: '<ul class="list-group bs-treeview"></ul>',
                    item: '<li class="list-group-item"></li>',
                    indent: '<span class="indent"></span>',
                    icon: '<span class="icon"></span>',
                    link: '<a href="#" style="color:inherit;"></a>',
                    badge: '<span class="badge"></span>'
                };
            };
            MultiSelectList.prototype._createIcon = function (elt, icon, autre) {
                var that = this;
                var iconItem = $(that._template().icon).get(0);
                if (icon)
                    that._addIcon(iconItem, icon, autre);
                _dom.append(elt, iconItem);
                return iconItem;
            };
            MultiSelectList.prototype._addIcon = function (elt, icon, autre) {
                var that = this;
                _dom.attr(elt, "class", "icon icon-exist " + _dom.iconClass(icon) + (autre ? " " + autre : ""));
            };
            MultiSelectList.prototype._setEvents = function () {
                var that = this;
                if (that._container)
                    that._container.addEventListener("click", function (event) {
                        var target = event.target;
                        var itemHTML = null;
                        if (_dom.attr(target, "data-event") === "click")
                            itemHTML = target;
                        else
                            itemHTML = _dom.parentByTag(that._container, target, "LI");
                        if (itemHTML && _dom.attr(itemHTML, "data-event") === "click") {
                            var parentHTML = _dom.parentByTag(that._container, itemHTML, "LI");
                            var name_1 = _dom.attr(parentHTML, "data-id");
                            var action = _dom.attr(itemHTML, "data-action");
                            if (action === "expand")
                                that._display(name_1, true);
                            else if (action === "collapse")
                                that._display(name_1, false);
                            else if (action === "selectitem")
                                that._select(name_1, that._callback);
                            else if (action === "check" && that._options.multiSelect)
                                that._checkF(name_1, false, that._callback);
                            else if (action === "uncheck" && that._options.multiSelect)
                                that._checkF(name_1, true, that._callback);
                            else if (action === "checkG" && that._options.multiSelect)
                                that._checkG(name_1, false, that._callback, true);
                            else if (action === "uncheckG" && that._options.multiSelect)
                                that._checkG(name_1, true, that._callback, true);
                        }
                    });
            };
            MultiSelectList.prototype._display = function (name, show) {
                var that = this;
                var group = that._getGroupNode(that._nodes, name);
                if (group) {
                    var displayItem_1 = function (items, open) {
                        items.forEach(function (item) {
                            item.show = open;
                            if (item.items) {
                                displayItem_1(item.items, false);
                                var ic = _dom.query(item.component, ".icon-group");
                                if (ic) {
                                    that._addIcon(ic, that._options.expandIcon, "icon-group bs-cursor-p");
                                    _dom.attr(ic, "data-action", "expand");
                                }
                            }
                        });
                    };
                    displayItem_1(group.items, show);
                    var gHTML = _dom.query(group.component, ".icon-group");
                    that._addIcon(gHTML, show ? that._options.collapseIcon : that._options.expandIcon, "icon-group bs-cursor-p");
                    _dom.attr(gHTML, "data-action", show ? "collapse" : "expand");
                    that._renderItems(that._nodes);
                }
            };
            MultiSelectList.prototype._select = function (name, callback) {
                var that = this;
                var oldHTML = _dom.query(that._container, ".active");
                if (oldHTML)
                    _dom.removeClass(oldHTML, "active");
                that._selectedItems.splice(0);
                var item = that._getItem(that._nodes, name);
                if (!item)
                    return;
                that._showItem(name);
                _dom.addClass(item.component, "active");
                item = that._getItem(that._data, name);
                if (item) {
                    that._selectedItems.push(item);
                    if (callback)
                        callback({ action: "add", data: item });
                }
            };
            MultiSelectList.prototype._unSelect = function (name, callback) {
                var that = this;
                var oldHTML = _dom.query(that._container, ".active");
                if (oldHTML)
                    _dom.removeClass(oldHTML, "active");
                var item = that._getItem(that._selectedItems, name);
                if (item) {
                    that._selectedItems.splice(0);
                    if (callback)
                        callback({ action: "remove", data: item });
                }
            };
            MultiSelectList.prototype._checkF = function (name, isCheck, callback) {
                var that = this;
                that._check(name, isCheck, callback);
                var item = that._getItem(that._nodes, name);
                if (item && item.parent) {
                    var parent_2 = that._getItem(that._data, item.parent[that._name]);
                    if (!parent_2)
                        return;
                    if (isCheck && that._itemsIsSelected(parent_2.items))
                        that._checkG(parent_2[that._name], isCheck, callback, false);
                    else if (!isCheck && that._itemsIsUnselected(parent_2.items))
                        that._checkG(parent_2[that._name], isCheck, callback, false);
                }
            };
            MultiSelectList.prototype._check = function (name, isCheck, callback) {
                var that = this;
                var item = that._getItem(that._data, name);
                if (item) {
                    var gHTML = that._getItem(that._nodes, name).component;
                    var cHTML = _dom.query(gHTML, ".icon-check");
                    that._addIcon(cHTML, isCheck ? that._options.checkedIcon : that._options.uncheckedIcon, "icon-check bs-cursor-p");
                    _dom.attr(cHTML, "data-action", isCheck ? "check" : "uncheck");
                    var action = void 0;
                    var selectedItemIndex = that._getSelectedItemIndex(name);
                    if (isCheck) {
                        if (selectedItemIndex < 0) {
                            that._selectedItems.push(item);
                            action = "add";
                        }
                    }
                    else {
                        if (selectedItemIndex >= 0) {
                            that._selectedItems.splice(selectedItemIndex, 1);
                            action = "remove";
                        }
                    }
                    if (callback && action)
                        callback({ action: action, data: item });
                }
            };
            MultiSelectList.prototype._checkG = function (name, isCheck, callback, children) {
                var that = this;
                var group = that._getItem(that._data, name);
                if (group) {
                    var gHTML = that._getItem(that._nodes, name).component;
                    var cHTML = _dom.query(gHTML, ".icon-check");
                    that._addIcon(cHTML, isCheck ? that._options.checkedIcon : that._options.uncheckedIcon, "icon-check bs-cursor-p");
                    _dom.attr(cHTML, "data-action", isCheck ? "checkG" : "uncheckG");
                    if (children)
                        group.items.forEach(function (item) {
                            if (item.items)
                                that._checkG(item.name, isCheck, callback, children);
                            else
                                that._check(item.name, isCheck, callback);
                        });
                }
            };
            MultiSelectList.prototype._showItem = function (name) {
                var that = this;
                var item = that._getItem(that._nodes, name);
                if (item) {
                    var parent_3 = item.parent;
                    while (parent_3) {
                        displayItem(parent_3.items, true);
                        var gHTML = _dom.query(parent_3.component, ".icon-group");
                        that._addIcon(gHTML, that._options.collapseIcon, "icon-group bs-cursor-p");
                        _dom.attr(gHTML, "data-action", "collapse");
                        parent_3 = parent_3.parent;
                    }
                    that._renderItems(that._nodes);
                }
                function displayItem(items, open) {
                    items.forEach(function (item) {
                        item.show = open;
                        if (item.items) {
                            displayItem(item.items, false);
                            var ic = _dom.query(item.component, ".icon-group");
                            if (ic) {
                                that._addIcon(ic, that._options.expandIcon, "icon-group bs-cursor-p");
                                _dom.attr(ic, "data-action", "expand");
                            }
                        }
                    });
                }
                ;
            };
            MultiSelectList.prototype.addItem = function (name) {
                var that = this;
                if (that._options.multiSelect)
                    that._checkF(name, true);
                else
                    that._select(name);
            };
            MultiSelectList.prototype.removeItem = function (name) {
                var that = this;
                if (that._options.multiSelect)
                    that._checkF(name, false);
                else
                    that._unSelect(name);
            };
            MultiSelectList.prototype._renderItems = function (nodes) {
                var that = this;
                _dom.empty(that._container);
                var frag = document.createDocumentFragment();
                render(nodes, frag);
                _dom.append(that._container, frag);
                function render(nodes, frag) {
                    nodes.forEach(function (node) {
                        if (node.show)
                            _dom.append(frag, node.component);
                        if (node.items)
                            render(node.items, frag);
                    });
                }
            };
            MultiSelectList.prototype.render = function (parent) {
                var that = this;
                if (!that._container) {
                    that._container = $(that._template().list).get(0);
                    that._container.style.maxHeight = that._options.maxHeight;
                    if (!that._options.border)
                        _dom.addClass(that._container, "noborder");
                    that._renderItems(that._nodes);
                    that._setEvents();
                }
                if (parent)
                    _dom.append(parent, that._container);
                return that._container;
            };
            return MultiSelectList;
        }());
        ui.MultiSelectList = MultiSelectList;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../../js/ui/form/form.control.ts" />
/// <reference path="../../js/ui/form/controls/absfield.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _ulocale = Phoenix.ulocale, _dom = Phoenix.dom, _drag = Phoenix.drag, _events = Phoenix.events, _sutils = Phoenix.Observable.SchemaUtils;
        function _createPillboxContainer(id, options, authoring, title) {
            title = title || '';
            options = $.extend({ titleIsHidden: false, placeHolder: false, columns: false }, options);
            var html = [];
            _ui.Utils.fieldWrapper(html, options, authoring, function () {
                html.push('<ul id="{0}" class="pillbox boxed-tags"></ul>');
            });
            return _utils.format(html.join(''), id);
        }
        ;
        var PillBox = (function () {
            function PillBox(data, options, callback) {
                var that = this;
                var defaultOptions = {
                    mapping: {
                        id: "name",
                        lib: "title"
                    },
                    removeIcon: "remove",
                    border: false
                };
                that._options = $.extend(true, defaultOptions, options);
                that._name = that._options.mapping.id;
                that._title = that._options.mapping.libelle || that._options.mapping.lib;
                that._data = data || [];
                that._callback = callback || null;
                that._nodes = $.extend(true, [], data);
                that._selectedItems = [];
                that._init();
            }
            Object.defineProperty(PillBox.prototype, "selectedItems", {
                get: function () {
                    return this._selectedItems;
                },
                set: function (value) {
                    this._selectedItems = value;
                },
                enumerable: true,
                configurable: true
            });
            PillBox.prototype._init = function () {
                var that = this;
                that._constructeNodes(that._nodes, that._options);
            };
            PillBox.prototype._constructeNodes = function (items, options) {
                if (!Array.isArray(items) || !items.length)
                    return;
                var that = this;
                var htmlItem = $(that._template().itemTag).get(0);
                var htmlIcon = $(that._template().icon).get(0);
                items.forEach(function (item) {
                    if (!item[that._name])
                        return;
                    item.component = htmlItem.cloneNode();
                    _dom.append(item.component, document.createTextNode(item[that._title] || item[that._name]));
                    _dom.attr(item.component, "data-id", item[that._name]);
                    _dom.append(item.component, htmlIcon.cloneNode());
                    item.filter = true;
                });
                that._input = $(that._template().itemInput).get(0);
            };
            PillBox.prototype._getItem = function (items, name) {
                var that = this;
                var elt = null;
                items.every(function (item) {
                    if (item[that._name] === name) {
                        elt = item;
                        return false;
                    }
                    return true;
                });
                return elt;
            };
            PillBox.prototype._getItemIndex = function (items, name) {
                var that = this;
                var index = -1;
                items.every(function (item, i) {
                    if (item[that._name] === name) {
                        index = i;
                        return false;
                    }
                    return true;
                });
                return index;
            };
            PillBox.prototype._addTag = function (name, callback) {
                var that = this;
                var item = that._getItem(that._selectedItems, name);
                if (!item) {
                    item = that._getItem(that._data, name);
                    if (item) {
                        that._selectedItems.push(item);
                        that._getItem(that._nodes, name).filter = false;
                        that._renderItems();
                        if (callback)
                            callback({ action: "add", data: item });
                    }
                }
            };
            PillBox.prototype._removeTag = function (name, callback) {
                var that = this;
                var index = that._getItemIndex(that._selectedItems, name);
                if (index >= 0) {
                    that._selectedItems.splice(index, 1);
                    that._getItem(that._nodes, name).filter = true;
                    that._renderItems();
                    if (callback)
                        callback({ action: "remove", data: that._getItem(that._data, name) });
                }
            };
            PillBox.prototype._filterList = function (chaine) {
                var that = this;
                chaine.toLowerCase();
                that._nodes.forEach(function (n) {
                    n.filter = (n[that._title].toLowerCase().indexOf(chaine) >= 0 && that._getItem(that._selectedItems, n[that._name]) == null);
                });
                var filters = [];
                that._nodes.forEach(function (node) {
                    if (node.filter)
                        filters.push(node);
                });
                that._menu.show({ value: filters }, 0, true);
            };
            PillBox.prototype._setEvents = function (parent) {
                var that = this;
                if (that._container) {
                    that._container.addEventListener("click", function (event) {
                        var target = event.target;
                        if (target["href"]) {
                            var href = _dom.attr(target, 'href');
                            if (href === '#') {
                                event.preventDefault();
                                event.stopPropagation();
                            }
                        }
                        if (target && _dom.attr(target, "data-event") === "click") {
                            var action = _dom.attr(target, "data-action");
                            if (action === "remove") {
                                var parentHTML = _dom.parentByTag(that._container, target, "LI");
                                var name_2 = _dom.attr(parentHTML, "data-id");
                                that._removeTag(name_2, that._callback);
                            }
                        }
                        else if (that._menu && that._menu.opened && that._menu.inMenu(event.target)) {
                            that._menu.click(event);
                        }
                        var input = _dom.query(that._input, "input");
                        if (input)
                            input.focus();
                    });
                    that._container.addEventListener("keyup", function (event) {
                        if (event.keyCode == 13 && that._menu && that._menu.opened)
                            that._menu.select();
                        var input = _dom.query(that._input, "input");
                        if (input)
                            input.focus();
                    });
                }
                if (that._input) {
                    var menuShow_1 = true;
                    that._input.addEventListener("keyup", function (event) {
                        var target = event.target;
                        if (event.keyCode == 38 || event.keyCode == 40) {
                        }
                        else if (event.keyCode == 8) {
                            var input_1 = target;
                            if (menuShow_1)
                                that._filterList(target.value);
                            else if (that._menu && that._menu.opened)
                                that._menu.hide(target);
                        }
                        else if (event.keyCode == 13 && target && _dom.attr(target, "data-event") === "keyup") {
                            var input_2 = target;
                            that._addTag(input_2.value, that._callback);
                            input_2.value = "";
                        }
                        else {
                            that._filterList(target.value);
                            var tagFocus = _dom.query(that._container, ".bs-pillbox-item-tag.focus");
                            if (tagFocus)
                                _dom.removeClass(tagFocus, "focus");
                        }
                        var input = _dom.query(that._input, "input");
                        if (input)
                            input.focus();
                    });
                    that._input.addEventListener("keydown", function (event) {
                        var target = event.target;
                        if (event.keyCode == 40 && that._menu && that._menu.opened) {
                            that._menu.move(1);
                        }
                        else if (event.keyCode == 38 && that._menu && that._menu.opened) {
                            that._menu.move(-1);
                        }
                        else if (event.keyCode == 8) {
                            var input_3 = target;
                            if (input_3.value.length <= 0 && that._selectedItems.length && _dom.attr(target, "data-event") === "keyup") {
                                var item = that._selectedItems[that._selectedItems.length - 1];
                                var n = that._getItem(that._nodes, item[that._name]);
                                if (_dom.hasClass(n.component, "focus")) {
                                    _dom.removeClass(n.component, "focus");
                                    that._removeTag(item[that._name], that._callback);
                                }
                                else
                                    _dom.addClass(n.component, "focus");
                                menuShow_1 = false;
                            }
                            else
                                menuShow_1 = true;
                        }
                        else if (event.keyCode == 9 || event.keyCode == 27) {
                            if (that._menu && that._menu.opened)
                                that._menu.hide(target);
                        }
                        var input = _dom.query(that._input, "input");
                        if (input)
                            input.focus();
                    });
                }
                that._drag = _drag.dragManager.addDrag([that._container]);
                that._drag.canStartDragHandler = that._canStartDrag.bind(that);
                that._drag.onDragStart = that._onDragStart.bind(that);
                that._drag.onDrag = that._onDrag.bind(that);
                that._drag.onDragEnd = that._onDragEnd.bind(that);
            };
            PillBox.prototype._template = function () {
                var that = this;
                return {
                    list: '<ul class="bs-pillbox noborder"></ul>',
                    itemTag: '<li class="bs-pillbox-item bs-pillbox-item-tag" data-drag="move"></li>',
                    icon: '<span class="icon pull-right ' + _dom.iconClass(that._options.removeIcon) + ' icon-remove bs-cursor-p" data-event="click" data-action="remove"></span>',
                    itemInput: '<li class="bs-pillbox-item bs-pillbox-item-edit"><input autocomplete="off" autofocus="true" placeholder="..." data-event="keyup" data-action="add,remove" /></li>'
                };
            };
            PillBox.prototype.addItem = function (name) {
                this._addTag(name);
            };
            PillBox.prototype.removeItem = function (name) {
                this._removeTag(name);
            };
            PillBox.prototype._canStartDrag = function (event) {
                var that = this;
                var target = event.target;
                var tag = _dom.parentByTag(that._container, target, 'LI');
                if (!tag)
                    return;
                var opDrag = _dom.attr(tag, 'data-drag');
                if (!opDrag)
                    return false;
                if (!tag.id)
                    tag.id = _utils.allocID();
                var drag = that._drag;
                drag.coverDocument = true;
                drag.data.op = opDrag;
                drag.data.cloneId = tag.id;
                drag.data.column = _dom.attr(tag, 'data-id');
                if (!drag.data.column)
                    return false;
                var cloned = _dom.find(that._container, drag.data.cloneId);
                drag.cursor = 'move';
                drag.moveX = true;
                drag.moveY = true;
                drag.startOffset = _dom.position(cloned, null);
                var children;
                var copts = {
                    top: 0,
                    height: cloned.offsetHeight
                };
                var nodesSelected = [];
                that.selectedItems.forEach(function (item) {
                    var nodeHTML = _dom.query(that._container, "li[data-id='" + item[that._name] + "']");
                    if (nodeHTML) {
                        if (!nodeHTML.id)
                            nodeHTML.id = _utils.allocID();
                        nodesSelected.push({ htmlId: nodeHTML.id, info: item });
                    }
                });
                drag.data.childrenPositions = _dom.childrenPositions(that._container, nodesSelected, false, 'free', copts);
                return true;
            };
            PillBox.prototype._onDragStart = function (event) {
                var that = this;
                var drag = that._drag;
                if (!drag.data.op)
                    return false;
                var eltHTML = _dom.find(that._container, drag.data.cloneId);
                var cloneHTML = eltHTML.cloneNode(true);
                var p = _dom.position(eltHTML, null);
                cloneHTML.style.top = p.top + "px";
                cloneHTML.style.left = p.left + "px";
                cloneHTML.style.width = eltHTML.offsetWidth + "px";
                cloneHTML.style.height = eltHTML.offsetHeight + "px";
                cloneHTML.style.zIndex = '5000';
                cloneHTML.style.position = 'absolute';
                cloneHTML.style.cursor = "move";
                drag.floatElement = cloneHTML;
                _dom.append(document.body, drag.floatElement);
                return true;
            };
            PillBox.prototype._onDrag = function (event) {
                var that = this;
                var drag = that._drag;
                if (!drag.data.op)
                    return false;
                var p = _events.point(event);
                var best = _dom.findNearest(p.x, p.y, drag.data.childrenPositions);
                if (drag.data.best != best) {
                    var pos = {
                        left: best.left,
                        top: best.top,
                        width: best.width,
                        height: best.height
                    };
                    drag.data.mdiv = _dom.showMove(drag.data.mdiv, best.vertical, pos, 'bs-drag-color-info');
                }
                drag.data.best = best;
                return true;
            };
            PillBox.prototype._onDragEnd = function (cancel, event) {
                var that = this;
                var drag = that._drag;
                if (!drag.data.op)
                    return false;
                if (drag.floatElement) {
                    _dom.remove(drag.floatElement);
                    drag.floatElement = null;
                }
                if (drag.data.mdiv) {
                    _dom.remove(drag.data.mdiv);
                    drag.data.mdiv = null;
                }
                if (cancel)
                    return;
                if (drag.data.best && drag.data.column) {
                    var info = drag.data.best.info;
                    if (drag.data.best.position === 'empty' || info[that._name] === drag.data.column)
                        return;
                    var src = that._getItem(that._selectedItems, drag.data.column);
                    var srcIndex = that._getItemIndex(that._selectedItems, drag.data.column);
                    that.selectedItems.splice(srcIndex, 1);
                    var destIndex = that._getItemIndex(that._selectedItems, info[that._name]);
                    destIndex = drag.data.best.position === 'after' ? destIndex + 1 : destIndex;
                    that.selectedItems.splice(destIndex, 0, src);
                    if (that._callback)
                        that._callback({ action: "drag", srcIndex: srcIndex, destIndex: destIndex, data: src });
                }
                that._renderItems();
                var input = _dom.query(that._input, "input");
                if (input)
                    input.focus();
            };
            PillBox.prototype._onMenuSelectItemHandler = function (v) {
                var that = this;
                if (v) {
                    that._addTag(v[that._name], that._callback);
                    var input = _dom.query(that._input, "input");
                    if (input)
                        input.value = "";
                }
            };
            PillBox.prototype._includeDropDownMenu = function () {
                var that = this;
                var input = _dom.query(that._input, "input");
                that._menu = new ui.DropItems($(that._input), input, {
                    primaryKey: that._name,
                    search: that._title,
                    onselect: that._onMenuSelectItemHandler.bind(that)
                });
            };
            PillBox.prototype._renderItems = function () {
                var that = this;
                _dom.empty(that._container);
                var frag = document.createDocumentFragment();
                renderTag(that._selectedItems, frag);
                _dom.append(frag, that._input);
                _dom.append(that._container, frag);
                function renderTag(nodes, frag) {
                    nodes.forEach(function (node) {
                        var n = that._getItem(that._nodes, node[that._name]);
                        n.filter = false;
                        _dom.append(frag, n.component);
                    });
                }
            };
            PillBox.prototype.render = function (parent) {
                var that = this;
                if (!that._container) {
                    that._container = $(that._template().list).get(0);
                    that._renderItems();
                    that._includeDropDownMenu();
                    that._setEvents(parent);
                }
                if (parent)
                    _dom.append(parent, that._container);
                return that._container;
            };
            PillBox.prototype.remove = function () {
                var that = this;
                that._menu = null;
                if (that._drag) {
                    _drag.dragManager.rmvDrag(that._drag);
                    that._drag = null;
                }
            };
            return PillBox;
        }());
        ui.PillBox = PillBox;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../../js/ui/form/form.control.ts" />
/// <reference path="../../js/ui/form/controls/absfield.control.ts" />
/// <reference path="./multiselect.ts" />
/// <reference path="./pillbox.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _ui = ui, _utils = Phoenix.utils, _ulocale = Phoenix.ulocale, _dom = Phoenix.dom, _sutils = Phoenix.Observable.SchemaUtils;
        var ComposantMultiSelect = (function (_super) {
            __extends(ComposantMultiSelect, _super);
            function ComposantMultiSelect(fp, options, form) {
                _super.call(this, fp, options, form);
                var that = this;
                that._state();
                var optionsParDefaut = {
                    mapping: {
                        id: "name",
                        lib: "title"
                    },
                    groupLink: true,
                    itemLink: true,
                    multiSelect: true,
                    showTags: false,
                    pillBox: true
                };
                var entree = that.state.value.model().entree || [];
                var sortie = that.state.value.sortie || [];
                that._options = $.extend(true, optionsParDefaut, that.renderOptions);
                that._name = that._options.mapping.id;
                that._title = that._options.mapping.libelle || that._options.mapping.lib;
                if (Array.isArray(entree) && entree.length) {
                    that.multiSelectList = new ui.MultiSelectList(entree, that._options, function (data) {
                        if (data.action === "add") {
                            if (that.pillBox)
                                that.pillBox.addItem(data.data[that._name]);
                            sortie.push(data.data);
                        }
                        else if (data.action === "remove") {
                            if (that.pillBox)
                                that.pillBox.removeItem(data.data[that._name]);
                            var item = getSortieItem(sortie, data.data[that._name]);
                            if (item)
                                sortie.remove(item.data);
                        }
                    });
                    that.multiSelectList.selectedItems = that.state.value.model().sortie || [];
                    if (that._options.pillBox) {
                        var itemList = that._extractItems(entree, that._options.groupLink);
                        that.pillBox = new ui.PillBox(itemList, that._options, function (data) {
                            if (data.action === "add") {
                                that.multiSelectList.addItem(data.data[that._name]);
                                sortie.push(data.data);
                            }
                            else if (data.action === "remove") {
                                that.multiSelectList.removeItem(data.data[that._name]);
                                var item = getSortieItem(sortie, data.data[that._name]);
                                if (item)
                                    sortie.remove(item.data);
                            }
                            else if (data.action === "drag") {
                                var elt = getSortieItem(sortie, data.data[that._name]);
                                sortie.remove(elt.data);
                                sortie.splice(data.destIndex, 0, data.data);
                            }
                        });
                        that.pillBox.selectedItems = that.state.value.model().sortie || [];
                    }
                }
                function getSortieItem(items, name) {
                    var elt = null;
                    items.forEach(function (item, i) {
                        if (item[that._name] === name) {
                            elt = { id: i, data: item };
                            return false;
                        }
                        return true;
                    });
                    return elt;
                }
            }
            ComposantMultiSelect.prototype._extractItems = function (liste, groupIsItem) {
                var that = this;
                var items = [];
                extract(liste, items, groupIsItem);
                function extract(oldListe, newList, groupIsItem) {
                    oldListe.forEach(function (item) {
                        if (item.items) {
                            if (groupIsItem)
                                newList.push(item);
                            extract(item.items, newList, groupIsItem);
                        }
                        else
                            newList.push(item);
                    });
                }
                return items;
            };
            ComposantMultiSelect.prototype._state = function () {
                var that = this;
                that.state = that.state || {};
                var state = that.form.getState(that.$bind);
                Object.keys(state).forEach(function (pn) {
                    that.state[pn] = state[pn];
                });
                that.state.value = that.form.getValue(that.$bind);
            };
            ComposantMultiSelect.prototype._state2UI = function () {
                var that = this;
            };
            ComposantMultiSelect.prototype.changed = function (propName, ov, nv, op, params) {
                var that = this;
            };
            ComposantMultiSelect.prototype.stateChanged = function (propName) {
            };
            ComposantMultiSelect.prototype._template = function (id) {
                return _utils.format('<div id="{0}" data-render="{0}"><div id="{0}_pillbox"><h5 class="bs-block-title">Choix de colonnes</h5><div data-id="pillbox" style="overflow-y:auto;max-height:250px"></div></div><div id="{0}_multiselect"><h5 class="bs-block-title">Liste de champs</h5><div data-id="multiselect" style="overflow-y:auto;max-height:300px;border: 1px solid #dddddd;"></div></div></div>', id);
            };
            ComposantMultiSelect.prototype.render = function ($parent) {
                var that = this;
                var opts = that._initOptions(_ui.Utils.defaultOptions);
                if (!that.$element) {
                    that.$element = $(that._template(that.id));
                    var e = that.$element.get(0);
                    if (!that._options.pillBox) {
                        var pillBoxView = _dom.find(e, that.id + "_pillbox");
                        if (pillBoxView)
                            _dom.addClass(pillBoxView, "bs-none");
                    }
                    if (that.pillBox) {
                        var pillBoxHTML = _dom.query(e, 'div[data-id="pillbox"]');
                        that.pillBox.render(pillBoxHTML);
                    }
                    if (that.multiSelectList) {
                        var multiselectHTML = _dom.query(e, 'div[data-id="multiselect"]');
                        that.multiSelectList.render(multiselectHTML);
                    }
                }
                that.appendElement($parent, opts);
                return that.$element;
            };
            return ComposantMultiSelect;
        }(ui.AbsField));
        ui.ComposantMultiSelect = ComposantMultiSelect;
        _ui.registerControl(ComposantMultiSelect, "object", false, "multiselectlist", null);
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
/// <reference path="../../../typings/index.d.ts" />
/// <reference path="../../js/core/core.ts" />
/// <reference path="../filter-express/filter-express.control.ts" />
var Phoenix;
(function (Phoenix) {
    var ui;
    (function (ui) {
        var _dom = Phoenix.dom, _ui = ui, _utils = Phoenix.utils, _locale = Phoenix.locale, _link = Phoenix.link;
        var ToolElement = (function () {
            function ToolElement(config, options) {
                var that = this;
                that.config = config || {};
                that.options = options || {};
                that.data = {
                    value: config.value
                };
                that.props = {};
                that._defineProps();
            }
            ToolElement.prototype._defineProps = function () {
                var that = this, _dp = Phoenix.utils.defineProperty;
                _dp("value", that);
            };
            ToolElement.prototype._notifyChange = function (propertyName) {
                var that = this;
                switch (propertyName) {
                    case "value":
                        that.update();
                        break;
                }
            };
            ToolElement.prototype.createElement = function (index, config, data) {
                return '<div class="bs-toolbar-item">A</div>';
            };
            ToolElement.prototype._setEvents = function () { };
            ToolElement.prototype.update = function () { };
            ToolElement.prototype.getValue = function () { };
            ToolElement.prototype.after = function () { };
            ToolElement.prototype.render = function ($parent) {
                var that = this;
                if (!that.$element) {
                    that.$element = $(that.createElement(that.config.id, that.config, that.data.value));
                    that._setEvents();
                }
                if ($parent)
                    _dom.append($parent.get(0), that.$element.get(0));
                return that.$element;
            };
            ToolElement.prototype.destroy = function () {
                var that = this;
                that.$element = null;
                that.options = null;
                that.config = null;
            };
            return ToolElement;
        }());
        ui.ToolElement = ToolElement;
        var ToolElementButton = (function (_super) {
            __extends(ToolElementButton, _super);
            function ToolElementButton(config, options) {
                _super.call(this, config, options);
            }
            ToolElementButton.prototype.createElement = function (index, config, data) {
                var css = ["bs-button btn btn-default"];
                if (config.style)
                    css.push('btn-' + config.style);
                if (config.right)
                    css.push("pull-right");
                var html = [
                    '<div class="bs-toolbar-item ' + (config.right ? "pull-right" : "") + '">',
                    '<button toolClick="' + index + '" type="button" class="' + css.join(" ") + '">',
                    (config.icon ? '<span class="' + _dom.iconClass(config.icon) + '" toolClick="' + index + '" ></span>' : ''),
                    (config.title ? '&nbsp;' + config.title : ''),
                    '</button>',
                    '</div>'
                ];
                return html.join('');
            };
            return ToolElementButton;
        }(ToolElement));
        ui.ToolElementButton = ToolElementButton;
        var ToolElementCount = (function (_super) {
            __extends(ToolElementCount, _super);
            function ToolElementCount(config, options) {
                _super.call(this, config, options);
            }
            ToolElementCount.prototype.createElement = function (index, config, data) {
                var css = ["label label-default form-control-static bs-toolbar-item bs-toolbar-item-count"];
                if (config.right)
                    css.push("pull-right");
                var html = [
                    '<span tool="' + index + '" class="' + css.join(' ') + '">' + data + '</span>'
                ];
                return html.join('');
            };
            ToolElementCount.prototype.update = function () {
                var that = this;
                if (!that.$element)
                    return;
                _dom.text(that.$element.get(0), that.data.value);
            };
            return ToolElementCount;
        }(ToolElement));
        ui.ToolElementCount = ToolElementCount;
        var ToolElementDropdownAction = (function (_super) {
            __extends(ToolElementDropdownAction, _super);
            function ToolElementDropdownAction(config, options) {
                _super.call(this, config, options);
            }
            ToolElementDropdownAction.prototype.createElement = function (index, config, data) {
                var css = ["bs-toolbar-item dropdown"];
                if (config.right)
                    css.push("pull-right");
                var actionsView = [];
                // action : {name, events}
                config.actions && config.actions.forEach(function (action) {
                    actionsView.push('<li data-id="' + action.code + '"><a href="#" data-id="' + action.code + '">' + (action.lib || action.code) + '</a></li>');
                });
                var title = [];
                if (!config.title && !config.icon)
                    title.push('<span class="' + _dom.iconClass("menu-hamburger") + '"></span> ');
                if (config.icon)
                    title.push('<span class="' + _dom.iconClass(config.icon) + '"></span> ');
                if (config.title)
                    title.push(' ' + config.title + " ");
                var html = [
                    '<div tabindex="' + index + '" class="' + css.join(" ") + '">',
                    '<button class="btn btn-default dropdown-toogle" id="tooltip-dropdown-' + index + '" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">',
                    title.join(""),
                    ' <span class="caret"></span>',
                    '</button>',
                    '<ul class="dropdown-menu dropdown-menu-right" aria-labelledby="tooltip-dropdown-' + index + '" data-id="toolCommands">',
                    actionsView.join(""),
                    '</ul>',
                    '</div>'
                ];
                return html.join('');
            };
            ToolElementDropdownAction.prototype._setEvents = function () {
                var that = this;
                var listView = _dom.query(that.$element.get(0), "ul[data-id='toolCommands']");
                if (listView)
                    listView.addEventListener("click", function (event) {
                        var target = event.target;
                        var commandCode = _dom.attr(target, "data-id");
                        if (commandCode && that.options.callback)
                            that.options.callback({ id: that.config.id, name: that.config.name, type: that.config.type, value: commandCode, toolData: that.config });
                        that.after();
                    }, false);
            };
            ToolElementDropdownAction.prototype.after = function () {
                var that = this;
                _dom.removeClass(that.$element.get(0), "open");
            };
            return ToolElementDropdownAction;
        }(ToolElement));
        ui.ToolElementDropdownAction = ToolElementDropdownAction;
        var ToolElementSelect = (function (_super) {
            __extends(ToolElementSelect, _super);
            function ToolElementSelect(config, options) {
                _super.call(this, config, options);
                var that = this;
                config.value = config.value || {};
                // Test
                config.value.default = _link.context().$url.idTra;
                // Test
                config.value.items = config.value.items || [];
            }
            ToolElementSelect.prototype.createElement = function (index, config, data) {
                var css = ["bs-toolbar-item"];
                if (config.right)
                    css.push("pull-right");
                var actionsView = [];
                // action : {name, events}
                config.value.items && config.value.items.forEach(function (action) {
                    actionsView.push('<option value="' + action.code + '" ' + (config.value.default == action.code ? "selected" : "") + '>' + (action.lib || action.code) + '</option>');
                });
                var html = [
                    '<div tabindex="' + index + '" class="' + css.join(" ") + '">',
                    '<form class="form-horizontal">',
                    '<div class="input-group">',
                    '<span class="input-group-addon">',
                    (config.title || ""),
                    '</span>',
                    '<select class="form-control" data-id="toolSelect">',
                    actionsView.join(""),
                    '</select>',
                    '</div>',
                    '</form>',
                    '</div>'
                ];
                return html.join('');
            };
            ToolElementSelect.prototype.update = function () {
                var that = this;
                if (!that.$element)
                    return;
                var frag = document.createDocumentFragment();
                that.data.value.items && that.data.value.items.forEach(function (action) {
                    _dom.append(frag, $('<option value="' + action.code + '" ' + (that.data.value.default == action.code ? "selected" : "") + '>' + (action.lib || action.libelle || action.code) + '</option>').get(0));
                });
                var selectView = _dom.query(that.$element.get(0), "select[data-id='toolSelect']");
                _dom.empty(selectView);
                _dom.append(selectView, frag);
            };
            ToolElementSelect.prototype._setEvents = function () {
                var that = this;
                var selectView = _dom.query(that.$element.get(0), "select[data-id='toolSelect']");
                if (selectView)
                    selectView.addEventListener("change", function (event) {
                        var target = event.target;
                        var optionView = event.target.options[target.selectedIndex];
                        if (that.options.callback)
                            that.options.callback({ id: that.config.id, name: that.config.name, type: that.config.type, value: optionView.value, toolData: that.config });
                    }, false);
            };
            return ToolElementSelect;
        }(ToolElement));
        ui.ToolElementSelect = ToolElementSelect;
        var ToolElementSearch = (function (_super) {
            __extends(ToolElementSearch, _super);
            function ToolElementSearch(config, options) {
                _super.call(this, config, options);
                this.data.value = "";
                this.oldValue = "";
            }
            ToolElementSearch.prototype.createElement = function (index, config, data) {
                var css = [];
                if (config.right)
                    css.push("pull-right");
                var html = [
                    '<div tabindex="' + index + '" class="bs-toolbar-item input-group' + css.join(" ") + '">',
                    '<input toolKeyup="' + index + '" type="text" class="form-control" placeholder="' + (config.title || "Recherche") + '" />',
                    '<span class="input-group-btn">',
                    '<button toolClick="' + index + '" class="bs-button btn btn-default" type="button">',
                    '<span toolClick="' + index + '" class="' + _dom.iconClass(config.icon || "search") + '"> </span>',
                    '</button>',
                    '</span>',
                    '</div>'
                ];
                return html.join('');
            };
            ToolElementSearch.prototype.update = function () {
                var that = this;
                if (!that.$element)
                    return;
                var input = _dom.query(that.$element.get(0), "input");
                if (input)
                    input.value = that.data.value;
            };
            ToolElementSearch.prototype.getValue = function () {
                var that = this;
                that.oldValue = that._getInputValue();
                return that.oldValue;
            };
            ToolElementSearch.prototype._getInputValue = function () {
                var that = this;
                if (!that.$element)
                    return;
                var input = _dom.query(that.$element.get(0), "input");
                if (input)
                    return input.value;
                return null;
            };
            ToolElementSearch.prototype._setEvents = function () {
                var that = this;
                if (!that.$element)
                    return;
                var div = that.$element.get(0);
                if (div) {
                    var input_4 = _dom.query(div, "input");
                    var btn_1 = _dom.query(div, "button");
                    input_4.addEventListener('focus', function (event) {
                        input_4.select();
                    });
                    div.addEventListener('blur', function (event) {
                        var isNotBtnSearch = event.explicitOriginalTarget && event.explicitOriginalTarget != btn_1 && event.relatedTarget == null;
                        isNotBtnSearch = isNotBtnSearch || (event.relatedTarget == null || (event.relatedTarget && event.relatedTarget != btn_1)) && event.explicitOriginalTarget == undefined;
                        if (event.target == input_4 && isNotBtnSearch) {
                            //if (!that._getInputValue() && that.filtering){
                            that.data.value = " ";
                            that.props.value = that.oldValue;
                        }
                    }, true);
                }
            };
            return ToolElementSearch;
        }(ToolElement));
        ui.ToolElementSearch = ToolElementSearch;
        var ToolElementFilterExpress = (function (_super) {
            __extends(ToolElementFilterExpress, _super);
            function ToolElementFilterExpress(config, options) {
                _super.call(this, config, options);
                var that = this;
                that.filterExpress = new _ui.FilterExpress(config.fields || [], function (filter) {
                    if (that.options.callback) {
                        var lfilter = filter ? _ui.filter.format.toPhenix(config.fields, [filter]) : null;
                        var ltitle = "";
                        if (lfilter)
                            ltitle = that._format(config.fields, filter.code, filter.values[0]);
                        that.options.callback({ id: config.id, name: config.name, type: config.type, value: { title: ltitle, value: lfilter }, toolData: config });
                    }
                });
            }
            ToolElementFilterExpress.prototype.createElement = function (index, config, data) {
                var css = [];
                if (config.right)
                    css.push("pull-right");
                return '<div class="bs-toolbar-item ' + css.join(" ") + '"></div>';
            };
            ToolElementFilterExpress.prototype.render = function ($parent) {
                var that = this;
                if (!that.$element) {
                    that.$element = $(that.createElement(that.config.id, that.config, that.data.value));
                    if (that.filterExpress)
                        that.filterExpress.render(that.$element);
                }
                if ($parent)
                    _dom.append($parent.get(0), that.$element.get(0));
                return that.$element;
            };
            ToolElementFilterExpress.prototype._format = function (fields, code, value) {
                var field = null;
                fields.every(function (item) {
                    if (item.code == code) {
                        field = item;
                        return false;
                    }
                    return true;
                });
                if (!field)
                    return "";
                if (field.enum) {
                    var index_1 = -1;
                    field.enumNames && field.enum.every(function (item, i) {
                        if (item == value) {
                            index_1 = i;
                            return false;
                        }
                        return true;
                    });
                    if (index_1 >= 0)
                        value = field.enumNames[index_1];
                    return (field.lib || field.libelle) + " contient " + value;
                }
                return (field.lib || field.libelle) + " = " + value;
            };
            return ToolElementFilterExpress;
        }(ToolElement));
        ui.ToolElementFilterExpress = ToolElementFilterExpress;
        var ToolElementFilter = (function (_super) {
            __extends(ToolElementFilter, _super);
            function ToolElementFilter(config, options) {
                _super.call(this, config, options);
            }
            ToolElementFilter.prototype.createElement = function (index, config, data) {
                var css = ["bs-button btn btn-default"];
                var html = [
                    '<div class="bs-toolbar-item ' + (config.right ? "pull-right" : "") + '">',
                    '<button toolClick="' + index + '" type="button" class="' + css.join(" ") + '">',
                    (config.icon ? '<span toolClick="' + index + '" class="' + _dom.iconClass(config.icon) + '"></span>' : ''),
                    (config.title ? '&nbsp;' + config.title : ''),
                    '</button>',
                    '<span class="bs-toolbar-item-filter form-control-static bs-cursor-h"></span>',
                    '</div>'
                ];
                return html.join('');
            };
            ToolElementFilter.prototype.addTooltip = function (data) {
                var that = this;
                var tooltip = $('<span data-toggle="tooltip" data-phoenix-tooltip="true" data-placement="auto" title= "' + data + '"> ' + data + ' </span>');
                var tt = _dom.query(that.$element.get(0), ".bs-toolbar-item-filter");
                _dom.empty(tt);
                _dom.append(tt, tooltip.get(0));
                tooltip["tooltip"]({
                    html: true,
                    container: 'body',
                    template: '<div class="tooltip bs-tooltip-help" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner" style="text-align:left"></div></div>'
                });
            };
            ToolElementFilter.prototype.update = function () {
                var that = this;
                if (!that.$element)
                    return;
                that.addTooltip(that.data.value);
            };
            ToolElementFilter.prototype.render = function ($parent) {
                _super.prototype.render.call(this, $parent);
                var that = this;
                that.addTooltip(that.data.value);
            };
            return ToolElementFilter;
        }(ToolElement));
        ui.ToolElementFilter = ToolElementFilter;
        var ToolBar = (function () {
            function ToolBar(toolElements, options) {
                var that = this;
                that.options = options || {};
                that.toolElements = toolElements || {};
            }
            ToolBar.prototype.getToolElement = function (indexOrName) {
                var e = null;
                this.toolElements.forEach(function (item, i) {
                    if (i == indexOrName || item.name === indexOrName) {
                        e = item.$component;
                        return false;
                    }
                });
                return e;
            };
            ToolBar.prototype.setValue = function (name, value) {
                var that = this;
                var te = that.getToolElement(name);
                if (te)
                    te.props.value = value;
            };
            ToolBar.prototype.getValue = function (name, value) {
                var that = this;
                var te = that.getToolElement(name);
                if (te)
                    return te.getValue();
                return;
            };
            ToolBar.prototype._setEvents = function () {
                var that = this;
                if (that.$element) {
                    that.$element.on('click', function (event) {
                        var index = _dom.attr(event.target, "toolClick");
                        if (index !== null)
                            onToolElement("click", index);
                    }).on('keyup', function (event) {
                        if (event.keyCode == 13) {
                            var index = _dom.attr(event.target, "toolKeyup");
                            onToolElement("keyup", index);
                        }
                    });
                }
                function onToolElement(action, id) {
                    if (id >= 0) {
                        var toolData = that.getToolElement(id);
                        if (toolData && that.options.selectToolElement) {
                            var value = toolData.getValue();
                            toolData.after();
                            that.options.selectToolElement({ id: toolData.config.id, type: toolData.config.type, name: toolData.config.name, value: value, toolData: toolData.config }, action);
                        }
                    }
                }
            };
            ToolBar.prototype._removeEvents = function () {
                var that = this;
                if (that.$element)
                    that.$element.off('click');
            };
            ToolBar.prototype._renderToolElements = function (toolElements) {
                var that = this;
                if (!toolElements.length)
                    return;
                var e = that.$element.get(0);
                toolElements.forEach(function (item, index) {
                    item.id = index;
                    var type = item.type;
                    switch (type.toLowerCase()) {
                        case "count":
                            item.$component = new ToolElementCount(item, { callback: that.options.selectToolElement });
                            break;
                        case "filter":
                            item.$component = new ToolElementFilter(item, { callback: that.options.selectToolElement });
                            break;
                        case "search":
                            item.$component = new ToolElementSearch(item, { callback: that.options.selectToolElement });
                            break;
                        case "filterexpress":
                            item.$component = new ToolElementFilterExpress(item, { callback: that.options.selectToolElement });
                            break;
                        case "dropdownaction":
                            item.$component = new ToolElementDropdownAction(item, { callback: that.options.selectToolElement });
                            break;
                        case "select":
                            item.$component = new ToolElementSelect(item, { callback: that.options.selectToolElement });
                            break;
                        default:
                            item.style = item.style || item.type;
                            item.$component = new ToolElementButton(item, { callback: that.options.selectToolElement });
                            break;
                    }
                    if (item.$component)
                        item.$component.render(that.$element);
                });
            };
            ToolBar.prototype.render = function ($parent) {
                var that = this;
                if (!that.$element) {
                    that.$element = $('<div class="form-inline bs-toolbar"></div>');
                    that._renderToolElements(that.toolElements);
                    that._setEvents();
                }
                if ($parent) {
                    if (that.options.replaceParent)
                        $parent.replaceWith(that.$element);
                    else
                        $parent.append(that.$element);
                }
                return that.$element;
            };
            ToolBar.prototype.destroy = function () {
                var that = this;
                that._removeEvents();
                that.$element = null;
                that.options = null;
            };
            return ToolBar;
        }());
        ui.ToolBar = ToolBar;
    })(ui = Phoenix.ui || (Phoenix.ui = {}));
})(Phoenix || (Phoenix = {}));
//# sourceMappingURL=core.js.map
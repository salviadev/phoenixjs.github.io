var Phoenix,__extends=this&&this.__extends||function(){var n=function(e,o){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,o){e.__proto__=o}||function(e,o){for(var t in o)o.hasOwnProperty(t)&&(e[t]=o[t])})(e,o)};return function(e,o){function t(){this.constructor=e}n(e,o),e.prototype=null===o?Object.create(o):(t.prototype=o.prototype,new t)}}();Phoenix=Phoenix||{},angular.module("app.core.ui",["phoenix.ui"]),function(){"use strict";angular.module("phoenix.authoring",[]).controller("AuthoringCtrl",["$scope","$rootScope","authoring","model","toolbox","form","prototype","locale","path",function(e,o,t,n,a,i,r,c,l){e.model=n,e.isform=!!i&&{},e.toolbox=a,e.schema=r,e.locale=c,e.path=l}])}(Phoenix=Phoenix||{}),function(e){var n=e.ajax;e.application.configuration;angular.module("app.core.ui").service("PhoenixAuthSession",function(){return this.create=function(e){this.init=!0,this.connected=!0,this.credentials=e},this.destroy=function(){this.init=!0,this.connected=!1,this.credentials=null},this.notifyLogEvent=function(e,o,t){e.$emit(o,{connected:this.connected,credentials:this.credentials,params:t})},this}).factory("PhoenixAuthService",["$rootScope","PhoenixAuthSession",function(t,n){return{login:function(e,o){t.doLogIn?t.doLogIn(e,function(e){e?n.create(e):n.destroy(),n.notifyLogEvent(t,"auth-state-changed"),o&&o()}):(n.create(e),n.notifyLogEvent(t,"auth-state-changed"),o&&o())},checkLoggedIn:function(o){n.init||t.checkLoggedIn&&t.checkLoggedIn(function(e){e?n.create(e):n.destroy(),n.notifyLogEvent(t,"auth-state-changed"),o&&o({connected:n.connected,credentials:n.credentials})})},logout:function(e){e?(n.destroy(),n.notifyLogEvent(t,"auth-state-changed"),n.notifyLogEvent(t,"auth-show-login-page",{noRedirect:!0})):t.doLogOut&&t.doLogOut(function(){n.destroy(),n.notifyLogEvent(t,"auth-state-changed"),n.notifyLogEvent(t,"auth-show-login-page",{noRedirect:!0})})}}}]).run(["$rootScope","PhoenixAuthService","PhoenixAuthSession",function(e,o,t){n.interceptError(401,function(){t.destroy(),e.$apply(function(){t.notifyLogEvent(e,"auth-state-changed"),t.notifyLogEvent(e,"auth-show-login-page",{noRedirect:!1,sessionExpired:!0})})})}])}(Phoenix=Phoenix||{}),function(e){var o=angular.module("app.core.ui"),t=e.ajax,n=e.pagecontrol,a=e.locale;o.controller("ForbiddenCtrl",["$scope",function(e){}]),o.directive("forbidden",[function(){return{scope:!0,replace:!0,templateUrl:"./core/templates/forbidden.html",controller:"ForbiddenCtrl",link:function(e,o,t){n.Page().props.$title=a.errors.notAuthorized}}}]),o.run(["$rootScope",function(e){t.interceptError(403,function(){e.$apply(function(){e.$emit("show-forbidden",{})})})}])}(Phoenix=Phoenix||{}),function(e){var a,o=e.ui,r=e.ajax,c=e.link,t=e.customData,l=e.application,n={name:"page-form",$type:"block",$items:[{$type:"block",$items:[{$bind:"pageName"},{$bind:"avanced"}]},{$type:"block",$items:[{$bind:"formName"},{$bind:"metaName"},{$bind:"controllerName"}]}],form:!0},i={type:"object",properties:{pageName:{title:"Page name",format:"code",type:"string"},formName:{title:"Form name",format:"code",type:"string"},metaName:{title:"Meta name",format:"code",type:"string"},controllerName:{title:"Controller name",format:"code",type:"string",default:"phoenix.empty.controller"},avanced:{type:"boolean",title:"Avanced",ux:!0,default:!1}},states:{pageName:{isMandatory:!0},formName:{isHidden:!0,isMandatory:!0},metaName:{isHidden:!0,isMandatory:!0},controllerName:{isHidden:!0,isMandatory:!0,default:"phoenix.empty.controller"}}},s=(a=e.ui.FormController,__extends(u,a),u.prototype.onAvanced=function(e,o,t){o.$states.formName.isHidden=!o.avanced,o.$states.metaName.isHidden=!o.avanced,o.$states.controllerName.isHidden=!o.avanced},u.prototype.onPageName=function(e,o,t){if(0<o.pageName.indexOf("/")){var n=o.pageName.split("/"),a=n.pop(),i=n.slice(0);n.push("forms"),n.push(a),i.push("metas"),i.push(a),o.formName=n.join("/"),o.metaName=i.join("/")}else o.formName=o.pageName+"-form",o.metaName=o.pageName+"-meta"},u.prototype.onModelChanged=function(e,o,t,n){a.prototype.onModelChanged.call(this,e,o,t,n)},u.prototype.onCreate=function(e,o,t,n){if(o.validate()){var a=o.model(),i=l.config(l.name);i&&i.current&&i.current.pageformcreate?r.post(i.current.pageformcreate,a).then(function(e){n.close();var o=c.context();e.formName?c.execLink({$formAuthoring:!0,name:e.formName,schema:e.metaName},o,null):c.execLink({$page:e.pageName},o,null)}).catch(function(e){o.addAjaxException(e)}):n.close()}},u.prototype.onClose=function(e,o,t,n){n.close()},u);function u(){return null!==a&&a.apply(this,arguments)||this}t.register("phoenix.formcreate.controller",new s),t.register("phoenix.action.createform",function(){var e={name:n,meta:i,controller:"phoenix.formcreate.controller",options:{title:"Create a new page & a new form",buttons:[{pattern:"create"},{pattern:"close"}]}};o.showModalForm(e,{controllerName:"phoenix.empty.controller"})})}(Phoenix=Phoenix||{}),function(e){var o,a=e.ui,i=e.ajax,t=e.utils,n=e.customData,r=e.application,c={name:"page-form",$type:"block",$items:[{$type:"block",$items:[{$bind:"schemaName",options:{titleIsHidden:!0}}]},{$type:"block",$items:[{$bind:"schema"}]}],form:!0},l={type:"object",properties:{schemaName:{title:"Schema name",format:"code",type:"string"},schema:{title:"Schema",format:"json",type:"string"}},states:{schemaName:{isReadOnly:!0},schema:{isMandatory:!0}}},s=(o=e.ui.FormController,__extends(u,o),u.prototype.onValidate=function(e,o,t,n){if(o.validate()){o.model();var a=r.config(r.name);a&&a.current&&a.current.prototypes?i.put(a.current.prototypes+"/"+o.schemaName+"?original=true",JSON.parse(o.model(!0).schema)).then(function(e){n.close()}).catch(function(e){o.addAjaxException(e)}):n.close()}},u.prototype.onClose=function(e,o,t,n){n.close()},u);function u(){return null!==o&&o.apply(this,arguments)||this}n.register("phoenix.action.updschema",function(){t.prompt("Enter schema name","",function(n){var e=r.config(r.name);e&&e.current&&e.current.prototypes&&i.get(e.current.prototypes+"/"+n+"?original=true").then(function(e){var o,t;o={schemaName:n,schema:JSON.stringify(e,null,2)},t={name:c,meta:l,controller:"phoenix.updateschema.controller",options:{title:"Create a new page & a new form",buttons:[{pattern:"validate"},{pattern:"close"}]}},a.showModalForm(t,o)}).catch(function(e){console.log(e),e.message&&alert(e.message)})})}),n.register("phoenix.updateschema.controller",new s)}(Phoenix=Phoenix||{}),function(e){var o=angular.module("app.core.ui"),c=e.dom,l=e.history,n=e.ui,a=e.pagecontrol,s=e.ajax,i=e.ulocale,u=e.application,p=e.DatasetPlugin,t=e.data;o.controller("LoginCtrl",["$scope","$location","PhoenixAuthService","PhoenixAuthSession",function(a,i,e,r){a.canResetPassword=!!(u.configuration&&u.configuration.application&&u.configuration.application.authentication&&u.configuration.application.authentication.resetPasswordDs),a.credentials={},a.icons={user:c.iconClass("user"),lock:c.iconClass("lock")},a.doResetPassword=function(){var e,r,o,t;e=a.view,r=null,o={type:"object",properties:{login:{title:e.login.title,type:"string"}},states:{login:{isMandatory:!0}}},t={title:e.resetPassword,buttons:[{type:"success",title:e.sendPassword,name:"send"}]},n.OpenModalForm(t,{name:"resetpwd",$type:"block",$items:[{$bind:"login"}]},o,{},{},function(t,e,n,o){switch(e.property){case"send":if(!n.validate())return;var a=u.configuration.application.authentication.resetPasswordDs;if(!a)return void t.close();c.processing(!0);var i={login:n.login};a.name="data",s.activateInterceptError(401,!1),p.executeDatasets([a],i,{},[],function(e,o){s.activateInterceptError(401,!0),o?(n.addAjaxException(o),c.processing(!1)):(c.processing(!1),t.close(),r&&r())})}})},a.login=function(){var n=a.credentials;n.login&&n.password&&(s.activateInterceptError(403,!1),e.login(n,function(){if(s.activateInterceptError(403,!0),r.connected){var e=i.search(),o=e.redirectUrl||"/"+u.homeName,t=JSON.parse(e.redirectSearch||"{}");l.removeLast(),i.path(o).search(t).replace()}else n.message=a.view.defaultMessage}))}}]),o.directive("login",["$rootScope",function(e){return{scope:!0,replace:!0,templateUrl:"./core/templates/login.html",controller:"LoginCtrl",link:function(n,e,o){c.bodyTheme("login"),t.schema.get("login",!0,u.core).then(function(e){if(e&&e.$view){var o=u.configuration;if(o.locales&&o.locales.login){var t=i.lang;o.locales.login[t]||(t="fr"),o.locales.login[t]&&(e.$view.titlepage=o.locales.login[t].titlePage,e.$view.title.title=o.locales.login[t].title)}}n.$apply(function(){n.view=e?e.$view:null,n.view&&(a.Page().props.$title=n.view.title.title)})})}}}])}(Phoenix=Phoenix||{}),function(){"use strict";angular.module("phoenix.page",[]).controller("PageCtrl",["$scope","$rootScope","model",function(e,o,t){e.model=t||null}])}(Phoenix=Phoenix||{}),angular.module("phoenix.authoring").run(["$templateCache",function(e){"use strict";e.put("./authoring/authoring.html",'<div class="container-fluid"><authoring toolbox="toolbox" isform="isform" authoring="true"></authoring><div id="nav"></div><div class="row design-table"><div style="width:100%;"><layout model="model" prototype="schema" locale="locale" handlers="handlers" isform="isform" authoring="true" path="path"></layout></div><div style="width:300px;"><div id="toolbox_parent" class="bs-scroll-container"><div id="toolbox"></div></div></div></div><div id="editor"></div></div>')}]),angular.module("app.core.ui").run(["$templateCache",function(e){"use strict";e.put("./core/templates/forbidden.html",'<div class="container-fluid"><h2>Forbidden</h2></div>'),e.put("./core/templates/login.html",'<div class="bs-app-login"><center><div class="hidden-xs"><br><br><br><br></div><h3 class="bs-app-login-title">{{::view.titlepage}}</h3><div class="center-block"><center><div class="form"><form role="form"><div class="bs-app-login-width"><div class="input-group input-group-lg bs-app-login-input"><span class="input-group-addon {{::icons.user}}" id="sizing-addon1"></span> <input type="text" class="form-control user" autofocus ng-model="credentials.login" placeholder="{{::view.login.title}}"></div><div class="input-group input-group-lg bs-app-login-input"><span class="input-group-addon {{::icons.lock}}" id="sizing-addon2"></span> <input type="password" class="form-control password" ng-model="credentials.password" placeholder="{{::view.password.title}}"></div></div><div ng-show="canResetPassword" class="ng-hide bs-app-login-width bs-app-login-resetpassword"><br><a data-ng-click="doResetPassword()" href="">{{::view.forgotPassword}}</a><br></div><br><div id="sign-in-error" class="form-error text-danger"><alert type="danger">{{credentials.message}}</alert></div><br><div class="form-input form-group form-group-lg bs-app-login-width"><button class="bs-button btn btn-block btn-lg btn-danger" data-ng-click="login()">{{::view.signin.title}}</button></div></form></div></center></div><div class="bs-app-login-icon"></div></center></div>')}]),function(e){var d=e.authentication,g=e.application,h=e.ajax,f=e.utils,a=e.pagecontrol,m=e.link,v=e.dom,x=e.data,y=function(e,n,o,t){var a=n,i=g.configuration,r=i&&i.authentication&&i.authentication.autoLogon,c="";if(r){var l=m.context({cookie:!0});(c=f.execAngularExpression(i.authentication.autoLogon.login,l))||(r=!1)}r&&"GET"===o&&(t&&t.autoLogon||(a=function(e){if(e)n(e);else{var o={},t=m.context({cookie:!0});o.login=c,o.password=f.execAngularExpression(i.authentication.autoLogon.password,t),y(o,n,"POST",{autoLogon:!0})}}));var s=!e;if(s=(s=s||("GET"===o||"DELETE"===o)&&!e.token)||"POST"===o&&!e.login)a&&a(null);else{function u(e,o){v.processing(!1),"DELETE"===e&&d.clear(),h.activateInterceptError(401,!0),"POST"!==e&&"GET"!==e||(g.licences={},o.licences&&o.licences.forEach(function(e){g.licences[e.module]=e}),d.save(o,!0)),a&&a(o)}v.processing(!0),h.activateInterceptError(401,!1);var p=null;if("POST"===o&&(p=e),r&&i.authentication.autoLogon.force)return u(o,{licences:[],login:r.login});x.rest.getRessources({$method:o,$url:"{$context}/authentif/api/session",$data:p},!1,null).then(function(e){return u(o,e)}).catch(function(e){v.processing(!1),d.clear(),h.activateInterceptError(401,!0),a&&a(null)})}};e.external.checkLoggedInHandler=function(e){var o=d.load();y(o,e,"GET")},g.angularApplication&&g.angularApplication.run(["$rootScope",function(n){function t(e,o,t){y(e,function(e){n.$apply(function(){o&&o(e)})},t)}n.doLogIn=function(e,o){d.clear(),t(e,function(e){o&&o(e)},"POST")},n.checkLoggedIn=function(o){var e=d.load();t(e,function(e){o&&o(e)},"GET")},n.doLogOut=function(o){var e=d.load();t(e,function(e){o&&o(e)},"DELETE")},n.$on("auth-state-changed",function(e,o){a.Page().props.$user=o})}])}(Phoenix=Phoenix||{}),function(){var e=(Phoenix||(Phoenix={})).application;angular.module("app",["ngRoute","app.core.ui","phoenix.page","phoenix.authoring","phoenix.ui",e.name])}(),function(){var p=Phoenix||(Phoenix={}),d=p.application,e=p.device,g=p.build,h=p.pagecontrol,f=p.utils,o=p.ulocale,m=p.history,v=p.ajax,x=p.data,c=p.angularjs;function y(){return p.build.release&&g.releaseVersion&&o.currentLang!==o.sourceLang?"_"+o.currentLang:""}function l(i){function o(e,o){var t=e.current.params.layoutId||"home",n=d.isCustomizable(o?"forms":"pages",t)?i.dev:i.current,a=(o?n.forms:n.pages)+"/"+t+y()+".json";return p.build.release&&g.releaseVersion&&(a=a+"?release="+g.releaseVersion),x.rest.get(a)}var e=angular.module("app"),t=["$route",function(e){return o(e,!1)}],n=["$route",function(e){return o(e,!0)}],a=["$route",function(e){return v.get(i.current.toolboxes+"/"+(e.current.params.toolbarId||"default")+".json")}],r=["$route",function(e){return v.get(i.current.toolboxes+"/"+(e.current.params.toolbarId||"default")+".json?form=true")}],c=["$route",function(e){return v.get(i.current.locales+"/"+(e.current.params.locale||e.current.params.layoutId)+".json",{ignore:{404:!0}})}],l=["$route",function(e){var o=i.current.prototypes+"/"+(e.current.params.prototype||e.current.params.layoutId)+y()+".json";return p.build.release&&g.releaseVersion&&(o=o+"?release="+g.releaseVersion),v.get(o)}],s=["$route",function(e){return e.current.params.path}],u=["$route",function(e){var o=f.phoenixPath().split("/");return o.push(g.release?"phoenix.design.min.js":"phoenix.design.js"),v.getScript(o.join("/"))}];e.config(["$routeProvider","$locationProvider",function(e,o){o.hashPrefix(m.locationPrefix),e.when("/login",{template:'<div class="container"><login></login></div>'}).when("/forbidden",{template:'<div class="container"><forbidden></forbidden></div>'}).when("/authoring/forms/:layoutId*",{templateUrl:"./authoring/authoring.html",controller:"AuthoringCtrl",resolve:{authoring:u,model:n,toolbox:r,prototype:l,locale:c,form:function(){return!0},path:s}}).when("/authoring/:layoutId*",{templateUrl:"./authoring/authoring.html",controller:"AuthoringCtrl",resolve:{authoring:u,model:t,toolbox:a,prototype:function(){return null},locale:function(){return null},form:function(){return!1},path:function(){return null}}}).when("/:layoutId*",{template:'<layout model="model"></layout>',controller:"PageCtrl",resolve:{model:t},reloadOnSearch:!0}).otherwise({redirectTo:"/"+d.homeName})}]).run(["$rootScope","$location",function(e,l){e.$on("$routeChangeStart",function(e,o,t){var n=h.Page(),a=n.props.$user&&n.props.$user.connected;if(o&&o.params&&o.params.layoutId&&!a&&"login"!=o.params.layoutId){var i=l.path(),r=l.search(),c={redirectUrl:i,redirectSearch:JSON.stringify(r)};0<=i.toLowerCase().indexOf("/login")||!r||r.redirectUrl?l.path("/login"):l.path("/login").search(c).replace()}})}])}var t=window.isMobile||{phone:!1,tablet:!1,windows:{},android:{},apple:{}};e.phone=t.phone,e.tablet=t.tablet,e.deviceType=t.windows.device?"windows":t.android.device?"android":t.apple.device?"apple":"",function(){var e=d.configuration?d.configuration:{},o=e.odata?e.odata:{base:"/dataserver/data",headers:{"mg-authentication":"NoPopup"},authentication:"basic"},t=e.rest?e.rest:{},n=e.preferences?e.preferences:{},a=g.release&&e.ui&&e.ui.baseUri?e.ui.baseUri:"/api",i={static:{locales:"./ui/locales",menus:"./ui/menus",pages:"./ui/pages",forms:"./ui/forms",toolboxes:"./ui/toolboxes",prototypes:"./ui/forms/meta",pageformcreate:null,localData:"./data",odata:o,rest:t,preferences:n},dev:{locales:".//ui/locales",menus:a+"/menus/"+d.name,pages:a+"/pages/"+d.name,forms:a+"/forms/"+d.name,toolboxes:a+"/toolboxes/"+d.name,prototypes:a+"/metaform/"+d.name,localData:a+"/data/"+d.name,pageformcreate:a+"/pageform/"+d.name,odata:o,rest:t,preferences:n},current:null};i.current=g.release?i.static:i.dev,d.config(d.name,i);var r=angular.module(d.name);c.registerFilters(r),document.title=d.title,l(i)}()}(),function(n){var p=n.application,d=p.configuration&&p.configuration.application?p.configuration.application:null,g=n.history,e=n.build,o=n.pagecontrol,h=n.link,f=n.utils,a=n.ajax,r=n.external,c=new n.serial.SingleEventBus(1e3),t=angular.module("app"),i=f.phoenixPath().split("/");i.pop(),i.pop(),i.pop(),i.push("phoenix-app/dist/ui/locales"),p.config(p.core,{current:{locales:i.join("/")}}),t.run(["$location","$rootScope","PhoenixAuthService","$route",function(s,u,e,a){var i=s.path;s.path=function(e,o){if(o)var t=a.current,n=u.$on("$locationChangeSuccess",function(){a.current=t,n()});return i.apply(s,[e])};function t(e,o){e&&g.removeLast();var t=p.configuration&&p.configuration.application?p.configuration.application.forbiddenLink:null;t?(t.$replace=!0,h.execLink(t,{},null)):s.path("/forbidden").replace()}function n(e,o){var t=p.configuration,n=t&&t.authentication&&t.authentication.autoLogon;if(n){var a=h.context({cookie:!0});f.execAngularExpression(t.authentication.autoLogon.login,a)||(n=!1)}if(n)document.location.reload();else{var i=s.path(),r=s.search(),c={};if(e||"/"!=i&&(c.redirectUrl=i,c.redirectSearch=JSON.stringify(r)),!(0<=i.toLowerCase().indexOf("/login"))){var l={$apply:function(e){e()}};o.apply&&(l=u),l.$apply(function(){e?d&&d.authentication&&d.authentication.home?s.path("/login"):s.path("/"):(g.removeLast(),s.path("/login").search(c).replace())})}}}r.hashHandler=function(o,t,n){f.nextTick(function(){u.$apply(function(){var e=h.parseUrl(o);t?s.path(e.path,n).search(e.search).replace():s.path(e.path,n).search(e.search)})})},r.forbiddenHandler=function(){u.$apply(function(){t(!0)})},r.logoutHandler=function(){u.$apply(function(){e.logout()})},u.$on("$routeChangeSuccess",function(e){g.add(window.location.hash,window.location.hash=="#/"+p.homeName)}),u.$on("auth-show-login-page",function(e,o){var t={};o&&o.params&&o.params.sessionExpired&&(t.sessionExpired=!0),function(e,o){if(o.sessionExpired){c.push(function(){return o.apply=!0,n(e,o),null},function(){},!1)}else n(e,o)}(!(!o||!o.params)&&o.params.noRedirect,t)}),u.$on("show-forbidden",function(e,o){t(!0,o&&o.code&&o.code)})}]),angular.element(document).ready(function(){function t(){r.checkLoggedInHandler?r.checkLoggedInHandler(function(e){o.Page().props.$user={connected:!!e,credentials:e},angular.bootstrap(document,["app"])}):angular.bootstrap(document,["app"])}new Date;a.get("../app.json?release="+e.releaseVersion).then(function(o){if(o){o.support&&(p.support=o.support,delete o.support);var e=p.config(p.name);o.mem&&"object"==typeof o.mem&&(Object.keys(o.mem).forEach(function(e){n.$mem[e]=o.mem[e]}),delete o.mem),f.extend(e,o),p.config(p.name,e)}t()}).catch(function(e){t()})})}(Phoenix=Phoenix||{});
//# sourceMappingURL=app.min.js.map
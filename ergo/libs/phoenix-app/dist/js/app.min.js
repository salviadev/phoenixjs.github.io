var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,o){e.__proto__=o}||function(e,o){for(var t in o)o.hasOwnProperty(t)&&(e[t]=o[t])};return function(o,t){function n(){this.constructor=o}e(o,t),o.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}}(),Phoenix;Phoenix||(Phoenix={}),angular.module("app.core.ui",["phoenix.ui"]);var Phoenix;!function(e){"use strict";angular.module("phoenix.authoring",[]).controller("AuthoringCtrl",["$scope","$rootScope","authoring","model","toolbox","form","prototype","locale","path",function(e,o,t,n,a,i,r,c,l){e.model=n,e.isform=!!i&&{},e.toolbox=a,e.schema=r,e.locale=c,e.path=l}])}(Phoenix||(Phoenix={}));var Phoenix;!function(e){var o=e.ajax;e.application.configuration;angular.module("app.core.ui").service("PhoenixAuthSession",function(){return this.create=function(e){this.init=!0,this.connected=!0,this.credentials=e},this.destroy=function(){this.init=!0,this.connected=!1,this.credentials=null},this.notifyLogEvent=function(e,o,t){e.$emit(o,{connected:this.connected,credentials:this.credentials,params:t})},this}).factory("PhoenixAuthService",["$rootScope","PhoenixAuthSession",function(e,o){return{login:function(t,n){e.doLogIn?e.doLogIn(t,function(t){t?o.create(t):o.destroy(),o.notifyLogEvent(e,"auth-state-changed"),n&&n()}):(o.create(t),o.notifyLogEvent(e,"auth-state-changed"),n&&n())},checkLoggedIn:function(t){o.init||e.checkLoggedIn&&e.checkLoggedIn(function(n){n?o.create(n):o.destroy(),o.notifyLogEvent(e,"auth-state-changed"),t&&t({connected:o.connected,credentials:o.credentials})})},logout:function(t){t?(o.destroy(),o.notifyLogEvent(e,"auth-state-changed"),o.notifyLogEvent(e,"auth-show-login-page",{noRedirect:!0})):e.doLogOut&&e.doLogOut(function(){o.destroy(),o.notifyLogEvent(e,"auth-state-changed"),o.notifyLogEvent(e,"auth-show-login-page",{noRedirect:!0})})}}}]).run(["$rootScope","PhoenixAuthService","PhoenixAuthSession",function(e,t,n){o.interceptError(401,function(){n.destroy(),e.$apply(function(){n.notifyLogEvent(e,"auth-state-changed"),n.notifyLogEvent(e,"auth-show-login-page",{noRedirect:!1,sessionExpired:!0})})})}])}(Phoenix||(Phoenix={}));var Phoenix;!function(e){var o=angular.module("app.core.ui"),t=e.ajax,n=e.pagecontrol,a=e.locale;o.controller("ForbiddenCtrl",["$scope",function(e){}]),o.directive("forbidden",[function(){return{scope:!0,replace:!0,templateUrl:"./core/templates/forbidden.html",controller:"ForbiddenCtrl",link:function(e,o,t){n.Page().props.$title=a.errors.notAuthorized}}}]),o.run(["$rootScope",function(e){t.interceptError(403,function(){e.$apply(function(){e.$emit("show-forbidden",{})})})}])}(Phoenix||(Phoenix={}));var Phoenix;!function(e){var o=e.ui,t=e.ajax,n=e.link,a=e.customData,i=e.application,r={name:"page-form",$type:"block",$items:[{$type:"block",$items:[{$bind:"pageName"},{$bind:"avanced"}]},{$type:"block",$items:[{$bind:"formName"},{$bind:"metaName"},{$bind:"controllerName"}]}],form:!0},c={type:"object",properties:{pageName:{title:"Page name",format:"code",type:"string"},formName:{title:"Form name",format:"code",type:"string"},metaName:{title:"Meta name",format:"code",type:"string"},controllerName:{title:"Controller name",format:"code",type:"string",default:"phoenix.empty.controller"},avanced:{type:"boolean",title:"Avanced",ux:!0,default:!1}},states:{pageName:{isMandatory:!0},formName:{isHidden:!0,isMandatory:!0},metaName:{isHidden:!0,isMandatory:!0},controllerName:{isHidden:!0,isMandatory:!0,default:"phoenix.empty.controller"}}},l=function(e){function o(){return null!==e&&e.apply(this,arguments)||this}return __extends(o,e),o.prototype.onAvanced=function(e,o,t){o.$states.formName.isHidden=!o.avanced,o.$states.metaName.isHidden=!o.avanced,o.$states.controllerName.isHidden=!o.avanced},o.prototype.onPageName=function(e,o,t){o.formName=o.pageName+"-form",o.metaName=o.pageName+"-meta"},o.prototype.onModelChanged=function(o,t,n,a){e.prototype.onModelChanged.call(this,o,t,n,a)},o.prototype.onCreate=function(e,o,a,r){if(o.validate()){var c=o.model(),l=i.config(i.name);l&&l.current&&l.current.pageformcreate?t.post(l.current.pageformcreate,c).then(function(e){r.close();var o=n.context();e.formName?n.execLink({$formAuthoring:!0,name:e.formName,schema:e.metaName},o,null):n.execLink({$page:e.pageName},o,null)}).catch(function(e){o.addAjaxException(e)}):r.close()}},o.prototype.onClose=function(e,o,t,n){n.close()},o}(e.ui.FormController);a.register("phoenix.formcreate.controller",new l),a.register("phoenix.action.createform",function(){var e={name:r,meta:c,controller:"phoenix.formcreate.controller",options:{title:"Create a new page & a new form",buttons:[{pattern:"create"},{pattern:"close"}]}};o.showModalForm(e,{controllerName:"phoenix.empty.controller"})})}(Phoenix||(Phoenix={}));var Phoenix;!function(e){var o=e.ui,t=e.ajax,n=e.utils,a=e.customData,i=e.application,r={name:"page-form",$type:"block",$items:[{$type:"block",$items:[{$bind:"schemaName",options:{titleIsHidden:!0}}]},{$type:"block",$items:[{$bind:"schema"}]}],form:!0},c={type:"object",properties:{schemaName:{title:"Schema name",format:"code",type:"string"},schema:{title:"Schema",format:"json",type:"string"}},states:{schemaName:{isReadOnly:!0},schema:{isMandatory:!0}}},l=function(e){function o(){return null!==e&&e.apply(this,arguments)||this}return __extends(o,e),o.prototype.onValidate=function(e,o,n,a){if(o.validate()){o.model();var r=i.config(i.name);r&&r.current&&r.current.prototypes?t.put(r.current.prototypes+"/"+o.schemaName+"?original=true",JSON.parse(o.model(!0).schema)).then(function(e){a.close()}).catch(function(e){o.addAjaxException(e)}):a.close()}},o.prototype.onClose=function(e,o,t,n){n.close()},o}(e.ui.FormController),s=function(e){var t={name:r,meta:c,controller:"phoenix.updateschema.controller",options:{title:"Create a new page & a new form",buttons:[{pattern:"validate"},{pattern:"close"}]}};o.showModalForm(t,e)};a.register("phoenix.action.updschema",function(){n.prompt("Enter schema name","",function(e){var o=i.config(i.name);o&&o.current&&o.current.prototypes&&t.get(o.current.prototypes+"/"+e+"?original=true").then(function(o){s({schemaName:e,schema:JSON.stringify(o,null,2)})}).catch(function(e){console.log(e),e.message&&alert(e.message)})})}),a.register("phoenix.updateschema.controller",new l)}(Phoenix||(Phoenix={}));var Phoenix;!function(e){var o=angular.module("app.core.ui"),t=e,n=t.dom,a=t.history,i=t.ui,r=t.pagecontrol,c=t.ajax,l=t.ulocale,s=t.application,u=t.DatasetPlugin,p=t.data,d=function(e,o){var t={name:"resetpwd",$type:"block",$items:[{$bind:"login"}]},a={type:"object",properties:{login:{title:e.login.title,type:"string"}},states:{login:{isMandatory:!0}}},r={title:e.resetPassword,buttons:[{type:"success",title:e.sendPassword,name:"send"}]};i.OpenModalForm(r,t,a,{},{},function(e,t,a,i){switch(t.property){case"send":if(!a.validate())return;var r={},l=s.configuration.application.authentication.resetPasswordDs;if(!l)return void e.close();n.processing(!0);var p={login:a.login};l.name="data",c.activateInterceptError(401,!1),u.executeDatasets([l],p,r,[],function(t,i){c.activateInterceptError(401,!0),i?(a.addAjaxException(i),n.processing(!1)):(n.processing(!1),e.close(),o&&o())})}})};o.controller("LoginCtrl",["$scope","$location","PhoenixAuthService","PhoenixAuthSession",function(e,o,t,i){e.canResetPassword=!!(s.configuration&&s.configuration.application&&s.configuration.application.authentication&&s.configuration.application.authentication.resetPasswordDs),e.credentials={},e.icons={user:n.iconClass("user"),lock:n.iconClass("lock")},e.doResetPassword=function(){d(e.view,null)},e.login=function(){var n=e.credentials;n.login&&n.password&&(c.activateInterceptError(403,!1),t.login(n,function(){if(c.activateInterceptError(403,!0),i.connected){var t=o.search(),r=t.redirectUrl||"/"+s.homeName,l=JSON.parse(t.redirectSearch||"{}");a.removeLast(),o.path(r).search(l).replace()}else n.message=e.view.defaultMessage}))}}]),o.directive("login",["$rootScope",function(e){return{scope:!0,replace:!0,templateUrl:"./core/templates/login.html",controller:"LoginCtrl",link:function(e,o,t){n.bodyTheme("login"),p.schema.get("login",!0,s.core).then(function(o){if(o&&o.$view){var t=s.configuration;if(t.locales&&t.locales.login){var n=l.lang;t.locales.login[n]||(n="fr"),t.locales.login[n]&&(o.$view.titlepage=t.locales.login[n].titlePage,o.$view.title.title=t.locales.login[n].title)}}e.$apply(function(){e.view=o?o.$view:null,e.view&&(r.Page().props.$title=e.view.title.title)})})}}}])}(Phoenix||(Phoenix={}));var Phoenix;!function(e){"use strict";angular.module("phoenix.page",[]).controller("PageCtrl",["$scope","$rootScope","model",function(e,o,t){e.model=t||null}])}(Phoenix||(Phoenix={})),angular.module("phoenix.authoring").run(["$templateCache",function(e){"use strict";e.put("./authoring/authoring.html",'<div class="container-fluid"><authoring toolbox="toolbox" isform="isform" authoring="true"></authoring><div id="nav"></div><div class="row design-table"><div style="width:100%"><layout model="model" prototype="schema" locale="locale" handlers="handlers" isform="isform" authoring="true" path="path"></layout></div><div style="width:300px"><div id="toolbox_parent" class="bs-scroll-container"><div id="toolbox"></div></div></div></div><div id="editor"></div></div>')}]),angular.module("app.core.ui").run(["$templateCache",function(e){"use strict";e.put("./core/templates/forbidden.html",'<div class="container-fluid"><h2>Forbidden</h2></div>'),e.put("./core/templates/login.html",'<div class="bs-app-login"><center><div class="hidden-xs"><br><br><br><br></div><h3 class="bs-app-login-title">{{::view.titlepage}}</h3><div class="center-block"><center><div class="form"><form role="form"><div class="bs-app-login-width"><div class="input-group input-group-lg bs-app-login-input"><span class="input-group-addon {{::icons.user}}" id="sizing-addon1"></span> <input type="text" class="form-control user" autofocus ng-model="credentials.login" placeholder="{{::view.login.title}}"></div><div class="input-group input-group-lg bs-app-login-input"><span class="input-group-addon {{::icons.lock}}" id="sizing-addon2"></span> <input type="password" class="form-control password" ng-model="credentials.password" placeholder="{{::view.password.title}}"></div></div><div ng-show="canResetPassword" class="ng-hide bs-app-login-width bs-app-login-resetpassword"><br><a data-ng-click="doResetPassword()" href="">{{::view.forgotPassword}}</a><br></div><br><div id="sign-in-error" class="form-error text-danger"><alert type="danger">{{credentials.message}}</alert></div><br><div class="form-input form-group form-group-lg bs-app-login-width"><button class="bs-button btn btn-block btn-lg btn-danger" data-ng-click="login()">{{::view.signin.title}}</button></div></form></div></center></div><div class="bs-app-login-icon"></div></center></div>')}]);var Phoenix;!function(e){var o=e.authentication,t=e.application,n=e.ajax,a=e.utils,i=e.pagecontrol,r=e.link,c=e.external,l=(e.ui,e.dom),s=e.data,u=function(i,c,p,d){var h=c,g=t.configuration,f=g&&g.authentication&&g.authentication.autoLogon,m="";if(f){var v=r.context({cookie:!0});(m=a.execAngularExpression(g.authentication.autoLogon.login,v))||(f=!1)}f&&"GET"===p&&(d&&d.autoLogon||(h=function(e){if(e)c(e);else{var o={},t=r.context({cookie:!0});o.login=m,o.password=a.execAngularExpression(g.authentication.autoLogon.password,t),u(o,c,"POST",{autoLogon:!0})}}));var x=!i;if(x||(x=("GET"===p||"DELETE"===p)&&!i.token),x||(x="POST"===p&&!i.login),x)h&&h(null);else{var y=function(a,i){l.processing(!1),"DELETE"===a&&o.clear(),n.activateInterceptError(401,!0),"POST"!==a&&"GET"!==a||(t.licences={},i.licences&&i.licences.forEach(function(o){e.application.licences[o.module]=o}),o.save(i,!0)),h&&h(i)};l.processing(!0),n.activateInterceptError(401,!1);var b=null;if("POST"===p&&(b=i),f&&g.authentication.autoLogon.force)return y(p,{licences:[],login:f.login});s.rest.getRessources({$method:p,$url:"{$context}/authentif/api/session",$data:b},null).then(function(e){return y(p,e)}).catch(function(e){l.processing(!1),o.clear(),n.activateInterceptError(401,!0),h&&h(null)})}};c.checkLoggedInHandler=function(e){var t=o.load();u(t,e,"GET")},t.angularApplication&&function(e){e.run(["$rootScope",function(e){var t=function(o,t,n){u(o,function(o){e.$apply(function(){t&&t(o)})},n)};e.doLogIn=function(e,n){o.clear(),t(e,function(e){n&&n(e)},"POST")},e.checkLoggedIn=function(e){var n=o.load();t(n,function(o){e&&e(o)},"GET")},e.doLogOut=function(e){var n=o.load();t(n,function(o){e&&e(o)},"DELETE")},e.$on("auth-state-changed",function(e,o){i.Page().props.$user=o})}])}(t.angularApplication)}(Phoenix||(Phoenix={}));var Phoenix;!function(e){var o=e.application;angular.module("app",["ngRoute","app.core.ui","phoenix.page","phoenix.authoring","phoenix.ui",o.name])}(Phoenix||(Phoenix={}));var Phoenix;!function(e){var o=e,t=o.application,n=o.device,a=o.build,i=o.pagecontrol,r=o.utils,c=o.history,l=o.ajax,s=o.data,u=o.angularjs,p=function(e){var o=function(o,n){var a=o.current.params.layoutId||"home",i=t.isCustomizable(n?"forms":"pages",a)?e.dev:e.current,r=n?i.forms:i.pages;return s.rest.get(r+"/"+a+".json")},n=["$route",function(e){return o(e,!1)}],u=["$route",function(e){return o(e,!0)}],p=["$route",function(o){return l.get(e.current.toolboxes+"/"+(o.current.params.toolbarId||"default")+".json")}],d=["$route",function(o){return l.get(e.current.toolboxes+"/"+(o.current.params.toolbarId||"default")+".json?form=true")}],h=["$route",function(o){return l.get(e.current.locales+"/"+(o.current.params.locale||o.current.params.layoutId)+".json",{ignore:{404:!0}})}],g=["$route",function(o){return l.get(e.current.prototypes+"/"+(o.current.params.prototype||o.current.params.layoutId)+".json")}],f=["$route",function(e){return e.current.params.path}],m=["$route",function(e){var o=r.phoenixPath().split("/");return o.push(a.release?"phoenix.design.min.js":"phoenix.design.js"),l.getScript(o.join("/"))}];angular.module("app").config(["$routeProvider","$locationProvider",function(e,o){o.hashPrefix(c.locationPrefix),e.when("/login",{template:'<div class="container"><login></login></div>'}).when("/forbidden",{template:'<div class="container"><forbidden></forbidden></div>'}).when("/authoring/forms/:layoutId*",{templateUrl:"./authoring/authoring.html",controller:"AuthoringCtrl",resolve:{authoring:m,model:u,toolbox:d,prototype:g,locale:h,form:function(){return!0},path:f}}).when("/authoring/:layoutId*",{templateUrl:"./authoring/authoring.html",controller:"AuthoringCtrl",resolve:{authoring:m,model:n,toolbox:p,prototype:function(){return null},locale:function(){return null},form:function(){return!1},path:function(){return null}}}).when("/:layoutId*",{template:'<layout model="model"></layout>',controller:"PageCtrl",resolve:{model:n},reloadOnSearch:!0}).otherwise({redirectTo:"/"+t.homeName})}]).run(["$rootScope","$location",function(e,o){e.$on("$routeChangeStart",function(e,t,n){var a=i.Page(),r=a.props.$user&&a.props.$user.connected;if(t&&t.params&&t.params.layoutId&&!r&&"login"!=t.params.layoutId){var c=o.path(),l=o.search(),s={redirectUrl:c,redirectSearch:JSON.stringify(l)};c.toLowerCase().indexOf("/login")>=0||!l||l.redirectUrl?o.path("/login"):o.path("/login").search(s).replace()}})}])},d=window.isMobile||{phone:!1,tablet:!1,windows:{},android:{},apple:{}};n.phone=d.phone,n.tablet=d.tablet,n.deviceType=d.windows.device?"windows":d.android.device?"android":d.apple.device?"apple":"",function(){var e={base:"/dataserver/data",headers:{"mg-authentication":"NoPopup"},authentication:"basic"},o=t.configuration?t.configuration:{},n=o.odata?o.odata:e,i=o.rest?o.rest:{},r=o.preferences?o.preferences:{},c=a.release&&o.ui&&o.ui.baseUri?o.ui.baseUri:"/api",l={static:{locales:"./ui/locales",menus:"./ui/menus",pages:"./ui/pages",forms:"./ui/forms",toolboxes:"./ui/toolboxes",prototypes:"./ui/forms/meta",pageformcreate:null,localData:"./data",odata:n,rest:i,preferences:r},dev:{locales:".//ui/locales",menus:c+"/menus/"+t.name,pages:c+"/pages/"+t.name,forms:c+"/forms/"+t.name,toolboxes:c+"/toolboxes/"+t.name,prototypes:c+"/metaform/"+t.name,localData:c+"/data/"+t.name,pageformcreate:c+"/pageform/"+t.name,odata:n,rest:i,preferences:r},current:null};l.current=a.release?l.static:l.dev,t.config(t.name,l);var s=angular.module(t.name);u.registerFilters(s),document.title=t.title,p(l)}()}(Phoenix||(Phoenix={}));var Phoenix;!function(e){var o=e.application,t=o.configuration&&o.configuration.application?o.configuration.application:null,n=e.history,a=(e.ui,e.pagecontrol),i=e.link,r=e.utils,c=e.ajax,l=e.external,s=new e.serial.SingleEventBus(1e3),u=angular.module("app"),p=r.phoenixPath().split("/");p.pop(),p.pop(),p.pop(),p.push("phoenix-app/dist/ui/locales"),o.config(o.core,{current:{locales:p.join("/")}}),u.run(["$location","$rootScope","PhoenixAuthService","$route",function(e,a,c,u){var p=e.path;e.path=function(o,t){if(t)var n=u.current,i=a.$on("$locationChangeSuccess",function(){u.current=n,i()});return p.apply(e,[o])};var d=function(t,a){t&&n.removeLast();var r=o.configuration&&o.configuration.application?o.configuration.application.forbiddenLink:null;r?(r.$replace=!0,i.execLink(r,{},null)):e.path("/forbidden").replace()},h=function(c,l){var s=o.configuration,u=s&&s.authentication&&s.authentication.autoLogon;if(u){var p=i.context({cookie:!0});r.execAngularExpression(s.authentication.autoLogon.login,p)||(u=!1)}if(u)document.location.reload();else{var d=e.path(),h=e.search(),g={};if(c||"/"!=d&&(g.redirectUrl=d,g.redirectSearch=JSON.stringify(h)),!(d.toLowerCase().indexOf("/login")>=0)){var f={$apply:function(e){e()}};l.apply&&(f=a),f.$apply(function(){c?t&&t.authentication&&t.authentication.home?e.path("/login"):e.path("/"):(n.removeLast(),e.path("/login").search(g).replace())})}}},g=function(e,o){if(o.sessionExpired){s.push(function(){return o.apply=!0,h(e,o),null},function(){},!1)}else h(e,o)};l.hashHandler=function(o,t,n){r.nextTick(function(){a.$apply(function(){var a=i.parseUrl(o);t?e.path(a.path,n).search(a.search).replace():e.path(a.path,n).search(a.search)})})},l.forbiddenHandler=function(){a.$apply(function(){d(!0)})},l.logoutHandler=function(){a.$apply(function(){c.logout()})},a.$on("$routeChangeSuccess",function(e){n.add(window.location.hash,window.location.hash=="#/"+o.homeName)}),a.$on("auth-show-login-page",function(e,o){var t={};o&&o.params&&o.params.sessionExpired&&(t.sessionExpired=!0),g(!(!o||!o.params)&&o.params.noRedirect,t)}),a.$on("show-forbidden",function(e,o){d(!0,o&&o.code&&o.code)})}]),angular.element(document).ready(function(){var e=function(){l.checkLoggedInHandler?l.checkLoggedInHandler(function(e){a.Page().props.$user={connected:!!e,credentials:e},angular.bootstrap(document,["app"])}):angular.bootstrap(document,["app"])};c.get("../app.json").then(function(t){if(t){t.support&&(o.support=t.support,delete t.support);var n=o.config(o.name);r.extend(n,t),o.config(o.name,n)}e()}).catch(function(o){e()})})}(Phoenix||(Phoenix={}));
//# sourceMappingURL=app.min.js.map